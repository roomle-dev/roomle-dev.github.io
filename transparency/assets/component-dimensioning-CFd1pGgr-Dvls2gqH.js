import{ai as O,aj as B,S as s,ak as F,al as P,am as R,R as q,an as j,ao as p,ap as M,P as S,aq as f,ar as D,N as G,a0 as N,as as U,at as g,au as V,A as H}from"./index-CBKByVQi.js";class W extends V{constructor(e,i={}){const n=i.font;if(n===void 0)super();else{const t=n.generateShapes(e,i.size);i.depth===void 0&&(i.depth=50),i.bevelThickness===void 0&&(i.bevelThickness=10),i.bevelSize===void 0&&(i.bevelSize=8),i.bevelEnabled===void 0&&(i.bevelEnabled=!1),super(t,i)}this.type="TextGeometry"}}var Y=Object.defineProperty,L=(_,e,i,n)=>{for(var t=void 0,a=_.length-1,o;a>=0;a--)(o=_[a])&&(t=o(e,i,t)||t);return t&&Y(e,i,t),t};const u="component_dimensioning_line_material",y="component_dimensioning_plane_material",w="component_dimensioning_text_material",d=.02,I=.025,C=3618615,J=16777215,Q=.05;class h{constructor(e,i,n){this._direction=h._getDirection(e);const t=h._getDefaultLabelDirection(e,this._direction),a=n.dot(t)>=0;this._labelDirection=h._calculateActualLabelDirection(e,a,t),this._origin=h._calculateOrigin(e,i,a)}get direction(){return this._direction}get labelDirection(){return this._labelDirection}getEdge(e,i,n){const t=this._origin.clone().add(this._direction.clone().multiplyScalar(e)).add(this._labelDirection.clone().multiplyScalar(n)),a=this._origin.clone().add(this._direction.clone().multiplyScalar(i)).add(this._labelDirection.clone().multiplyScalar(n));return new U(t,a)}static _getDirection(e){return e.axis?g(e.axis.direction).normalize():e.dimensioning.axis==="x"?new s(1,0,0):e.dimensioning.axis==="y"?new s(0,0,1):new s(0,1,0)}static _getDefaultLabelDirection(e,i){if(e.axis){const n=g(e.axis.labelDirection);return i.clone().cross(n).cross(i).normalize()}else{if(e.dimensioning.axis==="x")return new s(0,1,0);if(e.dimensioning.axis==="y")return new s(-1,0,0)}return new s(-1,0,0)}static _calculateActualLabelDirection(e,i,n){if(i){if(e.axis){if(e.axis.alternativeOrigin)return n.clone().multiplyScalar(-1)}else if(e.dimensioning.axis==="y"||e.dimensioning.axis==="z")return n.clone().multiplyScalar(-1)}return n}static _calculateOrigin(e,i,n){const t=i.getCenter(new s),a=i.getSize(new s);return e.axis?n&&e.axis.alternativeOrigin?g(e.axis.alternativeOrigin):g(e.axis.origin):e.dimensioning.axis==="x"?new s(0,t.y+a.y*.5,t.z-a.z*.5):e.dimensioning.axis==="y"?new s(t.x+a.x*(n?.5:-.5),t.y-a.y*.5,0):new s(t.x+a.x*(n?.5:-.5),0,t.z-a.z*.5)}}class E extends O{constructor(e,i,n,t){super(),this.name=B,this._size=i.getSize(new s),this._relativeCameraDirection=t.clone(),this._dimensioning=F(e.dimensioning),this._axis=new h(e,i,t),this._level=this._dimensioning.maxLevel-this._dimensioning.level,this._font=n,this._init()}clone(){console.warn("Will not clone ComponentDimensioning")}_initMaterials(){this._cacheHolder.materialCache&&(this._cacheHolder.materialCache.has(u)?this._lineMaterial=this._cacheHolder.materialCache.get(u):(this._lineMaterial=new P({color:C}),this._cacheHolder.materialCache.set(u,this._lineMaterial)),this._cacheHolder.materialCache.has(y)?this._planeMaterial=this._cacheHolder.materialCache.get(y):(this._planeMaterial=new R({color:J,side:q,opacity:.8,transparent:!0}),this._cacheHolder.materialCache.set(y,this._planeMaterial)),this._cacheHolder.materialCache.has(w)?this._textMaterial=this._cacheHolder.materialCache.get(w):(this._textMaterial=new j({color:C}),this._cacheHolder.materialCache.set(w,this._textMaterial)))}_init(){this._initMaterials();const e=new p;this._line=new M(e,this._lineMaterial),this._line.name="component dimension line "+this._dimensioning.axis,this._text=new S(e,this._textMaterial),this._text.name="component dimension text "+this._dimensioning.axis,this._plane=new S(e,this._planeMaterial),this._plane.name="component dimension plane "+this._dimensioning.axis;const i=new p,n=Math.round(Math.max(this._size.y,this._size.x,this._size.z)),t=Math.abs(this._dimensioning.to-this._dimensioning.from);let a=I+(n<4?0:n*.005);t<.3&&(a*=.5+t);const o={font:this._font,size:a,height:.001,curveSegments:2,bevelEnabled:!0,bevelThickness:.001,bevelSize:.001,depth:.001},r=this._dimensioning.label?this._dimensioning.label:this._unitFormatter.formatMMValueToUnitString(t*1e3),c=new W(r,o);c.computeBoundingBox();const b=c.boundingBox.getSize(new s).y,T=Q+(3*d+b)*this._level,l=this._axis.getEdge(this._dimensioning.from,this._dimensioning.to,T);this._addEdgeSideLines(b,l,this._axis.labelDirection.clone());const k=[l.start.x,l.start.y,l.start.z,l.end.x,l.end.y,l.end.z];i.setAttribute("position",new f(new Float32Array(k),3)),this._line.geometry.dispose(),this._line.geometry=i,this.add(this._line),this._text.geometry=c;const v=this._axis.direction.clone(),m=this._axis.labelDirection.clone();new s(0,1,0).dot(m)<Math.SQRT1_2&&m.multiplyScalar(-1);const z=v.clone().cross(m);let x=new D().makeBasis(v,m,z);this._relativeCameraDirection.dot(z)>0&&(x=x.multiply(new D().makeRotationY(Math.PI)));const A=new G().setFromRotationMatrix(x);this._addText(l,c,A,this._axis.labelDirection.clone().multiplyScalar(2*d))}_addEdgeSideLines(e,i,n){const t=-(3*d+e)*.5,a=i.start.clone(),o=i.start.clone().add(n.clone().multiplyScalar(t)),r=i.end.clone(),c=i.end.clone().add(n.clone().multiplyScalar(t));this._addLine(o,a),this._addLine(c,r)}_addLine(e,i){const n=new p,t=[e.x,e.y,e.z,i.x,i.y,i.z];n.setAttribute("position",new f(new Float32Array(t),3)),this.add(new M(n,this._lineMaterial))}_addText(e,i,n,t){const a=e.getCenter(new s);a.add(t);const o=i.boundingBox.getSize(new s);i.center(),this._text.position.copy(a),this._text.quaternion.copy(n),this.add(this._text);const r=new N(o.x+d,o.y+d,32);r.center(),this._plane.geometry=r,this._plane.position.copy(a),this._plane.quaternion.copy(n),this.add(this._plane)}}L([H],E.prototype,"_cacheHolder");L([H],E.prototype,"_unitFormatter");export{E as default};
