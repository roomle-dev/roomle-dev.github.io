import{d2 as p,d3 as c,d4 as h,P as l,d5 as u,d6 as m,d7 as b,S as o,d8 as d,F as _}from"./index-BowFTnF3.js";class C{constructor(){this._nonTransparentComponent=null,this._raycaster=new p,this._raycaster.near=.1,this._raycaster.layers.enable(c.OBJECT),this._raycaster.layers.enable(c.COMPONENT),this._raycaster.layers.enable(c.PREVIEW),this._raycaster.layers.enable(c.UI)}init(e,t){this._object=e,this._camera=t,this.checkComponentVisibility=h(this.checkComponentVisibility,100).bind(this),this.checkPreviewVisibility=h(this.checkPreviewVisibility,100).bind(this)}setCamera(e){this._camera=e}setObject(e){this._object=e}changeMaterialsOnSelect(e,t,s=!1,a){t!==this._nonTransparentComponent&&(this._nonTransparentComponent=t,this._changeMaterialsOnSelect(e,t,s,a))}_changeMaterialsOnSelect(e,t,s=!1,a){if(e.children.length>0)for(const n of e.children){const i=t&&e.id===t.id||s,r=!(n instanceof l);n.userData.ignoreComponentRaycast||this._changeMaterialsOnSelect(n,t,i&&r?!1:i,a)}if(t)e instanceof l&&e.material instanceof u&&!e.userData.oldMaterial&&(e.userData.oldMaterial=e.material,e.material=e.material.clone(),s||m(e,{opacity:.2,transparent:!0}).then(()=>{a?.()}));else if(e.userData.oldMaterial&&e instanceof l&&e.material instanceof u){const{opacity:n,transparent:i}=e.userData.oldMaterial;m(e,{opacity:n,transparent:i}).then(()=>a?.()),e.userData.oldMaterial=void 0}}isComponentVisible(e){const t=[];e.traverse(i=>t.push(i.uuid));const s=new b().setFromObject(e).getCenter(new o),a=new o().subVectors(s,this._camera.position).normalize();this._raycaster.set(this._camera.position,a),this._raycaster.far=this._camera.position.distanceTo(s);const n=[];return this._raycaster.intersectObjects(this._object.children,!0).forEach(i=>{i.object.material.visible&&(t.includes(i.object.uuid)||i.object.userData.ignoreComponentRaycast||n.push(i))}),n.length===0}checkComponentAndPreviewVisibility(e,t){e.hasSelection()?this.checkComponentVisibility(e,t):t.hasPreviews()?this.checkPreviewVisibility(t):this.changeMaterialsOnSelect(this._object,null)}checkComponentVisibility(e,t){if(!e.hasSelection())return;const s=t.getComponentsForIds(e.getSelectedRuntimeComponentIds());if(s.length>1)return;const a=s[0];this.isComponentVisible(a)?this.changeMaterialsOnSelect(this._object,null):this.changeMaterialsOnSelect(this._object,a)}areAllPreviewsVisible(e){if(!e.hasPreviews())return!0;const t=e.getPreviews();return t.length===0?!0:t.map(s=>this.isComponentVisible(s)).reduce((s,a)=>s&&a)}areAllComponentsInFrustum(e){if(e.length===0)return!0;const t=new d,s=new _().multiplyMatrices(this._camera.projectionMatrix,this._camera.matrixWorldInverse),a=new b;t.setFromProjectionMatrix(s);const n=i=>{const r=a.setFromObject(i).getCenter(new o);return t.containsPoint(r)};return e.map(i=>n(i)).reduce((i,r)=>i&&r)}checkPreviewVisibility(e){e.hasPreviewLines()||(this.areAllPreviewsVisible(e)?this.changeMaterialsOnSelect(this._object,null):this.changeMaterialsOnSelect(this._object,{id:-1}))}isComponentMeasurementLabelOccluded(e,t){const s=new o().subVectors(e,this._camera.position).normalize(),a=this._camera.position.distanceTo(e);return this._raycaster.set(this._camera.position,s),this._raycaster.far=a-.01,this._raycaster.intersectObject(t,!0).filter(n=>{const i=n.object;return!(i.type!=="Mesh"||i.userData.ignoreComponentRaycast||i.material&&!i.material.visible)}).length>0}checkMultipleLabelOcclusion(e,t){const s=new Set;return e.forEach(({id:a,worldPos:n})=>{this.isComponentMeasurementLabelOccluded(n,t)&&s.add(a)}),s}}export{C as default};
