import{du as p,dv as A,dw as L,cU as g}from"./index-vzMrgKlp.js";class R{}const P=(...n)=>console.log("[HI]","Message:",...n);class O{constructor(e){this._roomlePlanner=e}loadMasterData(e){this._roomlePlanner.loadExternalObjectMasterData(e)}async loadPosGroups(e,t){const o=Array.isArray(e)?e:[e];await this._roomlePlanner.loadExternalObjectGroups(o,t)}async selectGroup(e){await this._roomlePlanner.selectExternalObjectGroup(e)}async selectRoot(e){await this._roomlePlanner.selectExternalObjectRootModule(e)}async selectModule(e,t){await this._roomlePlanner.selectExternalObjectSubModule(e,t)}openCloseGroup(e,t,o,r){return this._roomlePlanner.openOrCloseGeometryOfExternalObject(e,t??null,o,r),Promise.resolve()}deleteGroup(e){this._roomlePlanner.removeExternalObject(e)}deleteRootModule(e){this._roomlePlanner.selectExternalObjectGroup(e)}async getPosDataOfAllGroups(){return await this._roomlePlanner.getExternalObjectGroups()}async getRoomInformation(){return await this._roomlePlanner.getExternalRoomInformation()}async generatePlanSnapshot(){const[e,t]=await Promise.all([this._roomlePlanner.saveExternalObjectSnapshot(),this._roomlePlanner.saveCurrentPlanSnapshot()]);return{objectId:e?.id??"",planId:t.id??""}}async saveExternalObjectSnapshot(){return this._roomlePlanner.saveExternalObjectSnapshot()}async saveCurrentPlanSnapshot(){return this._roomlePlanner.saveCurrentPlanSnapshot()}async renderPosDataImage(e){const t=Array.isArray(e)?e:[e];await this._roomlePlanner.renderImagesOfExternalObjectGroup(t)}async downloadGlb(){const e=await this._roomlePlanner.saveExternalObjectSnapshot();if(!e){P("No plan snapshot available to download GLB.");return}window.open(e.topImage,"_blank")?.focus(),window.open(e.perspectiveImage,"_blank"),window.open(e.glb,"_blank")}}var S=(n=>(n.BOTTOM_BAR="bottom_bar",n.PARTLIST_BOUNDS="partlist_bounds",n.INTERACTION_NOTES="interaction_notes",n.PARAMETER_GROUPS="parameter_groups",n))(S||{});S.INTERACTION_NOTES+"";const _={HIDE:"hide",SHOW_ATTRIBUTES:"attributes",SHOW_ARTICLES:"articles"},f={NONE:"none",GROUP:"group",ROOT_MODULE:"rootModule",SUB_MODULE:"subModule"},m={MULTI_SELECT:"multiselect",TC_CONFIG:"tc-config",RML_OBJECT:"rml-object"};class w{constructor(e){this._callbacks=null,this._contextType=g.PLANNER,this._selectionMode=null,this._hiSelection={type:f.NONE,groupId:null,rootModuleId:null,subModuleId:null},this._emittedSelection={panel:null,groupId:null,rootModuleId:null,subModuleId:null},this._callbacks=e}setSidebar(e){if(e!=="productSettings"){if(e==="catalog"){this._emitSelectionChange(_.SHOW_ARTICLES);return}this._emitSelectionChange(_.HIDE)}}contextChanged(e){this._contextType=e,e===g.PLANNER&&this._resetSelection(),this._handleViewTypeChange()}groupOrModuleSelected(e,t,o){this._selectionMode=m.TC_CONFIG,this._hiSelection.groupId=e,this._hiSelection.rootModuleId=t??null,this._hiSelection.subModuleId=o??null,this._hiSelection.rootModuleId&&this._hiSelection.subModuleId?this._hiSelection.type=f.SUB_MODULE:this._hiSelection.rootModuleId?this._hiSelection.type=f.ROOT_MODULE:this._hiSelection.type=f.GROUP,this._handleViewTypeChange()}componentSelectionCancel(e){this._contextType===g.CONFIGURATOR&&(e==="click_outside"||e==="isolation_mode_cancelled"||e==="select_other"||(this._resetSelection(),this._handleViewTypeChange()))}selectionCancel(e){e!=="select_other"&&(this._resetSelection(),this._handleViewTypeChange())}selectionChanged(e,t,o,r,s){this._selectionHandler(g.PLANNER,e,t,o)}_resetSelection(){this._selectionMode=null}_selectionHandler(e,t,o,r){if(e!==g.CONFIGURATOR){if(t===m.MULTI_SELECT){this._selectionMode=t,this._handleViewTypeChange();return}o==="external-configuration"&&r.externalConfigurationType===m.TC_CONFIG?this._selectionMode=m.TC_CONFIG:this._selectionMode=m.RML_OBJECT,this._handleViewTypeChange()}}_handleViewTypeChange(){let e=_.SHOW_ARTICLES;this._selectionMode===m.TC_CONFIG&&(this._contextType===g.CONFIGURATOR||this._hiSelection.type!==f.GROUP)&&(e=_.SHOW_ATTRIBUTES),this._emitSelectionChange(e)}_emitSelectionChange(e){if(this._emittedSelection.panel!==e){this._emittedSelection.panel=e;const t=e===_.SHOW_ATTRIBUTES;this._emittedSelection.groupId=t?this._hiSelection.groupId:null,this._emittedSelection.rootModuleId=t?this._hiSelection.rootModuleId:null,this._emittedSelection.subModuleId=t?this._hiSelection.subModuleId:null,this._callbacks?.onShowHidePanel(e,this._emittedSelection.groupId,this._emittedSelection.rootModuleId,this._emittedSelection.subModuleId)}else this._emittedSelection.panel===_.SHOW_ATTRIBUTES&&(this._emittedSelection.groupId!==this._hiSelection.groupId||this._emittedSelection.rootModuleId!==this._hiSelection.rootModuleId||this._emittedSelection.subModuleId!==this._hiSelection.subModuleId)&&(this._emittedSelection.groupId=this._hiSelection.groupId??null,this._emittedSelection.rootModuleId=this._hiSelection.rootModuleId??null,this._emittedSelection.subModuleId=this._hiSelection.subModuleId??null,this._callbacks?.onSelectModule(this._emittedSelection.groupId,this._emittedSelection.rootModuleId,this._emittedSelection.subModuleId))}}class G{constructor(e,t=null){this._libraryData=new Map,this._posDataForLoading=null,this._posArticleMap=new Map,this._groupMap=new Map,this._nextPosDataId=1,this._hiCallbacks=null,this._pendingGroupsToBeLoaded=[],this._planCompletelyLoaded=!1,this._validSubArticles=[],this._designerRequests=e,this._hiCallbacks=t,this._hiObjectSelection=new w(t)}get hiCallbacks(){return this._hiCallbacks}get hiObjectSelection(){return this._hiObjectSelection}_getGroup(e){return this._groupMap.get(e)}getLibraryData(e){if(this._libraryData.size===1)return Array.from(this._libraryData.values())[0];let t;return typeof e=="string"?t=e:t=this._getLibraryIdForPosData(e),this._libraryData.has(t)?this._libraryData.get(t)??null:(console.error(`Library data for libraryId '${t}' not found`),null)}isLibraryLoaded(e){return this._libraryData.has(e)}addLibrary(e){this._libraryData.has(e.libraryId)||(this._libraryData.set(e.libraryId,e),this._loadPendingGroup(e.libraryId))}loadPosData(e,t){e?.articles&&(e=e.articles),e.forEach(o=>{const r=o.id||o.articleId,s=p(o);s.libraryId=t,this._posArticleMap.set(r,s)})}setPosDataForLoading(e){this._posDataForLoading=e;const t=Array.from(this._groupMap.values()).map(o=>o.posDataJson);this._groupMap.clear();for(const o of t)this.loadedGroup(o)}async getSaveDataGroups(){return this._posDataForLoading?.groups??null}async newPosDataFromId(e){A(e)&&(e=L(e));const t=p(this._posArticleMap.get(e));if(!t)return;const o=t;o.ver=this.getLibraryData(o.libraryId)?.posGroupVersion,o.logMessages=[],o.roots.forEach(s=>{s.libraryId=t.libraryId,s.catalog=t.libraryId,s.logMessages=[],s.isGenerated||(s.articleName=t.articleName,s.articleId=t.articleId,s.desc=t.desc,s.imageUrl=t.imageUrl,s.category=t.category)});const r=this._addNewGroup(o,!1);return this._groupsModified(r.posDataJson,[],[]),r.posDataJson}async newPosDataFromGroup(e){const t=this._addNewGroup(e,!1);return this._groupsModified(t.posDataJson,[],[]),t.posDataJson}async selectGroup(e){try{await this._designerRequests.selectGroup(e)}catch(t){console.error(t)}}async selectRoot(e,t){try{await this._designerRequests.selectRoot(t)}catch(o){console.error(o)}}async deleteRoot(e,t){try{await this._designerRequests.deleteRootModule(t)}catch(o){console.error(o)}}async selectSubModule(e,t,o){try{await this._designerRequests.selectModule(t,o)}catch(r){console.error(r)}}async openCloseGroup(e){try{const t=this._getGroup(e);if(t){const o=!t.opened;await this._designerRequests.openCloseGroup(e,null,o,!1),t.opened=o}}catch(t){console.error(t)}}deleteRootModule(e,t,o){try{const r=this._getGroup(e.groupId);if(r){this._setGroupPosition(r,e),this._setGroupContour(r,e),this._setRootModulesPosition(r,e);const s=r.posDataJson;s.roots=s.roots.filter(a=>a.id!==t);const i=this._splitOffGroupsFromGroups(r,o);this._calculateAndUpdateGroupMap(r),this._loadPosData(r,i),this._groupsModified(i.map(a=>a.posDataJson),r.posDataJson,[])}}catch(r){console.error(r)}}duplicateGroup(e){try{const t=this._getGroup(e?.groupId);if(t){const o=p(t.posDataJson);o.roots=o.roots.filter(s=>e.rootModules.find(i=>i.moduleId===s.id)!==void 0);const r=this._addNewGroup(o,!1);this._setGroupPosition(r,e),this._designerRequests.loadPosGroups(r.posDataJson,{findFreeSpaceInPlan:!0}),this._groupsModified(r.posDataJson,[],[])}}catch(t){console.error(t)}}mergeGroups(e,t,o){try{const r=Array.isArray(t)?t:[t];if(this._groupMap.has(e.groupId)&&r.length>0){const s=[];for(const l of r){const u=this._getGroup(l);u&&s.push(...u.posDataJson.roots)}const i=s.filter(l=>!l.isGenerated),a=this._getGroup(e.groupId);if(a){const l=a.posDataJson.roots.find(d=>d.id===o);l&&this._applyImplicitRelevantAttributes(this._getLibraryIdForPosData(a.posDataJson),l,i),a.posDataJson.roots.push(...i),this._setGroupPosition(a,e),this._setGroupContour(a,e),this._setRootModulesPosition(a,e),this._calculateAndUpdateGroupMap(a),this._designerRequests.loadPosGroups(a.posDataJson,{mergedGroups:r});const u=[];for(const d of r)this._groupMap.has(d)&&(this._groupMap.delete(d),u.push(d));this._groupsModified([],a.posDataJson,u)}}}catch(r){console.error(r)}}_applyImplicitRelevantAttributes(e,t,o){const r=this.getLibraryData(e)?.masterData;if(!r||!t||o.length===0)return;const s=r.modules.find(i=>i.id===t.name)?.assignedAttributes.filter(i=>r.attributes.find(a=>a.id===i)?.implicitRelevant===!0)??[];for(const i of o){const a=r.modules.find(l=>l.id===i.name);for(const l of s){const u=t.attributes?.find(h=>h.id===l);if(!a?.assignedAttributes.find(h=>h===l))continue;const d=i.attributes?.find(h=>h.id===l);d?(d.isInput=u?.isInput??!1,d.isInput===!0&&(d.value=u?.value)):(u?.isInput??!1)&&i.attributes?.push({id:l,value:u?.value,isInput:!0})}}}splitRootModuleFromGroup(e,t){try{const o=this._getGroup(e.groupId);if(o){this._setGroupPosition(o,e),this._setGroupContour(o,e),this._setRootModulesPosition(o,e);const r=Array.isArray(t)?t:[t],s=this._splitOffGroupsFromGroups(o,r);this._calculateAndUpdateGroupMap(o),this._loadPosData(o,s),this._groupsModified(s.map(i=>i.posDataJson),o.posDataJson,[])}}catch(o){console.error(o)}}arrangeRootModulesOfGroup(e){try{const t=this._getGroup(e.groupId);if(t){for(const r of t.posDataJson.roots)e.rootModules.filter(s=>s.moduleId===r.id).forEach(s=>{r.articlePos=s.pos,r.rotationY=s.rotationY});const o=this._calculateAndUpdateGroupMap(t);this._designerRequests.loadPosGroups(o,{}),this._groupsModified([],o,[])}}catch(t){console.error(t)}}removedGroup(e){try{this._groupMap.has(e)&&(this._groupMap.delete(e),this._groupsModified([],[],e))}catch(t){console.error(t)}}changedGroupFromHistory(e,t){try{const o=this._calculate(e),r=o.id,s=this._getGroup(r);s?s.posDataJson=o:this._addGroupToMap(r,o),t&&this._designerRequests.loadPosGroups(e,{}),this._groupsModified(s?[]:[o],s?[o]:[],[])}catch(o){console.error(o)}}changedGroupPlanningSituation(e){try{const t=this._getGroup(e.groupId);if(t){this._setGroupPosition(t,e),this._setGroupContour(t,e);const o=this._calculateAndUpdateGroupMap(t);this._designerRequests.loadPosGroups(o,{}),this._groupsModified([],o,[])}}catch(t){console.error(t)}}loadedGroup(e){const t=this._getLibraryIdForPosData(e);if(!this._libraryData.has(t)){this._pendingGroupsToBeLoaded.push(e);return}this._loadedGroup(e)}_loadPendingGroup(e){const t=this._pendingGroupsToBeLoaded.filter(o=>this._getLibraryIdForPosData(o)===e);this._pendingGroupsToBeLoaded=this._pendingGroupsToBeLoaded.filter(o=>this._getLibraryIdForPosData(o)!==e),t.forEach(o=>this._loadedGroup(o)),this._pendingGroupsToBeLoaded.length===0&&this._groupsCompletelyLoaded()}_loadedGroup(e){if(!this._posDataForLoading){this._recalculateLoadedGroup(e);return}const t=this._posDataForLoading.groups.find(r=>r.id===e.id);if(!t){this.removedGroup(e.id),this._designerRequests.deleteGroup(e.id);return}const o=p(t);o.ver=this.getLibraryData(e)?.posGroupVersion,e.pos!==void 0&&(o.pos=e.pos),e.rotationY!==void 0&&(o.rotationY=e.rotationY),this._recalculateLoadedGroup(o)}_recalculateLoadedGroup(e){try{const t=e.id,o=!this._groupMap.has(t);o&&this._addGroupToMap(t,e);const r=this._getGroup(t);if(r){const s=this._calculateAndUpdateGroupMap(r);this._designerRequests.loadPosGroups(s,{respondWithPositionInPlan:!0}),this._groupsModified(o?s:[],o?[]:s,[])}}catch(t){console.error(t)}}groupsCompletelyLoaded(){this._planCompletelyLoaded=!0,this._groupsCompletelyLoaded()}_groupsCompletelyLoaded(){this._planCompletelyLoaded&&this._libraryData.size>0&&this._pendingGroupsToBeLoaded.length===0&&this._hiCallbacks?.onPosGroupsCompletelyLoaded()}async getGroupDataForOrder(e){try{const t=Array.from(this._groupMap.values()).map(i=>i.posDataJson);let o=1;t.forEach(i=>{i.roots.forEach(a=>{a.additionalText="Additional Text "+o++})});const r=this.getLibraryData(e)?.getOrderData(t,e);if(!r)return null;const s=await this._designerRequests.getRoomInformation();return r.rooms=s?.rooms??[],r}catch(t){return console.error(t),null}}_setGroupContour(e,t){t.contours&&(e.posDataJson.contours=t.contours)}_setGroupPosition(e,t){const o=e.posDataJson;t.pos!==void 0&&(o.pos=t.pos),t.rotationY!==void 0&&(o.rotationY=t.rotationY)}_setRootModulesPosition(e,t){for(const o of e.posDataJson.roots)t.rootModules.filter(r=>r.moduleId===o.id).forEach(r=>{o.articlePos=r.pos,o.rotationY=r.rotationY})}_loadPosData(e,t){const o=p(e.posDataJson),r=Array.isArray(o)?o:[o];for(const s of t??[])r.push(p(s.posDataJson));this._designerRequests.loadPosGroups(r,{})}_splitOffGroupsFromGroups(e,t){const o=[];for(const r of t??[]){const s=this._splitOffRootModulesFromGroup(e,r),i=this._addNewGroup(s,!0);o.push(i)}return o}_splitOffRootModulesFromGroup(e,t){const o=t.rootModules.map(i=>i.moduleId),r=e.posDataJson,s=r.roots.filter(i=>o.includes(i.id));r.roots=r.roots.filter(i=>!o.includes(i.id));for(const i of s)t.rootModules.filter(a=>a.moduleId===i.id).forEach(a=>{i.articlePos=a.pos,i.rotationY=a.rotationY});for(const i of r.roots)i.isGenerated&&s.push(p(i));return{id:void 0,libraryId:r.libraryId,pos:t.pos,rotationY:t.rotationY,roots:s,ver:r.ver,logMessages:[]}}_calculateNewGroup(e,t){return this._replacesIDs(e,t),this._calculate(e)}_getLibraryIdForPosData(e){return e.libraryId?e.libraryId:e.roots.find(t=>t.libraryId)?.libraryId}_populateRootFromMasterData(e,t,o){if(!o)return;const r=o.modules.find(s=>s.id===e.name);r&&(t?.articleName||(e.articleName=r.name),t?.articleId||(e.articleId=r.name),t?.imageUrl||(e.imageUrl=r.imageUrl),t?.desc||(e.desc=r.desc))}_setSubmoduleImages(e,t){t&&e.modules?.length&&e.modules.forEach(o=>{const r=t.modules.find(s=>s.id===o.name);r&&(o.imageUrl=r.imageUrl),this._setSubmoduleImages(o,t)})}_calculateAndUpdateGroupMap(e){const t=this._calculate(e.posDataJson);return e.posDataJson=t,this._groupMap.set(e.posDataJson.id,e),t}_addNewGroup(e,t){const o=this._calculateNewGroup(e,t);return this._addGroupToMap(o.id,o)}_addGroupToMap(e,t){const o={posDataJson:t,opened:!1};return this._groupMap.set(e,o),o}updateAttribute(e,t,o,r){if(!e)return;const s=Array.from(this._groupMap.entries()).find(([,a])=>a.posDataJson.roots.some(l=>l.id===e));if(!s)throw new Error("PosGroup not found inside the calculated articles list");const[,i]=s;if(i){const a=this._modifyAttributeOfModules(i,t??e,o,r);this._designerRequests.loadPosGroups(a,{correctArrangement:!0}),this._groupsModified([],a,[])}}modifyAttribute(e,t,o,r){const s=this._getGroup(e);if(s){const i=t.map(l=>l.subModuleId??l.rootModuleId),a=this._modifyAttributeOfModules(s,i,o,r);this._designerRequests.loadPosGroups(a,{correctArrangement:!0}),this._groupsModified([],a,[])}}async getVerifiedAttributeOptions(e,t){const o=this._findModuleInAllGroups(e);if(!o){console.error("Module not found inside the calculated articles list");return}if(!o.module.checkAttributes)return;let r;try{r=await this.getLibraryData(o.group)?.getAttributesDropDownValues(o.module,t)}catch(i){console.error(i)}if(!r)return;const s={};for(const[i,a]of Object.entries(r))a&&a.length>0&&(s[i]={calcResult:a.map(l=>({value:l.value,kind:l.kind}))});return s}updateAdditionalInfo(e,t){const o=this._findRootModuleInAllGroups(e);if(!o){console.error("Root module not found inside the calculated articles list");return}o.rootModule.additionalText=t,this._designerRequests.loadPosGroups(o.group,{}),this._groupsModified([],o.group,[])}async swapRootModule(e,t,o){const r=this._getGroup(e);if(!r)return;const s=r.posDataJson,i=s.roots.find(b=>b.id===t);if(!i)return;const a=await this.newPosDataFromId(o),l=a.roots.filter(b=>!b.isGenerated);if(!a||l.length!==1)return;const u=l[0];i&&this._applyImplicitRelevantAttributes(this._getLibraryIdForPosData(s),i,[u]),u.articlePos=i.articlePos,u.rotationY=i.rotationY,s.roots=s.roots.filter(b=>b.id!==t),s.roots.push(u);const d=this._calculateAndUpdateGroupMap(r),h={originalModuleId:t,newModuleId:u.id};this._designerRequests.loadPosGroups(d,{newAction:!0,correctArrangement:!0,moduleIdMap:[h]}),this._groupsModified([],d,[])}_modifyAttributeOfModules(e,t,o,r){const s=Array.isArray(t)?t:[t],i=this.getLibraryData(e.posDataJson);for(const a of s){const l=this._findModule(e.posDataJson.roots,a);if(l&&i){const u=i.solveModuleAttributeConflict(l,o,r);this._setAttribute(l,o,r),u&&u.length>0&&u.forEach(d=>{d.value!==void 0&&this._setAttribute(l,d.id,d.value)})}}return this._calculateAndUpdateGroupMap(e)}_setAttribute(e,t,o){if(e.attributes&&e.attributes.length>0){const s=e.attributes.find(i=>i.id===t);if(s){s.value=o,s.isInput=!0;return}}const r={id:t,value:o,isInput:!0};e.attributes?e.attributes.push(r):e.attributes=[r]}findValidSubArticles(e){this._validSubArticles=[];const t=Array.isArray(e)?e:[e];for(const o of t){const r=this._getGroup(o);if(!r)continue;const s=r.posDataJson,{libraryId:i,libraryData:a}=this._getLibrary(s);if(!a)continue;const l=Array.from(this._posArticleMap.values()).filter(u=>u.libraryId===i);try{const u=a.getValidSubArticles(s,l,a.masterData);this._validSubArticles.push(...Array.from(u))}catch(u){console.error(u)}}return this._validSubArticles}_getValidSubArticle(e){return this._validSubArticles.find(t=>t.articleId===e)??null}getValidContainerModulesForSubArticle(e,t){const o=this._getValidSubArticle(t);if(!o)return[];const r=Array.isArray(e)?e:[e],s=[];for(const i of r){const a=this._getGroup(i);if(!a)continue;const l=a.posDataJson,{libraryData:u}=this._getLibrary(l);if(u)try{const d=u.getValidContainerModulesForSubArticle(l,o,u.masterData);s.push(...Array.from(d))}catch(d){console.error(d)}}return s}addSubArticle(e,t,o){const r=this._getValidSubArticle(e);if(!r)return;const{group:s}=this._findRootModuleInAllGroups(t);if(!s)return;const i=this._addSubArticle(s,r,t,o);this._designerRequests.loadPosGroups(i,{}),this._groupsModified([],i,[])}async savePlanSnapshot(){const[e,t]=await Promise.all([this._designerRequests.saveExternalObjectSnapshot(),this._designerRequests.saveCurrentPlanSnapshot()]);return t?{id:t.id,perspectiveImageLink:t?.perspectiveImage,topImageLink:t?.topImage,room3dLink:e?.glb,room3dFullLink:`https://api.roomle.com/v2/planSnapshots/${t.id}/3dAssets/glTF/plan.glb`}:(console.error("Failed to save plan snapshot"),null)}_findRootModuleInAllGroups(e){for(const t of this._groupMap.values()){const o=t.posDataJson,r=o.roots.find(s=>s.id===e);if(r!==void 0)return{group:o,rootModule:r}}}_findModuleInAllGroups(e){for(const t of this._groupMap.values()){const o=t.posDataJson,r=this._findModule(o.roots,e);if(r!==void 0)return{group:o,module:r}}}_findModule(e,t){for(const o of e){if(o.id===t)return o;if(o.modules&&o.modules.length>0){const r=this._findModule(o.modules,t);if(r!==void 0)return r}}}_replacesIDs(e,t){if(e.id=this._getNextID(),!t)for(const o of e.roots)this._replacesModuleIDs(o)}_replacesModuleIDs(e){if(e.id=this._getNextID(),e.modules)for(const t of e.modules)this._replacesModuleIDs(t)}_getNextID(){if(window.uuidv4)return window.uuidv4();let e=(this._nextPosDataId++).toString();return e.length<4&&(e="0".repeat(4-e.length)+e),"id"+e}async _groupsModified(e,t,o){const r=Array.isArray(e)?e:[e];r.length>0&&await this._hiCallbacks?.onPosGroupAdded(r);const s=Array.isArray(t)?t:[t];s.length>0&&await this._hiCallbacks?.onPosGroupChanged(s);const i=Array.isArray(o)?o:[o];i.length>0&&await this._hiCallbacks?.onPosGroupDeleted(i),this._calculatePrice()}_calculatePrice(){const e=Array.from(this._groupMap.values()).map(t=>t.posDataJson);this._hiCallbacks?.onPriceCalc(e)}_calculate(e){const{libraryId:t,libraryData:o}=this._getLibrary(e);if(!o)return null;const r=p(e);r.libraryId=t,r.logMessages&&(r.logMessages=[]);let s=e;try{s=o.calculateGroup(e)}catch(i){console.error("Error calculating group:",i)}return this._takeOverPropertiesFromOriginalGroup(t,o,e,s),s}_addSubArticle(e,t,o,r){const{libraryId:s,libraryData:i}=this._getLibrary(e);if(!i)return null;const a=p(e);a.libraryId=s,a.logMessages=[];let l=e;try{l=i.addSubArticle(e,t,o,r)}catch(u){console.error("Error adding sub article to group:",u)}return this._takeOverPropertiesFromOriginalGroup(s,i,e,l),l}_getLibrary(e){const t=this._getLibraryIdForPosData(e),o=this.getLibraryData(t);return{libraryId:t,libraryData:o}}_takeOverPropertiesFromOriginalGroup(e,t,o,r){o.pos!==void 0&&(r.pos=o.pos),o.rotationY!==void 0&&(r.rotationY=o.rotationY);const s=t.masterData;r.roots.forEach(i=>{const a=o.roots.find(l=>l.id===i.id);i.additionalText=a?.additionalText,i.libraryId=a?.libraryId??e,this._populateRootFromMasterData(i,a,s),i.articleName??=a?.articleName??i.name,i.articleId??=a?.articleId??a?.articleName??i.articleName??i.name,i.imageUrl??=a?.imageUrl,i.desc??=a?.desc,i.category=a?.category,i.canBeDeleted=!i.isGenerated,this._setSubmoduleImages(i,s)})}}const c=[];for(let n=0;n<256;++n)c.push((n+256).toString(16).slice(1));function C(n,e=0){return(c[n[e+0]]+c[n[e+1]]+c[n[e+2]]+c[n[e+3]]+"-"+c[n[e+4]]+c[n[e+5]]+"-"+c[n[e+6]]+c[n[e+7]]+"-"+c[n[e+8]]+c[n[e+9]]+"-"+c[n[e+10]]+c[n[e+11]]+c[n[e+12]]+c[n[e+13]]+c[n[e+14]]+c[n[e+15]]).toLowerCase()}let I;const v=new Uint8Array(16);function E(){if(!I){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");I=crypto.getRandomValues.bind(crypto)}return I(v)}const F=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),M={randomUUID:F};function T(n,e,t){if(M.randomUUID&&!e&&!n)return M.randomUUID();n=n||{};const o=n.random||(n.rng||E)();if(o[6]=o[6]&15|64,o[8]=o[8]&63|128,e){t=t||0;for(let r=0;r<16;++r)e[t+r]=o[r];return e}return C(o)}const N=(n,e)=>{n.callbacks.onMergeExternalObjectGroup=(t,o,r)=>{e.mergeGroups(t,o,r)},n.callbacks.onSplitExternalObjectGroup=(t,o)=>{e.splitRootModuleFromGroup(t,o)},n.callbacks.onExternalObjectGroupArrangementChanged=t=>{e.arrangeRootModulesOfGroup(t)},n.callbacks.onDeleteExternalObjectGroup=t=>{e.removedGroup(t)},n.callbacks.onDeleteExternalObjectRootModule=(t,o,r)=>{e.deleteRootModule(t,o,r??[])},n.callbacks.onDeleteExternalObjectSubModule=(t,o)=>{},n.callbacks.onDuplicateExternalObjectGroup=(t,o)=>{e.duplicateGroup(o)},n.callbacks.onChangedExternalObjectGroupPlan=t=>{e.changedGroupPlanningSituation(t)},n.callbacks.onExternalObjectEnvironmentChanged=t=>{},n.callbacks.onExternalObjectGroupChanged=t=>{const o=JSON.parse(t);e.changedGroupFromHistory(o,!1)},n.callbacks.onExternalObjectGroupLoaded=t=>{const o=JSON.parse(t);e.loadedGroup(o)},n.callbacks.onExternalObjectAttributeChanged=(t,o,r,s)=>{Array.isArray(o)?e.modifyAttribute(t,o,r,s):e.modifyAttribute(t,[{groupId:t,rootModuleId:o,subModuleId:null}],r,s)},n.callbacks.onCompletelyLoaded=()=>{e.groupsCompletelyLoaded()},n.callbacks.onPlanSnapshotCreated=(...t)=>{},n.callbacks.onExternalObjectModuleSelected=(t,o,r)=>{e.hiObjectSelection.groupOrModuleSelected(t,o,r)},n.callbacks.onContextChanged=t=>{e.hiObjectSelection.contextChanged(t)},n.callbacks.onSelectionChange=(t,o,r,s,i)=>{e.hiObjectSelection.selectionChanged(t,o,r,s,i)},n.callbacks.onSelectionCancel=t=>{e.hiObjectSelection.selectionCancel(t)}},y=(n=new Date)=>{let e=n.toISOString();e=e.slice(0,-1);const t=e.lastIndexOf(".");let o=e;t!==-1&&(o=e.substring(0,t+4)+"0000");const r=n.getTimezoneOffset(),s=Math.abs(Math.floor(r/60)),i=Math.abs(r%60),a=`${r<=0?"+":"-"}${String(s).padStart(2,"0")}:${String(i).padStart(2,"0")}`;return o+a},D=()=>({id:window.uuidv4?window.uuidv4():"00000000-0000-0000-0000-000000000000",state:"New",orderNumber:"736362",orderName:"Bedroom & bathroom 01",orderDescription:"Lorem ipsum dolor sit amet...",project:"Single family house Müller John",personInCharge:"Joe",orderDate:y(),deliveryDatePlanned:y(new Date(Date.now()+336*60*60*1e3)),addresses:[{type:"Delivery, Billing",street:"Musterstraße",houseNumber:"1",postalCode:"12345",city:"Musterstadt",country:"Deutschland"}],customerName:"Müller & Co.",customerNumber:"462642",createdAt:y(),changedAt:y(),changedBy:"Selfish",items:[]}),q=async(n,e)=>{const t=await n.getPlanOverview(),o={},r=t.objects.reduce((i,a)=>(a.catalogItemId&&(o[a.catalogItemId]||(o[a.catalogItemId]=0,i.push(a.catalogItemId)),o[a.catalogItemId]++),i),[]),s=(Array.isArray(r)&&r.length>0?await n.getRapiAccess().getItems(r):[]).filter(i=>i.manufacturerSKU!==void 0?(i.count=o[i.id],!0):!1);if(Array.isArray(s)&&s.length>0){e.items||(e.items=[]);let i=e.items.reduce((a,l)=>l.items?.length?a+l.items.length:a,0);s.forEach(a=>{const l={};l.type="Position",l.name=(++i).toString(),l.articleNumber=a.manufacturerSKU,l.articleName=a.label,l.catalog=a.catalog,l.quantity=a.count,l.height=a.displayedHeight,l.width=a.displayedWidth,l.depth=a.displayedDepth,l.color=a.basecolor,l.procurementType="PTO",l.additionalData=[],a.perspectiveImage&&l.additionalData.push({category:"ArticleImage",downloadUri:a.perspectiveImage,type:"Image"}),e.items.push(l)})}};class k{constructor(e,t){this._roomlePlanner=e,this._glueLogic=t}async placeOrder(){const e=await this._glueLogic.savePlanSnapshot();if(!e){console.error("Could not save plan snapshot before placing order");return}const t=this._glueLogic.hiCallbacks;let o=await this._glueLogic.getGroupDataForOrder(e.id),r=D();r.items.push(o);const s=await t?.onFetchPrice(r);s?(r=s.orderData,o=r.items[0]):(r.items.push(o),await q(this._roomlePlanner,o)),Array.isArray(o.additionalData)||(o.additionalData=[]),e.perspectiveImageLink&&o.additionalData.push({type:"Image",category:"OverviewImage",downloadUri:e.perspectiveImageLink}),e.topImageLink&&o.additionalData.push({type:"Image",category:"AboveImage",downloadUri:e.topImageLink}),e.room3dLink&&o.additionalData.push({type:"ThreeD",category:"ThreeDModel",downloadUri:e.room3dLink}),await t?.onPlaceOrder(r)}async fetchPrice(e){let t=await this._glueLogic.getGroupDataForOrder(e),o=D();return o.items.push(t),this._glueLogic.hiCallbacks?.onFetchPrice(o)}}class U{constructor(e,t){this._glueLogic=e,this._hiCallbacks=t}get hiCallbacks(){return this._hiCallbacks}get hiObjectSelection(){return this._glueLogic.hiObjectSelection}_logRequest(e,...t){let o=e;t&&t.forEach(r=>{o+=" "+r}),this._hiCallbacks.onLogMessage?.("HI REQUEST",o)}isLibraryLoaded(e){return this._glueLogic.isLibraryLoaded(e)}getLibraryData(e){return this._glueLogic.getLibraryData(e)}addLibrary(e){this._logRequest("addLibrary",e.libraryId),this._glueLogic.addLibrary(e)}setPosDataForLoading(e){this._logRequest("setPosDataForLoading",e?"set":"null"),this._glueLogic.setPosDataForLoading(e)}loadPosData(e,t){this._logRequest("loadPosData",t),this._glueLogic.loadPosData(e,t)}mergeGroups(e,t,o){this._logRequest("mergeGroups",e.groupId,JSON.stringify(t),o),this._glueLogic.mergeGroups(e,t,o)}deleteRootModule(e,t,o){this._logRequest("deleteRootModule",JSON.stringify(e),t,JSON.stringify(o)),this._glueLogic.deleteRootModule(e,t,o)}splitRootModuleFromGroup(e,t){this._logRequest("splitRootModuleFromGroup",JSON.stringify(e),JSON.stringify(t)),this._glueLogic.splitRootModuleFromGroup(e,t)}duplicateGroup(e){this._logRequest("duplicateGroup",e.groupId),this._glueLogic.duplicateGroup(e)}modifyAttribute(e,t,o,r){this._logRequest("modifyAttribute",e,JSON.stringify(t),o,r),this._glueLogic.modifyAttribute(e,t,o,r)}updateAttribute(e,t,o,r){this._logRequest("updateAttribute",e,t,o,r.toString()),this._glueLogic.updateAttribute(e,t,o,r)}getVerifiedAttributeOptions(e,t){return this._logRequest("getVerifiedAttributeOptions",e,t?JSON.stringify(t):"[]"),this._glueLogic.getVerifiedAttributeOptions(e,t)}updateAdditionalInfo(e,t){this._logRequest("updateAdditionalInfo",e,t),this._glueLogic.updateAdditionalInfo(e,t)}findValidSubArticles(e){return this._logRequest("findValidSubArticles",Array.isArray(e)?JSON.stringify(e):e),this._glueLogic.findValidSubArticles(e)}getValidContainerModulesForSubArticle(e,t){return this._logRequest("getValidContainerModulesForSubArticle",Array.isArray(e)?JSON.stringify(e):e,t),this._glueLogic.getValidContainerModulesForSubArticle(e,t)}addSubArticle(e,t,o){this._logRequest("addSubArticle",e,t,o),this._glueLogic.addSubArticle(e,t,o)}swapRootModule(e,t,o){this._logRequest("swapRootModule",e,t,o),this._glueLogic.swapRootModule(e,t,o)}arrangeRootModulesOfGroup(e){this._logRequest("arrangeRootModulesOfGroup",JSON.stringify(e)),this._glueLogic.arrangeRootModulesOfGroup(e)}changedGroupPlanningSituation(e){this._logRequest("changedGroupPlanningSituation",e.groupId),this._glueLogic.changedGroupPlanningSituation(e)}changedGroupFromHistory(e,t){this._logRequest("changedGroupFromHistory",e.id,t.toString()),this._glueLogic.changedGroupFromHistory(e,t)}loadedGroup(e){this._logRequest("loadedGroup",e.id),this._glueLogic.loadedGroup(e)}groupsCompletelyLoaded(){this._logRequest("groupsCompletelyLoaded"),this._glueLogic.groupsCompletelyLoaded()}removedGroup(e){this._logRequest("removedGroup",e),this._glueLogic.removedGroup(e)}openCloseGroup(e){this._logRequest("openCloseGroup",e),this._glueLogic.openCloseGroup(e)}getSaveDataGroups(){return this._logRequest("getSaveDataGroups"),this._glueLogic.getSaveDataGroups()}async newPosDataFromId(e){return this._logRequest("newPosDataFromId",e),this._glueLogic.newPosDataFromId(e)}async newPosDataFromGroup(e){return this._logRequest("newPosDataFromId",JSON.stringify(e)),this._glueLogic.newPosDataFromGroup(e)}getGroupDataForOrder(e){return this._logRequest("getGroupDataForOrder",e),this._glueLogic.getGroupDataForOrder(e)}savePlanSnapshot(){return this._logRequest("savePlanSnapshot"),this._glueLogic.savePlanSnapshot()}}class J{constructor(e,t){this._roomDesignerRequests=e,this._hiCallbacks=t}_logResponse(e,...t){let o=e;t&&t.forEach(r=>{o+=" "+r}),this._hiCallbacks.onLogMessage?.("HI RESPONSE",o)}loadMasterData(e){this._logResponse("loadMasterData"),this._roomDesignerRequests.loadMasterData(e)}async loadPosGroups(e,t){const o=Array.isArray(e)?e.map(r=>r.id).join(","):e.id;return this._logResponse("loadPosGroups",o,t.newAction?.toString()??"false",t.findFreeSpaceInPlan?.toString()??"false",t.correctArrangement?.toString()??"false",t.moduleIdMap?JSON.stringify(t.moduleIdMap):"[]",t.mergedGroups?JSON.stringify(t.mergedGroups):"[]",t.respondWithPositionInPlan?.toString()??"false"),this._roomDesignerRequests.loadPosGroups(e,t)}async selectGroup(e){return this._logResponse("selectGroup",e),this._roomDesignerRequests.selectGroup(e)}async selectRoot(e){return this._logResponse("selectRoot",e),this._roomDesignerRequests.selectRoot(e)}async selectModule(e,t){return this._logResponse("selectModule",e,t),this._roomDesignerRequests.selectModule(e,t)}openCloseGroup(e,t,o,r){return this._logResponse("openCloseGroup",e,t,o.toString(),r.toString()),this._roomDesignerRequests.openCloseGroup(e,t,o,r),Promise.resolve()}deleteGroup(e){return this._logResponse("deleteGroup",e),this._roomDesignerRequests.deleteGroup(e)}deleteRootModule(e){return this._logResponse("deleteRootModule",e),this._roomDesignerRequests.deleteRootModule(e)}getPosDataOfAllGroups(){return this._logResponse("getPosDataOfAllGroups"),this._roomDesignerRequests.getPosDataOfAllGroups()}getRoomInformation(){return this._logResponse("getRoomInformation"),this._roomDesignerRequests.getRoomInformation()}generatePlanSnapshot(){this._logResponse("generatePlanSnapshot");const e=this._roomDesignerRequests.generatePlanSnapshot();return e.then(t=>{this._hiCallbacks.onLogMessage?.("Group ID",t.objectId),this._hiCallbacks.onLogMessage?.("Plan ID",t.planId)}),e}saveExternalObjectSnapshot(){return this._logResponse("saveExternalObjectSnapshot"),this._roomDesignerRequests.saveExternalObjectSnapshot()}saveCurrentPlanSnapshot(){return this._logResponse("saveCurrentPlanSnapshot"),this._roomDesignerRequests.saveCurrentPlanSnapshot()}}console.warn("Homag Intelligence plugin is loaded.");class j extends R{constructor(){super(),this._roomlePlanner=null,this._api=null,this._glueLogic=null,this._orders=null,window.uuidv4||(window.uuidv4=T)}async init(e,t,o){if(this._roomlePlanner=e,this._roomlePlanner.setHomagIntelligence(this),this._api=new O(this._roomlePlanner),t?.debugLogging){const s=new J(this._api,o),i=new G(s,o);this._glueLogic=new U(i,o)}else this._glueLogic=new G(this._api,o);N(this._roomlePlanner,this._glueLogic);const r=await o.onGetSavedPosGroupData()??null;return this._glueLogic.setPosDataForLoading(r),this._orders=new k(e,this._glueLogic),this}async loadLibrary(e){if(!this._glueLogic)throw new Error("GlueLogic not initialized");const t=await this._loadLibraryData(e);this._glueLogic.addLibrary(t)}async loadCatalog(e,t,o){if(!this._glueLogic)throw new Error("GlueLogic not initialized");o?.setEmulator(this._glueLogic),this._glueLogic.loadPosData(await t,e)}async _loadLibraryData(e){if(this._glueLogic.isLibraryLoaded(e))return this._glueLogic.getLibraryData(e);const t=this._glueLogic.hiCallbacks,{masterData:o,libraryExports:r}=await this._requestHiLibrary(e,t);return this._loadMasterData(o),{libraryId:e,masterData:o,posGroupVersion:1,calculateGroup:s=>r.calc(s),getOrderData:(s,i)=>r.getOrderData(s,i),getAttributesDropDownValues:async(s,i)=>{const a=i?Array.isArray(i)?i:[i]:s.attributes.map(u=>u.id),l={};for(const u of a)try{const d=r.getAttributesDropDownValues(s,u);l[u]=d}catch(d){console.error(d),l[u]=[]}return l},solveModuleAttributeConflict:(s,i,a)=>r.solveModuleAttributeConflict?r.solveModuleAttributeConflict(s,i,a):void 0,getValidSubArticles(s,i,a){return r.getValidSubArticles?r.getValidSubArticles(s,i,a):[]},getValidContainerModulesForSubArticle(s,i,a){return r.getValidContainerModulesForSubArticle?r.getValidContainerModulesForSubArticle(s,i,a):[]},addSubArticle(s,i,a,l){return r.addSubArticle?r.addSubArticle(s,i,a,l):s}}}async _requestHiLibrary(e,t){if(!this._glueLogic)throw new Error("GlueLogic not initialized");const[o,r]=await Promise.all([t.onLoadMasterData(e),t.onLoadJavascript(e)]),s=await this._initCalcScript(r);return{masterData:o,libraryExports:s}}_loadMasterData(e){if(!this._api)throw new Error("API not initialized");return this._api.loadMasterData(e)}async _initCalcScript(e){try{window.exports={};const t=new Blob([e],{type:"text/javascript"}),o=URL.createObjectURL(t);return await import(o),URL.revokeObjectURL(o),window.exports}catch(t){throw console.error(t),new Error("Failed to load calc.js!")}}getGlueLogic(){return this._glueLogic}async placeOrder(){await this._orders.placeOrder()}async fetchPrice(e){return this._orders.fetchPrice(e)}}export{j as HomagIntelligence};
