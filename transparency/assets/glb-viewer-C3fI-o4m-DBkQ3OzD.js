import{Ai as e,An as t,Di as n,Dt as r,Er as i,G as a,Ii as o,Ki as s,Nr as c,O as l,Qn as u,Sa as d,Un as f,Vi as p,Vr as m,Wr as h,fa as g,fi as _,hn as v,ht as y,in as b,it as x,ka as S,mr as C,qn as w,ra as T,sa as E,tn as D,tt as O,vi as k,vt as A,xn as j,yr as M}from"./index-SBcZ5nhW.js";import{t as N}from"./script-loader-qSelToN3-DM6Xat45.js";var P=class extends j{},F=[new w(`script-loader`,N),new w(`glb-input-manager`,P,x.CONTEXT),new w(`logger`,h),new w(`rapi-access`,o)],I=class extends O{constructor(){super(...arguments),this.shouldIgnoreStandardBehavior=!1}adjust(e,t,n,a,o){this._boundingBox=new i(new D(-e.x/2,0,-e.z/2),new D(e.x/2,e.y,e.z/2));let s=new M(-Math.PI/2+a,n,0,`ZYX`),c=new r().setFromEuler(s);this._camera.updateProjectionMatrix(),this._camera.quaternion.copy(c),this._camera.position.copy(t)}_update(e){this.shouldIgnoreStandardBehavior?this._saveYawAndPitch():super._update(e)}animateCamera(e){return this.shouldIgnoreStandardBehavior?!0:super.animateCamera(e)}},L=class extends l{constructor(e,t){super(e,t),this._params={ambientLight:{color:`#ffffff`}},this._ambientLight=new A(new C(this._params.ambientLight.color),.5),this.addToScene()}addToScene(){this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=t();if(e&&this._ambientLight){let t=e.addFolder(`Ambient Light`);t.add(this._ambientLight,`visible`),t.add(this._ambientLight,`intensity`).min(0).max(5).step(.1),t.addColor(this._params.ambientLight,`color`).onChange(e=>{this._ambientLight.color=new C(e)})}}},R=Object.defineProperty,z=(e,t,n,r)=>{for(var i=void 0,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(t,n,i)||i);return i&&R(t,n,i),i},B=class extends E{constructor(e,t){super(e,t,p.GLB,S.CAMERA_3D),this._itemsCount=0,this._standardSceneBackgroundColor=this._scene.background,this._initData.legacyLight&&!this._initData.featureFlags.webGpu&&(this._renderer.capabilities.maxTextures>8?this.loadDynamicLightSetting(c.createDynamicLightSettingSource(null,d.CAMERA)):(console.warn(`this device has a maximum of 8 texture units thus we are using a simpler light setting`),this._lightSetting=new L(this._scene)))}createCameraControl(e,t){this._changeCameraBehaviour(new g(new I(this._creator_,this._getInputManager(),null),this._cameraBehaviourState))}_getInputManager(){return this._glbInputManager}async loadStaticItem(e,t){let r=await this._rapiAccess.getItem(e);if(r.configuration)return Promise.reject();let i=n(r);return i?this.loadGLB(i,!0,void 0,t):Promise.reject(Error(`GLB Url not detected`))}loadGLB(e,t=!0,n=new D(1,1,1),r){return this.clearScene(),new Promise((a,o)=>{this._loadGLB(e,new D(0,0,0),0,void 0,n,void 0,void 0,r).then(e=>{this._currentGLB=e,this._scene.add(this._currentGLB);let n=new i().setFromObject(this._currentGLB);t&&this.cameraBehaviour.cameraControl instanceof I&&this.glbViewerCameraBehaviour.updateCameraOnItemLoaded(n),this._updateBounds(n,null,!0),this._readyForRender(),a()},o)})}preparePerspectiveImage(e,t,n){return new Promise(r=>{t||=1e3,n||=1e3,e||(e=new y({antialias:!0}),e.setSize(t,n),e.outputColorSpace=`srgb`,e.autoClear=!1,e.shadowMap.enabled=!0,e.shadowMap.type=0);let i=this.cameraBehaviour.cameraControl.getCamera().clone();i instanceof f&&(i.aspect=t/n,i.updateProjectionMatrix()),this._lightSetting?.removeFromScene();let a=new T(this._scene);e.render(this._scene,i);let o=e.domElement.toDataURL();e.domElement.toBlob(e=>{r({image:o,width:t,height:n,blob:e})},`image/png`),a.removeFromScene(),this._lightSetting?.addToScene()})}adjustCamera(e,t,n,r){if(this.cameraBehaviour.cameraControl instanceof I){let a=new i().setFromObject(this._scene).getSize(new D);this.cameraBehaviour.cameraControl.adjust(a,e,t,n,r),this._requestRender()}}onStart(e){this._itemsCount=e,this._scene.background=null,this.cameraBehaviour.cameraControl instanceof I&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!0),console.log(`start processing `+e+` items`)}onElementFinished(e){console.log(`processed `+e+` of `+this._itemsCount+` items (`+Math.round(100/this._itemsCount*e)+`%)`)}onFinished(e){this._scene.background=this._standardSceneBackgroundColor,this.cameraBehaviour.cameraControl instanceof I&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!1)}clearScene(){this._currentGLB&&=(this._scene.remove(this._currentGLB),a(this._currentGLB),null),super.clearScene()}enableHD(){super.enableHD()}sceneChanged(){}getBounds(){return this._currentGLB?new i().setFromObject(this._currentGLB):null}get glbViewerCameraBehaviour(){return this.cameraBehaviour}getGeometryBounds(){return null}cameraBehaviourChanged(){super.cameraBehaviourChanged(),this.cameraBehaviour.cameraControl.addEventListener(_.ZOOM_IN,()=>{this._requestRender()},this),this.cameraBehaviour.cameraControl.addEventListener(_.ZOOM_OUT,()=>{this._requestRender()},this)}async moveCamera(e){return this.glbViewerCameraBehaviour.externalApiMoveCamera(e)}_readyForRender(){console.log(`ready_for_render`),this._globalCallback.onReadyForRender()}};z([s],B.prototype,`_glbInputManager`),z([s],B.prototype,`_rapiAccess`);var V=class{constructor(e,t,n){this._prefix=`https://furniture.roomle.com/3d/glb/`,this._listeners=new Set,this._finishedItems=0,this._sceneManager=e,this._renderer=new y({antialias:!0,alpha:!0}),this._width=t,this._height=n,this._renderer.setSize(t,n),this._renderer.setClearColor(16777215,0),this._renderer.outputColorSpace=k}addListener(e){this._listeners.add(e)}removeListener(e){this._listeners.delete(e)}start(e){return this._entries=[],e.forEach(e=>{this._entries.push(this._transform(e))}),this._finishedItems=0,this._listeners.forEach(e=>e.onStart(this._entries.length)),this._zip=new window.JSZip,this._doNextEntry(),new Promise(e=>{this._resolve=e})}_transform(e){return{name:e.path.replace(`.glb`,`.png`),url:this._prefix+e.path,position:new D(e.camera.position.x,e.camera.position.z,-e.camera.position.y),fov:e.camera.fieldOfView*2,yaw:e.camera.rotation.z,pitch:e.camera.rotation.x}}_doNextEntry(){this._entries.length===0?(this._listeners.forEach(e=>e.onFinished(this._zip)),this._resolve(this._zip)):this._processEntry(this._entries[0])}_processEntry(e){this._sceneManager.loadGLB(e.url,!1,void 0).then(()=>{this._sceneManager.adjustCamera(e.position,e.yaw,e.pitch,e.fov),this._sceneManager.preparePerspectiveImage(this._renderer,this._width,this._height).then(t=>{this._entryFinished(e,t)})})}_entryFinished(e,t){let n=this._entries.indexOf(e);n>-1&&this._entries.splice(n,1),this._finishedItems++,this._listeners.forEach(e=>e.onElementFinished(this._finishedItems)),this._zip.file(e.name,t.blob),this._doNextEntry()}},H=``+new URL(`/transparency/assets/jszip.min-CfLB8HDG.js`,``+import.meta.url).href,U=Object.defineProperty,W=(e,t,n,r)=>{for(var i=void 0,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(t,n,i)||i);return i&&U(t,n,i),i},G=class{constructor(e){this._currentIdOrUrl=null,this._creator_=e}setCameraOffset(e){this._sceneManager.setCameraOffset(e)}getCameraOffset(){return this._sceneManager.getCameraOffset()}init(e,t){return this.setOverrides(t),this._domHelper.setDomElement(e),this._sceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):new Promise(this._initPromiseCallback.bind(this))}_initPromiseCallback(e,t){this._sceneManager=new B(this._creator_,{left:0,top:1,right:1,bottom:0}),this._sceneManager.enableHD(),e()}clearScene(){this._sceneManager.clearScene()}loadGLB(e,t=1,n){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadGLB(e,!0,new D(t,t,t),n)}loadStaticItem(e,t){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadStaticItem(e,t)}getCurrentId(){return this._currentIdOrUrl}loadSceneSetting(e){return this._sceneManager.loadSceneSettings(e)}preparePerspectiveImage(){return this._sceneManager.preparePerspectiveImage()}processRenderList(e,t=320,n=320){let r=JSON.parse(e);this._scriptLoader.fetch(H,{id:`jszip-js`}).then(()=>{let e=new V(this._sceneManager,t,n);e.addListener(this._sceneManager),e.start(r.items).then(t=>{t.generateAsync({type:`blob`}).then(t=>{u(`content.zip`,URL.createObjectURL(t)),e.removeListener(this._sceneManager)})})})}setOverrides(e){e&&(this._initData.setOverrides(e),this._globalInitData.setOverrides(e))}updateSize(){this._sceneManager.updateCamera()}getMain(){}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}showGUI(){this._sceneManager.showGUI()}get callbacks(){return{}}getScene(){return this._sceneManager.getScene()}updateScene(){this._sceneManager.updateScene()}getUnitFormatter(){return this._unitFormatter}getStorage(){return this._idbManager}setEnvironmentMap(e){let{url:t,intensity:n,rotation:r,maxLightSources:i}=e;this._sceneManager.setEnvironmentMap(t,n,r,i)}exportCanvasScreenshot(e){return this._sceneManager.exportCanvasScreenshot(e)}async moveCamera(e){return this._sceneManager.moveCamera(e)}get globalCallbacks(){return this._globalCallback}};W([s],G.prototype,`_rapiAccess`),W([s],G.prototype,`_domHelper`),W([s],G.prototype,`_scriptLoader`),W([s],G.prototype,`_lifeCycleManager`),W([s],G.prototype,`_initData`),W([s],G.prototype,`_globalInitData`),W([s],G.prototype,`_globalCallback`),W([s],G.prototype,`_unitFormatter`),W([s],G.prototype,`_idbManager`);var K=class extends m{setupGlobals(){}setupDependencies(){e.setup(F),this.lookup(`logger`,this._context)}cleanUpGlobals(){throw Error(`Method not implemented.`)}cleanUpDependencies(){throw Error(`Method not implemented.`)}async bootFinished(){this._viewer=new G(this._context),window.RoomleGLBViewer||(window.RoomleGLBViewer=this._viewer)}getApi(){return this._viewer}getContextName(){return v.GLB_VIEWER}};export{K as GlbViewer};