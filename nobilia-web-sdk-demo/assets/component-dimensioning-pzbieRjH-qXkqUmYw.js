import{D as B,W as E,C as s,s as R,X as P,a as W,x as k,P as X,b as p,c as z,$ as f,p as $,t as S,F as C,N as q,R as I,d as N,l as m,H}from"./index-BKJoEMmA.js";var U=Object.defineProperty,L=(g,i,e,n)=>{for(var t=void 0,a=g.length-1,o;a>=0;a--)(o=g[a])&&(t=o(i,e,t)||t);return t&&U(i,e,t),t};const u="component_dimensioning_line_material",y="component_dimensioning_plane_material",w="component_dimensioning_text_material",_=.02,V=.025,v=3618615,Y=16777215,j=.05;class h{constructor(i,e,n){this._direction=h._getDirection(i);const t=h._getDefaultLabelDirection(i,this._direction),a=n.dot(t)>=0;this._labelDirection=h._calculateActualLabelDirection(i,a,t),this._origin=h._calculateOrigin(i,e,a)}get direction(){return this._direction}get labelDirection(){return this._labelDirection}getEdge(i,e,n){const t=this._origin.clone().add(this._direction.clone().multiplyScalar(i)).add(this._labelDirection.clone().multiplyScalar(n)),a=this._origin.clone().add(this._direction.clone().multiplyScalar(e)).add(this._labelDirection.clone().multiplyScalar(n));return new N(t,a)}static _getDirection(i){return i.axis?m(i.axis.direction).normalize():i.dimensioning.axis==="x"?new s(1,0,0):i.dimensioning.axis==="y"?new s(0,0,1):new s(0,1,0)}static _getDefaultLabelDirection(i,e){if(i.axis){const n=m(i.axis.labelDirection);return e.clone().cross(n).cross(e).normalize()}else{if(i.dimensioning.axis==="x")return new s(0,1,0);if(i.dimensioning.axis==="y")return new s(-1,0,0)}return new s(-1,0,0)}static _calculateActualLabelDirection(i,e,n){if(e){if(i.axis){if(i.axis.alternativeOrigin)return n.clone().multiplyScalar(-1)}else if(i.dimensioning.axis==="y"||i.dimensioning.axis==="z")return n.clone().multiplyScalar(-1)}return n}static _calculateOrigin(i,e,n){const t=e.getCenter(new s),a=e.getSize(new s);return i.axis?n&&i.axis.alternativeOrigin?m(i.axis.alternativeOrigin):m(i.axis.origin):i.dimensioning.axis==="x"?new s(0,t.y+a.y*.5,t.z-a.z*.5):i.dimensioning.axis==="y"?new s(t.x+a.x*(n?.5:-.5),t.y-a.y*.5,0):new s(t.x+a.x*(n?.5:-.5),0,t.z-a.z*.5)}}class F extends B{constructor(i,e,n,t){super(),this.name=E,this._size=e.getSize(new s),this._relativeCameraDirection=t.clone(),this._dimensioning=R(i.dimensioning),this._axis=new h(i,e,t),this._level=this._dimensioning.maxLevel-this._dimensioning.level,this._font=n,this._init()}clone(){console.warn("Will not clone ComponentDimensioning")}_initMaterials(){this._cacheHolder.materialCache&&(this._cacheHolder.materialCache.has(u)?this._lineMaterial=this._cacheHolder.materialCache.get(u):(this._lineMaterial=new P({color:v}),this._cacheHolder.materialCache.set(u,this._lineMaterial)),this._cacheHolder.materialCache.has(y)?this._planeMaterial=this._cacheHolder.materialCache.get(y):(this._planeMaterial=new W({color:Y,side:k,opacity:.8,transparent:!0}),this._cacheHolder.materialCache.set(y,this._planeMaterial)),this._cacheHolder.materialCache.has(w)?this._textMaterial=this._cacheHolder.materialCache.get(w):(this._textMaterial=new X({color:v}),this._cacheHolder.materialCache.set(w,this._textMaterial)))}_init(){this._initMaterials();const i=new p;this._line=new z(i,this._lineMaterial),this._line.name="component dimension line "+this._dimensioning.axis,this._text=new f(i,this._textMaterial),this._text.name="component dimension text "+this._dimensioning.axis,this._plane=new f(i,this._planeMaterial),this._plane.name="component dimension plane "+this._dimensioning.axis;const e=new p,n=Math.round(Math.max(this._size.y,this._size.x,this._size.z)),t=Math.abs(this._dimensioning.to-this._dimensioning.from);let a=V+(n<4?0:n*.005);t<.3&&(a*=.5+t);const o={font:this._font,size:a,height:.001,curveSegments:2,bevelEnabled:!0,bevelThickness:.001,bevelSize:.001,depth:.001},r=this._dimensioning.label?this._dimensioning.label:this._unitFormatter.formatMMValueToUnitString(t*1e3),c=new $(r,o);c.computeBoundingBox();const b=c.boundingBox.getSize(new s).y,O=j+(3*_+b)*this._level,l=this._axis.getEdge(this._dimensioning.from,this._dimensioning.to,O);this._addEdgeSideLines(b,l,this._axis.labelDirection.clone());const A=[l.start.x,l.start.y,l.start.z,l.end.x,l.end.y,l.end.z];e.setAttribute("position",new S(new Float32Array(A),3)),this._line.geometry.dispose(),this._line.geometry=e,this.add(this._line),this._text.geometry=c;const M=this._axis.direction.clone(),d=this._axis.labelDirection.clone();new s(0,1,0).dot(d)<Math.SQRT1_2&&d.multiplyScalar(-1);const D=M.clone().cross(d);let x=new C().makeBasis(M,d,D);this._relativeCameraDirection.dot(D)>0&&(x=x.multiply(new C().makeRotationY(Math.PI)));const T=new q().setFromRotationMatrix(x);this._addText(l,c,T,this._axis.labelDirection.clone().multiplyScalar(2*_))}_addEdgeSideLines(i,e,n){const t=-(3*_+i)*.5,a=e.start.clone(),o=e.start.clone().add(n.clone().multiplyScalar(t)),r=e.end.clone(),c=e.end.clone().add(n.clone().multiplyScalar(t));this._addLine(o,a),this._addLine(c,r)}_addLine(i,e){const n=new p,t=[i.x,i.y,i.z,e.x,e.y,e.z];n.setAttribute("position",new S(new Float32Array(t),3)),this.add(new z(n,this._lineMaterial))}_addText(i,e,n,t){const a=i.getCenter(new s);a.add(t);const o=e.boundingBox.getSize(new s);e.center(),this._text.position.copy(a),this._text.quaternion.copy(n),this.add(this._text);const r=new I(o.x+_,o.y+_,32);r.center(),this._plane.geometry=r,this._plane.position.copy(a),this._plane.quaternion.copy(n),this.add(this._plane)}}L([H],F.prototype,"_cacheHolder");L([H],F.prototype,"_unitFormatter");export{F as default};
