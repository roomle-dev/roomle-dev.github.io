import{Ji as e,Ot as t,ar as n,mi as r,mr as i}from"./index-SBcZ5nhW.js";var a=class{constructor(e,t=``,n=[],r=[]){this.name=e,this.type=t,this.metadata=n,this.properties=r,this.children=[]}addMetadata(e,t){this.metadata.push({key:e,value:t})}addProperty(e,t=[]){this.properties.push({property:e,metadata:t})}addChild(e){this.children.push(e)}toString(e=0){let t=`	`.repeat(e),n=this.metadata.map(e=>{let n=e.key,r=e.value;if(Array.isArray(r)){let e=[];return e.push(`${n} = {`),r.forEach(n=>{e.push(`${t}		${n}`)}),e.push(`${t}	}`),e.join(`
`)}else return`${n} = ${r}`}),r=n.length?` (
${n.map(e=>`${t}	${e}`).join(`
`)}
${t})`:``,i=this.properties.map(e=>`${t}	${e.property}${e.metadata.length?` (
${e.metadata.map(e=>`${t}		${e}`).join(`
`)}
${t}	)`:``}`),a=this.children.map(t=>t.toString(e+1)),o=[];if(i.length>0&&o.push(...i),a.length>0){i.length>0&&o.push(``);for(let e=0;e<a.length;e++)o.push(a[e]),e<a.length-1&&o.push(``)}let s=o.join(`
`);return`${t}def ${this.type?this.type+` `:``}"${this.name}"${r}
${t}{
${s}
${t}}`}},o=class{constructor(){this.textureUtils=null}setTextureUtils(e){this.textureUtils=e}parse(e,t,n,r){this.parseAsync(e,r).then(t).catch(n)}async parseAsync(t,n={}){n=Object.assign({ar:{anchoring:{type:`plane`},planeAnchoring:{alignment:`horizontal`}},includeAnchoringProperties:!0,onlyVisible:!0,quickLookCompatible:!1,maxTextureSize:1024},n);let i=new Set,o={},s=`model.usda`;o[s]=null;let l=new a(`Root`,`Xform`),f=new a(`Scenes`,`Scope`);f.addMetadata(`kind`,`"sceneLibrary"`),l.addChild(f);let p=`Scene`,m=new a(p,`Xform`);m.addMetadata(`customData`,[`bool preliminary_collidesWithEnvironment = 0`,`string sceneName = "${p}"`]),m.addMetadata(`sceneName`,`"${p}"`),n.includeAnchoringProperties&&(m.addProperty(`token preliminary:anchoring:type = "${n.ar.anchoring.type}"`),m.addProperty(`token preliminary:planeAnchoring:alignment = "${n.ar.planeAnchoring.alignment}"`)),f.addChild(m);let h,g={},_={};d(t,m,g,i,o,n);let v=S(g,_,n.quickLookCompatible);for(let t in h=u()+`
`+l.toString()+`

`+v.toString(),o[s]=e(h),h=null,_){let e=_[t];if(e.isCompressedTexture===!0){if(this.textureUtils===null)throw Error(`THREE.USDZExporter: setTextureUtils() must be called to process compressed textures.`);e=await this.textureUtils.decompress(e)}let r=c(e.image,e.flipY,n.maxTextureSize),i=await new Promise(e=>r.toBlob(e,`image/png`,1));o[`textures/Texture_${t}.png`]=new Uint8Array(await i.arrayBuffer())}let y=0;for(let e in o){let t=o[e],n=34+e.length;y+=n;let r=y&63;if(r!==4){let n=64-r,i=new Uint8Array(n);o[e]=[t,{extra:{12345:i}}]}y=t.length}return r(o,{level:0})}};function s(e,t){let n=e.name;return n=n.replace(/[^A-Za-z0-9_]/g,``),/^[0-9]/.test(n)&&(n=`_`+n),n===``&&(n=e.isCamera?`Camera`:`Object`),t.has(n)&&(n=n+`_`+e.id),t.add(n),n}function c(e,t,n){if(typeof HTMLImageElement<`u`&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<`u`&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<`u`&&e instanceof OffscreenCanvas||typeof ImageBitmap<`u`&&e instanceof ImageBitmap){let r=n/Math.max(e.width,e.height),i=document.createElement(`canvas`);i.width=e.width*Math.min(1,r),i.height=e.height*Math.min(1,r);let a=i.getContext(`2d`);return t===!0&&(a.translate(0,i.height),a.scale(1,-1)),a.drawImage(e,0,0,i.width,i.height),i}else throw Error(`THREE.USDZExporter: No valid image data found. Unable to process texture.`)}var l=7;function u(){return`#usda 1.0
(
	customLayerData = {
		string creator = "Three.js USDZExporter"
	}
	defaultPrim = "Root"
	metersPerUnit = 1
	upAxis = "Y"
)
`}function d(t,n,r,i,a,o){for(let s=0,c=t.children.length;s<c;s++){let c=t.children[s];if(c.visible===!1&&o.onlyVisible===!0)continue;let l;if(c.isMesh){let t=c.geometry,n=c.material;if(n.isMeshStandardMaterial){let o=`geometries/Geometry_`+t.id+`.usda`;if(!(o in a)){let n=g(t);a[o]=e(u()+`
`+n.toString())}n.uuid in r||(r[n.uuid]=n),l=p(c,t,r[n.uuid],i)}else console.warn(`THREE.USDZExporter: Unsupported material type (USDZ only supports MeshStandardMaterial)`,c)}else l=c.isCamera?D(c,i):f(c,i);l&&(n.addChild(l),d(c,l,r,i,a,o))}}function f(e,t){let n=s(e,t),r=m(e.matrix);e.matrix.determinant()<0&&console.warn(`THREE.USDZExporter: USDZ does not support negative scales`,e);let i=new a(n,`Xform`);return i.addProperty(`matrix4d xformOp:transform = ${r}`),i.addProperty(`uniform token[] xformOpOrder = ["xformOp:transform"]`),i}function p(e,t,n,r){let i=f(e,r);return i.addMetadata(`prepend references`,`@./geometries/Geometry_${t.id}.usda@</Geometry>`),i.addMetadata(`prepend apiSchemas`,`["MaterialBindingAPI"]`),i.addProperty(`rel material:binding = </Materials/Material_${n.id}>`),i}function m(e){let t=e.elements;return`( ${h(t,0)}, ${h(t,4)}, ${h(t,8)}, ${h(t,12)} )`}function h(e,t){return`(${e[t+0]}, ${e[t+1]}, ${e[t+2]}, ${e[t+3]})`}function g(e){let t=new a(`Geometry`),n=_(e);return t.addChild(n),t}function _(e){let t=e.attributes,n=t.position.count,r=new a(`Geometry`,`Mesh`);r.addProperty(`int[] faceVertexCounts = [${v(e)}]`),r.addProperty(`int[] faceVertexIndices = [${y(e)}]`),r.addProperty(`normal3f[] normals = [${b(t.normal,n)}]`,[`interpolation = "vertex"`]),r.addProperty(`point3f[] points = [${b(t.position,n)}]`);for(let e=0;e<4;e++){let n=e>0?e:``,i=t[`uv`+n];i!==void 0&&r.addProperty(`texCoord2f[] primvars:st${n} = [${x(i)}]`,[`interpolation = "vertex"`])}let i=t.color;return i!==void 0&&r.addProperty(`color3f[] primvars:displayColor = [${b(i,n)}]`,[`interpolation = "vertex"`]),r.addProperty(`uniform token subdivisionScheme = "none"`),r}function v(e){let t=e.index===null?e.attributes.position.count:e.index.count;return Array(t/3).fill(3).join(`, `)}function y(e){let t=e.index,n=[];if(t!==null)for(let e=0;e<t.count;e++)n.push(t.getX(e));else{let t=e.attributes.position.count;for(let e=0;e<t;e++)n.push(e)}return n.join(`, `)}function b(e,t){if(e===void 0)return console.warn(`USDZExporter: Normals missing.`),Array(t).fill(`(0, 0, 0)`).join(`, `);let n=[];for(let t=0;t<e.count;t++){let r=e.getX(t),i=e.getY(t),a=e.getZ(t);n.push(`(${r.toPrecision(l)}, ${i.toPrecision(l)}, ${a.toPrecision(l)})`)}return n.join(`, `)}function x(e){let t=[];for(let n=0;n<e.count;n++){let r=e.getX(n),i=e.getY(n);t.push(`(${r.toPrecision(l)}, ${1-i.toPrecision(l)})`)}return t.join(`, `)}function S(e,t,n=!1){let r=new a(`Materials`);for(let i in e){let a=e[i];r.addChild(C(a,t,n))}return r}function C(e,t,n=!1){let r=new a(`Material_${e.id}`,`Material`);function o(r,i,o){let s=r.source.id+`_`+r.flipY;t[s]=r;let c=r.channel>0?`st`+r.channel:`st`,u={1e3:`repeat`,1001:`clamp`,1002:`mirror`},d=r.repeat.clone(),f=r.offset.clone(),p=r.rotation,m=Math.sin(p),h=Math.cos(p);f.y=1-f.y-d.y,n?(f.x/=d.x,f.y/=d.y,f.x+=m/d.x,f.y+=h-1):(f.x+=m*d.x,f.y+=(1-h)*d.y);let g=new a(`PrimvarReader_${i}`,`Shader`);g.addProperty(`uniform token info:id = "UsdPrimvarReader_float2"`),g.addProperty(`float2 inputs:fallback = (0.0, 0.0)`),g.addProperty(`token inputs:varname = "${c}"`),g.addProperty(`float2 outputs:result`);let _=new a(`Transform2d_${i}`,`Shader`);_.addProperty(`uniform token info:id = "UsdTransform2d"`),_.addProperty(`token inputs:in.connect = </Materials/Material_${e.id}/PrimvarReader_${i}.outputs:result>`),_.addProperty(`float inputs:rotation = ${(p*(180/Math.PI)).toFixed(l)}`),_.addProperty(`float2 inputs:scale = ${E(d)}`),_.addProperty(`float2 inputs:translation = ${E(f)}`),_.addProperty(`float2 outputs:result`);let v=new a(`Texture_${r.id}_${i}`,`Shader`);return v.addProperty(`uniform token info:id = "UsdUVTexture"`),v.addProperty(`asset inputs:file = @textures/Texture_${s}.png@`),v.addProperty(`float2 inputs:st.connect = </Materials/Material_${e.id}/Transform2d_${i}.outputs:result>`),o!==void 0&&v.addProperty(`float4 inputs:scale = ${T(o)}`),v.addProperty(`token inputs:sourceColorSpace = "${r.colorSpace===``?`raw`:`sRGB`}"`),v.addProperty(`token inputs:wrapS = "${u[r.wrapS]}"`),v.addProperty(`token inputs:wrapT = "${u[r.wrapT]}"`),v.addProperty(`float outputs:r`),v.addProperty(`float outputs:g`),v.addProperty(`float outputs:b`),v.addProperty(`float3 outputs:rgb`),(e.transparent||e.alphaTest>0)&&v.addProperty(`float outputs:a`),[g,_,v]}e.side===2&&console.warn(`THREE.USDZExporter: USDZ does not support double sided materials`,e);let s=new a(`PreviewSurface`,`Shader`);if(s.addProperty(`uniform token info:id = "UsdPreviewSurface"`),e.map===null?s.addProperty(`color3f inputs:diffuseColor = ${w(e.color)}`):(s.addProperty(`color3f inputs:diffuseColor.connect = </Materials/Material_${e.id}/Texture_${e.map.id}_diffuse.outputs:rgb>`),e.transparent?s.addProperty(`float inputs:opacity.connect = </Materials/Material_${e.id}/Texture_${e.map.id}_diffuse.outputs:a>`):e.alphaTest>0&&(s.addProperty(`float inputs:opacity.connect = </Materials/Material_${e.id}/Texture_${e.map.id}_diffuse.outputs:a>`),s.addProperty(`float inputs:opacityThreshold = ${e.alphaTest}`)),o(e.map,`diffuse`,e.color).forEach(e=>r.addChild(e))),e.emissiveMap!==null){s.addProperty(`color3f inputs:emissiveColor.connect = </Materials/Material_${e.id}/Texture_${e.emissiveMap.id}_emissive.outputs:rgb>`);let t=new i(e.emissive.r*e.emissiveIntensity,e.emissive.g*e.emissiveIntensity,e.emissive.b*e.emissiveIntensity);o(e.emissiveMap,`emissive`,t).forEach(e=>r.addChild(e))}else e.emissive.getHex()>0&&s.addProperty(`color3f inputs:emissiveColor = ${w(e.emissive)}`);if(e.normalMap!==null&&(s.addProperty(`normal3f inputs:normal.connect = </Materials/Material_${e.id}/Texture_${e.normalMap.id}_normal.outputs:rgb>`),o(e.normalMap,`normal`).forEach(e=>r.addChild(e))),e.aoMap!==null){s.addProperty(`float inputs:occlusion.connect = </Materials/Material_${e.id}/Texture_${e.aoMap.id}_occlusion.outputs:r>`);let t=new i(e.aoMapIntensity,e.aoMapIntensity,e.aoMapIntensity);o(e.aoMap,`occlusion`,t).forEach(e=>r.addChild(e))}if(e.roughnessMap!==null){s.addProperty(`float inputs:roughness.connect = </Materials/Material_${e.id}/Texture_${e.roughnessMap.id}_roughness.outputs:g>`);let t=new i(e.roughness,e.roughness,e.roughness);o(e.roughnessMap,`roughness`,t).forEach(e=>r.addChild(e))}else s.addProperty(`float inputs:roughness = ${e.roughness}`);if(e.metalnessMap!==null){s.addProperty(`float inputs:metallic.connect = </Materials/Material_${e.id}/Texture_${e.metalnessMap.id}_metallic.outputs:b>`);let t=new i(e.metalness,e.metalness,e.metalness);o(e.metalnessMap,`metallic`,t).forEach(e=>r.addChild(e))}else s.addProperty(`float inputs:metallic = ${e.metalness}`);if(e.alphaMap===null?s.addProperty(`float inputs:opacity = ${e.opacity}`):(s.addProperty(`float inputs:opacity.connect = </Materials/Material_${e.id}/Texture_${e.alphaMap.id}_opacity.outputs:r>`),s.addProperty(`float inputs:opacityThreshold = 0.0001`),o(e.alphaMap,`opacity`).forEach(e=>r.addChild(e))),e.isMeshPhysicalMaterial){if(e.clearcoatMap!==null){s.addProperty(`float inputs:clearcoat.connect = </Materials/Material_${e.id}/Texture_${e.clearcoatMap.id}_clearcoat.outputs:r>`);let t=new i(e.clearcoat,e.clearcoat,e.clearcoat);o(e.clearcoatMap,`clearcoat`,t).forEach(e=>r.addChild(e))}else s.addProperty(`float inputs:clearcoat = ${e.clearcoat}`);if(e.clearcoatRoughnessMap!==null){s.addProperty(`float inputs:clearcoatRoughness.connect = </Materials/Material_${e.id}/Texture_${e.clearcoatRoughnessMap.id}_clearcoatRoughness.outputs:g>`);let t=new i(e.clearcoatRoughness,e.clearcoatRoughness,e.clearcoatRoughness);o(e.clearcoatRoughnessMap,`clearcoatRoughness`,t).forEach(e=>r.addChild(e))}else s.addProperty(`float inputs:clearcoatRoughness = ${e.clearcoatRoughness}`);s.addProperty(`float inputs:ior = ${e.ior}`)}return s.addProperty(`int inputs:useSpecularWorkflow = 0`),s.addProperty(`token outputs:surface`),r.addChild(s),r.addProperty(`token outputs:surface.connect = </Materials/Material_${e.id}/PreviewSurface.outputs:surface>`),r}function w(e){return`(${e.r}, ${e.g}, ${e.b})`}function T(e){return`(${e.r}, ${e.g}, ${e.b}, 1.0)`}function E(e){return`(${e.x}, ${e.y})`}function D(e,t){let n=s(e,t),r=m(e.matrix);e.matrix.determinant()<0&&console.warn(`THREE.USDZExporter: USDZ does not support negative scales`,e);let i=new a(n,`Camera`);i.addProperty(`matrix4d xformOp:transform = ${r}`),i.addProperty(`uniform token[] xformOpOrder = ["xformOp:transform"]`);let o=e.isOrthographicCamera?`orthographic`:`perspective`;i.addProperty(`token projection = "${o}"`);let c=`(${e.near.toPrecision(l)}, ${e.far.toPrecision(l)})`;i.addProperty(`float2 clippingRange = ${c}`);let u;u=e.isOrthographicCamera?((Math.abs(e.left)+Math.abs(e.right))*10).toPrecision(l):e.getFilmWidth().toPrecision(l),i.addProperty(`float horizontalAperture = ${u}`);let d;if(d=e.isOrthographicCamera?((Math.abs(e.top)+Math.abs(e.bottom))*10).toPrecision(l):e.getFilmHeight().toPrecision(l),i.addProperty(`float verticalAperture = ${d}`),e.isPerspectiveCamera){let t=e.getFocalLength().toPrecision(l);i.addProperty(`float focalLength = ${t}`);let n=e.focus.toPrecision(l);i.addProperty(`float focusDistance = ${n}`)}return i}export{o as USDZExporter};