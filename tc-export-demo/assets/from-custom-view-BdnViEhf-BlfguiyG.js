var w=Object.defineProperty;var C=(a,t,e)=>t in a?w(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var i=(a,t,e)=>C(a,typeof t!="symbol"?t+"":t,e);import{X as D,O as B,r as v,E as y,f as X,m as Y,Y as I}from"./touch-drag-DXJTOrk5-B8mmbwSu.js";import{f as M,e as U,d as l}from"./drag-in-DuufO5eB-1XMqa0D_.js";import"./index-BwWVlgHv.js";const L=a=>`[data-rml-custom-view="${a}"]`,u=a=>{a.preventDefault(),a.stopPropagation()},O=(a,t,e,r)=>{const s=e-a,n=r-t;return Math.sqrt(s*s+n*n)};class x{constructor({onCustomDragStart:t},e={}){i(this,"_startX",0);i(this,"_startY",0);i(this,"_lastX",0);i(this,"_lastY",0);i(this,"_epsilon");i(this,"_isWaiting",!1);i(this,"_onCustomDragStart");this._epsilon=typeof e.epsilon=="number"?e.epsilon:y,this._onCustomDragStart=t}onMove(t){this._lastX=t.clientX,this._lastY=t.clientY,this._isWaiting&&O(this._startX,this._startY,this._lastX,this._lastY)>this._epsilon&&(this._onCustomDragStart(t),this._isWaiting=!1)}onStart(t){this._startX=t.clientX,this._startY=t.clientY,this.onMove(t),this._isWaiting=!0}onEnd(){this._reset()}_reset(){this._startX=0,this._startY=0,this._lastX=0,this._lastY=0,this._isWaiting=!1}}const c="data-rml-old-draggable",A=void 0,b=(a,t)=>{const e=v(a),r={delay:e?Y:I,epsilon:e?X:y};if(!t)return r;if(!e&&!(a instanceof MouseEvent))return console.warn("Unsupported event! It is not TouchEvent and also not MouseEvent"),r;const{delayKey:s,epsilonKey:n}=e?{delayKey:"touchDragDelay",epsilonKey:"touchDragEpsilon"}:{delayKey:"customDragDelay",epsilonKey:"customDragEpsilon"};return typeof t[s]=="number"&&(r.delay=t.touchDragDelay),typeof t[n]=="number"&&(r.epsilon=t.touchDragEpsilon),r},K=a=>{let t="",e=U,r=M;if(!a)return{url:l,width:e,height:r};const s=a;if(s instanceof HTMLElement){const n=s.getBoundingClientRect(),o=s.getAttribute("data-rml-ghost-url"),h=s.getAttribute("data-rml-ghost-width"),g=s.getAttribute("data-rml-ghost-height");o?t=o:!o&&s instanceof HTMLImageElement&&s.src&&(t=s.src),t?(e=n.width,r=n.height):t=l,e=h?parseInt(h,10):e,r=g?parseInt(g,10):r}return{url:t||l,width:e,height:r}};class G{constructor(t,e,r){i(this,"_options",{});i(this,"_instance");i(this,"_mainDomElement");i(this,"_viewName");i(this,"_currentCustomDrag",null);i(this,"_currentBb",null);i(this,"_startTarget",null);i(this,"_onBeforeUpdateDrag",()=>({}));i(this,"isDragging",!1);var s;this._instance=t,this._options=e||{},this._viewName=r,this._mainDomElement=mainDomElement,(s=this._mainDomElement.parentElement)==null||s.addEventListener("dragleave",()=>{this._instance.cancelDragIn()})}beforeUpdateGhost(t){this._onBeforeUpdateDrag=t}async _dragStart(t,e,r="rml_id"){this._startTarget&&(this._startTarget.style.pointerEvents="none",this._startTarget.style.userSelect="none",this._startTarget.setAttribute(c,this._startTarget.draggable.toString()),this._startTarget.draggable=!1,this._startTarget.removeEventListener("dragstart",u),this._startTarget.addEventListener("dragstart",u)),this._currentBb=await this._instance.getBoundingClientRect(L(this._viewName));const{clientX:s,clientY:n}=D(e),o=this._currentBb.x+s,h=this._currentBb.y+n;this.isDragging=!0,this._instance.dragInObject(t,o,h,r)}_dragUpdate(t){if(document.body.focus(),this._currentCustomDrag&&this._currentCustomDrag.onMove(t),!this._currentBb||!this.isDragging)return;const{clientX:e,clientY:r}=D(t),{url:s,width:n,height:o}=K(this._startTarget),h=this._currentBb.x+e,g=this._currentBb.y+r,_=this._options||{},d={ghost:{visibleIn:{x:this._currentBb.x-(_.dragInOverlapX||0),y:this._currentBb.y+(_.dragInOverlapY||0),width:this._currentBb.width+(_.dragInOverlapX||0),height:this._currentBb.height+(_.dragInOverlapY||0)},url:s,width:n,height:o},mode:"custom-view"},{x:m,y:p,options:E}=this._onBeforeUpdateDrag(h,g,d),f=typeof m=="number"?m:h,T=typeof p=="number"?p:g,S=E||d;this._instance.updateDrag(f,T,S)}_dragEnd(){this._currentCustomDrag&&this._currentCustomDrag.onEnd(),this._currentCustomDrag=null,this.isDragging=!1,this._currentBb=null,this._resetStartTarget(),this._instance.enableEvents(),this._instance.dragInObjectEnd()}dragStart(t,e,r){this._instance.disableEvents(),this._startTarget=e.target;const s=(n,o)=>{this._dragStart(t,o,r)};this._currentCustomDrag=v(e)?new B(A,{onTouchDragStart:s},b(e,this._options)):new x({onCustomDragStart:n=>this._dragStart(t,n,r)},b(e,this._options)),this._currentCustomDrag.onStart(e)}dragEnd(){this._dragEnd()}dragUpdate(t){this._dragUpdate(t)}touchStart(t,e,r="rml_id"){this.dragStart(t,e,r)}touchMove(t){this.dragUpdate(t)}touchEnd(){this.dragEnd()}dispose(){}_resetStartTarget(){this._startTarget&&(this._startTarget.style.pointerEvents="",this._startTarget.style.userSelect="",this._startTarget.draggable=this._startTarget.getAttribute(c)==="true",this._startTarget.removeAttribute(c),this._startTarget.removeEventListener("dragstart",u))}releaseInput(t){this._currentCustomDrag&&this._currentCustomDrag.onEnd(),this._resetStartTarget()}}export{G as DragInFromCustomViewStrategy};
