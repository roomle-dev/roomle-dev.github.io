import{H as B,m as y,v as u,B as L,J as M,s as I,p as x,S as d,d as E,a as G,x as O,r as F,l as j,y as P,b as U,c as D,f as R,g as p,U as b,n as f,h as k,$ as z,Z as A,V,i as w,j as N,N as T,k as v,q as H,Q as Z,t as $,u as q,z as o}from"./index-3eT8XdN2.js";import{_ as J}from"./script-loader-CQpf5Bmb-G9jVBCYI.js";class Q extends G{}const X=[new u("script-loader",J),new u("glb-input-manager",Q,M.CONTEXT),new u("logger",I),new u("rapi-access",x)];class _ extends Z{constructor(){super(...arguments),this.shouldIgnoreStandardBehavior=!1}adjust(e,t,r,s,a){let i=new d(-e.x/2,0,-e.z/2),l=new d(e.x/2,e.y,e.z/2);this._boundingBox=new p(i,l);let m=new q(-Math.PI/2+s,r,0,"ZYX"),S=new $().setFromEuler(m);this._camera.updateProjectionMatrix(),this._camera.quaternion.copy(S),this._camera.position.copy(t)}_update(e){this.shouldIgnoreStandardBehavior?this._saveYawAndPitch():super._update(e)}animateCamera(e){return this.shouldIgnoreStandardBehavior?!0:super.animateCamera(e)}}class W extends N{constructor(e,t){super(e,t),this._params={ambientLight:{color:"#ffffff"}},this._ambientLight=new T(new v(this._params.ambientLight.color),.5),this.addToScene()}addToScene(){this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=H();if(e&&this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(r=>{this._ambientLight.color=new v(r)})}}}var Y=Object.defineProperty,C=(n,e,t,r)=>{for(var s=void 0,a=n.length-1,i;a>=0;a--)(i=n[a])&&(s=i(e,t,s)||s);return s&&Y(e,t,s),s};class g extends O{constructor(e,t){super(e,t,F.GLB,j.CAMERA_3D),this._itemsCount=0,this._standardSceneBackgroundColor=this._scene.background,this._initData.legacyLight&&!this._initData.featureFlags.webGpu&&(this._renderer.capabilities.maxTextures>8?this.loadDynamicLightSetting(P.createDynamicLightSettingSource(null,U.CAMERA)):(console.warn("this device has a maximum of 8 texture units thus we are using a simpler light setting"),this._lightSetting=new W(this._scene)))}createCameraControl(e,t){this._changeCameraBehaviour(new D(new _(this._creator_,this._getInputManager(),null),this._cameraBehaviourState))}_getInputManager(){return this._glbInputManager}async loadStaticItem(e,t){const r=await this._rapiAccess.getItem(e);if(r.configuration)return Promise.reject();const s=R(r);return s?this.loadGLB(s,!0,void 0,t):Promise.reject(new Error("GLB Url not detected"))}loadGLB(e,t=!0,r=new d(1,1,1),s){return this.clearScene(),new Promise((a,i)=>{this._loadGLB(e,new d(0,0,0),0,void 0,r,void 0,void 0,s).then(l=>{this._currentGLB=l,this._scene.add(this._currentGLB);let m=new p().setFromObject(this._currentGLB);t&&this.cameraBehaviour.cameraControl instanceof _&&this.glbViewerCameraBehaviour.updateCameraOnItemLoaded(m),this._updateBounds(m,null,!0),this._readyForRender(),a()},i)})}preparePerspectiveImage(e,t,r){return new Promise(s=>{t||(t=1e3),r||(r=1e3),e||(e=new b({antialias:!0}),e.setSize(t,r),e.outputColorSpace=f,e.autoClear=!1,e.shadowMap.enabled=!0,e.shadowMap.type=k);let a=this.cameraBehaviour.cameraControl.getCamera().clone();a instanceof z&&(a.aspect=t/r,a.updateProjectionMatrix()),this._lightSetting?.removeFromScene();let i=new A(this._scene);e.render(this._scene,a);let l=e.domElement.toDataURL();e.domElement.toBlob(m=>{s({image:l,width:t,height:r,blob:m})},"image/png"),i.removeFromScene(),this._lightSetting?.addToScene()})}adjustCamera(e,t,r,s){if(this.cameraBehaviour.cameraControl instanceof _){let a=new p().setFromObject(this._scene).getSize(new d);this.cameraBehaviour.cameraControl.adjust(a,e,t,r,s),this._requestRender()}}onStart(e){this._itemsCount=e,this._scene.background=null,this.cameraBehaviour.cameraControl instanceof _&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!0),console.log("start processing "+e+" items")}onElementFinished(e){console.log("processed "+e+" of "+this._itemsCount+" items ("+Math.round(100/this._itemsCount*e)+"%)")}onFinished(e){this._scene.background=this._standardSceneBackgroundColor,this.cameraBehaviour.cameraControl instanceof _&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!1)}clearScene(){this._currentGLB&&(this._scene.remove(this._currentGLB),V(this._currentGLB),this._currentGLB=null),super.clearScene()}enableHD(){super.enableHD()}sceneChanged(){}getBounds(){return this._currentGLB?new p().setFromObject(this._currentGLB):null}get glbViewerCameraBehaviour(){return this.cameraBehaviour}getGeometryBounds(){return null}cameraBehaviourChanged(){super.cameraBehaviourChanged(),this.cameraBehaviour.cameraControl.addEventListener(w.ZOOM_IN,()=>{this._requestRender()},this),this.cameraBehaviour.cameraControl.addEventListener(w.ZOOM_OUT,()=>{this._requestRender()},this)}async moveCamera(e){return this.glbViewerCameraBehaviour.externalApiMoveCamera(e)}_readyForRender(){console.log("ready_for_render"),this._globalCallback.onReadyForRender()}}C([o],g.prototype,"_glbInputManager");C([o],g.prototype,"_rapiAccess");class K{constructor(e,t,r){this._prefix="https://furniture.roomle.com/3d/glb/",this._listeners=new Set,this._finishedItems=0,this._sceneManager=e,this._renderer=new b({antialias:!0,alpha:!0}),this._width=t,this._height=r,this._renderer.setSize(t,r),this._renderer.setClearColor(16777215,0),this._renderer.outputColorSpace=f}addListener(e){this._listeners.add(e)}removeListener(e){this._listeners.delete(e)}start(e){return this._entries=[],e.forEach(t=>{this._entries.push(this._transform(t))}),this._finishedItems=0,this._listeners.forEach(t=>t.onStart(this._entries.length)),this._zip=new window.JSZip,this._doNextEntry(),new Promise(t=>{this._resolve=t})}_transform(e){return{name:e.path.replace(".glb",".png"),url:this._prefix+e.path,position:new d(e.camera.position.x,e.camera.position.z,-e.camera.position.y),fov:e.camera.fieldOfView*2,yaw:e.camera.rotation.z,pitch:e.camera.rotation.x}}_doNextEntry(){this._entries.length===0?(this._listeners.forEach(e=>e.onFinished(this._zip)),this._resolve(this._zip)):this._processEntry(this._entries[0])}_processEntry(e){this._sceneManager.loadGLB(e.url,!1,void 0).then(()=>{this._sceneManager.adjustCamera(e.position,e.yaw,e.pitch,e.fov),this._sceneManager.preparePerspectiveImage(this._renderer,this._width,this._height).then(t=>{this._entryFinished(e,t)})})}_entryFinished(e,t){let r=this._entries.indexOf(e);r>-1&&this._entries.splice(r,1),this._finishedItems++,this._listeners.forEach(s=>s.onElementFinished(this._finishedItems)),this._zip.file(e.name,t.blob),this._doNextEntry()}}const ee=""+new URL("/transparency/assets/jszip.min-CfLB8HDG.js",import.meta.url).href;var te=Object.defineProperty,c=(n,e,t,r)=>{for(var s=void 0,a=n.length-1,i;a>=0;a--)(i=n[a])&&(s=i(e,t,s)||s);return s&&te(e,t,s),s};class h{constructor(e){this._currentIdOrUrl=null,this._creator_=e}setCameraOffset(e){this._sceneManager.setCameraOffset(e)}getCameraOffset(){return this._sceneManager.getCameraOffset()}init(e,t){return this.setOverrides(t),this._domHelper.setDomElement(e),this._sceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):new Promise(this._initPromiseCallback.bind(this))}_initPromiseCallback(e,t){this._sceneManager=new g(this._creator_,{left:0,top:1,right:1,bottom:0}),this._sceneManager.enableHD(),e()}clearScene(){this._sceneManager.clearScene()}loadGLB(e,t=1,r){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadGLB(e,!0,new d(t,t,t),r)}loadStaticItem(e,t){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadStaticItem(e,t)}getCurrentId(){return this._currentIdOrUrl}loadSceneSetting(e){return this._sceneManager.loadSceneSettings(e)}preparePerspectiveImage(){return this._sceneManager.preparePerspectiveImage()}processRenderList(e,t=320,r=320){const s=JSON.parse(e);this._scriptLoader.fetch(ee,{id:"jszip-js"}).then(()=>{const a=new K(this._sceneManager,t,r);a.addListener(this._sceneManager),a.start(s.items).then(i=>{i.generateAsync({type:"blob"}).then(l=>{E("content.zip",URL.createObjectURL(l)),a.removeListener(this._sceneManager)})})})}setOverrides(e){e&&(this._initData.setOverrides(e),this._globalInitData.setOverrides(e))}updateSize(){this._sceneManager.updateCamera()}getMain(){}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}showGUI(){this._sceneManager.showGUI()}get callbacks(){return{}}getScene(){return this._sceneManager.getScene()}updateScene(){this._sceneManager.updateScene()}getUnitFormatter(){return this._unitFormatter}getStorage(){return this._idbManager}setEnvironmentMap(e){const{url:t,intensity:r,rotation:s,maxLightSources:a}=e;this._sceneManager.setEnvironmentMap(t,r,s,a)}exportCanvasScreenshot(e){return this._sceneManager.exportCanvasScreenshot(e)}async moveCamera(e){return this._sceneManager.moveCamera(e)}get globalCallbacks(){return this._globalCallback}}c([o],h.prototype,"_rapiAccess");c([o],h.prototype,"_domHelper");c([o],h.prototype,"_scriptLoader");c([o],h.prototype,"_lifeCycleManager");c([o],h.prototype,"_initData");c([o],h.prototype,"_globalInitData");c([o],h.prototype,"_globalCallback");c([o],h.prototype,"_unitFormatter");c([o],h.prototype,"_idbManager");class ae extends B{setupGlobals(){}setupDependencies(){y.setup(X),this.lookup("logger",this._context)}cleanUpGlobals(){throw new Error("Method not implemented.")}cleanUpDependencies(){throw new Error("Method not implemented.")}async bootFinished(){this._viewer=new h(this._context),window.RoomleGLBViewer||(window.RoomleGLBViewer=this._viewer)}getApi(){return this._viewer}getContextName(){return L.GLB_VIEWER}}export{ae as GlbViewer};
