import{cO as B,cP as L,cQ as u,cU as M,d0 as y,cV as I,cW as x,S as d,n as E,d9 as G,da as O,db as F,dc as P,dd as U,de as j,df as D,dg as R,d7 as p,dh as b,cD as f,di as k,dj as z,dk as A,dl as V,dm as w,dn as T,dp as N,cs as v,dq as H,cX as q,N as X,dr as Z,a as o}from"./index-Dis_VqaA.js";import{_ as J}from"./script-loader-qSelToN3-CuOGFJmv.js";class W extends G{}const Q=[new u("script-loader",J),new u("glb-input-manager",W,y.CONTEXT),new u("logger",I),new u("rapi-access",x)];class m extends q{constructor(){super(...arguments),this.shouldIgnoreStandardBehavior=!1}adjust(e,t,r,a,s){let i=new d(-e.x/2,0,-e.z/2),l=new d(e.x/2,e.y,e.z/2);this._boundingBox=new p(i,l);let _=new Z(-Math.PI/2+a,r,0,"ZYX"),S=new X().setFromEuler(_);this._camera.updateProjectionMatrix(),this._camera.quaternion.copy(S),this._camera.position.copy(t)}_update(e){this.shouldIgnoreStandardBehavior?this._saveYawAndPitch():super._update(e)}animateCamera(e){return this.shouldIgnoreStandardBehavior?!0:super.animateCamera(e)}}class Y extends T{constructor(e,t){super(e,t),this._params={ambientLight:{color:"#ffffff"}},this._ambientLight=new N(new v(this._params.ambientLight.color),.5),this.addToScene()}addToScene(){this._scene.add(this._ambientLight)}removeFromScene(){this._scene.remove(this._ambientLight)}reload(){this.removeFromScene(),this.addToScene()}showGUI(){let e=H();if(e&&this._ambientLight){let t=e.addFolder("Ambient Light");t.add(this._ambientLight,"visible"),t.add(this._ambientLight,"intensity").min(0).max(5).step(.1),t.addColor(this._params.ambientLight,"color").onChange(r=>{this._ambientLight.color=new v(r)})}}}var $=Object.defineProperty,C=(n,e,t,r)=>{for(var a=void 0,s=n.length-1,i;s>=0;s--)(i=n[s])&&(a=i(e,t,a)||a);return a&&$(e,t,a),a};class g extends O{constructor(e,t){super(e,t,F.GLB,P.CAMERA_3D),this._itemsCount=0,this._standardSceneBackgroundColor=this._scene.background,this._initData.legacyLight&&!this._initData.featureFlags.webGpu&&(this._renderer.capabilities.maxTextures>8?this.loadDynamicLightSetting(U.createDynamicLightSettingSource(null,j.CAMERA)):(console.warn("this device has a maximum of 8 texture units thus we are using a simpler light setting"),this._lightSetting=new Y(this._scene)))}createCameraControl(e,t){this._changeCameraBehaviour(new D(new m(this._creator_,this._getInputManager(),null),this._cameraBehaviourState))}_getInputManager(){return this._glbInputManager}async loadStaticItem(e,t){const r=await this._rapiAccess.getItem(e);if(r.configuration)return Promise.reject();const a=R(r);return a?this.loadGLB(a,!0,void 0,t):Promise.reject(new Error("GLB Url not detected"))}loadGLB(e,t=!0,r=new d(1,1,1),a){return this.clearScene(),new Promise((s,i)=>{this._loadGLB(e,new d(0,0,0),0,void 0,r,void 0,void 0,a).then(l=>{this._currentGLB=l,this._scene.add(this._currentGLB);let _=new p().setFromObject(this._currentGLB);t&&this.cameraBehaviour.cameraControl instanceof m&&this.glbViewerCameraBehaviour.updateCameraOnItemLoaded(_),this._updateBounds(_,null,!0),this._readyForRender(),s()},i)})}preparePerspectiveImage(e,t,r){return new Promise(a=>{t||(t=1e3),r||(r=1e3),e||(e=new b({antialias:!0}),e.setSize(t,r),e.outputColorSpace=f,e.autoClear=!1,e.shadowMap.enabled=!0,e.shadowMap.type=k);let s=this.cameraBehaviour.cameraControl.getCamera().clone();s instanceof z&&(s.aspect=t/r,s.updateProjectionMatrix()),this._lightSetting?.removeFromScene();let i=new A(this._scene);e.render(this._scene,s);let l=e.domElement.toDataURL();e.domElement.toBlob(_=>{a({image:l,width:t,height:r,blob:_})},"image/png"),i.removeFromScene(),this._lightSetting?.addToScene()})}adjustCamera(e,t,r,a){if(this.cameraBehaviour.cameraControl instanceof m){let s=new p().setFromObject(this._scene).getSize(new d);this.cameraBehaviour.cameraControl.adjust(s,e,t,r,a),this._requestRender()}}onStart(e){this._itemsCount=e,this._scene.background=null,this.cameraBehaviour.cameraControl instanceof m&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!0),console.log("start processing "+e+" items")}onElementFinished(e){console.log("processed "+e+" of "+this._itemsCount+" items ("+Math.round(100/this._itemsCount*e)+"%)")}onFinished(e){this._scene.background=this._standardSceneBackgroundColor,this.cameraBehaviour.cameraControl instanceof m&&(this.cameraBehaviour.cameraControl.shouldIgnoreStandardBehavior=!1)}clearScene(){this._currentGLB&&(this._scene.remove(this._currentGLB),V(this._currentGLB),this._currentGLB=null),super.clearScene()}enableHD(){super.enableHD()}sceneChanged(){}getBounds(){return this._currentGLB?new p().setFromObject(this._currentGLB):null}get glbViewerCameraBehaviour(){return this.cameraBehaviour}getGeometryBounds(){return null}cameraBehaviourChanged(){super.cameraBehaviourChanged(),this.cameraBehaviour.cameraControl.addEventListener(w.ZOOM_IN,()=>{this._requestRender()},this),this.cameraBehaviour.cameraControl.addEventListener(w.ZOOM_OUT,()=>{this._requestRender()},this)}async moveCamera(e){return this.glbViewerCameraBehaviour.externalApiMoveCamera(e)}_readyForRender(){console.log("ready_for_render"),this._globalCallback.onReadyForRender()}}C([o],g.prototype,"_glbInputManager");C([o],g.prototype,"_rapiAccess");class K{constructor(e,t,r){this._prefix="https://furniture.roomle.com/3d/glb/",this._listeners=new Set,this._finishedItems=0,this._sceneManager=e,this._renderer=new b({antialias:!0,alpha:!0}),this._width=t,this._height=r,this._renderer.setSize(t,r),this._renderer.setClearColor(16777215,0),this._renderer.outputColorSpace=f}addListener(e){this._listeners.add(e)}removeListener(e){this._listeners.delete(e)}start(e){return this._entries=[],e.forEach(t=>{this._entries.push(this._transform(t))}),this._finishedItems=0,this._listeners.forEach(t=>t.onStart(this._entries.length)),this._zip=new window.JSZip,this._doNextEntry(),new Promise(t=>{this._resolve=t})}_transform(e){return{name:e.path.replace(".glb",".png"),url:this._prefix+e.path,position:new d(e.camera.position.x,e.camera.position.z,-e.camera.position.y),fov:e.camera.fieldOfView*2,yaw:e.camera.rotation.z,pitch:e.camera.rotation.x}}_doNextEntry(){this._entries.length===0?(this._listeners.forEach(e=>e.onFinished(this._zip)),this._resolve(this._zip)):this._processEntry(this._entries[0])}_processEntry(e){this._sceneManager.loadGLB(e.url,!1,void 0).then(()=>{this._sceneManager.adjustCamera(e.position,e.yaw,e.pitch,e.fov),this._sceneManager.preparePerspectiveImage(this._renderer,this._width,this._height).then(t=>{this._entryFinished(e,t)})})}_entryFinished(e,t){let r=this._entries.indexOf(e);r>-1&&this._entries.splice(r,1),this._finishedItems++,this._listeners.forEach(a=>a.onElementFinished(this._finishedItems)),this._zip.file(e.name,t.blob),this._doNextEntry()}}const ee=""+new URL("/nobilia-web-sdk-demo/assets/jszip.min-CfLB8HDG.js",import.meta.url).href;var te=Object.defineProperty,c=(n,e,t,r)=>{for(var a=void 0,s=n.length-1,i;s>=0;s--)(i=n[s])&&(a=i(e,t,a)||a);return a&&te(e,t,a),a};class h{constructor(e){this._currentIdOrUrl=null,this._creator_=e}setCameraOffset(e){this._sceneManager.setCameraOffset(e)}getCameraOffset(){return this._sceneManager.getCameraOffset()}init(e,t){return this.setOverrides(t),this._domHelper.setDomElement(e),this._sceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):new Promise(this._initPromiseCallback.bind(this))}_initPromiseCallback(e,t){this._sceneManager=new g(this._creator_,{left:0,top:1,right:1,bottom:0}),this._sceneManager.enableHD(),e()}clearScene(){this._sceneManager.clearScene()}loadGLB(e,t=1,r){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadGLB(e,!0,new d(t,t,t),r)}loadStaticItem(e,t){return this._currentIdOrUrl=e,this._rapiAccess.trackView(e),this._sceneManager.loadStaticItem(e,t)}getCurrentId(){return this._currentIdOrUrl}loadSceneSetting(e){return this._sceneManager.loadSceneSettings(e)}preparePerspectiveImage(){return this._sceneManager.preparePerspectiveImage()}processRenderList(e,t=320,r=320){const a=JSON.parse(e);this._scriptLoader.fetch(ee,{id:"jszip-js"}).then(()=>{const s=new K(this._sceneManager,t,r);s.addListener(this._sceneManager),s.start(a.items).then(i=>{i.generateAsync({type:"blob"}).then(l=>{E("content.zip",URL.createObjectURL(l)),s.removeListener(this._sceneManager)})})})}setOverrides(e){e&&(this._initData.setOverrides(e),this._globalInitData.setOverrides(e))}updateSize(){this._sceneManager.updateCamera()}getMain(){}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}showGUI(){this._sceneManager.showGUI()}get callbacks(){return{}}getScene(){return this._sceneManager.getScene()}updateScene(){this._sceneManager.updateScene()}getUnitFormatter(){return this._unitFormatter}getStorage(){return this._idbManager}setEnvironmentMap(e){const{url:t,intensity:r,rotation:a,maxLightSources:s}=e;this._sceneManager.setEnvironmentMap(t,r,a,s)}exportCanvasScreenshot(e){return this._sceneManager.exportCanvasScreenshot(e)}async moveCamera(e){return this._sceneManager.moveCamera(e)}get globalCallbacks(){return this._globalCallback}}c([o],h.prototype,"_rapiAccess");c([o],h.prototype,"_domHelper");c([o],h.prototype,"_scriptLoader");c([o],h.prototype,"_lifeCycleManager");c([o],h.prototype,"_initData");c([o],h.prototype,"_globalInitData");c([o],h.prototype,"_globalCallback");c([o],h.prototype,"_unitFormatter");c([o],h.prototype,"_idbManager");class se extends B{setupGlobals(){}setupDependencies(){L.setup(Q),this.lookup("logger",this._context)}cleanUpGlobals(){throw new Error("Method not implemented.")}cleanUpDependencies(){throw new Error("Method not implemented.")}async bootFinished(){this._viewer=new h(this._context),window.RoomleGLBViewer||(window.RoomleGLBViewer=this._viewer)}getApi(){return this._viewer}getContextName(){return M.GLB_VIEWER}}export{se as GlbViewer};
