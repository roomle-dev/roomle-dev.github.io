import{Ai as e,An as t,C as n,Er as r,Gi as i,Ii as a,K as o,Ki as s,Kt as c,Ln as l,Mr as u,Nr as d,Pt as f,Qt as p,Rr as m,Rt as h,Sa as g,Vi as _,Vr as v,Wr as y,Xi as b,ar as x,di as S,dt as C,hn as w,it as T,ka as E,ki as D,mr as O,ni as k,or as A,qn as j,qt as M,sa as N,tt as P,wi as F,wn as I,xn as L}from"./index-ByVIxf7c.js";import{t as R}from"./script-loader-qSelToN3-Djv7G19p.js";var z=class extends C{get cameraControl(){return this._cameraControl}},B=Object.defineProperty,V=(e,t,n,r)=>{for(var i=void 0,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(t,n,i)||i);return i&&B(t,n,i),i},H={x:1,y:1,z:1},U=class extends N{constructor(e,t){super(e,t,_.RMV,E.CAMERA_3D),this._sceneParams={type:`cube`},this._materialParams={color:`#ffffff`,metallic:.5,alpha:0,alphaCutoff:0,doubleSided:!1},this._initializeRendererSettings(),this._initScene()}_initializeRendererSettings(){if(!this._renderer){setTimeout(()=>this._initializeRendererSettings(),0);return}(I(this._renderer)?this._renderer.capabilities.maxTextures:16)>8&&this.loadDynamicLightSetting(d.createDynamicLightSettingSource(null,g.CAMERA))}_initScene(){let e=new o(H.x,H.y,H.z,100,100,100),t=F.createMeshPhysicalMaterial({color:this._initData.colors.PRIMARY});this._setMaterial(t),this._mesh=new h(e,this._material),this._mesh.castShadow=!0,this._mesh.position.setY(H.y/2),this._scene.add(this._mesh);let{initialFloorMaterial:n}=this._initData;if(n?this.changeFloorMaterialById(n):this._environment=new u(this._scene,null,new O(16777215)),this.cameraBehaviour.cameraControl instanceof P){let e=new r;e.setFromObject(this._mesh),console.trace(`reset camera`),this.cameraBehaviour.cameraControl.updateAndReset(e)}this.showGUI()}loadMaterialId(e){return new Promise(t=>{this._configuratorMeshGenerator.loadMaterial(e,H.x*1e3,H.y*1e3).then(e=>{this._setMaterial(e),this._mesh.material=this._material,this._updateGUI(),this._requestRender(),t()})})}loadMaterial(e){return new Promise(t=>{e.__rapi_path__||=`materials`,this._mesh.material=this._material,this._configuratorMeshGenerator.loadTextures(e,this._material,H.x*100,H.y*100).then(()=>{this._updateGUI(),this._requestRender()}),t()})}loadMaterialShading(e){return new Promise(t=>{let n={shading:e};this._setMaterial(i(this._material,n)),this._mesh.material=this._material,this._updateGUI(),this._requestRender(),t()})}resetMaterial(){this._initScene()}_setMaterial(e){this._material=e,this._materialParams.alpha=e.opacity,this._materialParams.alphaCutoff=e.alphaTest,this._materialParams.color=`#`+e.color.getHexString(),this._materialParams.doubleSided=e.side===2,this._materialParams.metallic=e.metalness===1?1:e.reflectivity}getMaterialShading(e=1){return b(this._material,e)}createCameraControl(e,t){this._changeCameraBehaviour(new z(new P(this._creator_,this._getInputManager(),null),this._cameraBehaviourState))}_getInputManager(){return this._inputManager}sceneChanged(){}getBounds(){return this._mesh?new r().setFromObject(this._mesh):null}getGeometryBounds(){return null}_guiLoaded(){this._updateGUI()}_updateGUI(){let e=t();e&&(this._guiGeometryFolder||(this._guiGeometryFolder=e.addFolder(`Geometry`),this._guiGeometryFolder.add(this._sceneParams,`type`,{Cube:`cube`,Sphere:`sphere`,PlaneVertical:`plane_vertical`,PlaneHorizontal:`plane_horizontal`}).onChange(e=>{console.log(e),this._setGeometry()})),this._material&&(this._guiMaterialFolder&&e.removeFolder(this._guiMaterialFolder),this._guiMaterialFolder=e.addFolder(`Material`),this._guiMaterialFolder.addColor(this._materialParams,`color`).onChange(e=>{this._material.color=new O(e),this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,`metallic`).min(0).max(1).step(.01).onChange(e=>{this._material.metalness=e===1?1:.5,this._material.reflectivity=e||.5,this._shadingChanged()}),this._guiMaterialFolder.add(this._material,`roughness`).min(0).max(1).step(.01).onChange(e=>{this._shadingChanged()}),this._guiMaterialFolder.add(this._material,`transmission`).min(0).max(1).step(.01).onChange(e=>{this._material.transmission=e,e>0&&(this._material.opacity=1,this._material.alphaTest=.5,this._material.depthWrite=!1,this._material.transparent=!0,this._material.metalness=0),this._mesh.castShadow=!this._material.transparent,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,`alpha`).min(0).max(1).step(.01).onChange(e=>{this._material.transparent=e<1,this._material.opacity=e,this._material.depthWrite=e>=1,this._mesh.castShadow=!this._material.transparent,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,`alphaCutoff`).min(0).max(1).step(.01).onChange(e=>{e?this._material.alphaTest=e:this._material.alphaTest=0,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,`doubleSided`).onChange(e=>{e?this._material.side=2:this._material.side=0,this._shadingChanged()})),this._addGUIListener(e))}_shadingChanged(){this._roomleMaterialViewerUiCallback.onMaterialShadingChanged(b(this._material))}setGeometry(e){this._sceneParams.type=e,this._setGeometry()}_setGeometry(){let e;this._sceneParams.type===`cube`&&(e=new o(H.x,H.y,H.z,100,100,100)),this._sceneParams.type===`sphere`&&(e=new k(.5,100,100)),this._sceneParams.type===`plane_horizontal`&&(e=new S(H.x,H.z),e.rotateX(-Math.PI/2)),this._sceneParams.type===`plane_vertical`&&(e=new S(H.x,H.z)),this._mesh.geometry=e,this._renderEverything()}async changeFloorMaterialById(e){let t=await this._rapiAccess.getMaterial(e);return(!this._environment||!(this._environment instanceof M))&&(this._environment=new M(this._scene,this._environment,!0)),new Promise((e,n)=>{this._environment.changeFloorMaterial(t,this._maxAnisotropy).then(()=>{this._requestRender(),e()},n)})}async addTexture(e,t){let n=H.x*100,r=H.y*100,i=n/(e.mmWidth===0?1:e.mmWidth),a=r/(e.mmHeight===0?1:e.mmHeight),o=I(this._renderer)?this._renderer.capabilities.maxTextures:16;if(t){let n=new Image;n.src=t;let r=new D;r.image=n,n.onload=function(){r.needsUpdate=!0},m(r,e,this._material,this._maxAnisotropy,i,a,o)}else await c(e.image,e,this._material,this._maxAnisotropy,i,a,o);this._requestRender()}removeTexture(e){e.mapping===f.ORM&&(this._material.aoMap=null,this._material.roughnessMap=null,this._material.metalnessMap=null),(e.mapping===f.RGB||e.mapping===f.RGBA)&&(this._material.map=null),e.mapping===f.XYZ&&(this._material.normalMap=null),this._material.needsUpdate=!0,this._requestRender()}clearCache(){this._configuratorMeshGenerator.clear()}};V([s],U.prototype,`_inputManager`),V([s],U.prototype,`_configuratorMeshGenerator`),V([s],U.prototype,`_roomleMaterialViewerUiCallback`),V([s],U.prototype,`_rapiAccess`);var W=Object.defineProperty,G=(e,t,n,r)=>{for(var i=void 0,a=e.length-1,o;a>=0;a--)(o=e[a])&&(i=o(t,n,i)||i);return i&&W(t,n,i),i},K=class{constructor(e){this._creator_=e}setCameraOffset(e){this._sceneManager.setCameraOffset(e)}getCameraOffset(){return this._sceneManager.getCameraOffset()}init(e){return this._domHelper.setDomElement(e),this._sceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):new Promise(this._initPromiseCallback.bind(this))}_initPromiseCallback(e,t){this._sceneManager=new U(this._creator_,{left:0,top:1,right:1,bottom:0}),this._sceneManager.enableHD(),e()}get callbacks(){return this._roomleMaterialViewerUiCallback}set callbacks(e){this._roomleMaterialViewerUiCallback=e}loadMaterialShading(e){return this._sceneManager.loadMaterialShading(e)}resetMaterial(){this._sceneManager.resetMaterial()}loadMaterial(e,t={}){return t.flushCache&&this._clearCaches(),this._sceneManager.loadMaterial(e)}loadMaterialId(e,t={}){return t.flushCache&&this._clearCaches(),this._sceneManager.loadMaterialId(e)}getMaterialShading(e=1){return this._sceneManager.getMaterialShading(e)}loadSceneSetting(e){return this._sceneManager.loadSceneSettings(e)}setOverrides(e){e&&this._initData.setOverrides(e)}updateSize(){this._sceneManager.updateCamera()}getMain(){}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}showGUI(){this._sceneManager.showGUI()}async changeFloorMaterialById(e){return this._sceneManager.changeFloorMaterialById(e)}setGeometry(e){this._sceneManager.setGeometry(e)}async addTexture(e,t){return this._sceneManager.addTexture(e,t)}removeTexture(e){return this._sceneManager.removeTexture(e)}_clearCaches(){this._rapiAccess.cleanUp(),this._sceneManager.clearCache()}getScene(){return this._sceneManager.getScene()}updateScene(){this._sceneManager.updateScene()}getUnitFormatter(){return this._unitFormatter}getStorage(){return this._idbManager}setEnvironmentMap(e){let{url:t,intensity:n,rotation:r,maxLightSources:i}=e;this._sceneManager.setEnvironmentMap(t,n,r,i)}get globalCallbacks(){return this._globalCallback}};G([s],K.prototype,`_domHelper`),G([s],K.prototype,`_scriptLoader`),G([s],K.prototype,`_lifeCycleManager`),G([s],K.prototype,`_roomleMaterialViewerUiCallback`),G([s],K.prototype,`_initData`),G([s],K.prototype,`_globalCallback`),G([s],K.prototype,`_rapiAccess`),G([s],K.prototype,`_unitFormatter`),G([s],K.prototype,`_idbManager`);var q=class extends n{constructor(e){super(e),this.onMaterialShadingChanged=e=>{}}},J=[new j(`script-loader`,R),new j(`logger`,y),new j(`input-manager`,L,T.CONTEXT),new j(`configurator-mesh-generator`,A),new j(`rapi-access`,a),new j(`roomle-material-viewer-ui-callback`,q,T.CONTEXT)],Y=class extends v{setupGlobals(){}setupDependencies(){e.setup(J),this.lookup(`logger`,this._context)}cleanUpGlobals(){throw Error(`Method not implemented.`)}cleanUpDependencies(){throw Error(`Method not implemented.`)}async bootFinished(){this._viewer=new K(this._context),window.RoomleMaterialViewer||(window.RoomleMaterialViewer=this._viewer)}getApi(){return this._viewer}getContextName(){return w.MATERIAL_VIEWER}};export{Y as MaterialViewer};