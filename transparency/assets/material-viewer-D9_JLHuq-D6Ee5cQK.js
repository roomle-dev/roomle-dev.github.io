import{i as I,p as R,_ as m,U as T,b as U,W as A,d as y,B as O,r as k,D as B,v as D,s as E,l as z,F as C,Y as w,g as V,y as H,G as f,I as L,P as W,K as q,x as b,J as x,k as S,O as X,R as v,T as P,X as Y,V as j,$ as J,a0 as F,a1 as G,a2 as N,a3 as Q,a4 as $,a5 as d,a6 as K,A as s}from"./index-CBKByVQi.js";import{_ as Z}from"./script-loader-qSelToN3-Cbe2HZWk.js";class ee extends K{get cameraControl(){return this._cameraControl}}var te=Object.defineProperty,g=(l,e,t,r)=>{for(var a=void 0,n=l.length-1,_;n>=0;n--)(_=l[n])&&(a=_(e,t,a)||a);return a&&te(e,t,a),a};const i={x:1,y:1,z:1};class c extends D{constructor(e,t){super(e,t,E.RMV,z.CAMERA_3D),this._sceneParams={type:"cube"},this._materialParams={color:"#ffffff",metallic:.5,alpha:0,alphaCutoff:0,doubleSided:!1},this._initializeRendererSettings(),this._initScene()}_initializeRendererSettings(){if(!this._renderer){setTimeout(()=>this._initializeRendererSettings(),0);return}(C(this._renderer)?this._renderer.capabilities.maxTextures:w)>8&&this.loadDynamicLightSetting(V.createDynamicLightSettingSource(null,H.CAMERA))}_initScene(){const e=new f(i.x,i.y,i.z,100,100,100),t=L.createMeshPhysicalMaterial({color:this._initData.colors.PRIMARY});this._setMaterial(t),this._mesh=new W(e,this._material),this._mesh.castShadow=!0,this._mesh.position.setY(i.y/2),this._scene.add(this._mesh);const{initialFloorMaterial:r}=this._initData;if(r?this.changeFloorMaterialById(r):this._environment=new q(this._scene,null,new b(16777215)),this.cameraBehaviour.cameraControl instanceof x){const a=new S;a.setFromObject(this._mesh),console.trace("reset camera"),this.cameraBehaviour.cameraControl.updateAndReset(a)}this.showGUI()}loadMaterialId(e){return new Promise(t=>{this._configuratorMeshGenerator.loadMaterial(e,i.x*1e3,i.y*1e3).then(r=>{this._setMaterial(r),this._mesh.material=this._material,this._updateGUI(),this._requestRender(),t()})})}loadMaterial(e){return new Promise(t=>{e.__rapi_path__||(e.__rapi_path__="materials"),this._mesh.material=this._material,this._configuratorMeshGenerator.loadTextures(e,this._material,i.x*100,i.y*100).then(()=>{this._updateGUI(),this._requestRender()}),t()})}loadMaterialShading(e){return new Promise(t=>{let r={shading:e};this._setMaterial(X(this._material,r)),this._mesh.material=this._material,this._updateGUI(),this._requestRender(),t()})}resetMaterial(){this._initScene()}_setMaterial(e){this._material=e,this._materialParams.alpha=e.opacity,this._materialParams.alphaCutoff=e.alphaTest,this._materialParams.color="#"+e.color.getHexString(),this._materialParams.doubleSided=e.side===v,this._materialParams.metallic=e.metalness===1?1:e.reflectivity}getMaterialShading(e=1){return P(this._material,e)}createCameraControl(e,t){this._changeCameraBehaviour(new ee(new x(this._creator_,this._getInputManager(),null),this._cameraBehaviourState))}_getInputManager(){return this._inputManager}sceneChanged(){}getBounds(){return this._mesh?new S().setFromObject(this._mesh):null}getGeometryBounds(){return null}_guiLoaded(){this._updateGUI()}_updateGUI(){let e=Y();e&&(this._guiGeometryFolder||(this._guiGeometryFolder=e.addFolder("Geometry"),this._guiGeometryFolder.add(this._sceneParams,"type",{Cube:"cube",Sphere:"sphere",PlaneVertical:"plane_vertical",PlaneHorizontal:"plane_horizontal"}).onChange(t=>{console.log(t),this._setGeometry()})),this._material&&(this._guiMaterialFolder&&e.removeFolder(this._guiMaterialFolder),this._guiMaterialFolder=e.addFolder("Material"),this._guiMaterialFolder.addColor(this._materialParams,"color").onChange(t=>{this._material.color=new b(t),this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,"metallic").min(0).max(1).step(.01).onChange(t=>{this._material.metalness=t===1?1:.5,this._material.reflectivity=t||.5,this._shadingChanged()}),this._guiMaterialFolder.add(this._material,"roughness").min(0).max(1).step(.01).onChange(t=>{this._shadingChanged()}),this._guiMaterialFolder.add(this._material,"transmission").min(0).max(1).step(.01).onChange(t=>{this._material.transmission=t,t>0&&(this._material.opacity=1,this._material.alphaTest=.5,this._material.depthWrite=!1,this._material.transparent=!0,this._material.metalness=0),this._mesh.castShadow=!this._material.transparent,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,"alpha").min(0).max(1).step(.01).onChange(t=>{this._material.transparent=t<1,this._material.opacity=t,this._material.depthWrite=t>=1,this._mesh.castShadow=!this._material.transparent,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,"alphaCutoff").min(0).max(1).step(.01).onChange(t=>{t?this._material.alphaTest=t:this._material.alphaTest=0,this._shadingChanged()}),this._guiMaterialFolder.add(this._materialParams,"doubleSided").onChange(t=>{t?this._material.side=v:this._material.side=j,this._shadingChanged()})),this._addGUIListener(e))}_shadingChanged(){this._roomleMaterialViewerUiCallback.onMaterialShadingChanged(P(this._material))}setGeometry(e){this._sceneParams.type=e,this._setGeometry()}_setGeometry(){let e;this._sceneParams.type==="cube"&&(e=new f(i.x,i.y,i.z,100,100,100)),this._sceneParams.type==="sphere"&&(e=new J(.5,100,100)),this._sceneParams.type==="plane_horizontal"&&(e=new F(i.x,i.z),e.rotateX(-Math.PI/2)),this._sceneParams.type==="plane_vertical"&&(e=new F(i.x,i.z)),this._mesh.geometry=e,this._renderEverything()}async changeFloorMaterialById(e){const t=await this._rapiAccess.getMaterial(e);return(!this._environment||!(this._environment instanceof G))&&(this._environment=new G(this._scene,this._environment,!0)),new Promise((r,a)=>{this._environment.changeFloorMaterial(t,this._maxAnisotropy).then(()=>{this._requestRender(),r()},a)})}async addTexture(e,t){const r=i.x*100,a=i.y*100,n=r/(e.mmWidth===0?1:e.mmWidth),_=a/(e.mmHeight===0?1:e.mmHeight),M=C(this._renderer)?this._renderer.capabilities.maxTextures:w;if(t){const p=new Image;p.src=t;const u=new N;u.image=p,p.onload=function(){u.needsUpdate=!0},Q(u,e,this._material,this._maxAnisotropy,n,_,M)}else await $(e.image,e,this._material,this._maxAnisotropy,n,_,M);this._requestRender()}removeTexture(e){e.mapping===d.ORM&&(this._material.aoMap=null,this._material.roughnessMap=null,this._material.metalnessMap=null),(e.mapping===d.RGB||e.mapping===d.RGBA)&&(this._material.map=null),e.mapping===d.XYZ&&(this._material.normalMap=null),this._material.needsUpdate=!0,this._requestRender()}clearCache(){this._configuratorMeshGenerator.clear()}}g([s],c.prototype,"_inputManager");g([s],c.prototype,"_configuratorMeshGenerator");g([s],c.prototype,"_roomleMaterialViewerUiCallback");g([s],c.prototype,"_rapiAccess");var ae=Object.defineProperty,o=(l,e,t,r)=>{for(var a=void 0,n=l.length-1,_;n>=0;n--)(_=l[n])&&(a=_(e,t,a)||a);return a&&ae(e,t,a),a};class h{constructor(e){this._creator_=e}setCameraOffset(e){this._sceneManager.setCameraOffset(e)}getCameraOffset(){return this._sceneManager.getCameraOffset()}init(e){return this._domHelper.setDomElement(e),this._sceneManager?(this._lifeCycleManager.resume(),Promise.resolve()):new Promise(this._initPromiseCallback.bind(this))}_initPromiseCallback(e,t){this._sceneManager=new c(this._creator_,{left:0,top:1,right:1,bottom:0}),this._sceneManager.enableHD(),e()}get callbacks(){return this._roomleMaterialViewerUiCallback}set callbacks(e){this._roomleMaterialViewerUiCallback=e}loadMaterialShading(e){return this._sceneManager.loadMaterialShading(e)}resetMaterial(){this._sceneManager.resetMaterial()}loadMaterial(e,t={}){return t.flushCache&&this._clearCaches(),this._sceneManager.loadMaterial(e)}loadMaterialId(e,t={}){return t.flushCache&&this._clearCaches(),this._sceneManager.loadMaterialId(e)}getMaterialShading(e=1){return this._sceneManager.getMaterialShading(e)}loadSceneSetting(e){return this._sceneManager.loadSceneSettings(e)}setOverrides(e){e&&this._initData.setOverrides(e)}updateSize(){this._sceneManager.updateCamera()}getMain(){}resumeTest(e){this._domHelper.setDomElement(e),this._lifeCycleManager.resume()}pauseTest(){this._lifeCycleManager.pause()}showGUI(){this._sceneManager.showGUI()}async changeFloorMaterialById(e){return this._sceneManager.changeFloorMaterialById(e)}setGeometry(e){this._sceneManager.setGeometry(e)}async addTexture(e,t){return this._sceneManager.addTexture(e,t)}removeTexture(e){return this._sceneManager.removeTexture(e)}_clearCaches(){this._rapiAccess.cleanUp(),this._sceneManager.clearCache()}getScene(){return this._sceneManager.getScene()}updateScene(){this._sceneManager.updateScene()}getUnitFormatter(){return this._unitFormatter}getStorage(){return this._idbManager}setEnvironmentMap(e){const{url:t,intensity:r,rotation:a,maxLightSources:n}=e;this._sceneManager.setEnvironmentMap(t,r,a,n)}get globalCallbacks(){return this._globalCallback}}o([s],h.prototype,"_domHelper");o([s],h.prototype,"_scriptLoader");o([s],h.prototype,"_lifeCycleManager");o([s],h.prototype,"_roomleMaterialViewerUiCallback");o([s],h.prototype,"_initData");o([s],h.prototype,"_globalCallback");o([s],h.prototype,"_rapiAccess");o([s],h.prototype,"_unitFormatter");o([s],h.prototype,"_idbManager");class ie extends B{constructor(e){super(e),this.onMaterialShadingChanged=t=>{}}}const re=[new m("script-loader",Z),new m("logger",U),new m("input-manager",A,y.CONTEXT),new m("configurator-mesh-generator",O),new m("rapi-access",k),new m("roomle-material-viewer-ui-callback",ie,y.CONTEXT)];class le extends I{setupGlobals(){}setupDependencies(){R.setup(re),this.lookup("logger",this._context)}cleanUpGlobals(){throw new Error("Method not implemented.")}cleanUpDependencies(){throw new Error("Method not implemented.")}async bootFinished(){this._viewer=new h(this._context),window.RoomleMaterialViewer||(window.RoomleMaterialViewer=this._viewer)}getApi(){return this._viewer}getContextName(){return T.MATERIAL_VIEWER}}export{le as MaterialViewer};
