import{Oa as e,Xn as t,Zn as n,gt as r,hn as i}from"./index-BVOtHrRf.js";var a=class{},o=(...e)=>console.log(`[HI]`,`Message:`,...e),s=class{constructor(e){this._roomlePlanner=e}loadMasterData(e){this._roomlePlanner.loadExternalObjectMasterData(e)}async loadPosGroups(e,t){let n=Array.isArray(e)?e:[e];await this._roomlePlanner.loadExternalObjectGroups(n,t)}async selectGroup(e){await this._roomlePlanner.selectExternalObjectGroup(e)}async selectRoot(e){await this._roomlePlanner.selectExternalObjectRootModule(e)}async selectModule(e,t){await this._roomlePlanner.selectExternalObjectSubModule(e,t)}openCloseGroup(e,t,n,r){return this._roomlePlanner.openOrCloseGeometryOfExternalObject(e,t??null,n,r),Promise.resolve()}deleteGroup(e){this._roomlePlanner.removeExternalObject(e)}deleteRootModule(e){this._roomlePlanner.selectExternalObjectGroup(e)}async getPosDataOfAllGroups(){return await this._roomlePlanner.getExternalObjectGroups()}async getRoomInformation(){return await this._roomlePlanner.getExternalRoomInformation()}async generatePlanSnapshot(){let[e,t]=await Promise.all([this._roomlePlanner.saveExternalObjectSnapshot(),this._roomlePlanner.saveCurrentPlanSnapshot()]);return{objectId:e?.id??``,planId:t.id??``}}async saveExternalObjectSnapshot(){return this._roomlePlanner.saveExternalObjectSnapshot()}async saveCurrentPlanSnapshot(){return this._roomlePlanner.saveCurrentPlanSnapshot()}async renderPosDataImage(e){let t=Array.isArray(e)?e:[e];await this._roomlePlanner.renderImagesOfExternalObjectGroup(t)}async downloadGlb(){let e=await this._roomlePlanner.saveExternalObjectSnapshot();if(!e){o(`No plan snapshot available to download GLB.`);return}window.open(e.topImage,`_blank`)?.focus(),window.open(e.perspectiveImage,`_blank`),window.open(e.glb,`_blank`)}},c=(e=>(e.BOTTOM_BAR=`bottom_bar`,e.PARTLIST_BOUNDS=`partlist_bounds`,e.INTERACTION_NOTES=`interaction_notes`,e.PARAMETER_GROUPS=`parameter_groups`,e))(c||{});c.INTERACTION_NOTES+``;var l={HIDE:`hide`,SHOW_ATTRIBUTES:`attributes`,SHOW_ARTICLES:`articles`},u={NONE:`none`,GROUP:`group`,ROOT_MODULE:`rootModule`,SUB_MODULE:`subModule`},d={MULTI_SELECT:`multiselect`,TC_CONFIG:`tc-config`,RML_OBJECT:`rml-object`},f=class{constructor(e){this._callbacks=null,this._contextType=i.PLANNER,this._selectionMode=null,this._hiSelection={type:u.NONE,groupId:null,rootModuleId:null,subModuleId:null},this._emittedSelection={panel:null,groupId:null,rootModuleId:null,subModuleId:null},this._callbacks=e}setSidebar(e){if(e!==`productSettings`){if(e===`catalog`){this._emitSelectionChange(l.SHOW_ARTICLES);return}this._emitSelectionChange(l.HIDE)}}contextChanged(e){this._contextType=e,e===i.PLANNER&&this._resetSelection(),this._handleViewTypeChange()}groupOrModuleSelected(e,t,n){this._selectionMode=d.TC_CONFIG,this._hiSelection.groupId=e,this._hiSelection.rootModuleId=t??null,this._hiSelection.subModuleId=n??null,this._hiSelection.rootModuleId&&this._hiSelection.subModuleId?this._hiSelection.type=u.SUB_MODULE:this._hiSelection.rootModuleId?this._hiSelection.type=u.ROOT_MODULE:this._hiSelection.type=u.GROUP,this._handleViewTypeChange()}componentSelectionCancel(e){this._contextType===i.CONFIGURATOR&&(e===`click_outside`||e===`isolation_mode_cancelled`||e===`select_other`||(this._resetSelection(),this._handleViewTypeChange()))}selectionCancel(e){e!==`select_other`&&(this._resetSelection(),this._handleViewTypeChange())}selectionChanged(e,t,n,r,a){this._selectionHandler(i.PLANNER,e,t,n)}_resetSelection(){this._selectionMode=null}_selectionHandler(e,t,n,r){if(e!==i.CONFIGURATOR){if(t===d.MULTI_SELECT){this._selectionMode=t,this._handleViewTypeChange();return}n===`external-configuration`&&r.externalConfigurationType===d.TC_CONFIG?this._selectionMode=d.TC_CONFIG:this._selectionMode=d.RML_OBJECT,this._handleViewTypeChange()}}_handleViewTypeChange(){let e=l.SHOW_ARTICLES;this._selectionMode===d.TC_CONFIG&&(this._contextType===i.CONFIGURATOR||this._hiSelection.type!==u.GROUP)&&(e=l.SHOW_ATTRIBUTES),this._emitSelectionChange(e)}_emitSelectionChange(e){if(this._emittedSelection.panel!==e){this._emittedSelection.panel=e;let t=e===l.SHOW_ATTRIBUTES;this._emittedSelection.groupId=t?this._hiSelection.groupId:null,this._emittedSelection.rootModuleId=t?this._hiSelection.rootModuleId:null,this._emittedSelection.subModuleId=t?this._hiSelection.subModuleId:null,this._callbacks?.onShowHidePanel(e,this._emittedSelection.groupId,this._emittedSelection.rootModuleId,this._emittedSelection.subModuleId)}else this._emittedSelection.panel===l.SHOW_ATTRIBUTES&&(this._emittedSelection.groupId!==this._hiSelection.groupId||this._emittedSelection.rootModuleId!==this._hiSelection.rootModuleId||this._emittedSelection.subModuleId!==this._hiSelection.subModuleId)&&(this._emittedSelection.groupId=this._hiSelection.groupId??null,this._emittedSelection.rootModuleId=this._hiSelection.rootModuleId??null,this._emittedSelection.subModuleId=this._hiSelection.subModuleId??null,this._callbacks?.onSelectModule(this._emittedSelection.groupId,this._emittedSelection.rootModuleId,this._emittedSelection.subModuleId))}},p=class{constructor(e,t=null){this._libraryData=new Map,this._posDataForLoading=null,this._posArticleMap=new Map,this._groupMap=new Map,this._nextPosDataId=1,this._hiCallbacks=null,this._pendingGroupsToBeLoaded=[],this._planCompletelyLoaded=!1,this._validSubArticles=[],this._designerRequests=e,this._hiCallbacks=t,this._hiObjectSelection=new f(t)}get hiCallbacks(){return this._hiCallbacks}get hiObjectSelection(){return this._hiObjectSelection}_getGroup(e){return this._groupMap.get(e)}getLibraryData(e){if(this._libraryData.size===1)return Array.from(this._libraryData.values())[0];let t;return t=typeof e==`string`?e:this._getLibraryIdForPosData(e),this._libraryData.has(t)?this._libraryData.get(t)??null:(console.error(`Library data for libraryId '${t}' not found`),null)}isLibraryLoaded(e){return this._libraryData.has(e)}addLibrary(e){this._libraryData.has(e.libraryId)||(this._libraryData.set(e.libraryId,e),this._loadPendingGroup(e.libraryId))}loadPosData(e,t){e?.articles&&(e=e.articles),e.forEach(e=>{let r=e.id||e.articleId,i=n(e);i.libraryId=t,this._posArticleMap.set(r,i)})}setPosDataForLoading(e){this._posDataForLoading=e;let t=Array.from(this._groupMap.values()).map(e=>e.posDataJson);this._groupMap.clear();for(let e of t)this.loadedGroup(e)}async getSaveDataGroups(){return this._posDataForLoading?.groups??null}async newPosDataFromId(e){r(e)&&(e=t(e));let i=n(this._posArticleMap.get(e));if(!i)return;let a=i;a.ver=this.getLibraryData(a.libraryId)?.posGroupVersion,a.logMessages=[],a.roots.forEach(e=>{e.libraryId=i.libraryId,e.catalog=i.libraryId,e.logMessages=[],e.isGenerated||(e.articleName=i.articleName,e.articleId=i.articleId,e.desc=i.desc,e.imageUrl=i.imageUrl,e.category=i.category)});let o=this._addNewGroup(a,!1);return this._groupsModified(o.posDataJson,[],[]),o.posDataJson}async newPosDataFromGroup(e){let t=this._addNewGroup(e,!1);return this._groupsModified(t.posDataJson,[],[]),t.posDataJson}async selectGroup(e){try{await this._designerRequests.selectGroup(e)}catch(e){console.error(e)}}async selectRoot(e,t){try{await this._designerRequests.selectRoot(t)}catch(e){console.error(e)}}async deleteRoot(e,t){try{await this._designerRequests.deleteRootModule(t)}catch(e){console.error(e)}}async selectSubModule(e,t,n){try{await this._designerRequests.selectModule(t,n)}catch(e){console.error(e)}}async openCloseGroup(e){try{let t=this._getGroup(e);if(t){let n=!t.opened;await this._designerRequests.openCloseGroup(e,null,n,!1),t.opened=n}}catch(e){console.error(e)}}deleteRootModule(e,t,n){try{let r=this._getGroup(e.groupId);if(r){this._setGroupPosition(r,e),this._setGroupContour(r,e),this._setRootModulesPosition(r,e);let i=r.posDataJson;i.roots=i.roots.filter(e=>e.id!==t);let a=this._splitOffGroupsFromGroups(r,n);this._calculateAndUpdateGroupMap(r),this._loadPosData(r,a),this._groupsModified(a.map(e=>e.posDataJson),r.posDataJson,[])}}catch(e){console.error(e)}}duplicateGroup(e){try{let t=this._getGroup(e?.groupId);if(t){let r=n(t.posDataJson);r.roots=r.roots.filter(t=>e.rootModules.find(e=>e.moduleId===t.id)!==void 0);let i=this._addNewGroup(r,!1);this._setGroupPosition(i,e),this._designerRequests.loadPosGroups(i.posDataJson,{findFreeSpaceInPlan:!0}),this._groupsModified(i.posDataJson,[],[])}}catch(e){console.error(e)}}mergeGroups(e,t,n){try{let r=Array.isArray(t)?t:[t];if(this._groupMap.has(e.groupId)&&r.length>0){let t=[];for(let e of r){let n=this._getGroup(e);n&&t.push(...n.posDataJson.roots)}let i=t.filter(e=>!e.isGenerated),a=this._getGroup(e.groupId);if(a){let t=a.posDataJson.roots.find(e=>e.id===n);t&&this._applyImplicitRelevantAttributes(this._getLibraryIdForPosData(a.posDataJson),t,i),a.posDataJson.roots.push(...i),this._setGroupPosition(a,e),this._setGroupContour(a,e),this._setRootModulesPosition(a,e),this._calculateAndUpdateGroupMap(a),this._designerRequests.loadPosGroups(a.posDataJson,{mergedGroups:r});let o=[];for(let e of r)this._groupMap.has(e)&&(this._groupMap.delete(e),o.push(e));this._groupsModified([],a.posDataJson,o)}}}catch(e){console.error(e)}}_applyImplicitRelevantAttributes(e,t,n){let r=this.getLibraryData(e)?.masterData;if(!r||!t||n.length===0)return;let i=r.modules.find(e=>e.id===t.name)?.assignedAttributes.filter(e=>r.attributes.find(t=>t.id===e)?.implicitRelevant===!0)??[];for(let e of n){let n=r.modules.find(t=>t.id===e.name);for(let r of i){let i=t.attributes?.find(e=>e.id===r);if(!n?.assignedAttributes.find(e=>e===r))continue;let a=e.attributes?.find(e=>e.id===r);a?(a.isInput=i?.isInput??!1,a.isInput===!0&&(a.value=i?.value)):(i?.isInput??!1)&&e.attributes?.push({id:r,value:i?.value,isInput:!0})}}}splitRootModuleFromGroup(e,t){try{let n=this._getGroup(e.groupId);if(n){this._setGroupPosition(n,e),this._setGroupContour(n,e),this._setRootModulesPosition(n,e);let r=Array.isArray(t)?t:[t],i=this._splitOffGroupsFromGroups(n,r);this._calculateAndUpdateGroupMap(n),this._loadPosData(n,i),this._groupsModified(i.map(e=>e.posDataJson),n.posDataJson,[])}}catch(e){console.error(e)}}arrangeRootModulesOfGroup(e){try{let t=this._getGroup(e.groupId);if(t){for(let n of t.posDataJson.roots)e.rootModules.filter(e=>e.moduleId===n.id).forEach(e=>{n.articlePos=e.pos,n.rotationY=e.rotationY});let n=this._calculateAndUpdateGroupMap(t);this._designerRequests.loadPosGroups(n,{}),this._groupsModified([],n,[])}}catch(e){console.error(e)}}removedGroup(e){try{this._groupMap.has(e)&&(this._groupMap.delete(e),this._groupsModified([],[],e))}catch(e){console.error(e)}}changedGroupFromHistory(e,t){try{let n=this._calculate(e),r=n.id,i=this._getGroup(r);i?i.posDataJson=n:this._addGroupToMap(r,n),t&&this._designerRequests.loadPosGroups(e,{}),this._groupsModified(i?[]:[n],i?[n]:[],[])}catch(e){console.error(e)}}changedGroupPlanningSituation(e){try{let t=this._getGroup(e.groupId);if(t){this._setGroupPosition(t,e),this._setGroupContour(t,e);let n=this._calculateAndUpdateGroupMap(t);this._designerRequests.loadPosGroups(n,{}),this._groupsModified([],n,[])}}catch(e){console.error(e)}}loadedGroup(e){let t=this._getLibraryIdForPosData(e);if(!this._libraryData.has(t)){this._pendingGroupsToBeLoaded.push(e);return}this._loadedGroup(e)}_loadPendingGroup(e){let t=this._pendingGroupsToBeLoaded.filter(t=>this._getLibraryIdForPosData(t)===e);this._pendingGroupsToBeLoaded=this._pendingGroupsToBeLoaded.filter(t=>this._getLibraryIdForPosData(t)!==e),t.forEach(e=>this._loadedGroup(e)),this._pendingGroupsToBeLoaded.length===0&&this._groupsCompletelyLoaded()}_loadedGroup(e){if(!this._posDataForLoading){this._recalculateLoadedGroup(e);return}let t=this._posDataForLoading.groups.find(t=>t.id===e.id);if(!t){this.removedGroup(e.id),this._designerRequests.deleteGroup(e.id);return}let r=n(t);r.ver=this.getLibraryData(e)?.posGroupVersion,e.pos!==void 0&&(r.pos=e.pos),e.rotationY!==void 0&&(r.rotationY=e.rotationY),this._recalculateLoadedGroup(r)}_recalculateLoadedGroup(e){try{let t=e.id,n=!this._groupMap.has(t);n&&this._addGroupToMap(t,e);let r=this._getGroup(t);if(r){let e=this._calculateAndUpdateGroupMap(r);this._designerRequests.loadPosGroups(e,{respondWithPositionInPlan:!0}),this._groupsModified(n?e:[],n?[]:e,[])}}catch(e){console.error(e)}}groupsCompletelyLoaded(){this._planCompletelyLoaded=!0,this._groupsCompletelyLoaded()}_groupsCompletelyLoaded(){this._planCompletelyLoaded&&this._libraryData.size>0&&this._pendingGroupsToBeLoaded.length===0&&this._hiCallbacks?.onPosGroupsCompletelyLoaded()}async getGroupDataForOrder(e){try{let t=Array.from(this._groupMap.values()).map(e=>e.posDataJson),n=1;t.forEach(e=>{e.roots.forEach(e=>{e.additionalText=`Additional Text `+ n++})});let r=this.getLibraryData(e)?.getOrderData(t,e);return r?(r.rooms=(await this._designerRequests.getRoomInformation())?.rooms??[],r):null}catch(e){return console.error(e),null}}_setGroupContour(e,t){t.contours&&(e.posDataJson.contours=t.contours)}_setGroupPosition(e,t){let n=e.posDataJson;t.pos!==void 0&&(n.pos=t.pos),t.rotationY!==void 0&&(n.rotationY=t.rotationY)}_setRootModulesPosition(e,t){for(let n of e.posDataJson.roots)t.rootModules.filter(e=>e.moduleId===n.id).forEach(e=>{n.articlePos=e.pos,n.rotationY=e.rotationY})}_loadPosData(e,t){let r=n(e.posDataJson),i=Array.isArray(r)?r:[r];for(let e of t??[])i.push(n(e.posDataJson));this._designerRequests.loadPosGroups(i,{})}_splitOffGroupsFromGroups(e,t){let n=[];for(let r of t??[]){let t=this._splitOffRootModulesFromGroup(e,r),i=this._addNewGroup(t,!0);n.push(i)}return n}_splitOffRootModulesFromGroup(e,t){let r=t.rootModules.map(e=>e.moduleId),i=e.posDataJson,a=i.roots.filter(e=>r.includes(e.id));i.roots=i.roots.filter(e=>!r.includes(e.id));for(let e of a)t.rootModules.filter(t=>t.moduleId===e.id).forEach(t=>{e.articlePos=t.pos,e.rotationY=t.rotationY});for(let e of i.roots)e.isGenerated&&a.push(n(e));return{id:void 0,libraryId:i.libraryId,pos:t.pos,rotationY:t.rotationY,roots:a,ver:i.ver,logMessages:[]}}_calculateNewGroup(e,t){return this._replacesIDs(e,t),this._calculate(e)}_getLibraryIdForPosData(e){return e.libraryId?e.libraryId:e.roots.find(e=>e.libraryId)?.libraryId}_populateRootFromMasterData(e,t,n){if(!n)return;let r=n.modules.find(t=>t.id===e.name);r&&(t?.articleName||(e.articleName=r.name),t?.articleId||(e.articleId=r.name),t?.imageUrl||(e.imageUrl=r.imageUrl),t?.desc||(e.desc=r.desc))}_setSubmoduleImages(e,t){t&&e.modules?.length&&e.modules.forEach(e=>{let n=t.modules.find(t=>t.id===e.name);n&&(e.imageUrl=n.imageUrl),this._setSubmoduleImages(e,t)})}_calculateAndUpdateGroupMap(e){let t=this._calculate(e.posDataJson);return e.posDataJson=t,this._groupMap.set(e.posDataJson.id,e),t}_addNewGroup(e,t){let n=this._calculateNewGroup(e,t);return this._addGroupToMap(n.id,n)}_addGroupToMap(e,t){let n={posDataJson:t,opened:!1};return this._groupMap.set(e,n),n}updateAttribute(e,t,n,r){if(!e)return;let i=Array.from(this._groupMap.entries()).find(([,t])=>t.posDataJson.roots.some(t=>t.id===e));if(!i)throw Error(`PosGroup not found inside the calculated articles list`);let[,a]=i;if(a){let i=this._modifyAttributeOfModules(a,t??e,n,r);this._designerRequests.loadPosGroups(i,{correctArrangement:!0}),this._groupsModified([],i,[])}}modifyAttribute(e,t,n,r){let i=this._getGroup(e);if(i){let e=t.map(e=>e.subModuleId??e.rootModuleId),a=this._modifyAttributeOfModules(i,e,n,r);this._designerRequests.loadPosGroups(a,{correctArrangement:!0}),this._groupsModified([],a,[])}}async getVerifiedAttributeOptions(e,t){let n=this._findModuleInAllGroups(e);if(!n){console.error(`Module not found inside the calculated articles list`);return}if(!n.module.checkAttributes)return;let r;try{r=await this.getLibraryData(n.group)?.getAttributesDropDownValues(n.module,t)}catch(e){console.error(e)}if(!r)return;let i={};for(let[e,t]of Object.entries(r))t&&t.length>0&&(i[e]={calcResult:t.map(e=>({value:e.value,kind:e.kind}))});return i}updateAdditionalInfo(e,t){let n=this._findRootModuleInAllGroups(e);if(!n){console.error(`Root module not found inside the calculated articles list`);return}n.rootModule.additionalText=t,this._designerRequests.loadPosGroups(n.group,{}),this._groupsModified([],n.group,[])}async swapRootModule(e,t,n){let r=this._getGroup(e);if(!r)return;let i=r.posDataJson,a=i.roots.find(e=>e.id===t);if(!a)return;let o=await this.newPosDataFromId(n),s=o.roots.filter(e=>!e.isGenerated);if(!o||s.length!==1)return;let c=s[0];a&&this._applyImplicitRelevantAttributes(this._getLibraryIdForPosData(i),a,[c]),c.articlePos=a.articlePos,c.rotationY=a.rotationY,i.roots=i.roots.filter(e=>e.id!==t),i.roots.push(c);let l=this._calculateAndUpdateGroupMap(r),u={originalModuleId:t,newModuleId:c.id};this._designerRequests.loadPosGroups(l,{newAction:!0,correctArrangement:!0,moduleIdMap:[u]}),this._groupsModified([],l,[])}_modifyAttributeOfModules(e,t,n,r){let i=Array.isArray(t)?t:[t],a=this.getLibraryData(e.posDataJson);for(let t of i){let i=this._findModule(e.posDataJson.roots,t);if(i&&a){let e=a.solveModuleAttributeConflict(i,n,r);this._setAttribute(i,n,r),e&&e.length>0&&e.forEach(e=>{e.value!==void 0&&this._setAttribute(i,e.id,e.value)})}}return this._calculateAndUpdateGroupMap(e)}_setAttribute(e,t,n){if(e.attributes&&e.attributes.length>0){let r=e.attributes.find(e=>e.id===t);if(r){r.value=n,r.isInput=!0;return}}let r={id:t,value:n,isInput:!0};e.attributes?e.attributes.push(r):e.attributes=[r]}findValidSubArticles(e){this._validSubArticles=[];let t=Array.isArray(e)?e:[e];for(let e of t){let t=this._getGroup(e);if(!t)continue;let n=t.posDataJson,{libraryId:r,libraryData:i}=this._getLibrary(n);if(!i)continue;let a=Array.from(this._posArticleMap.values()).filter(e=>e.libraryId===r);try{let e=i.getValidSubArticles(n,a,i.masterData);this._validSubArticles.push(...Array.from(e))}catch(e){console.error(e)}}return this._validSubArticles}_getValidSubArticle(e){return this._validSubArticles.find(t=>t.articleId===e)??null}getValidContainerModulesForSubArticle(e,t){let n=this._getValidSubArticle(t);if(!n)return[];let r=Array.isArray(e)?e:[e],i=[];for(let e of r){let t=this._getGroup(e);if(!t)continue;let r=t.posDataJson,{libraryData:a}=this._getLibrary(r);if(a)try{let e=a.getValidContainerModulesForSubArticle(r,n,a.masterData);i.push(...Array.from(e))}catch(e){console.error(e)}}return i}addSubArticle(e,t,n){let r=this._getValidSubArticle(e);if(!r)return;let{group:i}=this._findRootModuleInAllGroups(t);if(!i)return;let a=this._addSubArticle(i,r,t,n);this._designerRequests.loadPosGroups(a,{}),this._groupsModified([],a,[])}async savePlanSnapshot(){let[e,t]=await Promise.all([this._designerRequests.saveExternalObjectSnapshot(),this._designerRequests.saveCurrentPlanSnapshot()]);return t?{id:t.id,perspectiveImageLink:t?.perspectiveImage,topImageLink:t?.topImage,room3dLink:e?.glb,room3dFullLink:`https://api.roomle.com/v2/planSnapshots/${t.id}/3dAssets/glTF/plan.glb`}:(console.error(`Failed to save plan snapshot`),null)}_findRootModuleInAllGroups(e){for(let t of this._groupMap.values()){let n=t.posDataJson,r=n.roots.find(t=>t.id===e);if(r!==void 0)return{group:n,rootModule:r}}}_findModuleInAllGroups(e){for(let t of this._groupMap.values()){let n=t.posDataJson,r=this._findModule(n.roots,e);if(r!==void 0)return{group:n,module:r}}}_findModule(e,t){for(let n of e){if(n.id===t)return n;if(n.modules&&n.modules.length>0){let e=this._findModule(n.modules,t);if(e!==void 0)return e}}}_replacesIDs(e,t){if(e.id=this._getNextID(),!t)for(let t of e.roots)this._replacesModuleIDs(t)}_replacesModuleIDs(e){if(e.id=this._getNextID(),e.modules)for(let t of e.modules)this._replacesModuleIDs(t)}_getNextID(){if(window.uuidv4)return window.uuidv4();let e=(this._nextPosDataId++).toString();return e.length<4&&(e=`0`.repeat(4-e.length)+e),`id`+e}async _groupsModified(e,t,n){let r=Array.isArray(e)?e:[e];r.length>0&&await this._hiCallbacks?.onPosGroupAdded(r);let i=Array.isArray(t)?t:[t];i.length>0&&await this._hiCallbacks?.onPosGroupChanged(i);let a=Array.isArray(n)?n:[n];a.length>0&&await this._hiCallbacks?.onPosGroupDeleted(a),this._calculatePrice()}_calculatePrice(){let e=Array.from(this._groupMap.values()).map(e=>e.posDataJson);this._hiCallbacks?.onPriceCalc(e)}_calculate(e){let{libraryId:t,libraryData:r}=this._getLibrary(e);if(!r)return null;let i=n(e);i.libraryId=t,i.logMessages&&=[];let a=e;try{a=r.calculateGroup(e)}catch(e){console.error(`Error calculating group:`,e)}return this._takeOverPropertiesFromOriginalGroup(t,r,e,a),a}_addSubArticle(e,t,r,i){let{libraryId:a,libraryData:o}=this._getLibrary(e);if(!o)return null;let s=n(e);s.libraryId=a,s.logMessages=[];let c=e;try{c=o.addSubArticle(e,t,r,i)}catch(e){console.error(`Error adding sub article to group:`,e)}return this._takeOverPropertiesFromOriginalGroup(a,o,e,c),c}_getLibrary(e){let t=this._getLibraryIdForPosData(e);return{libraryId:t,libraryData:this.getLibraryData(t)}}_takeOverPropertiesFromOriginalGroup(e,t,n,r){n.pos!==void 0&&(r.pos=n.pos),n.rotationY!==void 0&&(r.rotationY=n.rotationY);let i=t.masterData;r.roots.forEach(t=>{let r=n.roots.find(e=>e.id===t.id);t.additionalText=r?.additionalText,t.libraryId=r?.libraryId??e,this._populateRootFromMasterData(t,r,i),t.articleName??=r?.articleName??t.name,t.articleId??=r?.articleId??r?.articleName??t.articleName??t.name,t.imageUrl??=r?.imageUrl,t.desc??=r?.desc,t.category=r?.category,t.canBeDeleted=!t.isGenerated,this._setSubmoduleImages(t,i)})}},m=[];for(let e=0;e<256;++e)m.push((e+256).toString(16).slice(1));function h(e,t=0){return(m[e[t+0]]+m[e[t+1]]+m[e[t+2]]+m[e[t+3]]+`-`+m[e[t+4]]+m[e[t+5]]+`-`+m[e[t+6]]+m[e[t+7]]+`-`+m[e[t+8]]+m[e[t+9]]+`-`+m[e[t+10]]+m[e[t+11]]+m[e[t+12]]+m[e[t+13]]+m[e[t+14]]+m[e[t+15]]).toLowerCase()}var g,_=new Uint8Array(16);function v(){if(!g){if(typeof crypto>`u`||!crypto.getRandomValues)throw Error(`crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported`);g=crypto.getRandomValues.bind(crypto)}return g(_)}var y={randomUUID:typeof crypto<`u`&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function b(e,t,n){if(y.randomUUID&&!t&&!e)return y.randomUUID();e||={};let r=e.random||(e.rng||v)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,t){n||=0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return h(r)}var x=(e,t)=>{e.callbacks.onMergeExternalObjectGroup=(e,n,r)=>{t.mergeGroups(e,n,r)},e.callbacks.onSplitExternalObjectGroup=(e,n)=>{t.splitRootModuleFromGroup(e,n)},e.callbacks.onExternalObjectGroupArrangementChanged=e=>{t.arrangeRootModulesOfGroup(e)},e.callbacks.onDeleteExternalObjectGroup=e=>{t.removedGroup(e)},e.callbacks.onDeleteExternalObjectRootModule=(e,n,r)=>{t.deleteRootModule(e,n,r??[])},e.callbacks.onDeleteExternalObjectSubModule=(e,t)=>{},e.callbacks.onDuplicateExternalObjectGroup=(e,n)=>{t.duplicateGroup(n)},e.callbacks.onChangedExternalObjectGroupPlan=e=>{t.changedGroupPlanningSituation(e)},e.callbacks.onExternalObjectEnvironmentChanged=e=>{},e.callbacks.onExternalObjectGroupChanged=e=>{let n=JSON.parse(e);t.changedGroupFromHistory(n,!1)},e.callbacks.onExternalObjectGroupLoaded=e=>{let n=JSON.parse(e);t.loadedGroup(n)},e.callbacks.onExternalObjectAttributeChanged=(e,n,r,i)=>{Array.isArray(n)?t.modifyAttribute(e,n,r,i):t.modifyAttribute(e,[{groupId:e,rootModuleId:n,subModuleId:null}],r,i)},e.callbacks.onCompletelyLoaded=()=>{t.groupsCompletelyLoaded()},e.callbacks.onPlanSnapshotCreated=(...e)=>{},e.callbacks.onExternalObjectModuleSelected=(e,n,r)=>{t.hiObjectSelection.groupOrModuleSelected(e,n,r)},e.callbacks.onContextChanged=e=>{t.hiObjectSelection.contextChanged(e)},e.callbacks.onSelectionChange=(e,n,r,i,a)=>{t.hiObjectSelection.selectionChanged(e,n,r,i,a)},e.callbacks.onSelectionCancel=e=>{t.hiObjectSelection.selectionCancel(e)}},S=(e=new Date)=>{let t=e.toISOString();t=t.slice(0,-1);let n=t.lastIndexOf(`.`),r=t;n!==-1&&(r=t.substring(0,n+4)+`0000`);let i=e.getTimezoneOffset(),a=Math.abs(Math.floor(i/60)),o=Math.abs(i%60),s=`${i<=0?`+`:`-`}${String(a).padStart(2,`0`)}:${String(o).padStart(2,`0`)}`;return r+s},C=()=>({id:window.uuidv4?window.uuidv4():`00000000-0000-0000-0000-000000000000`,state:`New`,orderNumber:`736362`,orderName:`Bedroom & bathroom 01`,orderDescription:`Lorem ipsum dolor sit amet...`,project:`Single family house Müller John`,personInCharge:`Joe`,orderDate:S(),deliveryDatePlanned:S(new Date(Date.now()+336*60*60*1e3)),addresses:[{type:`Delivery, Billing`,street:`Musterstraße`,houseNumber:`1`,postalCode:`12345`,city:`Musterstadt`,country:`Deutschland`}],customerName:`Müller & Co.`,customerNumber:`462642`,createdAt:S(),changedAt:S(),changedBy:`Selfish`,items:[]}),w=async(e,t)=>{let n=await e.getPlanOverview(),r={},i=n.objects.reduce((e,t)=>(t.catalogItemId&&(r[t.catalogItemId]||(r[t.catalogItemId]=0,e.push(t.catalogItemId)),r[t.catalogItemId]++),e),[]),a=(Array.isArray(i)&&i.length>0?await e.getRapiAccess().getItems(i):[]).filter(e=>e.manufacturerSKU===void 0?!1:(e.count=r[e.id],!0));if(Array.isArray(a)&&a.length>0){t.items||=[];let e=t.items.reduce((e,t)=>t.items?.length?e+t.items.length:e,0);a.forEach(n=>{let r={};r.type=`Position`,r.name=(++e).toString(),r.articleNumber=n.manufacturerSKU,r.articleName=n.label,r.catalog=n.catalog,r.quantity=n.count,r.height=n.displayedHeight,r.width=n.displayedWidth,r.depth=n.displayedDepth,r.color=n.basecolor,r.procurementType=`PTO`,r.additionalData=[],n.perspectiveImage&&r.additionalData.push({category:`ArticleImage`,downloadUri:n.perspectiveImage,type:`Image`}),t.items.push(r)})}},T=class{constructor(e,t){this._roomlePlanner=e,this._glueLogic=t}async placeOrder(){let e=await this._glueLogic.savePlanSnapshot();if(!e){console.error(`Could not save plan snapshot before placing order`);return}let t=this._glueLogic.hiCallbacks,n=await this._glueLogic.getGroupDataForOrder(e.id),r=C();r.items.push(n);let i=await t?.onFetchPrice(r);i?(r=i.orderData,n=r.items[0]):(r.items.push(n),await w(this._roomlePlanner,n)),Array.isArray(n.additionalData)||(n.additionalData=[]),e.perspectiveImageLink&&n.additionalData.push({type:`Image`,category:`OverviewImage`,downloadUri:e.perspectiveImageLink}),e.topImageLink&&n.additionalData.push({type:`Image`,category:`AboveImage`,downloadUri:e.topImageLink}),e.room3dLink&&n.additionalData.push({type:`ThreeD`,category:`ThreeDModel`,downloadUri:e.room3dLink}),await t?.onPlaceOrder(r)}async fetchPrice(e){let t=await this._glueLogic.getGroupDataForOrder(e),n=C();return n.items.push(t),this._glueLogic.hiCallbacks?.onFetchPrice(n)}},E=class{constructor(e,t){this._glueLogic=e,this._hiCallbacks=t}get hiCallbacks(){return this._hiCallbacks}get hiObjectSelection(){return this._glueLogic.hiObjectSelection}_logRequest(e,...t){let n=e;t&&t.forEach(e=>{n+=` `+e}),this._hiCallbacks.onLogMessage?.(`HI REQUEST`,n)}isLibraryLoaded(e){return this._glueLogic.isLibraryLoaded(e)}getLibraryData(e){return this._glueLogic.getLibraryData(e)}addLibrary(e){this._logRequest(`addLibrary`,e.libraryId),this._glueLogic.addLibrary(e)}setPosDataForLoading(e){this._logRequest(`setPosDataForLoading`,e?`set`:`null`),this._glueLogic.setPosDataForLoading(e)}loadPosData(e,t){this._logRequest(`loadPosData`,t),this._glueLogic.loadPosData(e,t)}mergeGroups(e,t,n){this._logRequest(`mergeGroups`,e.groupId,JSON.stringify(t),n),this._glueLogic.mergeGroups(e,t,n)}deleteRootModule(e,t,n){this._logRequest(`deleteRootModule`,JSON.stringify(e),t,JSON.stringify(n)),this._glueLogic.deleteRootModule(e,t,n)}splitRootModuleFromGroup(e,t){this._logRequest(`splitRootModuleFromGroup`,JSON.stringify(e),JSON.stringify(t)),this._glueLogic.splitRootModuleFromGroup(e,t)}duplicateGroup(e){this._logRequest(`duplicateGroup`,e.groupId),this._glueLogic.duplicateGroup(e)}modifyAttribute(e,t,n,r){this._logRequest(`modifyAttribute`,e,JSON.stringify(t),n,r),this._glueLogic.modifyAttribute(e,t,n,r)}updateAttribute(e,t,n,r){this._logRequest(`updateAttribute`,e,t,n,r.toString()),this._glueLogic.updateAttribute(e,t,n,r)}getVerifiedAttributeOptions(e,t){return this._logRequest(`getVerifiedAttributeOptions`,e,t?JSON.stringify(t):`[]`),this._glueLogic.getVerifiedAttributeOptions(e,t)}updateAdditionalInfo(e,t){this._logRequest(`updateAdditionalInfo`,e,t),this._glueLogic.updateAdditionalInfo(e,t)}findValidSubArticles(e){return this._logRequest(`findValidSubArticles`,Array.isArray(e)?JSON.stringify(e):e),this._glueLogic.findValidSubArticles(e)}getValidContainerModulesForSubArticle(e,t){return this._logRequest(`getValidContainerModulesForSubArticle`,Array.isArray(e)?JSON.stringify(e):e,t),this._glueLogic.getValidContainerModulesForSubArticle(e,t)}addSubArticle(e,t,n){this._logRequest(`addSubArticle`,e,t,n),this._glueLogic.addSubArticle(e,t,n)}swapRootModule(e,t,n){this._logRequest(`swapRootModule`,e,t,n),this._glueLogic.swapRootModule(e,t,n)}arrangeRootModulesOfGroup(e){this._logRequest(`arrangeRootModulesOfGroup`,JSON.stringify(e)),this._glueLogic.arrangeRootModulesOfGroup(e)}changedGroupPlanningSituation(e){this._logRequest(`changedGroupPlanningSituation`,e.groupId),this._glueLogic.changedGroupPlanningSituation(e)}changedGroupFromHistory(e,t){this._logRequest(`changedGroupFromHistory`,e.id,t.toString()),this._glueLogic.changedGroupFromHistory(e,t)}loadedGroup(e){this._logRequest(`loadedGroup`,e.id),this._glueLogic.loadedGroup(e)}groupsCompletelyLoaded(){this._logRequest(`groupsCompletelyLoaded`),this._glueLogic.groupsCompletelyLoaded()}removedGroup(e){this._logRequest(`removedGroup`,e),this._glueLogic.removedGroup(e)}openCloseGroup(e){this._logRequest(`openCloseGroup`,e),this._glueLogic.openCloseGroup(e)}getSaveDataGroups(){return this._logRequest(`getSaveDataGroups`),this._glueLogic.getSaveDataGroups()}async newPosDataFromId(e){return this._logRequest(`newPosDataFromId`,e),this._glueLogic.newPosDataFromId(e)}async newPosDataFromGroup(e){return this._logRequest(`newPosDataFromId`,JSON.stringify(e)),this._glueLogic.newPosDataFromGroup(e)}getGroupDataForOrder(e){return this._logRequest(`getGroupDataForOrder`,e),this._glueLogic.getGroupDataForOrder(e)}savePlanSnapshot(){return this._logRequest(`savePlanSnapshot`),this._glueLogic.savePlanSnapshot()}},D=class{constructor(e,t){this._roomDesignerRequests=e,this._hiCallbacks=t}_logResponse(e,...t){let n=e;t&&t.forEach(e=>{n+=` `+e}),this._hiCallbacks.onLogMessage?.(`HI RESPONSE`,n)}loadMasterData(e){this._logResponse(`loadMasterData`),this._roomDesignerRequests.loadMasterData(e)}async loadPosGroups(e,t){let n=Array.isArray(e)?e.map(e=>e.id).join(`,`):e.id;return this._logResponse(`loadPosGroups`,n,t.newAction?.toString()??`false`,t.findFreeSpaceInPlan?.toString()??`false`,t.correctArrangement?.toString()??`false`,t.moduleIdMap?JSON.stringify(t.moduleIdMap):`[]`,t.mergedGroups?JSON.stringify(t.mergedGroups):`[]`,t.respondWithPositionInPlan?.toString()??`false`),this._roomDesignerRequests.loadPosGroups(e,t)}async selectGroup(e){return this._logResponse(`selectGroup`,e),this._roomDesignerRequests.selectGroup(e)}async selectRoot(e){return this._logResponse(`selectRoot`,e),this._roomDesignerRequests.selectRoot(e)}async selectModule(e,t){return this._logResponse(`selectModule`,e,t),this._roomDesignerRequests.selectModule(e,t)}openCloseGroup(e,t,n,r){return this._logResponse(`openCloseGroup`,e,t,n.toString(),r.toString()),this._roomDesignerRequests.openCloseGroup(e,t,n,r),Promise.resolve()}deleteGroup(e){return this._logResponse(`deleteGroup`,e),this._roomDesignerRequests.deleteGroup(e)}deleteRootModule(e){return this._logResponse(`deleteRootModule`,e),this._roomDesignerRequests.deleteRootModule(e)}getPosDataOfAllGroups(){return this._logResponse(`getPosDataOfAllGroups`),this._roomDesignerRequests.getPosDataOfAllGroups()}getRoomInformation(){return this._logResponse(`getRoomInformation`),this._roomDesignerRequests.getRoomInformation()}generatePlanSnapshot(){this._logResponse(`generatePlanSnapshot`);let e=this._roomDesignerRequests.generatePlanSnapshot();return e.then(e=>{this._hiCallbacks.onLogMessage?.(`Group ID`,e.objectId),this._hiCallbacks.onLogMessage?.(`Plan ID`,e.planId)}),e}saveExternalObjectSnapshot(){return this._logResponse(`saveExternalObjectSnapshot`),this._roomDesignerRequests.saveExternalObjectSnapshot()}saveCurrentPlanSnapshot(){return this._logResponse(`saveCurrentPlanSnapshot`),this._roomDesignerRequests.saveCurrentPlanSnapshot()}};console.warn(`Homag Intelligence plugin is loaded.`);var O=class extends a{constructor(){super(),this._roomlePlanner=null,this._api=null,this._glueLogic=null,this._orders=null,window.uuidv4||(window.uuidv4=b)}async init(e,t,n){this._roomlePlanner=e,this._roomlePlanner.setHomagIntelligence(this),this._api=new s(this._roomlePlanner),t?.debugLogging?this._glueLogic=new E(new p(new D(this._api,n),n),n):this._glueLogic=new p(this._api,n),x(this._roomlePlanner,this._glueLogic);let r=await n.onGetSavedPosGroupData()??null;return this._glueLogic.setPosDataForLoading(r),this._orders=new T(e,this._glueLogic),this}async loadLibrary(e){if(!this._glueLogic)throw Error(`GlueLogic not initialized`);let t=await this._loadLibraryData(e);this._glueLogic.addLibrary(t)}async loadCatalog(e,t,n){if(!this._glueLogic)throw Error(`GlueLogic not initialized`);n?.setEmulator(this._glueLogic),this._glueLogic.loadPosData(await t,e)}async _loadLibraryData(e){if(this._glueLogic.isLibraryLoaded(e))return this._glueLogic.getLibraryData(e);let t=this._glueLogic.hiCallbacks,{masterData:n,libraryExports:r}=await this._requestHiLibrary(e,t);return this._loadMasterData(n),{libraryId:e,masterData:n,posGroupVersion:1,calculateGroup:e=>r.calc(e),getOrderData:(e,t)=>r.getOrderData(e,t),getAttributesDropDownValues:async(e,t)=>{let n=t?Array.isArray(t)?t:[t]:e.attributes.map(e=>e.id),i={};for(let t of n)try{i[t]=r.getAttributesDropDownValues(e,t)}catch(e){console.error(e),i[t]=[]}return i},solveModuleAttributeConflict:(e,t,n)=>r.solveModuleAttributeConflict?r.solveModuleAttributeConflict(e,t,n):void 0,getValidSubArticles(e,t,n){return r.getValidSubArticles?r.getValidSubArticles(e,t,n):[]},getValidContainerModulesForSubArticle(e,t,n){return r.getValidContainerModulesForSubArticle?r.getValidContainerModulesForSubArticle(e,t,n):[]},addSubArticle(e,t,n,i){return r.addSubArticle?r.addSubArticle(e,t,n,i):e}}}async _requestHiLibrary(e,t){if(!this._glueLogic)throw Error(`GlueLogic not initialized`);let[n,r]=await Promise.all([t.onLoadMasterData(e),t.onLoadJavascript(e)]);return{masterData:n,libraryExports:await this._initCalcScript(r)}}_loadMasterData(e){if(!this._api)throw Error(`API not initialized`);return this._api.loadMasterData(e)}async _initCalcScript(t){try{window.exports={};let n=new Blob([t],{type:`text/javascript`}),r=URL.createObjectURL(n);return await e(()=>import(r),[]),URL.revokeObjectURL(r),window.exports}catch(e){throw console.error(e),Error(`Failed to load calc.js!`)}}getGlueLogic(){return this._glueLogic}async placeOrder(){await this._orders.placeOrder()}async fetchPrice(e){return this._orders.fetchPrice(e)}};export{O as HomagIntelligence};