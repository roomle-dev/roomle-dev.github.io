import{$ as e,$i as t,$r as n,$t as r,Ar as i,At as a,B as o,Bi as s,Bn as c,Br as l,Bt as u,Ca as d,Cr as f,Ct as p,D as m,Da as h,Dn as g,Dr as _,E as v,Ea as y,Ei as b,En as ee,Et as x,Fi as te,Fn as ne,Gn as re,Gr as ie,Gt as S,H as ae,Hi as oe,Hn as se,Hr as ce,Ht as le,I as ue,In as de,Ir as fe,It as pe,J as me,Jr as he,Jt as ge,Kn as _e,Kr as ve,L as ye,Li as be,Lr as xe,Lt as Se,Mi as Ce,N as we,Ni as Te,Nn as Ee,Nt as De,Oi as Oe,On as ke,P as Ae,Pn as je,Q as Me,Qi as Ne,R as Pe,Ri as Fe,S as Ie,Si as Le,Sr as Re,St as ze,Ta as Be,Ti as Ve,Tn as He,Tr as Ue,Tt as We,U as Ge,V as Ke,Vn as qe,Vt as Je,W as Ye,Wi as Xe,Wn as Ze,Xt as Qe,Yi as $e,Yn as et,Yr as tt,Yt as nt,Z as rt,Zr as it,_a as at,_i as ot,_n as st,_r as ct,a as lt,aa as ut,ai as dt,an as ft,at as pt,ba as mt,bn as ht,br as gt,bt as _t,c as vt,ca as yt,ci as bt,cn as xt,cr as St,ct as Ct,d as wt,da as Tt,dr as Et,ea as Dt,ei as Ot,er as kt,et as At,f as jt,fn as Mt,fr as Nt,g as Pt,ga as Ft,gn as It,gr as Lt,h as Rt,hi as zt,hr as Bt,i as Vt,ia as Ht,ii as Ut,ji as Wt,jn as Gt,jr as Kt,jt as qt,k as Jt,kn as C,kr as Yt,l as Xt,ln as Zt,lr as Qt,lt as $t,mn as en,mt as tn,n as nn,na as rn,nn as an,nr as on,oa as sn,oi as cn,ot as ln,p as un,pa as dn,pi as fn,pn,pr as mn,q as hn,qi as gn,qr as _n,rn as vn,rr as yn,rt as w,s as bn,si as xn,sn as Sn,sr as Cn,st as wn,t as Tn,ti as En,tr as Dn,u as On,ua as kn,ui as An,un as jn,v as Mn,vn as Nn,w as Pn,wr as Fn,wt as In,x as Ln,xa as Rn,xi as zn,ya as Bn,yi as Vn,yn as Hn,yt as Un,z as Wn,zn as Gn,zt as Kn}from"./index-SBcZ5nhW.js";import{a as qn,c as Jn,d as Yn,f as Xn,h as Zn,i as Qn,l as $n,n as er,o as tr,p as T,r as nr,s as rr,t as ir,u as ar}from"./BufferGeometry-Bn0KB3W4-CQROJpl3.js";import{n as or,r as sr,t as cr}from"./SphereGeometry-C6pGg7kd-DWSklfpA.js";import{t as lr}from"./LineBasicMaterial-Cx-RKwkZ-B_Q8X_xw.js";var ur=class{constructor(e,t){this.nodes=e,this.info=t,this._context=typeof self<`u`?self:null,this._animationLoop=null,this._requestId=null}start(){let e=(t,n)=>{this._requestId=this._context.requestAnimationFrame(e),this.info.autoReset===!0&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,this._animationLoop!==null&&this._animationLoop(t,n)};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}getAnimationLoop(){return this._animationLoop}setAnimationLoop(e){this._animationLoop=e}getContext(){return this._context}setContext(e){this._context=e}dispose(){this.stop()}},dr=class{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let n=0;n<e.length-1;n++)if(t=t.get(e[n]),t===void 0)return;return t.get(e[e.length-1])}set(e,t){let n=this.weakMap;for(let t=0;t<e.length-1;t++){let r=e[t];n.has(r)===!1&&n.set(r,new WeakMap),n=n.get(r)}return n.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let n=0;n<e.length-1;n++)if(t=t.get(e[n]),t===void 0)return!1;return t.delete(e[e.length-1])}},fr=class e{constructor(t,n,r,i){e.prototype.isMatrix2=!0,this.elements=[1,0,0,1],t!==void 0&&this.set(t,n,r,i)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let n=0;n<4;n++)this.elements[n]=e[n+t];return this}set(e,t,n,r){let i=this.elements;return i[0]=e,i[2]=t,i[1]=n,i[3]=r,this}};function pr(e,t=0){let n=3735928559^t,r=1103547991^t;if(e instanceof Array)for(let t=0,i;t<e.length;t++)i=e[t],n=Math.imul(n^i,2654435761),r=Math.imul(r^i,1597334677);else for(let t=0,i;t<e.length;t++)i=e.charCodeAt(t),n=Math.imul(n^i,2654435761),r=Math.imul(r^i,1597334677);return n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(r^r>>>13,3266489909),r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(n^n>>>13,3266489909),4294967296*(2097151&r)+(n>>>0)}var mr=e=>pr(e),hr=e=>pr(e),gr=(...e)=>pr(e);function _r(e,t=!1){let n=[];e.isNode===!0&&n.push(e.id);for(let{property:r,childNode:i}of vr(e))n.push(pr(r.slice(0,-4)),i.getCacheKey(t));return pr(n)}function*vr(e,t=!1){for(let n of Object.getOwnPropertyNames(e)){if(n.startsWith(`_`)===!0)continue;let r=e[n];if(Array.isArray(r)===!0)for(let e=0;e<r.length;e++){let i=r[e];i&&(i.isNode===!0||t&&typeof i.toJSON==`function`)&&(yield{property:n,index:e,childNode:i})}else if(r&&r.isNode===!0)yield{property:n,childNode:r};else if(r&&Object.getPrototypeOf(r)===Object.prototype)for(let e in r){if(e.startsWith(`_`)===!0)continue;let i=r[e];i&&(i.isNode===!0||t&&typeof i.toJSON==`function`)&&(yield{property:n,index:e,childNode:i})}}}var yr=new Map([[1,`float`],[2,`vec2`],[3,`vec3`],[4,`vec4`],[9,`mat3`],[16,`mat4`]]),br=new WeakMap;function xr(e){return yr.get(e)}function Sr(e){if(e==null)return null;let t=typeof e;return e.isNode===!0?`node`:t===`number`?`float`:t===`boolean`?`bool`:t===`string`?`string`:t===`function`?`shader`:e.isVector2===!0?`vec2`:e.isVector3===!0?`vec3`:e.isVector4===!0?`vec4`:e.isMatrix2===!0?`mat2`:e.isMatrix3===!0?`mat3`:e.isMatrix4===!0?`mat4`:e.isColor===!0?`color`:e instanceof ArrayBuffer?`ArrayBuffer`:null}function Cr(e,...t){let n=e?e.slice(-4):void 0;return t.length===1&&(n===`vec2`?t=[t[0],t[0]]:n===`vec3`?t=[t[0],t[0],t[0]]:n===`vec4`&&(t=[t[0],t[0],t[0],t[0]])),e===`color`?new T(...t):n===`vec2`?new w(...t):n===`vec3`?new C(...t):n===`vec4`?new s(...t):n===`mat2`?new fr(...t):n===`mat3`?new qe(...t):n===`mat4`?new zn(...t):e===`bool`?t[0]||!1:e===`float`||e===`int`||e===`uint`?t[0]||0:e===`string`?t[0]||``:e===`ArrayBuffer`?Er(t[0]):null}function wr(e){let t=br.get(e);return t===void 0&&(t={},br.set(e,t)),t}function Tr(e){let t=``,n=new Uint8Array(e);for(let e=0;e<n.length;e++)t+=String.fromCharCode(n[e]);return btoa(t)}function Er(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0)).buffer}var Dr=0;function Or(e){let t=Object.keys(e),n=Object.getPrototypeOf(e);for(;n;){let e=Object.getOwnPropertyDescriptors(n);for(let n in e)if(e[n]!==void 0){let r=e[n];r&&typeof r.get==`function`&&t.push(n)}n=Object.getPrototypeOf(n)}return t}var kr=class{constructor(e,t,n,r,i,a,o,s,c,l){this.id=Dr++,this._nodes=e,this._geometries=t,this.renderer=n,this.object=r,this.material=i,this.scene=a,this.camera=o,this.lightsNode=s,this.context=c,this.geometry=r.geometry,this.version=i.version,this.drawRange=null,this.attributes=null,this.attributesId=null,this.pipeline=null,this.group=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=l,this.clippingContextCacheKey=l===null?``:l.cacheKey,this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.onGeometryDispose=()=>{this.attributes=null,this.attributesId=null},this.material.addEventListener(`dispose`,this.onMaterialDispose),this.geometry.addEventListener(`dispose`,this.onGeometryDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return this.clippingContext===null||this.clippingContext.cacheKey===this.clippingContextCacheKey?!1:(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return this.material.hardwareClipping===!0?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||=this._nodes.getForRender(this)}getMonitor(){return this._monitor||=this.getNodeBuilderState().observer}getBindings(){return this._bindings||=this.getNodeBuilderState().createBindings()}getBindingGroup(e){for(let t of this.getBindings())if(t.name===e)return t}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null,this.attributesId=null}getAttributes(){if(this.attributes!==null)return this.attributes;let e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,n=[],r=new Set,i={};for(let a of e){let e;if(a.node&&a.node.attribute?e=a.node.attribute:(e=t.getAttribute(a.name),i[a.name]=e.version),e===void 0)continue;n.push(e);let o=e.isInterleavedBufferAttribute?e.data:e;r.add(o)}return this.attributes=n,this.attributesId=i,this.vertexBuffers=Array.from(r.values()),n}getVertexBuffers(){return this.vertexBuffers===null&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){let{object:e,material:t,geometry:n,group:r,drawRange:i}=this,a=this.drawParams||={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0},o=this.getIndex(),s=o!==null,c=1;if(n.isInstancedBufferGeometry===!0?c=n.instanceCount:e.count!==void 0&&(c=Math.max(0,e.count)),c===0)return null;if(a.instanceCount=c,e.isBatchedMesh===!0)return a;let l=1;t.wireframe===!0&&!e.isPoints&&!e.isLineSegments&&!e.isLine&&!e.isLineLoop&&(l=2);let u=i.start*l,d=(i.start+i.count)*l;r!==null&&(u=Math.max(u,r.start*l),d=Math.min(d,(r.start+r.count)*l));let f=n.attributes.position,p=1/0;s?p=o.count:f!=null&&(p=f.count),u=Math.max(u,0),d=Math.min(d,p);let m=d-u;return m<0||m===1/0?null:(a.vertexCount=m,a.firstVertex=u,a)}getGeometryCacheKey(){let{geometry:e}=this,t=``;for(let n of Object.keys(e.attributes).sort()){let r=e.attributes[n];t+=n+`,`,r.data&&(t+=r.data.stride+`,`),r.offset&&(t+=r.offset+`,`),r.itemSize&&(t+=r.itemSize+`,`),r.normalized&&(t+=`n,`)}for(let n of Object.keys(e.morphAttributes).sort()){let r=e.morphAttributes[n];t+=`morph-`+n+`,`;for(let e=0,n=r.length;e<n;e++){let n=r[e];t+=n.id+`,`}}return e.index&&(t+=`index,`),t}getMaterialCacheKey(){let{object:e,material:t,renderer:n}=this,r=t.customProgramCacheKey();for(let e of Or(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;let i=t[e],a;if(i!==null){let e=typeof i;e===`number`?a=i===0?`0`:`1`:e===`object`?(a=`{`,i.isTexture&&(a+=i.mapping,n.backend.isWebGPUBackend===!0&&(a+=i.magFilter,a+=i.minFilter,a+=i.wrapS,a+=i.wrapT,a+=i.wrapR)),a+=`}`):a=String(i)}else a=String(i);r+=a+`,`}return r+=this.clippingContextCacheKey+`,`,e.geometry&&(r+=this.getGeometryCacheKey()),e.skeleton&&(r+=e.skeleton.bones.length+`,`),e.isBatchedMesh&&(r+=e._matricesTexture.uuid+`,`,e._colorsTexture!==null&&(r+=e._colorsTexture.uuid+`,`)),(e.isInstancedMesh||e.count>1)&&(r+=e.uuid+`,`),r+=e.receiveShadow+`,`,mr(r)}get needsGeometryUpdate(){if(this.geometry.id!==this.object.geometry.id)return!0;if(this.attributes!==null){let e=this.attributesId;for(let t in e){let n=this.geometry.getAttribute(t);if(n===void 0||e[t]!==n.id)return!0}}return!1}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=0;return this.material.isShadowPassMaterial!==!0&&(e=this._nodes.getCacheKey(this.scene,this.lightsNode)),this.camera.isArrayCamera&&(e=gr(e,this.camera.cameras.length)),this.object.receiveShadow&&(e=gr(e,1)),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener(`dispose`,this.onMaterialDispose),this.geometry.removeEventListener(`dispose`,this.onGeometryDispose),this.onDispose()}},Ar=[],jr=class{constructor(e,t,n,r,i,a){this.renderer=e,this.nodes=t,this.geometries=n,this.pipelines=r,this.bindings=i,this.info=a,this.chainMaps={}}get(e,t,n,r,i,a,o,s){let c=this.getChainMap(s);Ar[0]=e,Ar[1]=t,Ar[2]=a,Ar[3]=i;let l=c.get(Ar);return l===void 0?(l=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,n,r,i,a,o,s),c.set(Ar,l)):(l.updateClipping(o),l.needsGeometryUpdate&&l.setGeometry(e.geometry),(l.version!==t.version||l.needsUpdate)&&(l.initialCacheKey===l.getCacheKey()?l.version=t.version:(l.dispose(),l=this.get(e,t,n,r,i,a,o,s)))),Ar.length=0,l}getChainMap(e=`default`){return this.chainMaps[e]||(this.chainMaps[e]=new dr)}dispose(){this.chainMaps={}}createRenderObject(e,t,n,r,i,a,o,s,c,l,u){let d=this.getChainMap(u),f=new kr(e,t,n,r,i,a,o,s,c,l);return f.onDispose=()=>{this.pipelines.delete(f),this.bindings.delete(f),this.nodes.delete(f),d.delete(f.getChainArray())},f}},Mr=class{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return t===void 0&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}},Nr={VERTEX:1,INDEX:2,STORAGE:3,INDIRECT:4},Pr=16,Fr=211,Ir=212,Lr=class extends Mr{constructor(e){super(),this.backend=e}delete(e){let t=super.delete(e);return t!==null&&this.backend.destroyAttribute(e),t}update(e,t){let n=this.get(e);if(n.version===void 0)t===Nr.VERTEX?this.backend.createAttribute(e):t===Nr.INDEX?this.backend.createIndexAttribute(e):t===Nr.STORAGE?this.backend.createStorageAttribute(e):t===Nr.INDIRECT&&this.backend.createIndirectStorageAttribute(e),n.version=this._getBufferAttribute(e).version;else{let t=this._getBufferAttribute(e);(n.version<t.version||t.usage===35048)&&(this.backend.updateAttribute(e),n.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}};function Rr(e){return e.index===null?e.attributes.position.version:e.index.version}function zr(e){let t=[],n=e.index,r=e.attributes.position;if(n!==null){let e=n.array;for(let n=0,r=e.length;n<r;n+=3){let r=e[n+0],i=e[n+1],a=e[n+2];t.push(r,i,i,a,a,r)}}else{let e=r.array;for(let n=0,r=e.length/3-1;n<r;n+=3){let e=n+0,r=n+1,i=n+2;t.push(e,r,r,i,i,e)}}let i=new(Yn(t)?Xn:qn)(t,1);return i.version=Rr(e),i}var Br=class extends Mr{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){let t=e.geometry;return super.has(t)&&this.get(t).initialized===!0}updateForRender(e){this.has(e)===!1&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){let t=e.geometry,n=this.get(t);n.initialized=!0,this.info.memory.geometries++;let r=()=>{this.info.memory.geometries--;let n=t.index,i=e.getAttributes();n!==null&&this.attributes.delete(n);for(let e of i)this.attributes.delete(e);let a=this.wireframes.get(t);a!==void 0&&this.attributes.delete(a),t.removeEventListener(`dispose`,r)};t.addEventListener(`dispose`,r)}updateAttributes(e){let t=e.getAttributes();for(let e of t)e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute?this.updateAttribute(e,Nr.STORAGE):this.updateAttribute(e,Nr.VERTEX);let n=this.getIndex(e);n!==null&&this.updateAttribute(n,Nr.INDEX);let r=e.geometry.indirect;r!==null&&this.updateAttribute(r,Nr.INDIRECT)}updateAttribute(e,t){let n=this.info.render.calls;e.isInterleavedBufferAttribute?this.attributeCall.get(e)===void 0?(this.attributes.update(e,t),this.attributeCall.set(e,n)):this.attributeCall.get(e.data)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e.data,n),this.attributeCall.set(e,n)):this.attributeCall.get(e)!==n&&(this.attributes.update(e,t),this.attributeCall.set(e,n))}getIndirect(e){return e.geometry.indirect}getIndex(e){let{geometry:t,material:n}=e,r=t.index;if(n.wireframe===!0){let e=this.wireframes,n=e.get(t);n===void 0?(n=zr(t),e.set(t,n)):n.version!==Rr(t)&&(this.attributes.delete(n),n=zr(t),e.set(t,n)),r=n}return r}},Vr=class{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0},this.compute={calls:0,frameCalls:0,timestamp:0},this.memory={geometries:0,textures:0}}update(e,t,n){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=n*(t/3):e.isPoints?this.render.points+=n*t:e.isLineSegments?this.render.lines+=n*(t/2):e.isLine?this.render.lines+=n*(t-1):console.error(`THREE.WebGPUInfo: Unknown object type.`)}reset(){this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}},Hr=class{constructor(e){this.cacheKey=e,this.usedTimes=0}},Ur=class extends Hr{constructor(e,t,n){super(e),this.vertexProgram=t,this.fragmentProgram=n}},Wr=class extends Hr{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}},Gr=0,Kr=class{constructor(e,t,n,r=null,i=null){this.id=Gr++,this.code=e,this.stage=t,this.name=n,this.transforms=r,this.attributes=i,this.usedTimes=0}},qr=class extends Mr{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){let{backend:n}=this,r=this.get(e);if(this._needsComputeUpdate(e)){let i=r.pipeline;i&&(i.usedTimes--,i.computeProgram.usedTimes--);let a=this.nodes.getForCompute(e),o=this.programs.compute.get(a.computeShader);o===void 0&&(i&&i.computeProgram.usedTimes===0&&this._releaseProgram(i.computeProgram),o=new Kr(a.computeShader,`compute`,e.name,a.transforms,a.nodeAttributes),this.programs.compute.set(a.computeShader,o),n.createProgram(o));let s=this._getComputeCacheKey(e,o),c=this.caches.get(s);c===void 0&&(i&&i.usedTimes===0&&this._releasePipeline(i),c=this._getComputePipeline(e,o,s,t)),c.usedTimes++,o.usedTimes++,r.version=e.version,r.pipeline=c}return r.pipeline}getForRender(e,t=null){let{backend:n}=this,r=this.get(e);if(this._needsRenderUpdate(e)){let i=r.pipeline;i&&(i.usedTimes--,i.vertexProgram.usedTimes--,i.fragmentProgram.usedTimes--);let a=e.getNodeBuilderState(),o=e.material?e.material.name:``,s=this.programs.vertex.get(a.vertexShader);s===void 0&&(i&&i.vertexProgram.usedTimes===0&&this._releaseProgram(i.vertexProgram),s=new Kr(a.vertexShader,`vertex`,o),this.programs.vertex.set(a.vertexShader,s),n.createProgram(s));let c=this.programs.fragment.get(a.fragmentShader);c===void 0&&(i&&i.fragmentProgram.usedTimes===0&&this._releaseProgram(i.fragmentProgram),c=new Kr(a.fragmentShader,`fragment`,o),this.programs.fragment.set(a.fragmentShader,c),n.createProgram(c));let l=this._getRenderCacheKey(e,s,c),u=this.caches.get(l);u===void 0?(i&&i.usedTimes===0&&this._releasePipeline(i),u=this._getRenderPipeline(e,s,c,l,t)):e.pipeline=u,u.usedTimes++,s.usedTimes++,c.usedTimes++,r.pipeline=u}return r.pipeline}delete(e){let t=this.get(e).pipeline;return t&&(t.usedTimes--,t.usedTimes===0&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,t.computeProgram.usedTimes===0&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,t.vertexProgram.usedTimes===0&&this._releaseProgram(t.vertexProgram),t.fragmentProgram.usedTimes===0&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,n,r){n||=this._getComputeCacheKey(e,t);let i=this.caches.get(n);return i===void 0&&(i=new Wr(n,t),this.caches.set(n,i),this.backend.createComputePipeline(i,r)),i}_getRenderPipeline(e,t,n,r,i){r||=this._getRenderCacheKey(e,t,n);let a=this.caches.get(r);return a===void 0&&(a=new Ur(r,t,n),this.caches.set(r,a),e.pipeline=a,this.backend.createRenderPipeline(e,i)),a}_getComputeCacheKey(e,t){return e.id+`,`+t.id}_getRenderCacheKey(e,t,n){return t.id+`,`+n.id+`,`+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){let t=e.code,n=e.stage;this.programs[n].delete(t)}_needsComputeUpdate(e){let t=this.get(e);return t.pipeline===void 0||t.version!==e.version}_needsRenderUpdate(e){return this.get(e).pipeline===void 0||this.backend.needsRenderUpdate(e)}},Jr=class extends Mr{constructor(e,t,n,r,i,a){super(),this.backend=e,this.textures=n,this.pipelines=i,this.attributes=r,this.nodes=t,this.info=a,this.pipelines.bindings=this}getForRender(e){let t=e.getBindings();for(let e of t){let n=this.get(e);n.bindGroup===void 0&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}getForCompute(e){let t=this.nodes.getForCompute(e).bindings;for(let e of t){let n=this.get(e);n.bindGroup===void 0&&(this._init(e),this.backend.createBindings(e,t,0),n.bindGroup=e)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(let t of e)this._update(t,e)}_init(e){for(let t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){let e=t.attribute,n=e.isIndirectStorageBufferAttribute?Nr.INDIRECT:Nr.STORAGE;this.attributes.update(e,n)}}_update(e,t){let{backend:n}=this,r=!1,i=!0,a=0,o=0;for(let t of e.bindings)if(!(t.isNodeUniformsGroup&&this.nodes.updateGroup(t)===!1)){if(t.isStorageBuffer){let e=t.attribute,n=e.isIndirectStorageBufferAttribute?Nr.INDIRECT:Nr.STORAGE;this.attributes.update(e,n)}if(t.isUniformBuffer)t.update()&&n.updateBinding(t);else if(t.isSampledTexture){let e=t.update(),s=t.texture,c=this.textures.get(s);if(e&&(this.textures.updateTexture(s),t.generation!==c.generation&&(t.generation=c.generation,r=!0,i=!1)),n.get(s).externalTexture!==void 0||c.isDefaultTexture?i=!1:(a=a*10+s.id,o+=s.version),s.isStorageTexture===!0){let e=this.get(s);t.store===!0?e.needsMipmap=!0:this.textures.needsMipmaps(s)&&e.needsMipmap===!0&&(this.backend.generateMipmaps(s),e.needsMipmap=!1)}}else t.isSampler&&t.update()}r===!0&&this.backend.updateBindings(e,t,i?a:0,o)}};function Yr(e,t){return e.groupOrder===t.groupOrder?e.renderOrder===t.renderOrder?e.z===t.z?e.id-t.id:e.z-t.z:e.renderOrder-t.renderOrder:e.groupOrder-t.groupOrder}function Xr(e,t){return e.groupOrder===t.groupOrder?e.renderOrder===t.renderOrder?e.z===t.z?e.id-t.id:t.z-e.z:e.renderOrder-t.renderOrder:e.groupOrder-t.groupOrder}function Zr(e){return(e.transmission>0||e.transmissionNode)&&e.side===2&&e.forceSinglePass===!1}var Qr=class{constructor(e,t,n){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,n),this.lightsArray=[],this.scene=t,this.camera=n,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,n,r,i,a,o){let s=this.renderItems[this.renderItemsIndex];return s===void 0?(s={id:e.id,object:e,geometry:t,material:n,groupOrder:r,renderOrder:e.renderOrder,z:i,group:a,clippingContext:o},this.renderItems[this.renderItemsIndex]=s):(s.id=e.id,s.object=e,s.geometry=t,s.material=n,s.groupOrder=r,s.renderOrder=e.renderOrder,s.z=i,s.group=a,s.clippingContext=o),this.renderItemsIndex++,s}push(e,t,n,r,i,a,o){let s=this.getNextRenderItem(e,t,n,r,i,a,o);e.occlusionTest===!0&&this.occlusionQueryCount++,n.transparent===!0||n.transmission>0?(Zr(n)&&this.transparentDoublePass.push(s),this.transparent.push(s)):this.opaque.push(s)}unshift(e,t,n,r,i,a,o){let s=this.getNextRenderItem(e,t,n,r,i,a,o);n.transparent===!0||n.transmission>0?(Zr(n)&&this.transparentDoublePass.unshift(s),this.transparent.unshift(s)):this.opaque.unshift(s)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||Yr),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||Xr),this.transparent.length>1&&this.transparent.sort(t||Xr)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){let t=this.renderItems[e];if(t.id===null)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null,t.clippingContext=null}}},$r=[],ei=class{constructor(e){this.lighting=e,this.lists=new dr}get(e,t){let n=this.lists;$r[0]=e,$r[1]=t;let r=n.get($r);return r===void 0&&(r=new Qr(this.lighting,e,t),n.set($r,r)),$r.length=0,r}dispose(){this.lists=new dr}},ti=0,ni=class{constructor(){this.id=ti++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new s,this.scissor=!1,this.scissorValue=new s,this.renderTarget=null,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.activeMipmapLevel=0,this.sampleCount=1,this.width=0,this.height=0,this.occlusionQueryCount=0,this.clippingContext=null,this.isRenderContext=!0}getCacheKey(){return ri(this)}};function ri(e){let{textures:t,activeCubeFace:n,activeMipmapLevel:r}=e,i=[n,r];for(let e of t)i.push(e.id);return hr(i)}var ii=class extends it{constructor(){super(),this.isScene=!0,this.type=`Scene`,this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Ke,this.environmentIntensity=1,this.environmentRotation=new Ke,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<`u`&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent(`observe`,{detail:this}))}copy(e,t){return super.copy(e,t),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){let t=super.toJSON(e);return this.fog!==null&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),this.environmentIntensity!==1&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}},ai=[],oi=new ii,si=new mn,ci=class{constructor(){this.chainMaps={}}get(e,t,n=null){ai[0]=e,ai[1]=t;let r;if(n===null)r=`default`;else{let e=n.texture.format;r=`${n.textures.length}:${e}:${n.samples}:${n.depthBuffer}:${n.stencilBuffer}`}let i=this._getChainMap(r),a=i.get(ai);return a===void 0&&(a=new ni,i.set(ai,a)),ai.length=0,n!==null&&(a.sampleCount=n.samples===0?1:n.samples),a}getForClear(e=null){return this.get(oi,si,e)}_getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new dr)}dispose(){this.chainMaps={}}},li,ui=class{static getDataURL(e,t=`image/png`){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>`u`)return e.src;let n;if(e instanceof HTMLCanvasElement)n=e;else{li===void 0&&(li=Jn(`canvas`)),li.width=e.width,li.height=e.height;let t=li.getContext(`2d`);e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),n=li}return n.toDataURL(t)}static sRGBToLinear(e){if(typeof HTMLImageElement<`u`&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<`u`&&e instanceof HTMLCanvasElement||typeof ImageBitmap<`u`&&e instanceof ImageBitmap){let t=Jn(`canvas`);t.width=e.width,t.height=e.height;let n=t.getContext(`2d`);n.drawImage(e,0,0,e.width,e.height);let r=n.getImageData(0,0,e.width,e.height),i=r.data;for(let e=0;e<i.length;e++)i[e]=ar(i[e]/255)*255;return n.putImageData(r,0,0),t}else if(e.data){let t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(ar(t[e]/255)*255):t[e]=ar(t[e]);return{data:t,width:e.width,height:e.height}}else return console.warn(`THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied.`),e}},di=0,fi=class{constructor(e=null){this.isSource=!0,Object.defineProperty(this,`id`,{value:di++}),this.uuid=fn(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){let t=this.data;return typeof HTMLVideoElement<`u`&&t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight,0):t instanceof VideoFrame?e.set(t.displayHeight,t.displayWidth,0):t===null?e.set(0,0,0):e.set(t.width,t.height,t.depth||0),e}set needsUpdate(e){e===!0&&this.version++}toJSON(e){let t=e===void 0||typeof e==`string`;if(!t&&e.images[this.uuid]!==void 0)return e.images[this.uuid];let n={uuid:this.uuid,url:``},r=this.data;if(r!==null){let e;if(Array.isArray(r)){e=[];for(let t=0,n=r.length;t<n;t++)r[t].isDataTexture?e.push(pi(r[t].image)):e.push(pi(r[t]))}else e=pi(r);n.url=e}return t||(e.images[this.uuid]=n),n}};function pi(e){return typeof HTMLImageElement<`u`&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<`u`&&e instanceof HTMLCanvasElement||typeof ImageBitmap<`u`&&e instanceof ImageBitmap?ui.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn(`THREE.Texture: Unable to serialize Texture.`),{})}var mi=0,hi=new C,gi=class e extends be{constructor(t=e.DEFAULT_IMAGE,n=e.DEFAULT_MAPPING,r=Et,i=Et,a=Yt,o=ut,s=Ct,c=ge,l=e.DEFAULT_ANISOTROPY,u=``){super(),this.isTexture=!0,Object.defineProperty(this,`id`,{value:mi++}),this.uuid=fn(),this.name=``,this.source=new fi(t),this.mipmaps=[],this.mapping=n,this.channel=0,this.wrapS=r,this.wrapT=i,this.magFilter=a,this.minFilter=o,this.anisotropy=l,this.format=s,this.internalFormat=null,this.type=c,this.offset=new w(0,0),this.repeat=new w(1,1),this.center=new w(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new qe,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(hi).x}get height(){return this.source.getSize(hi).y}get depth(){return this.source.getSize(hi).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(let t in e){let n=e[t];if(n===void 0){console.warn(`THREE.Texture.setValues(): parameter '${t}' has value of undefined.`);continue}let r=this[t];if(r===void 0){console.warn(`THREE.Texture.setValues(): property '${t}' does not exist.`);continue}r&&n&&r.isVector2&&n.isVector2||r&&n&&r.isVector3&&n.isVector3||r&&n&&r.isMatrix3&&n.isMatrix3?r.copy(n):this[t]=n}}toJSON(e){let t=e===void 0||typeof e==`string`;if(!t&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];let n={metadata:{version:4.7,type:`Texture`,generator:`Texture.toJSON`},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:`dispose`})}transformUv(e){if(this.mapping!==300)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case fe:e.x-=Math.floor(e.x);break;case Et:e.x=e.x<0?0:1;break;case t:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x-=Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case fe:e.y-=Math.floor(e.y);break;case Et:e.y=e.y<0?0:1;break;case t:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y-=Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){e===!0&&this.pmremVersion++}};gi.DEFAULT_IMAGE=null,gi.DEFAULT_MAPPING=300,gi.DEFAULT_ANISOTROPY=1;var _i=class extends gi{constructor(e,t,n=an,r,i,a,o=Re,s=Re,c,l=Ln,u=1){if(l!==1026&&l!==1027)throw Error(`DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat`);super({width:e,height:t,depth:u},r,i,a,o,s,l,n,c),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new fi(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){let t=super.toJSON(e);return this.compareFunction!==null&&(t.compareFunction=this.compareFunction),t}},vi=new C,yi=class extends Mr{constructor(e,t,n){super(),this.renderer=e,this.backend=t,this.info=n}updateRenderTarget(e,t=0){let n=this.get(e),r=e.samples===0?1:e.samples,i=n.depthTextureMips||={},a=e.textures,o=this.getSize(a[0]),s=o.width>>t,c=o.height>>t,l=e.depthTexture||i[t],u=e.depthBuffer===!0||e.stencilBuffer===!0,d=!1;l===void 0&&u&&(l=new _i,l.format=e.stencilBuffer?1027:1026,l.type=e.stencilBuffer?1020:1014,l.image.width=s,l.image.height=c,l.image.depth=o.depth,l.isArrayTexture=e.multiview===!0&&o.depth>1,i[t]=l),(n.width!==o.width||o.height!==n.height)&&(d=!0,l&&(l.needsUpdate=!0,l.image.width=s,l.image.height=c,l.image.depth=l.isArrayTexture?l.image.depth:1)),n.width=o.width,n.height=o.height,n.textures=a,n.depthTexture=l||null,n.depth=e.depthBuffer,n.stencil=e.stencilBuffer,n.renderTarget=e,n.sampleCount!==r&&(d=!0,l&&(l.needsUpdate=!0),n.sampleCount=r);let f={sampleCount:r};if(e.isXRRenderTarget!==!0){for(let e=0;e<a.length;e++){let t=a[e];d&&(t.needsUpdate=!0),this.updateTexture(t,f)}l&&this.updateTexture(l,f)}if(n.initialized!==!0){n.initialized=!0;let t=()=>{e.removeEventListener(`dispose`,t);for(let e=0;e<a.length;e++)this._destroyTexture(a[e]);l&&this._destroyTexture(l),this.delete(e),this.backend.delete(e)};e.addEventListener(`dispose`,t)}}updateTexture(e,t={}){let n=this.get(e);if(n.initialized===!0&&n.version===e.version)return;let r=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,i=this.backend;if(r&&n.initialized===!0&&(i.destroySampler(e),i.destroyTexture(e)),e.isFramebufferTexture){let t=this.renderer.getRenderTarget();t?e.type=t.texture.type:e.type=ge}let{width:a,height:o,depth:s}=this.getSize(e);if(t.width=a,t.height=o,t.depth=s,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,a,o):1,e.isCubeTexture&&e.mipmaps.length>0&&t.levels++,r||e.isStorageTexture===!0||e.isExternalTexture===!0)i.createSampler(e),i.createTexture(e,t),n.generation=e.version;else if(n.initialized!==!0&&i.createSampler(e),e.version>0){let r=e.image;if(r===void 0)console.warn(`THREE.Renderer: Texture marked for update but image is undefined.`);else if(r.complete===!1)console.warn(`THREE.Renderer: Texture marked for update but image is incomplete.`);else{if(e.images){let n=[];for(let t of e.images)n.push(t);t.images=n}else t.image=r;(n.isDefaultTexture===void 0||n.isDefaultTexture===!0)&&(i.createTexture(e,t),n.isDefaultTexture=!1,n.generation=e.version),e.source.dataReady===!0&&i.updateTexture(e,t),t.needsMipmaps&&e.mipmaps.length===0&&i.generateMipmaps(e),e.onUpdate&&e.onUpdate(e)}}else i.createDefaultTexture(e),n.isDefaultTexture=!0,n.generation=e.version;if(n.initialized!==!0){n.initialized=!0,n.generation=e.version,this.info.memory.textures++,e.isVideoTexture&&Zn.getTransfer(e.colorSpace)!==`srgb`&&console.warn(`WebGPURenderer: Video textures must use a color space with a sRGB transfer function, e.g. SRGBColorSpace.`);let t=()=>{e.removeEventListener(`dispose`,t),this._destroyTexture(e)};e.addEventListener(`dispose`,t)}n.version=e.version}getSize(e,t=vi){let n=e.images?e.images[0]:e.image;return n?(n.image!==void 0&&(n=n.image),typeof HTMLVideoElement<`u`&&n instanceof HTMLVideoElement?(t.width=n.videoWidth||1,t.height=n.videoHeight||1,t.depth=1):n instanceof VideoFrame?(t.width=n.displayWidth||1,t.height=n.displayHeight||1,t.depth=1):(t.width=n.width||1,t.height=n.height||1,t.depth=e.isCubeTexture?6:n.depth||1)):t.width=t.height=t.depth=1,t}getMipLevels(e,t,n){let r;return r=e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture===!0?1:Math.floor(Math.log2(Math.max(t,n)))+1,r}needsMipmaps(e){return e.generateMipmaps===!0||e.mipmaps.length>0}_destroyTexture(e){this.has(e)===!0&&(this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e),this.info.memory.textures--)}},bi=class extends T{constructor(e,t,n,r=1){super(e,t,n),this.a=r}set(e,t,n,r=1){return this.a=r,super.set(e,t,n)}copy(e){return e.a!==void 0&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}},xi={VERTEX:`vertex`},E={NONE:`none`,FRAME:`frame`,RENDER:`render`,OBJECT:`object`},Si={READ_ONLY:`readOnly`,WRITE_ONLY:`writeOnly`,READ_WRITE:`readWrite`},Ci=[`fragment`,`vertex`],wi=[`setup`,`analyze`,`generate`],Ti=[...Ci,`compute`],Ei=[`x`,`y`,`z`,`w`],Di={analyze:`setup`,generate:`analyze`},Oi=0,D=class extends be{static get type(){return`Node`}constructor(e=null){super(),this.nodeType=e,this.updateType=E.NONE,this.updateBeforeType=E.NONE,this.updateAfterType=E.NONE,this.uuid=Lt.generateUUID(),this.version=0,this.global=!1,this.parents=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,`id`,{value:Oi++})}set needsUpdate(e){e===!0&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this),this}onFrameUpdate(e){return this.onUpdate(e,E.FRAME)}onRenderUpdate(e){return this.onUpdate(e,E.RENDER)}onObjectUpdate(e){return this.onUpdate(e,E.OBJECT)}onReference(e){return this.updateReference=e.bind(this),this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(let{childNode:e}of vr(this))yield e}dispose(){this.dispatchEvent({type:`dispose`})}traverse(e){e(this);for(let t of this.getChildren())t.traverse(e)}getCacheKey(e=!1){return e||=this.version!==this._cacheKeyVersion,(e===!0||this._cacheKey===null)&&(this._cacheKey=gr(_r(this,e),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){let t=this.getNodeType(e);return e.getElementType(t)}getMemberType(){return`void`}getNodeType(e){let t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){let t=this.getHash(e);return e.getNodeFromHash(t)||this}getArrayCount(){return null}setup(e){let t=e.getNodeProperties(this),n=0;for(let e of this.getChildren())t[`node`+ n++]=e;return t.outputNode||null}analyze(e,t=null){let n=e.increaseUsage(this);if(this.parents===!0){let n=e.getDataFromNode(this,`any`);n.stages=n.stages||{},n.stages[e.shaderStage]=n.stages[e.shaderStage]||[],n.stages[e.shaderStage].push(t)}if(n===1){let t=e.getNodeProperties(this);for(let n of Object.values(t))n&&n.isNode===!0&&n.build(e,this)}}generate(e,t){let{outputNode:n}=e.getNodeProperties(this);if(n&&n.isNode===!0)return n.build(e,t)}updateBefore(){console.warn(`Abstract function.`)}updateAfter(){console.warn(`Abstract function.`)}update(){console.warn(`Abstract function.`)}build(e,t=null){let n=this.getShared(e);if(this!==n)return n.build(e,t);let r=e.getDataFromNode(this);r.buildStages=r.buildStages||{},r.buildStages[e.buildStage]=!0;let i=Di[e.buildStage];if(i&&r.buildStages[i]!==!0){let t=e.getBuildStage();e.setBuildStage(i),this.build(e),e.setBuildStage(t)}e.addNode(this),e.addChain(this);let a=null,o=e.getBuildStage();if(o===`setup`){this.updateReference(e);let t=e.getNodeProperties(this);if(t.initialized!==!0){t.initialized=!0,t.outputNode=this.setup(e)||t.outputNode||null;for(let n of Object.values(t))if(n&&n.isNode===!0){if(n.parents===!0){let t=e.getNodeProperties(n);t.parents=t.parents||[],t.parents.push(this)}n.build(e)}}a=t.outputNode}else if(o===`analyze`)this.analyze(e,t);else if(o===`generate`){if(this.generate.length===1){let n=this.getNodeType(e),r=e.getDataFromNode(this);a=r.snippet,a===void 0?r.generated===void 0?(r.generated=!0,a=this.generate(e)||``,r.snippet=a):(console.warn(`THREE.Node: Recursion detected.`,this),a=`/* Recursion detected. */`):r.flowCodes!==void 0&&e.context.nodeBlock!==void 0&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),a=e.format(a,n,t)}else a=this.generate(e,t)||``;a===``&&t!==null&&t!==`void`&&t!==`OutputType`&&(console.error(`THREE.TSL: Invalid generated code, expected a "${t}".`),a=e.generateConst(t))}return e.removeChain(this),e.addSequentialNode(this),a}getSerializeChildren(){return vr(this)}serialize(e){let t=this.getSerializeChildren(),n={};for(let{property:r,index:i,childNode:a}of t)i===void 0?n[r]=a.toJSON(e.meta).uuid:(n[r]===void 0&&(n[r]=Number.isInteger(i)?[]:{}),n[r][i]=a.toJSON(e.meta).uuid);Object.keys(n).length>0&&(e.inputNodes=n)}deserialize(e){if(e.inputNodes!==void 0){let t=e.meta.nodes;for(let n in e.inputNodes)if(Array.isArray(e.inputNodes[n])){let r=[];for(let i of e.inputNodes[n])r.push(t[i]);this[n]=r}else if(typeof e.inputNodes[n]==`object`){let r={};for(let i in e.inputNodes[n])r[i]=t[e.inputNodes[n][i]];this[n]=r}else this[n]=t[e.inputNodes[n]]}}toJSON(e){let{uuid:t,type:n}=this,r=e===void 0||typeof e==`string`;r&&(e={textures:{},images:{},nodes:{}});let i=e.nodes[t];i===void 0&&(i={uuid:t,type:n,meta:e,metadata:{version:4.7,type:`Node`,generator:`Node.toJSON`}},r!==!0&&(e.nodes[i.uuid]=i),this.serialize(i),delete i.meta);function a(e){let t=[];for(let n in e){let r=e[n];delete r.metadata,t.push(r)}return t}if(r){let t=a(e.textures),n=a(e.images),r=a(e.nodes);t.length>0&&(i.textures=t),n.length>0&&(i.images=n),r.length>0&&(i.nodes=r)}return i}},ki=class extends D{static get type(){return`TempNode`}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if(e.getBuildStage()===`generate`){let n=e.getVectorType(this.getNodeType(e,t)),r=e.getDataFromNode(this);if(r.propertyName!==void 0)return e.format(r.propertyName,n,t);if(n!==`void`&&t!==`void`&&this.hasDependencies(e)){let i=super.build(e,n),a=e.getVarFromNode(this,null,n),o=e.getPropertyName(a);return e.addLineFlowCode(`${o} = ${i}`,this),r.snippet=i,r.propertyName=o,e.format(r.propertyName,n,t)}}return super.build(e,t)}},Ai=class extends D{static get type(){return`ArrayElementNode`}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){let t=this.indexNode.getNodeType(e);return`${this.node.build(e)}[ ${this.indexNode.build(e,!e.isVector(t)&&e.isInteger(t)?t:`uint`)} ]`}},ji=class extends D{static get type(){return`ConvertNode`}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){let t=this.node.getNodeType(e),n=null;for(let r of this.convertTo.split(`|`))(n===null||e.getTypeLength(t)===e.getTypeLength(r))&&(n=r);return n}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){let n=this.node,r=this.getNodeType(e),i=n.build(e,r);return e.format(i,r,t)}},Mi=class extends ki{static get type(){return`JoinNode`}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return this.nodeType===null?e.getTypeFromLength(this.nodes.reduce((t,n)=>t+e.getTypeLength(n.getNodeType(e)),0)):e.getVectorType(this.nodeType)}generate(e,t){let n=this.getNodeType(e),r=e.getTypeLength(n),i=this.nodes,a=e.getComponentType(n),o=[],s=0;for(let t of i){if(s>=r){console.error(`THREE.TSL: Length of parameters exceeds maximum length of function '${n}()' type.`);break}let i=t.getNodeType(e),c=e.getTypeLength(i),l;if(s+c>r&&(console.error(`THREE.TSL: Length of '${n}()' data exceeds maximum length of output type.`),c=r-s,i=e.getTypeFromLength(c)),s+=c,l=t.build(e,i),e.getComponentType(i)!==a){let t=e.getTypeFromLength(c,a);l=e.format(l,i,t)}o.push(l)}let c=`${e.getType(n)}( ${o.join(`, `)} )`;return e.format(c,n,t)}},Ni=Ei.join(``),Pi=class extends D{static get type(){return`SplitNode`}constructor(e,t=`x`){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(let t of this.components)e=Math.max(Ei.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}getScope(){return this.node.getScope()}generate(e,t){let n=this.node,r=e.getTypeLength(n.getNodeType(e)),i=null;if(r>1){let a=null;this.getVectorLength()>=r&&(a=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));let o=n.build(e,a);i=this.components.length===r&&this.components===Ni.slice(0,this.components.length)?e.format(o,a,t):e.format(`${o}.${this.components}`,this.getNodeType(e),t)}else i=n.build(e,t);return i}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}},Fi=class extends ki{static get type(){return`SetNode`}constructor(e,t,n){super(),this.sourceNode=e,this.components=t,this.targetNode=n}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){let{sourceNode:t,components:n,targetNode:r}=this,i=this.getNodeType(e),a=e.getComponentType(r.getNodeType(e)),o=e.getTypeFromLength(n.length,a),s=r.build(e,o),c=t.build(e,i),l=e.getTypeLength(i),u=[];for(let e=0;e<l;e++){let t=Ei[e];t===n[0]?(u.push(s),e+=n.length-1):u.push(c+`.`+t)}return`${e.getType(i)}( ${u.join(`, `)} )`}},Ii=class extends ki{static get type(){return`FlipNode`}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){let{components:t,sourceNode:n}=this,r=this.getNodeType(e),i=n.build(e),a=e.getVarFromNode(this),o=e.getPropertyName(a);e.addLineFlowCode(o+` = `+i,this);let s=e.getTypeLength(r),c=[],l=0;for(let e=0;e<s;e++){let n=Ei[e];n===t[l]?(c.push(`1.0 - `+(o+`.`+n)),l++):c.push(o+`.`+n)}return`${e.getType(r)}( ${c.join(`, `)} )`}},Li=class extends D{static get type(){return`InputNode`}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return this.nodeType===null?Sr(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=Sr(this.value),e.nodeType=this.nodeType,e.valueType===`ArrayBuffer`&&(e.value=Tr(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?Cr(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn(`Abstract function.`)}},Ri=/float|u?int/,zi=class extends Li{static get type(){return`ConstNode`}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){let n=this.getNodeType(e);return Ri.test(n)&&Ri.test(t)?e.generateConst(t,this.value):e.format(this.generateConst(e),n,t)}},Bi=class extends D{static get type(){return`MemberNode`}constructor(e,t){super(),this.structNode=e,this.property=t,this.isMemberNode=!0}hasMember(e){return this.structNode.isMemberNode&&this.structNode.hasMember(e)===!1?!1:this.structNode.getMemberType(e,this.property)!==`void`}getNodeType(e){return this.hasMember(e)===!1?`float`:this.structNode.getMemberType(e,this.property)}getMemberType(e,t){if(this.hasMember(e)===!1)return`float`;let n=this.getNodeType(e);return e.getStructTypeNode(n).getMemberType(e,t)}generate(e){if(this.hasMember(e)===!1){console.warn(`THREE.TSL: Member "${this.property}" does not exist in struct.`);let t=this.getNodeType(e);return e.generateConst(t)}return this.structNode.build(e)+`.`+this.property}},Vi=null,Hi=new Map;function O(e,t){if(Hi.has(e)){console.warn(`THREE.TSL: Redefinition of method chaining '${e}'.`);return}if(typeof t!=`function`)throw Error(`THREE.TSL: Node element ${e} is not a function`);Hi.set(e,t),e!==`assign`&&(D.prototype[e]=function(...e){return this.isStackNode?this.add(t(...e)):t(this,...e)},D.prototype[e+`Assign`]=function(...e){return this.isStackNode?this.assign(e[0],t(...e)):this.assign(t(this,...e))})}var Ui=e=>e.replace(/r|s/g,`x`).replace(/g|t/g,`y`).replace(/b|p/g,`z`).replace(/a|q/g,`w`),Wi=e=>Ui(e).split(``).sort().join(``);D.prototype.assign=function(...e){if(this.isStackNode!==!0)return Vi===null?console.error(`THREE.TSL: No stack defined for assign operation. Make sure the assign is inside a Fn().`):Vi.assign(this,...e),this;{let t=Hi.get(`assign`);return this.add(t(...e))}},D.prototype.toVarIntent=function(){return this},D.prototype.get=function(e){return new Bi(this,e)};var Gi={};function Ki(e,t,n){Gi[e]=Gi[t]=Gi[n]={get(){this._cache=this._cache||{};let t=this._cache[e];return t===void 0&&(t=new Pi(this,e),this._cache[e]=t),t},set(t){this[e].assign(k(t))}};let r=e.toUpperCase(),i=t.toUpperCase(),a=n.toUpperCase();D.prototype[`set`+r]=D.prototype[`set`+i]=D.prototype[`set`+a]=function(t){let n=Wi(e);return new Fi(this,n,k(t))},D.prototype[`flip`+r]=D.prototype[`flip`+i]=D.prototype[`flip`+a]=function(){let t=Wi(e);return new Ii(this,t)}}var qi=[`x`,`y`,`z`,`w`],Ji=[`r`,`g`,`b`,`a`],Yi=[`s`,`t`,`p`,`q`];for(let e=0;e<4;e++){let t=qi[e],n=Ji[e],r=Yi[e];Ki(t,n,r);for(let i=0;i<4;i++){t=qi[e]+qi[i],n=Ji[e]+Ji[i],r=Yi[e]+Yi[i],Ki(t,n,r);for(let a=0;a<4;a++){t=qi[e]+qi[i]+qi[a],n=Ji[e]+Ji[i]+Ji[a],r=Yi[e]+Yi[i]+Yi[a],Ki(t,n,r);for(let o=0;o<4;o++)t=qi[e]+qi[i]+qi[a]+qi[o],n=Ji[e]+Ji[i]+Ji[a]+Ji[o],r=Yi[e]+Yi[i]+Yi[a]+Yi[o],Ki(t,n,r)}}}for(let e=0;e<32;e++)Gi[e]={get(){this._cache=this._cache||{};let t=this._cache[e];return t===void 0&&(t=new Ai(this,new zi(e,`uint`)),this._cache[e]=t),t},set(t){this[e].assign(k(t))}};Object.defineProperties(D.prototype,Gi);var Xi=new WeakMap,Zi=function(e,t=null){let n=Sr(e);return n===`node`?e:t===null&&(n===`float`||n===`boolean`)||n&&n!==`shader`&&n!==`string`?k(ga(e,t)):n===`shader`?e.isFn?e:N(e):e},Qi=function(e,t=null){for(let n in e)e[n]=k(e[n],t);return e},$i=function(e,t=null){let n=e.length;for(let r=0;r<n;r++)e[r]=k(e[r],t);return e},ea=function(e,t=null,n=null,r=null){function i(e){return r===null?e=k(e):(e=k(Object.assign(e,r)),r.intent===!0&&(e=e.toVarIntent())),e}let a,o=t,s,c;function l(t){let n;return n=o?/[a-z]/i.test(o)?o+`()`:o:e.type,s!==void 0&&t.length<s?(console.error(`THREE.TSL: "${n}" parameter length is less than minimum required.`),t.concat(Array(s-t.length).fill(0))):c!==void 0&&t.length>c?(console.error(`THREE.TSL: "${n}" parameter length exceeds limit.`),t.slice(0,c)):t}return t===null?a=(...t)=>i(new e(...Ca(l(t)))):n===null?a=(...n)=>i(new e(t,...Ca(l(n)))):(n=k(n),a=(...r)=>i(new e(t,...Ca(l(r)),n))),a.setParameterLength=(...e)=>(e.length===1?s=c=e[0]:e.length===2&&([s,c]=e),a),a.setName=e=>(o=e,a),a},ta=function(e,...t){return k(new e(...Ca(t)))},na=class extends D{constructor(e,t){super(),this.shaderNode=e,this.rawInputs=t,this.isShaderCallNodeInternal=!0}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}getMemberType(e,t){return this.getOutputNode(e).getMemberType(e,t)}call(e){let{shaderNode:t,rawInputs:n}=this,r=e.getNodeProperties(t),i=e.getClosestSubBuild(t.subBuilds)||``,a=i||`default`;if(r[a])return r[a];let o=e.subBuildFn;e.subBuildFn=i;let s=null;if(t.layout){let r=Xi.get(e.constructor);r===void 0&&(r=new WeakMap,Xi.set(e.constructor,r));let i=r.get(t);i===void 0&&(i=k(e.buildFunctionNode(t)),r.set(t,i)),e.addInclude(i);let a=n?ra(n):null;s=k(i.call(a))}else{let r=new Proxy(e,{get:(e,t,n)=>{let r;return r=Symbol.iterator===t?function*(){yield void 0}:Reflect.get(e,t,n),r}}),i=n?ia(n):null,a=Array.isArray(n)?n.length>0:n!==null,o=t.jsFunc;s=k(a||o.length>1?o(i,r):o(r))}return e.subBuildFn=o,t.once&&(r[a]=s),s}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}getOutputNode(e){let t=e.getNodeProperties(this),n=e.getSubBuildOutput(this);return t[n]=t[n]||this.setupOutput(e),t[n].subBuild=e.getClosestSubBuild(this),t[n]}build(e,t=null){let n=null,r=e.getBuildStage(),i=e.getNodeProperties(this),a=e.getSubBuildOutput(this),o=this.getOutputNode(e);if(r===`setup`){let t=e.getSubBuildProperty(`initialized`,this);if(i[t]!==!0&&(i[t]=!0,i[a]=this.getOutputNode(e),i[a].build(e),this.shaderNode.subBuilds))for(let t of e.chaining){let n=e.getDataFromNode(t,`any`);n.subBuilds=n.subBuilds||new Set;for(let e of this.shaderNode.subBuilds)n.subBuilds.add(e)}n=i[a]}else r===`analyze`?o.build(e,t):r===`generate`&&(n=o.build(e,t)||``);return n}};function ra(e){let t;return Sa(e),t=e[0]&&(e[0].isNode||Object.getPrototypeOf(e[0])!==Object.prototype)?[...e]:e[0],t}function ia(e){let t=0;return Sa(e),new Proxy(e,{get:(n,r,i)=>{let a;if(r===`length`)return a=e.length,a;if(Symbol.iterator===r)a=function*(){for(let t of e)yield k(t)};else{if(e.length>0)if(Object.getPrototypeOf(e[0])===Object.prototype){let n=e[0];a=n[r]===void 0?n[t++]:Reflect.get(n,r,i)}else e[0]instanceof D&&(a=e[r]===void 0?e[t++]:Reflect.get(e,r,i));else a=Reflect.get(n,r,i);a=k(a)}return a}})}var aa=class extends D{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1}setLayout(e){return this.layout=e,this}call(e=null){return k(new na(this,e))}setup(){return this.call()}},oa=[!1,!0],sa=[0,1,2,3],ca=[-1,-2],la=[.5,1.5,1/3,1e-6,1e6,Math.PI,Math.PI*2,1/Math.PI,2/Math.PI,1/(Math.PI*2),Math.PI/2],ua=new Map;for(let e of oa)ua.set(e,new zi(e));var da=new Map;for(let e of sa)da.set(e,new zi(e,`uint`));var fa=new Map([...da].map(e=>new zi(e.value,`int`)));for(let e of ca)fa.set(e,new zi(e,`int`));var pa=new Map([...fa].map(e=>new zi(e.value)));for(let e of la)pa.set(e,new zi(e));for(let e of la)pa.set(-e,new zi(-e));var ma={bool:ua,uint:da,ints:fa,float:pa},ha=new Map([...ua,...pa]),ga=(e,t)=>ha.has(e)?ha.get(e):e.isNode===!0?e:new zi(e,t),_a=function(e,t=null){return(...n)=>{for(let t of n)if(t===void 0)return console.error(`THREE.TSL: Invalid parameter for the type "${e}".`),k(new zi(0,e));if((n.length===0||![`bool`,`float`,`int`,`uint`].includes(e)&&n.every(e=>{let t=typeof e;return t!==`object`&&t!==`function`}))&&(n=[Cr(e,...n)]),n.length===1&&t!==null&&t.has(n[0]))return xa(t.get(n[0]));if(n.length===1){let t=ga(n[0],e);return t.nodeType===e?xa(t):xa(new ji(t,e))}return xa(new Mi(n.map(e=>ga(e)),e))}},va=e=>typeof e==`object`&&e?e.value:e,ya=e=>e==null?null:e.nodeType||e.convertTo||(typeof e==`string`?e:null);function ba(e,t){return new aa(e,t)}var k=(e,t=null)=>Zi(e,t),xa=(e,t=null)=>k(e,t).toVarIntent(),Sa=(e,t=null)=>new Qi(e,t),Ca=(e,t=null)=>new $i(e,t),A=(e,t=null,n=null,r=null)=>new ea(e,t,n,r),j=(e,...t)=>new ta(e,...t),M=(e,t=null,n=null,r={})=>new ea(e,t,n,{intent:!0,...r}),wa=0,Ta=class extends D{constructor(e,t=null){super();let n=null;t!==null&&(typeof t==`object`?n=t.return:(typeof t==`string`?n=t:console.error(`THREE.TSL: Invalid layout type.`),t=null)),this.shaderNode=new ba(e,n),t!==null&&this.setLayout(t),this.isFn=!0}setLayout(e){let t=this.shaderNode.nodeType;if(typeof e.inputs!=`object`){let n={name:`fn`+ wa++,type:t,inputs:[]};for(let t in e)t!==`return`&&n.inputs.push({name:t,type:e[t]});e=n}return this.shaderNode.setLayout(e),this}getNodeType(e){return this.shaderNode.getNodeType(e)||`float`}call(...e){let t=this.shaderNode.call(e);return this.shaderNode.nodeType===`void`&&t.toStack(),t.toVarIntent()}once(e=null){return this.shaderNode.once=!0,this.shaderNode.subBuilds=e,this}generate(e){let t=this.getNodeType(e);return console.error(`THREE.TSL: "Fn()" was declared but not invoked. Try calling it like "Fn()( ...params )".`),e.generateConst(t)}};function N(e,t=null){let n=new Ta(e,t);return new Proxy(()=>{},{apply(e,t,r){return n.call(...r)},get(e,t,r){return Reflect.get(n,t,r)},set(e,t,r,i){return Reflect.set(n,t,r,i)}})}var Ea=e=>{Vi=e},Da=()=>Vi,Oa=(...e)=>Vi.If(...e);function ka(e){return Vi&&Vi.add(e),e}O(`toStack`,ka);var Aa=new _a(`color`),P=new _a(`float`,ma.float),F=new _a(`int`,ma.ints),ja=new _a(`uint`,ma.uint),Ma=new _a(`bool`,ma.bool),I=new _a(`vec2`),Na=new _a(`ivec2`),Pa=new _a(`uvec2`),Fa=new _a(`bvec2`),L=new _a(`vec3`),Ia=new _a(`ivec3`),La=new _a(`uvec3`),Ra=new _a(`bvec3`),R=new _a(`vec4`),za=new _a(`ivec4`),Ba=new _a(`uvec4`),Va=new _a(`bvec4`),Ha=new _a(`mat2`),Ua=new _a(`mat3`),Wa=new _a(`mat4`);O(`toColor`,Aa),O(`toFloat`,P),O(`toInt`,F),O(`toUint`,ja),O(`toBool`,Ma),O(`toVec2`,I),O(`toIVec2`,Na),O(`toUVec2`,Pa),O(`toBVec2`,Fa),O(`toVec3`,L),O(`toIVec3`,Ia),O(`toUVec3`,La),O(`toBVec3`,Ra),O(`toVec4`,R),O(`toIVec4`,za),O(`toUVec4`,Ba),O(`toBVec4`,Va),O(`toMat2`,Ha),O(`toMat3`,Ua),O(`toMat4`,Wa),O(`element`,A(Ai).setParameterLength(2)),O(`convert`,(e,t)=>k(new ji(k(e),t))),O(`append`,e=>(console.warn(`THREE.TSL: .append() has been renamed to .toStack().`),ka(e))),O(`assign`,A(class extends ki{static get type(){return`AssignNode`}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(e,t){return t===`void`?`void`:this.targetNode.getNodeType(e)}needsSplitAssign(e){let{targetNode:t}=this;if(e.isAvailable(`swizzleAssign`)===!1&&t.isSplitNode&&t.components.length>1){let n=e.getTypeLength(t.node.getNodeType(e));return Ei.join(``).slice(0,n)!==t.components}return!1}setup(e){let{targetNode:t,sourceNode:n}=this,r=t.getScope(),i=e.getNodeProperties(r);i.assign=!0;let a=e.getNodeProperties(this);a.sourceNode=n,a.targetNode=t.context({assign:!0})}generate(e,t){let{targetNode:n,sourceNode:r}=e.getNodeProperties(this),i=this.needsSplitAssign(e),a=n.build(e),o=n.getNodeType(e),s=r.build(e,o),c=r.getNodeType(e),l=e.getDataFromNode(this),u;if(l.initialized===!0)t!==`void`&&(u=a);else if(i){let r=e.getVarFromNode(this,null,o),i=e.getPropertyName(r);e.addLineFlowCode(`${i} = ${s}`,this);let c=n.node,l=c.node.context({assign:!0}).build(e);for(let t=0;t<c.components.length;t++){let n=c.components[t];e.addLineFlowCode(`${l}.${n} = ${i}[ ${t} ]`,this)}t!==`void`&&(u=a)}else u=`${a} = ${s}`,(t===`void`||c===`void`)&&(e.addLineFlowCode(u,this),t!==`void`&&(u=a));return l.initialized=!0,e.format(u,o,t)}}).setParameterLength(2));var Ga=class extends ki{static get type(){return`ArrayNode`}constructor(e,t,n=null){super(e),this.count=t,this.values=n,this.isArrayNode=!0}getArrayCount(){return this.count}getNodeType(e){return this.nodeType===null&&(this.nodeType=this.values[0].getNodeType(e)),this.nodeType}getElementType(e){return this.getNodeType(e)}generate(e){let t=this.getNodeType(e);return e.generateArray(t,this.count,this.values)}},Ka=(...e)=>{let t;if(e.length===1){let n=e[0];t=new Ga(null,n.length,n)}else{let n=e[0],r=e[1];t=new Ga(n,r)}return k(t)};O(`toArray`,(e,t)=>Ka(Array(t).fill(e)));var qa=class extends D{static get type(){return`UniformGroupNode`}constructor(e,t=!1,n=1){super(`string`),this.name=e,this.shared=t,this.order=n,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}},Ja=e=>new qa(e),Ya=(e,t=0)=>new qa(e,!0,t),Xa=Ya(`frame`),z=Ya(`render`),Za=Ja(`object`),Qa=class extends Li{static get type(){return`UniformNode`}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name=``,this.groupNode=Za}setName(e){return this.name=e,this}label(e){return console.warn(`THREE.TSL: "label()" has been deprecated. Use "setName()" instead.`),this.setName(e)}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){return e=e.bind(this),super.onUpdate(t=>{let n=e(t,this);n!==void 0&&(this.value=n)},t)}getInputType(e){let t=super.getInputType(e);return t===`bool`&&(t=`uint`),t}generate(e,t){let n=this.getNodeType(e),r=this.getUniformHash(e),i=e.getNodeFromHash(r);i===void 0&&(e.setHashNode(this,r),i=this);let a=i.getInputType(e),o=e.getUniformFromNode(i,a,e.shaderStage,this.name||e.context.nodeName),s=e.getPropertyName(o);e.context.nodeName!==void 0&&delete e.context.nodeName;let c=s;if(n===`bool`){let t=e.getDataFromNode(this),r=t.propertyName;if(r===void 0){let i=e.getVarFromNode(this,null,`bool`);r=e.getPropertyName(i),t.propertyName=r,c=e.format(s,a,n),e.addLineFlowCode(`${r} = ${c}`,this)}c=r}return e.format(c,n,t)}},B=(e,t)=>{let n=ya(t||e);return n===e&&(e=Cr(n)),e=e&&e.isNode===!0?e.node&&e.node.value||e.value:e,k(new Qa(e,n))},V=class extends D{static get type(){return`PropertyNode`}constructor(e,t=null,n=!1){super(e),this.name=t,this.varying=n,this.isPropertyNode=!0,this.global=!0}getHash(e){return this.name||super.getHash(e)}generate(e){let t;return this.varying===!0?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}},$a=(e,t)=>k(new V(e,t)),eo=(e,t)=>k(new V(e,t,!0)),H=j(V,`vec4`,`DiffuseColor`),to=j(V,`vec3`,`EmissiveColor`),no=j(V,`float`,`Roughness`),ro=j(V,`float`,`Metalness`),io=j(V,`float`,`Clearcoat`),ao=j(V,`float`,`ClearcoatRoughness`),oo=j(V,`vec3`,`Sheen`),so=j(V,`float`,`SheenRoughness`),co=j(V,`float`,`Iridescence`),lo=j(V,`float`,`IridescenceIOR`),uo=j(V,`float`,`IridescenceThickness`),fo=j(V,`float`,`AlphaT`),po=j(V,`float`,`Anisotropy`),mo=j(V,`vec3`,`AnisotropyT`),ho=j(V,`vec3`,`AnisotropyB`),go=j(V,`color`,`SpecularColor`),_o=j(V,`float`,`SpecularF90`),vo=j(V,`float`,`Shininess`),yo=j(V,`vec4`,`Output`),bo=j(V,`float`,`dashSize`),xo=j(V,`float`,`gapSize`),So=j(V,`float`,`IOR`),Co=j(V,`float`,`Transmission`),wo=j(V,`float`,`Thickness`),To=j(V,`float`,`AttenuationDistance`),Eo=j(V,`color`,`AttenuationColor`),Do=j(V,`float`,`Dispersion`),Oo=class extends ki{static get type(){return`FunctionCallNode`}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}getMemberType(e,t){return this.functionNode.getMemberType(e,t)}generate(e){let t=[],n=this.functionNode,r=n.getInputs(e),i=this.parameters,a=(t,n)=>{let r=n.type,i=r===`pointer`,a;return a=i?`&`+t.build(e):t.build(e,r),a};if(Array.isArray(i)){if(i.length>r.length)console.error(`THREE.TSL: The number of provided parameters exceeds the expected number of inputs in 'Fn()'.`),i.length=r.length;else if(i.length<r.length)for(console.error(`THREE.TSL: The number of provided parameters is less than the expected number of inputs in 'Fn()'.`);i.length<r.length;)i.push(P(0));for(let e=0;e<i.length;e++)t.push(a(i[e],r[e]))}else for(let e of r){let n=i[e.name];n===void 0?(console.error(`THREE.TSL: Input '${e.name}' not found in 'Fn()'.`),t.push(a(P(0),e))):t.push(a(n,e))}return`${n.build(e,`property`)}( ${t.join(`, `)} )`}};O(`call`,(e,...t)=>(t=t.length>1||t[0]&&t[0].isNode===!0?Ca(t):Sa(t[0]),k(new Oo(k(e),t))));var ko={"==":`equal`,"!=":`notEqual`,"<":`lessThan`,">":`greaterThan`,"<=":`lessThanEqual`,">=":`greaterThanEqual`,"%":`mod`},Ao=class e extends ki{static get type(){return`OperatorNode`}constructor(t,n,r,...i){if(super(),i.length>0){let a=new e(t,n,r);for(let n=0;n<i.length-1;n++)a=new e(t,a,i[n]);n=a,r=i[i.length-1]}this.op=t,this.aNode=n,this.bNode=r,this.isOperatorNode=!0}getOperatorMethod(e,t){return e.getMethod(ko[this.op],t)}getNodeType(e,t=null){let n=this.op,r=this.aNode,i=this.bNode,a=r.getNodeType(e),o=i?i.getNodeType(e):null;if(a===`void`||o===`void`)return t||`void`;if(n===`%`)return a;if(n===`~`||n===`&`||n===`|`||n===`^`||n===`>>`||n===`<<`)return e.getIntegerType(a);if(n===`!`||n===`&&`||n===`||`||n===`^^`)return`bool`;if(n===`==`||n===`!=`||n===`<`||n===`>`||n===`<=`||n===`>=`){let t=Math.max(e.getTypeLength(a),e.getTypeLength(o));return t>1?`bvec${t}`:`bool`}else{if(e.isMatrix(a)){if(o===`float`)return a;if(e.isVector(o))return e.getVectorFromMatrix(a);if(e.isMatrix(o))return a}else if(e.isMatrix(o)){if(a===`float`)return o;if(e.isVector(a))return e.getVectorFromMatrix(o)}return e.getTypeLength(o)>e.getTypeLength(a)?o:a}}generate(e,t){let n=this.op,{aNode:r,bNode:i}=this,a=this.getNodeType(e,t),o=null,s=null;a===`void`?o=s=a:(o=r.getNodeType(e),s=i?i.getNodeType(e):null,n===`<`||n===`>`||n===`<=`||n===`>=`||n===`==`||n===`!=`?e.isVector(o)?s=o:e.isVector(s)?o=s:o!==s&&(o=s=`float`):n===`>>`||n===`<<`?(o=a,s=e.changeComponentType(s,`uint`)):n===`%`?(o=a,s=e.isInteger(o)&&e.isInteger(s)?s:o):e.isMatrix(o)?s===`float`?s=`float`:e.isVector(s)?s=e.getVectorFromMatrix(o):e.isMatrix(s)||(o=s=a):o=e.isMatrix(s)?o===`float`?`float`:e.isVector(o)?e.getVectorFromMatrix(s):s=a:s=a);let c=r.build(e,o),l=i?i.build(e,s):null,u=e.getFunctionOperator(n);if(t!==`void`){let r=e.renderer.coordinateSystem===Xt;if(n===`==`||n===`!=`||n===`<`||n===`>`||n===`<=`||n===`>=`)return r&&e.isVector(o)?e.format(`${this.getOperatorMethod(e,t)}( ${c}, ${l} )`,a,t):e.format(`( ${c} ${n} ${l} )`,a,t);if(n===`%`)return e.isInteger(s)?e.format(`( ${c} % ${l} )`,a,t):e.format(`${this.getOperatorMethod(e,a)}( ${c}, ${l} )`,a,t);if(n===`!`||n===`~`)return e.format(`(${n}${c})`,o,t);if(u)return e.format(`${u}( ${c}, ${l} )`,a,t);if(e.isMatrix(o)&&s===`float`)return e.format(`( ${l} ${n} ${c} )`,a,t);if(o===`float`&&e.isMatrix(s))return e.format(`${c} ${n} ${l}`,a,t);{let i=`( ${c} ${n} ${l} )`;return!r&&a===`bool`&&e.isVector(o)&&e.isVector(s)&&(i=`all${i}`),e.format(i,a,t)}}else if(o!==`void`)return u?e.format(`${u}( ${c}, ${l} )`,a,t):e.isMatrix(o)&&s===`float`?e.format(`${l} ${n} ${c}`,a,t):e.format(`${c} ${n} ${l}`,a,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}},jo=M(Ao,`+`).setParameterLength(2,1/0).setName(`add`),Mo=M(Ao,`-`).setParameterLength(2,1/0).setName(`sub`),U=M(Ao,`*`).setParameterLength(2,1/0).setName(`mul`),No=M(Ao,`/`).setParameterLength(2,1/0).setName(`div`),Po=M(Ao,`%`).setParameterLength(2).setName(`mod`),Fo=M(Ao,`==`).setParameterLength(2).setName(`equal`),Io=M(Ao,`!=`).setParameterLength(2).setName(`notEqual`),Lo=M(Ao,`<`).setParameterLength(2).setName(`lessThan`),Ro=M(Ao,`>`).setParameterLength(2).setName(`greaterThan`),zo=M(Ao,`<=`).setParameterLength(2).setName(`lessThanEqual`),Bo=M(Ao,`>=`).setParameterLength(2).setName(`greaterThanEqual`),Vo=M(Ao,`&&`).setParameterLength(2,1/0).setName(`and`),Ho=M(Ao,`||`).setParameterLength(2,1/0).setName(`or`),Uo=M(Ao,`!`).setParameterLength(1).setName(`not`),Wo=M(Ao,`^^`).setParameterLength(2).setName(`xor`),Go=M(Ao,`&`).setParameterLength(2).setName(`bitAnd`),Ko=M(Ao,`~`).setParameterLength(2).setName(`bitNot`),qo=M(Ao,`|`).setParameterLength(2).setName(`bitOr`),Jo=M(Ao,`^`).setParameterLength(2).setName(`bitXor`),Yo=M(Ao,`<<`).setParameterLength(2).setName(`shiftLeft`),Xo=M(Ao,`>>`).setParameterLength(2).setName(`shiftRight`),Zo=N(([e])=>(e.addAssign(1),e)),Qo=N(([e])=>(e.subAssign(1),e)),$o=N(([e])=>{let t=F(e).toConst();return e.addAssign(1),t}),es=N(([e])=>{let t=F(e).toConst();return e.subAssign(1),t});O(`add`,jo),O(`sub`,Mo),O(`mul`,U),O(`div`,No),O(`mod`,Po),O(`equal`,Fo),O(`notEqual`,Io),O(`lessThan`,Lo),O(`greaterThan`,Ro),O(`lessThanEqual`,zo),O(`greaterThanEqual`,Bo),O(`and`,Vo),O(`or`,Ho),O(`not`,Uo),O(`xor`,Wo),O(`bitAnd`,Go),O(`bitNot`,Ko),O(`bitOr`,qo),O(`bitXor`,Jo),O(`shiftLeft`,Yo),O(`shiftRight`,Xo),O(`incrementBefore`,Zo),O(`decrementBefore`,Qo),O(`increment`,$o),O(`decrement`,es),O(`modInt`,(e,t)=>(console.warn(`THREE.TSL: "modInt()" is deprecated. Use "mod( int( ... ) )" instead.`),Po(F(e),F(t))));var W=class e extends ki{static get type(){return`MathNode`}constructor(t,n,r=null,i=null){if(super(),(t===e.MAX||t===e.MIN)&&arguments.length>3){let a=new e(t,n,r);for(let n=2;n<arguments.length-1;n++)a=new e(t,a,arguments[n]);n=a,r=arguments[arguments.length-1],i=null}this.method=t,this.aNode=n,this.bNode=r,this.cNode=i,this.isMathNode=!0}getInputType(e){let t=this.aNode.getNodeType(e),n=this.bNode?this.bNode.getNodeType(e):null,r=this.cNode?this.cNode.getNodeType(e):null,i=e.isMatrix(t)?0:e.getTypeLength(t),a=e.isMatrix(n)?0:e.getTypeLength(n),o=e.isMatrix(r)?0:e.getTypeLength(r);return i>a&&i>o?t:a>o?n:o>i?r:t}getNodeType(t){let n=this.method;return n===e.LENGTH||n===e.DISTANCE||n===e.DOT?`float`:n===e.CROSS?`vec3`:n===e.ALL||n===e.ANY?`bool`:n===e.EQUALS?t.changeComponentType(this.aNode.getNodeType(t),`bool`):this.getInputType(t)}setup(t){let{aNode:n,bNode:r,method:i}=this,a=null;if(i===e.ONE_MINUS)a=Mo(1,n);else if(i===e.RECIPROCAL)a=No(1,n);else if(i===e.DIFFERENCE)a=Cs(Mo(n,r));else if(i===e.TRANSFORM_DIRECTION){let e=n,i=r;t.isMatrix(e.getNodeType(t))?i=R(L(i),0):e=R(L(e),0);let o=U(e,i).xyz;a=hs(o)}return a===null?super.setup(t):a}generate(t,n){if(t.getNodeProperties(this).outputNode)return super.generate(t,n);let r=this.method,i=this.getNodeType(t),a=this.getInputType(t),o=this.aNode,s=this.bNode,c=this.cNode,l=t.renderer.coordinateSystem;if(r===e.NEGATE)return t.format(`( - `+o.build(t,a)+` )`,i,n);{let u=[];return r===e.CROSS?u.push(o.build(t,i),s.build(t,i)):l===2e3&&r===e.STEP?u.push(o.build(t,t.getTypeLength(o.getNodeType(t))===1?`float`:a),s.build(t,a)):l===2e3&&(r===e.MIN||r===e.MAX)?u.push(o.build(t,a),s.build(t,t.getTypeLength(s.getNodeType(t))===1?`float`:a)):r===e.REFRACT?u.push(o.build(t,a),s.build(t,a),c.build(t,`float`)):r===e.MIX?u.push(o.build(t,a),s.build(t,a),c.build(t,t.getTypeLength(c.getNodeType(t))===1?`float`:a)):(l===2001&&r===e.ATAN&&s!==null&&(r=`atan2`),t.shaderStage!==`fragment`&&(r===e.DFDX||r===e.DFDY)&&(console.warn(`THREE.TSL: '${r}' is not supported in the ${t.shaderStage} stage.`),r=`/*`+r+`*/`),u.push(o.build(t,a)),s!==null&&u.push(s.build(t,a)),c!==null&&u.push(c.build(t,a))),t.format(`${t.getMethod(r,i)}( ${u.join(`, `)} )`,i,n)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}};W.ALL=`all`,W.ANY=`any`,W.RADIANS=`radians`,W.DEGREES=`degrees`,W.EXP=`exp`,W.EXP2=`exp2`,W.LOG=`log`,W.LOG2=`log2`,W.SQRT=`sqrt`,W.INVERSE_SQRT=`inversesqrt`,W.FLOOR=`floor`,W.CEIL=`ceil`,W.NORMALIZE=`normalize`,W.FRACT=`fract`,W.SIN=`sin`,W.COS=`cos`,W.TAN=`tan`,W.ASIN=`asin`,W.ACOS=`acos`,W.ATAN=`atan`,W.ABS=`abs`,W.SIGN=`sign`,W.LENGTH=`length`,W.NEGATE=`negate`,W.ONE_MINUS=`oneMinus`,W.DFDX=`dFdx`,W.DFDY=`dFdy`,W.ROUND=`round`,W.RECIPROCAL=`reciprocal`,W.TRUNC=`trunc`,W.FWIDTH=`fwidth`,W.TRANSPOSE=`transpose`,W.DETERMINANT=`determinant`,W.INVERSE=`inverse`,W.EQUALS=`equals`,W.MIN=`min`,W.MAX=`max`,W.STEP=`step`,W.REFLECT=`reflect`,W.DISTANCE=`distance`,W.DIFFERENCE=`difference`,W.DOT=`dot`,W.CROSS=`cross`,W.POW=`pow`,W.TRANSFORM_DIRECTION=`transformDirection`,W.MIX=`mix`,W.CLAMP=`clamp`,W.REFRACT=`refract`,W.SMOOTHSTEP=`smoothstep`,W.FACEFORWARD=`faceforward`;var ts=P(1e-6),ns=P(Math.PI),rs=M(W,W.ALL).setParameterLength(1),is=M(W,W.ANY).setParameterLength(1),as=M(W,W.RADIANS).setParameterLength(1),os=M(W,W.DEGREES).setParameterLength(1),ss=M(W,W.EXP).setParameterLength(1),cs=M(W,W.EXP2).setParameterLength(1),ls=M(W,W.LOG).setParameterLength(1),us=M(W,W.LOG2).setParameterLength(1),ds=M(W,W.SQRT).setParameterLength(1),fs=M(W,W.INVERSE_SQRT).setParameterLength(1),ps=M(W,W.FLOOR).setParameterLength(1),ms=M(W,W.CEIL).setParameterLength(1),hs=M(W,W.NORMALIZE).setParameterLength(1),gs=M(W,W.FRACT).setParameterLength(1),_s=M(W,W.SIN).setParameterLength(1),vs=M(W,W.COS).setParameterLength(1),ys=M(W,W.TAN).setParameterLength(1),bs=M(W,W.ASIN).setParameterLength(1),xs=M(W,W.ACOS).setParameterLength(1),Ss=M(W,W.ATAN).setParameterLength(1,2),Cs=M(W,W.ABS).setParameterLength(1),ws=M(W,W.SIGN).setParameterLength(1),Ts=M(W,W.LENGTH).setParameterLength(1),Es=M(W,W.NEGATE).setParameterLength(1),Ds=M(W,W.ONE_MINUS).setParameterLength(1),Os=M(W,W.DFDX).setParameterLength(1),ks=M(W,W.DFDY).setParameterLength(1),As=M(W,W.ROUND).setParameterLength(1),js=M(W,W.RECIPROCAL).setParameterLength(1),Ms=M(W,W.TRUNC).setParameterLength(1),Ns=M(W,W.FWIDTH).setParameterLength(1),Ps=M(W,W.TRANSPOSE).setParameterLength(1),Fs=M(W,W.DETERMINANT).setParameterLength(1),Is=M(W,W.INVERSE).setParameterLength(1),Ls=(e,t)=>(console.warn(`THREE.TSL: "equals" is deprecated. Use "equal" inside a vector instead, like: "bvec*( equal( ... ) )"`),Fo(e,t)),Rs=M(W,W.MIN).setParameterLength(2,1/0),zs=M(W,W.MAX).setParameterLength(2,1/0),Bs=M(W,W.STEP).setParameterLength(2),Vs=M(W,W.REFLECT).setParameterLength(2),Hs=M(W,W.DISTANCE).setParameterLength(2),Us=M(W,W.DIFFERENCE).setParameterLength(2),Ws=M(W,W.DOT).setParameterLength(2),Gs=M(W,W.CROSS).setParameterLength(2),Ks=M(W,W.POW).setParameterLength(2),qs=e=>U(e,e),Js=e=>U(e,e,e),Ys=e=>U(e,e,e,e),Xs=M(W,W.TRANSFORM_DIRECTION).setParameterLength(2),Zs=e=>U(ws(e),Ks(Cs(e),1/3)),Qs=e=>Ws(e,e),G=M(W,W.MIX).setParameterLength(3),$s=(e,t=0,n=1)=>k(new W(W.CLAMP,k(e),k(t),k(n))),ec=e=>$s(e),tc=M(W,W.REFRACT).setParameterLength(3),nc=M(W,W.SMOOTHSTEP).setParameterLength(3),rc=M(W,W.FACEFORWARD).setParameterLength(3),ic=N(([e])=>gs(_s(Po(Ws(e.xy,I(12.9898,78.233)),ns)).mul(43758.5453)));O(`all`,rs),O(`any`,is),O(`equals`,Ls),O(`radians`,as),O(`degrees`,os),O(`exp`,ss),O(`exp2`,cs),O(`log`,ls),O(`log2`,us),O(`sqrt`,ds),O(`inverseSqrt`,fs),O(`floor`,ps),O(`ceil`,ms),O(`normalize`,hs),O(`fract`,gs),O(`sin`,_s),O(`cos`,vs),O(`tan`,ys),O(`asin`,bs),O(`acos`,xs),O(`atan`,Ss),O(`abs`,Cs),O(`sign`,ws),O(`length`,Ts),O(`lengthSq`,Qs),O(`negate`,Es),O(`oneMinus`,Ds),O(`dFdx`,Os),O(`dFdy`,ks),O(`round`,As),O(`reciprocal`,js),O(`trunc`,Ms),O(`fwidth`,Ns),O(`atan2`,(e,t)=>(console.warn(`THREE.TSL: "atan2" is overloaded. Use "atan" instead.`),Ss(e,t))),O(`min`,Rs),O(`max`,zs),O(`step`,(e,t)=>Bs(t,e)),O(`reflect`,Vs),O(`distance`,Hs),O(`dot`,Ws),O(`cross`,Gs),O(`pow`,Ks),O(`pow2`,qs),O(`pow3`,Js),O(`pow4`,Ys),O(`transformDirection`,Xs),O(`mix`,(e,t,n)=>G(t,n,e)),O(`clamp`,$s),O(`refract`,tc),O(`smoothstep`,(e,t,n)=>nc(t,n,e)),O(`faceForward`,rc),O(`difference`,Us),O(`saturate`,ec),O(`cbrt`,Zs),O(`transpose`,Ps),O(`determinant`,Fs),O(`inverse`,Is),O(`rand`,ic);var ac=A(class extends D{static get type(){return`ConditionalNode`}constructor(e,t,n=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=n}getNodeType(e){let{ifNode:t,elseNode:n}=e.getNodeProperties(this);if(t===void 0)return e.flowBuildStage(this,`setup`),this.getNodeType(e);let r=t.getNodeType(e);if(n!==null){let t=n.getNodeType(e);if(e.getTypeLength(t)>e.getTypeLength(r))return t}return r}setup(e){let t=this.condNode.cache(),n=this.ifNode.cache(),r=this.elseNode?this.elseNode.cache():null,i=e.context.nodeBlock;e.getDataFromNode(n).parentNodeBlock=i,r!==null&&(e.getDataFromNode(r).parentNodeBlock=i);let a=e.context.uniformFlow,o=e.getNodeProperties(this);o.condNode=t,o.ifNode=a?n:n.context({nodeBlock:n}),o.elseNode=r?a?r:r.context({nodeBlock:r}):null}generate(e,t){let n=this.getNodeType(e),r=e.getDataFromNode(this);if(r.nodeProperty!==void 0)return r.nodeProperty;let{condNode:i,ifNode:a,elseNode:o}=e.getNodeProperties(this),s=e.currentFunctionNode,c=t!==`void`,l=c?$a(n).build(e):``;r.nodeProperty=l;let u=i.build(e,`bool`);if(e.context.uniformFlow&&o!==null){let r=a.build(e,n),i=o.build(e,n),s=e.getTernary(u,r,i);return e.format(s,n,t)}e.addFlowCode(`
${e.tab}if ( ${u} ) {

`).addFlowTab();let d=a.build(e,n);if(d&&(c?d=l+` = `+d+`;`:(d=`return `+d+`;`,s===null&&(console.warn(`THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values.`),d=`// `+d))),e.removeFlowTab().addFlowCode(e.tab+`	`+d+`

`+e.tab+`}`),o!==null){e.addFlowCode(` else {

`).addFlowTab();let t=o.build(e,n);t&&(c?t=l+` = `+t+`;`:(t=`return `+t+`;`,s===null&&(console.warn(`THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values.`),t=`// `+t))),e.removeFlowTab().addFlowCode(e.tab+`	`+t+`

`+e.tab+`}

`)}else e.addFlowCode(`

`);return e.format(l,n,t)}}).setParameterLength(2,3);O(`select`,ac);var oc=class extends D{static get type(){return`ContextNode`}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}getMemberType(e,t){return this.node.getMemberType(e,t)}analyze(e){let t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}setup(e){let t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}generate(e,t){let n=e.getContext();e.setContext({...e.context,...this.value});let r=this.node.build(e,t);return e.setContext(n),r}},sc=A(oc).setParameterLength(1,2),cc=e=>sc(e,{uniformFlow:!0}),lc=(e,t)=>sc(e,{nodeName:t});function uc(e,t){return console.warn(`THREE.TSL: "label()" has been deprecated. Use "setName()" instead.`),lc(e,t)}O(`context`,sc),O(`label`,uc),O(`uniformFlow`,cc),O(`setName`,lc);var dc=class extends D{static get type(){return`VarNode`}constructor(e,t=null,n=!1){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0,this.readOnly=n,this.parents=!0,this.intent=!1}setIntent(e){return this.intent=e,this}getIntent(){return this.intent}getMemberType(e,t){return this.node.getMemberType(e,t)}getElementType(e){return this.node.getElementType(e)}getNodeType(e){return this.node.getNodeType(e)}getArrayCount(e){return this.node.getArrayCount(e)}build(...e){return this.intent===!0&&e[0].getNodeProperties(this).assign!==!0?this.node.build(...e):super.build(...e)}generate(e){let{node:t,name:n,readOnly:r}=this,{renderer:i}=e,a=i.backend.isWebGPUBackend===!0,o=!1,s=!1;r&&(o=e.isDeterministic(t),s=a?r:o);let c=e.getVectorType(this.getNodeType(e)),l=t.build(e,c),u=e.getVarFromNode(this,n,c,void 0,s),d=e.getPropertyName(u),f=d;if(s)if(a)f=o?`const ${d}`:`let ${d}`;else{let n=t.getArrayCount(e);f=`const ${e.getVar(u.type,d,n)}`}return e.addLineFlowCode(`${f} = ${l}`,this),d}},fc=A(dc);O(`toVar`,(e,t=null)=>fc(e,t).toStack()),O(`toConst`,(e,t=null)=>fc(e,t,!0).toStack()),O(`toVarIntent`,e=>Da()===null?e:fc(e).setIntent(!0).toStack());var pc=class extends D{static get type(){return`SubBuild`}constructor(e,t,n=null){super(n),this.node=e,this.name=t,this.isSubBuildNode=!0}getNodeType(e){if(this.nodeType!==null)return this.nodeType;e.addSubBuild(this.name);let t=this.node.getNodeType(e);return e.removeSubBuild(),t}build(e,...t){e.addSubBuild(this.name);let n=this.node.build(e,...t);return e.removeSubBuild(),n}},mc=(e,t,n=null)=>k(new pc(k(e),t,n)),hc=A(class extends D{static get type(){return`VaryingNode`}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(e,t=null){return this.interpolationType=e,this.interpolationSampling=t,this}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){let t=e.getNodeProperties(this),n=t.varying;if(n===void 0){let r=this.name,i=this.getNodeType(e),a=this.interpolationType,o=this.interpolationSampling;t.varying=n=e.getVaryingFromNode(this,r,i,a,o),t.node=mc(this.node,`VERTEX`)}return n.needsInterpolation||=e.shaderStage===`fragment`,n}setup(e){this.setupVarying(e),e.flowNodeFromShaderStage(xi.VERTEX,this.node)}analyze(e){this.setupVarying(e),e.flowNodeFromShaderStage(xi.VERTEX,this.node)}generate(e){let t=e.getSubBuildProperty(`property`,e.currentStack),n=e.getNodeProperties(this),r=this.setupVarying(e);if(n[t]===void 0){let i=this.getNodeType(e),a=e.getPropertyName(r,xi.VERTEX);e.flowNodeFromShaderStage(xi.VERTEX,n.node,i,a),n[t]=a}return e.getPropertyName(r)}}).setParameterLength(1,2);O(`toVarying`,hc),O(`toVertexStage`,e=>hc(e)),O(`varying`,(...e)=>(console.warn(`THREE.TSL: .varying() has been renamed to .toVarying().`),hc(...e))),O(`vertexStage`,(...e)=>(console.warn(`THREE.TSL: .vertexStage() has been renamed to .toVertexStage().`),hc(...e)));var gc=N(([e])=>G(e.mul(.9478672986).add(.0521327014).pow(2.4),e.mul(.0773993808),e.lessThanEqual(.04045))).setLayout({name:`sRGBTransferEOTF`,type:`vec3`,inputs:[{name:`color`,type:`vec3`}]}),_c=N(([e])=>G(e.pow(.41666).mul(1.055).sub(.055),e.mul(12.92),e.lessThanEqual(.0031308))).setLayout({name:`sRGBTransferOETF`,type:`vec3`,inputs:[{name:`color`,type:`vec3`}]}),vc=`WorkingColorSpace`,yc=`OutputColorSpace`,bc=class extends ki{static get type(){return`ColorSpaceNode`}constructor(e,t,n){super(`vec4`),this.colorNode=e,this.source=t,this.target=n}resolveColorSpace(e,t){return t===vc?Zn.workingColorSpace:t===yc?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){let{colorNode:t}=this,n=this.resolveColorSpace(e,this.source),r=this.resolveColorSpace(e,this.target),i=t;return Zn.enabled===!1||n===r||!n||!r||(Zn.getTransfer(n)===`srgb`&&(i=R(gc(i.rgb),i.a)),Zn.getPrimaries(n)!==Zn.getPrimaries(r)&&(i=R(Ua(Zn._getMatrix(new qe,n,r)).mul(i.rgb),i.a)),Zn.getTransfer(r)===`srgb`&&(i=R(_c(i.rgb),i.a))),i}},xc=(e,t)=>k(new bc(k(e),vc,t)),Sc=(e,t)=>k(new bc(k(e),t,vc));O(`workingToColorSpace`,xc),O(`colorSpaceToWorking`,Sc);var Cc=class extends Ai{static get type(){return`ReferenceElementNode`}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){let t=super.generate(e),n=this.referenceNode.getNodeType(),r=this.getNodeType();return e.format(t,n,r)}},wc=class extends D{static get type(){return`ReferenceBaseNode`}constructor(e,t,n=null,r=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=r,this.properties=e.split(`.`),this.reference=n,this.node=null,this.group=null,this.updateType=E.OBJECT}setGroup(e){return this.group=e,this}element(e){return k(new Cc(this,k(e)))}setNodeType(e){let t=B(null,e);this.group!==null&&t.setGroup(this.group),this.node=t}getNodeType(e){return this.node===null&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){let{properties:t}=this,n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=this.object===null?e.object:this.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){this.node===null&&this.setNodeType(this.uniformType);let e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}},Tc=(e,t,n)=>k(new wc(e,t,n)),Ec=class extends wc{static get type(){return`RendererReferenceNode`}constructor(e,t,n=null){super(e,t,n),this.renderer=n,this.setGroup(z)}updateReference(e){return this.reference=this.renderer===null?e.renderer:this.renderer,this.reference}},Dc=(e,t,n=null)=>k(new Ec(e,t,n)),Oc=class extends ki{static get type(){return`ToneMappingNode`}constructor(e,t=Ac,n=null){super(`vec3`),this.toneMapping=e,this.exposureNode=t,this.colorNode=n}customCacheKey(){return gr(this.toneMapping)}setup(e){let t=this.colorNode||e.context.color,n=this.toneMapping;if(n===0)return t;let r=null,i=e.renderer.library.getToneMappingFunction(n);return i===null?(console.error(`ToneMappingNode: Unsupported Tone Mapping configuration.`,n),r=t):r=R(i(t.rgb,this.exposureNode),t.a),r}},kc=(e,t,n)=>k(new Oc(e,k(t),k(n))),Ac=Dc(`toneMappingExposure`,`float`);O(`toneMapping`,(e,t,n)=>kc(t,n,e));var jc=new C,Mc=class e{constructor(e,t,n,r=!1){this.isInterleavedBufferAttribute=!0,this.name=``,this.data=e,this.itemSize=t,this.offset=n,this.normalized=r}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,n=this.data.count;t<n;t++)jc.fromBufferAttribute(this,t),jc.applyMatrix4(e),this.setXYZ(t,jc.x,jc.y,jc.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)jc.fromBufferAttribute(this,t),jc.applyNormalMatrix(e),this.setXYZ(t,jc.x,jc.y,jc.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)jc.fromBufferAttribute(this,t),jc.transformDirection(e),this.setXYZ(t,jc.x,jc.y,jc.z);return this}getComponent(e,t){let n=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(n=ee(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Ee(n,this.array)),this.data.array[e*this.data.stride+this.offset+t]=n,this}setX(e,t){return this.normalized&&(t=Ee(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Ee(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Ee(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Ee(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=ee(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=ee(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=ee(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=ee(t,this.array)),t}setXY(e,t,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ee(t,this.array),n=Ee(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this}setXYZ(e,t,n,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ee(t,this.array),n=Ee(n,this.array),r=Ee(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this}setXYZW(e,t,n,r,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ee(t,this.array),n=Ee(n,this.array),r=Ee(r,this.array),i=Ee(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=r,this.data.array[e+3]=i,this}clone(t){if(t===void 0){console.log(`THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.`);let e=[];for(let t=0;t<this.count;t++){let n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return new Qn(new this.array.constructor(e),this.itemSize,this.normalized)}else return t.interleavedBuffers===void 0&&(t.interleavedBuffers={}),t.interleavedBuffers[this.data.uuid]===void 0&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new e(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(e===void 0){console.log(`THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.`);let e=[];for(let t=0;t<this.count;t++){let n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}},Nc=class{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=e===void 0?0:e.length/t,this.usage=se,this.updateRanges=[],this.version=0,this.uuid=fn()}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,n){e*=this.stride,n*=t.stride;for(let r=0,i=this.stride;r<i;r++)this.array[e+r]=t.array[n+r];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=fn()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);let t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),n=new this.constructor(t,this.stride);return n.setUsage(this.usage),n}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=fn()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}},Pc=class extends Li{static get type(){return`BufferAttributeNode`}constructor(e,t=null,n=0,r=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=n,this.bufferOffset=r,this.usage=se,this.instanced=!1,this.attribute=null,this.global=!0,e&&e.isBufferAttribute===!0&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(this.bufferStride===0&&this.bufferOffset===0){let t=e.globalCache.getData(this.value);return t===void 0&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return this.bufferType===null&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(this.attribute!==null)return;let t=this.getNodeType(e),n=this.value,r=e.getTypeLength(t),i=this.bufferStride||r,a=this.bufferOffset,o=n.isInterleavedBuffer===!0?n:new Nc(n,i),s=new Mc(o,r,a);o.setUsage(this.usage),this.attribute=s,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){let t=this.getNodeType(e),n=e.getBufferAttributeFromNode(this,t),r=e.getPropertyName(n),i=null;return e.shaderStage===`vertex`||e.shaderStage===`compute`?(this.name=r,i=r):i=hc(this).build(e,t),i}getInputType(){return`bufferAttribute`}setUsage(e){return this.usage=e,this.attribute&&this.attribute.isBufferAttribute===!0&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}},Fc=(e,t=null,n=0,r=0)=>k(new Pc(e,t,n,r)),Ic=(e,t=null,n=0,r=0)=>Fc(e,t,n,r).setUsage(At),Lc=(e,t=null,n=0,r=0)=>Fc(e,t,n,r).setInstanced(!0),Rc=(e,t=null,n=0,r=0)=>Ic(e,t,n,r).setInstanced(!0);O(`toAttribute`,e=>Fc(e.value));var zc=class extends D{static get type(){return`ComputeNode`}constructor(e,t){super(`void`),this.isComputeNode=!0,this.computeNode=e,this.workgroupSize=t,this.count=null,this.version=1,this.name=``,this.updateBeforeType=E.OBJECT,this.onInitFunction=null}setCount(e){return this.count=e,this}getCount(){return this.count}dispose(){this.dispatchEvent({type:`dispose`})}setName(e){return this.name=e,this}label(e){return console.warn(`THREE.TSL: "label()" has been deprecated. Use "setName()" instead.`),this.setName(e)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}setup(e){let t=this.computeNode.build(e);if(t){let n=e.getNodeProperties(this);n.outputComputeNode=t.outputNode,t.outputNode=null}return t}generate(e,t){let{shaderStage:n}=e;if(n===`compute`){let t=this.computeNode.build(e,`void`);t!==``&&e.addLineFlowCode(t,this)}else{let n=e.getNodeProperties(this).outputComputeNode;if(n)return n.build(e,t)}}},Bc=(e,t=[64])=>{(t.length===0||t.length>3)&&console.error(`THREE.TSL: compute() workgroupSize must have 1, 2, or 3 elements`);for(let e=0;e<t.length;e++){let n=t[e];(typeof n!=`number`||n<=0||!Number.isInteger(n))&&console.error(`THREE.TSL: compute() workgroupSize element at index [ ${e} ] must be a positive integer`)}for(;t.length<3;)t.push(1);return k(new zc(k(e),t))};O(`compute`,(e,t,n)=>Bc(e,n).setCount(t)),O(`computeKernel`,Bc);var Vc=class extends D{static get type(){return`CacheNode`}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){let t=e.getCache(),n=e.getCacheFromNode(this,this.parent);e.setCache(n);let r=this.node.getNodeType(e);return e.setCache(t),r}build(e,...t){let n=e.getCache(),r=e.getCacheFromNode(this,this.parent);e.setCache(r);let i=this.node.build(e,...t);return e.setCache(n),i}},Hc=(e,t)=>k(new Vc(k(e),t));O(`cache`,Hc),O(`bypass`,A(class extends D{static get type(){return`BypassNode`}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){let t=this.callNode.build(e,`void`);return t!==``&&e.addLineFlowCode(t,this),this.outputNode.build(e)}}).setParameterLength(2));var Uc=class extends D{static get type(){return`RemapNode`}constructor(e,t,n,r=P(0),i=P(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=n,this.outLowNode=r,this.outHighNode=i,this.doClamp=!0}setup(){let{node:e,inLowNode:t,inHighNode:n,outLowNode:r,outHighNode:i,doClamp:a}=this,o=e.sub(t).div(n.sub(t));return a===!0&&(o=o.clamp()),o.mul(i.sub(r)).add(r)}},Wc=A(Uc,null,null,{doClamp:!1}).setParameterLength(3,5),Gc=A(Uc).setParameterLength(3,5);O(`remap`,Wc),O(`remapClamp`,Gc);var Kc=class extends D{static get type(){return`ExpressionNode`}constructor(e=``,t=`void`){super(t),this.snippet=e}generate(e,t){let n=this.getNodeType(e),r=this.snippet;if(n===`void`)e.addLineFlowCode(r,this);else return e.format(r,n,t)}},qc=A(Kc).setParameterLength(1,2);O(`discard`,e=>(e?ac(e,qc(`discard`)):qc(`discard`)).toStack());var Jc=class extends ki{static get type(){return`RenderOutputNode`}constructor(e,t,n){super(`vec4`),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=n,this.isRenderOutputNode=!0}setup({context:e}){let t=this.colorNode||e.color,n=(this.toneMapping===null?e.toneMapping:this.toneMapping)||0,r=(this.outputColorSpace===null?e.outputColorSpace:this.outputColorSpace)||``;return n!==0&&(t=t.toneMapping(n)),r!==``&&r!==Zn.workingColorSpace&&(t=t.workingToColorSpace(r)),t}};O(`renderOutput`,(e,t=null,n=null)=>k(new Jc(k(e),t,n)));var Yc=class extends ki{static get type(){return`DebugNode`}constructor(e,t=null){super(),this.node=e,this.callback=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){return this.node.build(e)}analyze(e){return this.node.build(e)}generate(e){let t=this.callback,n=this.node.build(e),r=`--- TSL debug - `+e.shaderStage+` shader ---`,i=`-`.repeat(r.length),a=``;return a+=`// #`+r+`#
`,a+=e.flow.code.replace(/^\t/gm,``)+`
`,a+=`/* ... */ `+n+` /* ... */
`,a+=`// #`+i+`#
`,t===null?console.log(a):t(e,a),n}};O(`debug`,(e,t=null)=>k(new Yc(k(e),t)).toStack());var Xc=class extends D{static get type(){return`AttributeNode`}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(t===null){let n=this.getAttributeName(e);if(e.hasGeometryAttribute(n)){let r=e.geometry.getAttribute(n);t=e.getTypeFromAttribute(r)}else t=`float`}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){let t=this.getAttributeName(e),n=this.getNodeType(e);if(e.hasGeometryAttribute(t)===!0){let r=e.geometry.getAttribute(t),i=e.getTypeFromAttribute(r),a=e.getAttribute(t,i);return e.shaderStage===`vertex`?e.format(a.name,i,n):hc(this).build(e,n)}else return console.warn(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(n)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}},Zc=(e,t=null)=>k(new Xc(e,t)),Qc=class e extends D{static get type(){return`IndexNode`}constructor(e){super(`uint`),this.scope=e,this.isIndexNode=!0}generate(t){let n=this.getNodeType(t),r=this.scope,i;if(r===e.VERTEX)i=t.getVertexIndex();else if(r===e.INSTANCE)i=t.getInstanceIndex();else if(r===e.DRAW)i=t.getDrawIndex();else if(r===e.INVOCATION_LOCAL)i=t.getInvocationLocalIndex();else if(r===e.INVOCATION_SUBGROUP)i=t.getInvocationSubgroupIndex();else if(r===e.SUBGROUP)i=t.getSubgroupIndex();else throw Error(`THREE.IndexNode: Unknown scope: `+r);let a;return a=t.shaderStage===`vertex`||t.shaderStage===`compute`?i:hc(this).build(t,n),a}};Qc.VERTEX=`vertex`,Qc.INSTANCE=`instance`,Qc.SUBGROUP=`subgroup`,Qc.INVOCATION_LOCAL=`invocationLocal`,Qc.INVOCATION_SUBGROUP=`invocationSubgroup`,Qc.DRAW=`draw`;var $c=j(Qc,Qc.VERTEX),el=j(Qc,Qc.INSTANCE),tl=j(Qc,Qc.DRAW),nl=class extends V{static get type(){return`ParameterNode`}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}},rl=A(class extends D{static get type(){return`StackNode`}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getNodeType(e){return this.hasOutput?this.outputNode.getNodeType(e):`void`}getMemberType(e,t){return this.hasOutput?this.outputNode.getMemberType(e,t):`void`}add(e){return e.isNode===!0?(this.nodes.push(e),this):(console.error(`THREE.TSL: Invalid node added to stack.`),this)}If(e,t){return this._currentCond=ac(e,new ba(t)),this.add(this._currentCond)}ElseIf(e,t){let n=ac(e,new ba(t));return this._currentCond.elseNode=n,this._currentCond=n,this}Else(e){return this._currentCond.elseNode=new ba(e),this}Switch(e){return this._expressionNode=k(e),this}Case(...e){let t=[];if(e.length>=2)for(let n=0;n<e.length-1;n++)t.push(this._expressionNode.equal(k(e[n])));else console.error(`THREE.TSL: Invalid parameter length. Case() requires at least two parameters.`);let n=e[e.length-1],r=new ba(n),i=t[0];for(let e=1;e<t.length;e++)i=i.or(t[e]);let a=ac(i,r);return this._currentCond===null?(this._currentCond=a,this.add(this._currentCond)):(this._currentCond.elseNode=a,this._currentCond=a,this)}Default(e){return this.Else(e),this}setup(e){let t=e.getNodeProperties(this),n=0;for(let r of this.getChildren())r.isVarNode&&r.intent===!0&&e.getNodeProperties(r).assign!==!0||(t[`node`+ n++]=r);return t.outputNode||null}get hasOutput(){return this.outputNode&&this.outputNode.isNode}build(e,...t){let n=e.currentStack,r=Da();Ea(this),e.currentStack=this;let i=e.buildStage;for(let t of this.nodes)if(!(t.isVarNode&&t.intent===!0&&e.getNodeProperties(t).assign!==!0)){if(i===`setup`)t.build(e);else if(i===`analyze`)t.build(e,this);else if(i===`generate`){let n=e.getDataFromNode(t,`any`).stages,r=n&&n[e.shaderStage];if(t.isVarNode&&r&&r.length===1&&r[0]&&r[0].isStackNode)continue;t.build(e,`void`)}}let a;return a=this.hasOutput?this.outputNode.build(e,...t):super.build(e,...t),Ea(r),e.currentStack=n,a}}).setParameterLength(0,1),il=class extends D{static get type(){return`LoopNode`}constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode(105+e)}getProperties(e){let t=e.getNodeProperties(this);if(t.stackNode!==void 0)return t;let n={};for(let e=0,t=this.params.length-1;e<t;e++){let t=this.params[e],r=t.isNode!==!0&&t.name||this.getVarName(e);n[r]=qc(r,t.isNode!==!0&&t.type||`int`)}let r=e.addStack();t.returnsNode=this.params[this.params.length-1](n,e),t.stackNode=r;let i=this.params[0];return i.isNode!==!0&&typeof i.update==`function`&&(t.updateNode=N(this.params[0].update)(n)),e.removeStack(),t}getNodeType(e){let{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):`void`}setup(e){this.getProperties(e)}generate(e){let t=this.getProperties(e),n=this.params,r=t.stackNode;for(let r=0,i=n.length-1;r<i;r++){let i=n[r],a=!1,o=null,s=null,c=null,l=null,u=null,d=null;i.isNode?i.getNodeType(e)===`bool`?(a=!0,l=`bool`,s=i.build(e,l)):(l=`int`,c=this.getVarName(r),o=`0`,s=i.build(e,l),u=`<`):(l=i.type||`int`,c=i.name||this.getVarName(r),o=i.start,s=i.end,u=i.condition,d=i.update,typeof o==`number`?o=e.generateConst(l,o):o&&o.isNode&&(o=o.build(e,l)),typeof s==`number`?s=e.generateConst(l,s):s&&s.isNode&&(s=s.build(e,l)),o!==void 0&&s===void 0?(o+=` - 1`,s=`0`,u=`>=`):s!==void 0&&o===void 0&&(o=`0`,u=`<`),u===void 0&&(u=Number(o)>Number(s)?`>=`:`<`));let f;if(a)f=`while ( ${s} )`;else{let n={start:o,end:s},r=n.start,i=n.end,a,p=()=>u.includes(`<`)?`+=`:`-=`;if(d!=null)switch(typeof d){case`function`:a=e.flowStagesNode(t.updateNode,`void`).code.replace(/\t|;/g,``);break;case`number`:a=c+` `+p()+` `+e.generateConst(l,d);break;case`string`:a=c+` `+d;break;default:d.isNode?a=c+` `+p()+` `+d.build(e):(console.error(`THREE.TSL: 'Loop( { update: ... } )' is not a function, string or number.`),a=`break /* invalid update */`)}else d=l===`int`||l===`uint`?u.includes(`<`)?`++`:`--`:p()+` 1.`,a=c+` `+d;f=`for ( ${e.getVar(l,c)+` = `+r}; ${c+` `+u+` `+i}; ${a} )`}e.addFlowCode((r===0?`
`:``)+e.tab+f+` {

`).addFlowTab()}let i=r.build(e,`void`),a=t.returnsNode?t.returnsNode.build(e):``;e.removeFlowTab().addFlowCode(`
`+e.tab+i);for(let t=0,n=this.params.length-1;t<n;t++)e.addFlowCode((t===0?``:e.tab)+`}

`).removeFlowTab();return e.addFlowTab(),a}},al=(...e)=>k(new il(Ca(e,`int`))).toStack(),ol=()=>qc(`break`).toStack(),sl=new u,cl=class e extends D{static get type(){return`Object3DNode`}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=E.OBJECT,this.uniformNode=new Qa(null)}getNodeType(){let t=this.scope;if(t===e.WORLD_MATRIX)return`mat4`;if(t===e.POSITION||t===e.VIEW_POSITION||t===e.DIRECTION||t===e.SCALE)return`vec3`;if(t===e.RADIUS)return`float`}update(t){let n=this.object3d,r=this.uniformNode,i=this.scope;if(i===e.WORLD_MATRIX)r.value=n.matrixWorld;else if(i===e.POSITION)r.value=r.value||new C,r.value.setFromMatrixPosition(n.matrixWorld);else if(i===e.SCALE)r.value=r.value||new C,r.value.setFromMatrixScale(n.matrixWorld);else if(i===e.DIRECTION)r.value=r.value||new C,n.getWorldDirection(r.value);else if(i===e.VIEW_POSITION){let e=t.camera;r.value=r.value||new C,r.value.setFromMatrixPosition(n.matrixWorld),r.value.applyMatrix4(e.matrixWorldInverse)}else if(i===e.RADIUS){let e=t.object.geometry;e.boundingSphere===null&&e.computeBoundingSphere(),sl.copy(e.boundingSphere).applyMatrix4(n.matrixWorld),r.value=sl.radius}}generate(t){let n=this.scope;return n===e.WORLD_MATRIX?this.uniformNode.nodeType=`mat4`:n===e.POSITION||n===e.VIEW_POSITION||n===e.DIRECTION||n===e.SCALE?this.uniformNode.nodeType=`vec3`:n===e.RADIUS&&(this.uniformNode.nodeType=`float`),this.uniformNode.build(t)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}};cl.WORLD_MATRIX=`worldMatrix`,cl.POSITION=`position`,cl.SCALE=`scale`,cl.VIEW_POSITION=`viewPosition`,cl.DIRECTION=`direction`,cl.RADIUS=`radius`;var ll=A(cl,cl.POSITION).setParameterLength(1),ul=class extends Qa{static get type(){return`BufferNode`}constructor(e,t,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=n}getElementType(e){return this.getNodeType(e)}getInputType(){return`buffer`}},dl=(e,t,n)=>k(new ul(e,t,n)),fl=class extends Ai{static get type(){return`UniformArrayElementNode`}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){let t=super.generate(e),n=this.getNodeType(),r=this.node.getPaddedType();return e.format(t,r,n)}},pl=class extends ul{static get type(){return`UniformArrayNode`}constructor(e,t=null){super(null),this.array=e,this.elementType=t===null?Sr(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=E.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){let e=this.elementType,t=`vec4`;return e===`mat2`?t=`mat2`:/mat/.test(e)===!0?t=`mat4`:e.charAt(0)===`i`?t=`ivec4`:e.charAt(0)===`u`&&(t=`uvec4`),t}update(){let{array:e,value:t}=this,n=this.elementType;if(n===`float`||n===`int`||n===`uint`)for(let n=0;n<e.length;n++){let r=n*4;t[r]=e[n]}else if(n===`color`)for(let n=0;n<e.length;n++){let r=n*4,i=e[n];t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b||0}else if(n===`mat2`)for(let n=0;n<e.length;n++){let r=n*4,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+3]=i.elements[3]}else if(n===`mat3`)for(let n=0;n<e.length;n++){let r=n*16,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+4]=i.elements[3],t[r+5]=i.elements[4],t[r+6]=i.elements[5],t[r+8]=i.elements[6],t[r+9]=i.elements[7],t[r+10]=i.elements[8],t[r+15]=1}else if(n===`mat4`)for(let n=0;n<e.length;n++){let r=n*16,i=e[n];for(let e=0;e<i.elements.length;e++)t[r+e]=i.elements[e]}else for(let n=0;n<e.length;n++){let r=n*4,i=e[n];t[r]=i.x,t[r+1]=i.y,t[r+2]=i.z||0,t[r+3]=i.w||0}}setup(e){let t=this.array.length,n=this.elementType,r=Float32Array,i=this.paddedType,a=e.getTypeLength(i);return n.charAt(0)===`i`&&(r=Int32Array),n.charAt(0)===`u`&&(r=Uint32Array),this.value=new r(t*a),this.bufferCount=t,this.bufferType=i,super.setup(e)}element(e){return k(new fl(this,k(e)))}},ml=(e,t)=>k(new pl(e,t)),hl=A(class extends D{constructor(e){super(`float`),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}}).setParameterLength(1),gl,_l,vl=class e extends D{static get type(){return`ScreenNode`}constructor(e){super(),this.scope=e,this._output=null,this.isViewportNode=!0}getNodeType(){return this.scope===e.DPR?`float`:this.scope===e.VIEWPORT?`vec4`:`vec2`}getUpdateType(){let t=E.NONE;return(this.scope===e.SIZE||this.scope===e.VIEWPORT||this.scope===e.DPR)&&(t=E.RENDER),this.updateType=t,t}update({renderer:t}){let n=t.getRenderTarget();this.scope===e.VIEWPORT?n===null?(t.getViewport(_l),_l.multiplyScalar(t.getPixelRatio())):_l.copy(n.viewport):this.scope===e.DPR?this._output.value=t.getPixelRatio():n===null?t.getDrawingBufferSize(gl):(gl.width=n.width,gl.height=n.height)}setup(){let t=this.scope,n=null;return n=t===e.SIZE?B(gl||=new w):t===e.VIEWPORT?B(_l||=new s):t===e.DPR?B(1):I(Sl.div(xl)),this._output=n,n}generate(t){if(this.scope===e.COORDINATE){let e=t.getFragCoord();if(t.isFlipY()){let n=t.getNodeProperties(xl).outputNode.build(t);e=`${t.getType(`vec2`)}( ${e}.x, ${n}.y - ${e}.y )`}return e}return super.generate(t)}};vl.COORDINATE=`coordinate`,vl.VIEWPORT=`viewport`,vl.SIZE=`size`,vl.UV=`uv`,vl.DPR=`dpr`;var yl=j(vl,vl.DPR),bl=j(vl,vl.UV),xl=j(vl,vl.SIZE),Sl=j(vl,vl.COORDINATE),Cl=j(vl,vl.VIEWPORT),wl=Cl.zw;Cl.xy;var Tl=B(0,`uint`).setName(`u_cameraIndex`).setGroup(Ya(`cameraIndex`)).toVarying(`v_cameraIndex`),El=B(`float`).setName(`cameraNear`).setGroup(z).onRenderUpdate(({camera:e})=>e.near),Dl=B(`float`).setName(`cameraFar`).setGroup(z).onRenderUpdate(({camera:e})=>e.far),Ol=N(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){let n=[];for(let t of e.cameras)n.push(t.projectionMatrix);t=ml(n).setGroup(z).setName(`cameraProjectionMatrices`).element(e.isMultiViewCamera?hl(`gl_ViewID_OVR`):Tl).toConst(`cameraProjectionMatrix`)}else t=B(`mat4`).setName(`cameraProjectionMatrix`).setGroup(z).onRenderUpdate(({camera:e})=>e.projectionMatrix);return t}).once()(),kl=N(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){let n=[];for(let t of e.cameras)n.push(t.matrixWorldInverse);t=ml(n).setGroup(z).setName(`cameraViewMatrices`).element(e.isMultiViewCamera?hl(`gl_ViewID_OVR`):Tl).toConst(`cameraViewMatrix`)}else t=B(`mat4`).setName(`cameraViewMatrix`).setGroup(z).onRenderUpdate(({camera:e})=>e.matrixWorldInverse);return t}).once()(),Al=N(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){let n=[];for(let t=0,r=e.cameras.length;t<r;t++)n.push(new C);t=ml(n).setGroup(z).setName(`cameraPositions`).onRenderUpdate(({camera:e},t)=>{let n=e.cameras,r=t.array;for(let e=0,t=n.length;e<t;e++)r[e].setFromMatrixPosition(n[e].matrixWorld)}).element(e.isMultiViewCamera?hl(`gl_ViewID_OVR`):Tl).toConst(`cameraPosition`)}else t=B(new C).setName(`cameraPosition`).setGroup(z).onRenderUpdate(({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld));return t}).once()(),jl=class extends cl{static get type(){return`ModelNode`}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}},Ml=j(jl,jl.WORLD_MATRIX),Nl=B(new qe).onObjectUpdate(({object:e},t)=>t.value.getNormalMatrix(e.matrixWorld)),Pl=N(e=>e.renderer.overrideNodes.modelViewMatrix||Fl).once()().toVar(`modelViewMatrix`),Fl=kl.mul(Ml),Il=N(e=>(e.context.isHighPrecisionModelViewMatrix=!0,B(`mat4`).onObjectUpdate(({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))).once()().toVar(`highpModelViewMatrix`),Ll=N(e=>{let t=e.context.isHighPrecisionModelViewMatrix;return B(`mat3`).onObjectUpdate(({object:e,camera:n})=>(t!==!0&&e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix)))}).once()().toVar(`highpModelNormalViewMatrix`),Rl=Zc(`position`,`vec3`),zl=Rl.toVarying(`positionLocal`),Bl=Rl.toVarying(`positionPrevious`),Vl=N(e=>Ml.mul(zl).xyz.toVarying(e.getSubBuildProperty(`v_positionWorld`)),`vec3`).once([`POSITION`])(),Hl=N(()=>zl.transformDirection(Ml).toVarying(`v_positionWorldDirection`).normalize().toVar(`positionWorldDirection`),`vec3`).once([`POSITION`])(),Ul=N(e=>e.context.setupPositionView().toVarying(`v_positionView`),`vec3`).once([`POSITION`])(),Wl=Ul.negate().toVarying(`v_positionViewDirection`).normalize().toVar(`positionViewDirection`),Gl=N(([e=Hl])=>I(e.z.atan(e.x).mul(1/(Math.PI*2)).add(.5),e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5))),Kl=P(j(class extends D{static get type(){return`FrontFacingNode`}constructor(){super(`bool`),this.isFrontFacingNode=!0}generate(e){if(e.shaderStage!==`fragment`)return`true`;let{material:t}=e;return t.side===1?`false`:e.getFrontFacing()}})).mul(2).sub(1),ql=N(([e],{material:t})=>{let n=t.side;return n===1?e=e.mul(-1):n===2&&(e=e.mul(Kl)),e}),Jl=Zc(`normal`,`vec3`),Yl=N(e=>e.geometry.hasAttribute(`normal`)===!1?(console.warn(`THREE.TSL: Vertex attribute "normal" not found on geometry.`),L(0,1,0)):Jl,`vec3`).once()().toVar(`normalLocal`),Xl=Ul.dFdx().cross(Ul.dFdy()).normalize().toVar(`normalFlat`),Zl=N(e=>{let t;return t=e.material.flatShading===!0?Xl:nu(Yl).toVarying(`v_normalViewGeometry`).normalize(),t},`vec3`).once()().toVar(`normalViewGeometry`),Ql=N(e=>{let t=Zl.transformDirection(kl);return e.material.flatShading!==!0&&(t=t.toVarying(`v_normalWorldGeometry`)),t.normalize().toVar(`normalWorldGeometry`)},`vec3`).once()(),K=N(({subBuildFn:e,material:t,context:n})=>{let r;return e===`NORMAL`||e===`VERTEX`?(r=Zl,t.flatShading!==!0&&(r=ql(r))):r=n.setupNormal().context({getUV:null}),r},`vec3`).once([`NORMAL`,`VERTEX`])().toVar(`normalView`),$l=K.transformDirection(kl).toVar(`normalWorld`),eu=N(({subBuildFn:e,context:t})=>{let n;return n=e===`NORMAL`||e===`VERTEX`?K:t.setupClearcoatNormal().context({getUV:null}),n},`vec3`).once([`NORMAL`,`VERTEX`])().toVar(`clearcoatNormalView`),tu=N(([e,t=Ml])=>{let n=Ua(t),r=e.div(L(n[0].dot(n[0]),n[1].dot(n[1]),n[2].dot(n[2])));return n.mul(r).xyz}),nu=N(([e],t)=>{let n=t.renderer.overrideNodes.modelNormalViewMatrix;if(n!==null)return n.transformDirection(e);let r=Nl.mul(e);return kl.transformDirection(r)});N(()=>(console.warn(`THREE.TSL: "transformedNormalView" is deprecated. Use "normalView" instead.`),K)).once([`NORMAL`,`VERTEX`])(),N(()=>(console.warn(`THREE.TSL: "transformedNormalWorld" is deprecated. Use "normalWorld" instead.`),$l)).once([`NORMAL`,`VERTEX`])(),N(()=>(console.warn(`THREE.TSL: "transformedClearcoatNormalView" is deprecated. Use "clearcoatNormalView" instead.`),eu)).once([`NORMAL`,`VERTEX`])();var ru=N(()=>{let e=L(Wl.z,0,Wl.x.negate()).normalize(),t=Wl.cross(e);return I(e.dot(K),t.dot(K)).mul(.495).add(.5)}).once([`NORMAL`,`VERTEX`])().toVar(`matcapUV`),iu=A(class extends Qa{static get type(){return`MaxMipLevelNode`}constructor(e){super(0),this._textureNode=e,this.updateType=E.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){let e=this.texture,t=e.images,n=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(n&&n.width!==void 0){let{width:e,height:t}=n;this.value=Math.log2(Math.max(e,t))}}}).setParameterLength(1),au=e=>k(e).mul(.5).add(.5),ou=A(class extends ki{static get type(){return`RotateNode`}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){let{rotationNode:t,positionNode:n}=this;if(this.getNodeType(e)===`vec2`){let e=t.cos(),r=t.sin();return Ha(e,r,r.negate(),e).mul(n)}else{let e=t,r=Wa(R(1,0,0,0),R(0,vs(e.x),_s(e.x).negate(),0),R(0,_s(e.x),vs(e.x),0),R(0,0,0,1)),i=Wa(R(vs(e.y),0,_s(e.y),0),R(0,1,0,0),R(_s(e.y).negate(),0,vs(e.y),0),R(0,0,0,1)),a=Wa(R(vs(e.z),_s(e.z).negate(),0,0),R(_s(e.z),vs(e.z),0,0),R(0,0,1,0),R(0,0,0,1));return r.mul(i).mul(a).mul(R(n,1)).xyz}}}).setParameterLength(2),su=(e=0)=>Zc(`uv`+(e>0?e:``),`vec2`),cu=A(class extends D{static get type(){return`TextureSizeNode`}constructor(e,t=null){super(`uvec2`),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){let n=this.textureNode.build(e,`property`),r=this.levelNode===null?`0`:this.levelNode.build(e,`int`);return e.format(`${e.getMethod(`textureDimensions`)}( ${n}, ${r} )`,this.getNodeType(e),t)}}).setParameterLength(1,2),lu=new gi,uu=class extends Qa{static get type(){return`TextureNode`}constructor(e=lu,t=null,n=null,r=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=n,this.biasNode=r,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.offsetNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=E.NONE,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(t===null)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return this.value.isDepthTexture===!0?`float`:this.value.type===1014?`uvec4`:this.value.type===1013?`ivec4`:`vec4`}getInputType(){return`texture`}getDefaultUV(){return su(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return this._matrixUniform===null&&(this._matrixUniform=B(this.value.matrix)),this._matrixUniform.mul(L(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?E.OBJECT:E.NONE,this}setupUV(e,t){let n=this.value;return e.isFlipY()&&(n.image instanceof ImageBitmap&&n.flipY===!0||n.isRenderTargetTexture===!0||n.isFramebufferTexture===!0||n.isDepthTexture===!0)&&(t=this.sampler?t.flipY():t.setY(F(cu(this,this.levelNode).y).sub(t.y).sub(1))),t}setup(e){let t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;let n=this.value;if(!n||n.isTexture!==!0)throw Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let r=this.uvNode;(r===null||e.context.forceUVContext===!0)&&e.context.getUV&&(r=e.context.getUV(this,e)),r||=this.getDefaultUV(),this.updateMatrix===!0&&(r=this.getTransformedUV(r)),r=this.setupUV(e,r);let i=this.levelNode;i===null&&e.context.getTextureLevel&&(i=e.context.getTextureLevel(this)),t.uvNode=r,t.levelNode=i,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode,t.offsetNode=this.offsetNode}generateUV(e,t){return t.build(e,this.sampler===!0?`vec2`:`ivec2`)}generateOffset(e,t){return t.build(e,`ivec2`)}generateSnippet(e,t,n,r,i,a,o,s,c){let l=this.value,u;return u=r?e.generateTextureLevel(l,t,n,r,a,c):i?e.generateTextureBias(l,t,n,i,a,c):s?e.generateTextureGrad(l,t,n,s,a,c):o?e.generateTextureCompare(l,t,n,o,a,c):this.sampler===!1?e.generateTextureLoad(l,t,n,a,c):e.generateTexture(l,t,n,a,c),u}generate(e,t){let n=this.value,r=e.getNodeProperties(this),i=super.generate(e,`property`);if(/^sampler/.test(t))return i+`_sampler`;if(e.isReference(t))return i;{let a=e.getDataFromNode(this),o=a.propertyName;if(o===void 0){let{uvNode:t,levelNode:n,biasNode:s,compareNode:c,depthNode:l,gradNode:u,offsetNode:d}=r,f=this.generateUV(e,t),p=n?n.build(e,`float`):null,m=s?s.build(e,`float`):null,h=l?l.build(e,`int`):null,g=c?c.build(e,`float`):null,_=u?[u[0].build(e,`vec2`),u[1].build(e,`vec2`)]:null,v=d?this.generateOffset(e,d):null,y=e.getVarFromNode(this);o=e.getPropertyName(y);let b=this.generateSnippet(e,i,f,p,m,h,g,_,v);e.addLineFlowCode(`${o} = ${b}`,this),a.snippet=b,a.propertyName=o}let s=o,c=this.getNodeType(e);return e.needsToWorkingColorSpace(n)&&(s=Sc(qc(s,c),n.colorSpace).setup(e).build(e,c)),e.format(s,c,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return console.warn(`THREE.TextureNode: .uv() has been renamed. Use .sample() instead.`),this.sample(e)}sample(e){let t=this.clone();return t.uvNode=k(e),t.referenceNode=this.getBase(),k(t)}load(e){return this.sample(e).setSampler(!1)}blur(e){let t=this.clone();t.biasNode=k(e).mul(iu(t)),t.referenceNode=this.getBase();let n=t.value;return t.generateMipmaps===!1&&(n&&n.generateMipmaps===!1||n.minFilter===1003||n.magFilter===1003)&&(console.warn(`THREE.TSL: texture().blur() requires mipmaps and sampling. Use .generateMipmaps=true and .minFilter/.magFilter=THREE.LinearFilter in the Texture.`),t.biasNode=null),k(t)}level(e){let t=this.clone();return t.levelNode=k(e),t.referenceNode=this.getBase(),k(t)}size(e){return cu(this,e)}bias(e){let t=this.clone();return t.biasNode=k(e),t.referenceNode=this.getBase(),k(t)}getBase(){return this.referenceNode?this.referenceNode.getBase():this}compare(e){let t=this.clone();return t.compareNode=k(e),t.referenceNode=this.getBase(),k(t)}grad(e,t){let n=this.clone();return n.gradNode=[k(e),k(t)],n.referenceNode=this.getBase(),k(n)}depth(e){let t=this.clone();return t.depthNode=k(e),t.referenceNode=this.getBase(),k(t)}offset(e){let t=this.clone();return t.offsetNode=k(e),t.referenceNode=this.getBase(),k(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){let e=this.value,t=this._matrixUniform;t!==null&&(t.value=e.matrix),e.matrixAutoUpdate===!0&&e.updateMatrix()}clone(){let e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e.offsetNode=this.offsetNode,e}},du=A(uu).setParameterLength(1,4).setName(`texture`),q=(e=lu,t=null,n=null,r=null)=>{let i;return e&&e.isTextureNode===!0?(i=k(e.clone()),i.referenceNode=e.getBase(),t!==null&&(i.uvNode=k(t)),n!==null&&(i.levelNode=k(n)),r!==null&&(i.biasNode=k(r))):i=du(e,t,n,r),i},fu=(...e)=>q(...e).setSampler(!1),pu=class extends gi{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=Re,this.minFilter=Re,this.generateMipmaps=!1,this.needsUpdate=!0}},mu=new w,hu=class extends uu{static get type(){return`ViewportTextureNode`}constructor(e=bl,t=null,n=null){let r=null;n===null?(r=new pu,r.minFilter=ut,n=r):r=n,super(n,e,t),this.generateMipmaps=!1,this.defaultFramebuffer=r,this.isOutputTextureNode=!0,this.updateBeforeType=E.FRAME,this._cacheTextures=new WeakMap}getTextureForReference(e=null){let t,n;if(this.referenceNode?(t=this.referenceNode.defaultFramebuffer,n=this.referenceNode._cacheTextures):(t=this.defaultFramebuffer,n=this._cacheTextures),e===null)return t;if(n.has(e)===!1){let r=t.clone();n.set(e,r)}return n.get(e)}updateReference(e){let t=e.renderer.getRenderTarget();return this.value=this.getTextureForReference(t),this.value}updateBefore(e){let t=e.renderer,n=t.getRenderTarget();n===null?t.getDrawingBufferSize(mu):mu.set(n.width,n.height);let r=this.getTextureForReference(n);(r.image.width!==mu.width||r.image.height!==mu.height)&&(r.image.width=mu.width,r.image.height=mu.height,r.needsUpdate=!0);let i=r.generateMipmaps;r.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(r),r.generateMipmaps=i}clone(){let e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}},gu=A(hu,null,null,{generateMipmaps:!0}).setParameterLength(0,3),_u=null,vu=A(class extends hu{static get type(){return`ViewportDepthTextureNode`}constructor(e=bl,t=null){_u===null&&(_u=new _i),super(e,t,_u)}getTextureForReference(){return _u}}).setParameterLength(0,2),yu=class e extends D{static get type(){return`ViewportDepthNode`}constructor(e,t=null){super(`float`),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(t){let{scope:n}=this;return n===e.DEPTH_BASE?t.getFragDepth():super.generate(t)}setup({camera:t}){let{scope:n}=this,r=this.valueNode,i=null;return n===e.DEPTH_BASE?r!==null&&(i=wu().assign(r)):n===e.DEPTH?i=t.isPerspectiveCamera?xu(Ul.z,El,Dl):bu(Ul.z,El,Dl):n===e.LINEAR_DEPTH&&(i=r===null?bu(Ul.z,El,Dl):t.isPerspectiveCamera?bu(Su(r,El,Dl),El,Dl):r),i}};yu.DEPTH_BASE=`depthBase`,yu.DEPTH=`depth`,yu.LINEAR_DEPTH=`linearDepth`;var bu=(e,t,n)=>e.add(t).div(t.sub(n)),xu=(e,t,n)=>t.add(e).mul(n).div(n.sub(t).mul(e)),Su=(e,t,n)=>t.mul(n).div(n.sub(t).mul(e).sub(n)),Cu=(e,t,n)=>{t=t.max(1e-6).toVar();let r=us(e.negate().div(t)),i=us(n.div(t));return r.div(i)},wu=A(yu,yu.DEPTH_BASE),Tu=j(yu,yu.DEPTH);vu(),Tu.assign=e=>wu(e);var Eu=class extends be{constructor(e=1,t=1,n={}){super(),n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:Yt,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},n),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=n.depth,this.scissor=new s(0,0,e,t),this.scissorTest=!1,this.viewport=new s(0,0,e,t);let r=new gi({width:e,height:t,depth:n.depth});this.textures=[];let i=n.count;for(let e=0;e<i;e++)this.textures[e]=r.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(n),this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=n.depthTexture,this.samples=n.samples,this.multiview=n.multiview}_setTextureOptions(e={}){let t={minFilter:Yt,generateMipmaps:!1,flipY:!1,internalFormat:null};e.mapping!==void 0&&(t.mapping=e.mapping),e.wrapS!==void 0&&(t.wrapS=e.wrapS),e.wrapT!==void 0&&(t.wrapT=e.wrapT),e.wrapR!==void 0&&(t.wrapR=e.wrapR),e.magFilter!==void 0&&(t.magFilter=e.magFilter),e.minFilter!==void 0&&(t.minFilter=e.minFilter),e.format!==void 0&&(t.format=e.format),e.type!==void 0&&(t.type=e.type),e.anisotropy!==void 0&&(t.anisotropy=e.anisotropy),e.colorSpace!==void 0&&(t.colorSpace=e.colorSpace),e.flipY!==void 0&&(t.flipY=e.flipY),e.generateMipmaps!==void 0&&(t.generateMipmaps=e.generateMipmaps),e.internalFormat!==void 0&&(t.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++)this.textures[e].setValues(t)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){this._depthTexture!==null&&(this._depthTexture.renderTarget=null),e!==null&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let r=0,i=this.textures.length;r<i;r++)this.textures[r].image.width=e,this.textures[r].image.height=t,this.textures[r].image.depth=n,this.textures[r].isArrayTexture=this.textures[r].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;let n=Object.assign({},e.textures[t].image);this.textures[t].source=new fi(n)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,e.depthTexture!==null&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:`dispose`})}};new Sn,new C,new C,new C,new zn,new C(0,0,-1),new s,new C,new C,new s,new w;var Du=new Eu;bl.flipX(),Du.depthTexture=new _i(1,1);var Ou=new Ke,ku=new zn,Au=B(0).onReference(({material:e})=>e).onObjectUpdate(({material:e})=>e.refractionRatio),ju=B(1).onReference(({material:e})=>e).onObjectUpdate(function({material:e,scene:t}){return e.envMap?e.envMapIntensity:t.environmentIntensity}),Mu=B(new zn).onReference(function(e){return e.material}).onObjectUpdate(function({material:e,scene:t}){let n=t.environment!==null&&e.envMap===null?t.environmentRotation:e.envMapRotation;return n?(Ou.copy(n),ku.makeRotationFromEuler(Ou)):ku.identity(),ku}),Nu=Wl.negate().reflect(K),Pu=Wl.negate().refract(K,Au),Fu=Nu.transformDirection(kl).toVar(`reflectVector`),Iu=Pu.transformDirection(kl).toVar(`reflectVector`),Lu=class extends gi{constructor(e=[],t=301,n,r,i,a,o,s,c,l){super(e,t,n,r,i,a,o,s,c,l),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}},Ru=new Lu,zu=A(class extends uu{static get type(){return`CubeTextureNode`}constructor(e,t=null,n=null,r=null){super(e,t,n,r),this.isCubeTextureNode=!0}getInputType(){return`cubeTexture`}getDefaultUV(){let e=this.value;return e.mapping===301?Fu:e.mapping===302?Iu:(console.error(`THREE.CubeTextureNode: Mapping "%s" not supported.`,e.mapping),L(0,0,0))}setUpdateMatrix(){}setupUV(e,t){let n=this.value;return(e.renderer.coordinateSystem===2001||!n.isRenderTargetTexture)&&(t=L(t.x.negate(),t.yz)),Mu.mul(t)}generateUV(e,t){return t.build(e,`vec3`)}}).setParameterLength(1,4).setName(`cubeTexture`),Bu=(e=Ru,t=null,n=null,r=null)=>{let i;return e&&e.isCubeTextureNode===!0?(i=k(e.clone()),i.referenceNode=e,t!==null&&(i.uvNode=k(t)),n!==null&&(i.levelNode=k(n)),r!==null&&(i.biasNode=k(r))):i=zu(e,t,n,r),i},Vu=class extends Ai{static get type(){return`ReferenceElementNode`}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){let t=super.generate(e),n=this.referenceNode.getNodeType(),r=this.getNodeType();return e.format(t,n,r)}},Hu=class extends D{static get type(){return`ReferenceNode`}constructor(e,t,n=null,r=null){super(),this.property=e,this.uniformType=t,this.object=n,this.count=r,this.properties=e.split(`.`),this.reference=n,this.node=null,this.group=null,this.name=null,this.updateType=E.OBJECT}element(e){return k(new Vu(this,k(e)))}setGroup(e){return this.group=e,this}setName(e){return this.name=e,this}label(e){return console.warn(`THREE.TSL: "label()" has been deprecated. Use "setName()" instead.`),this.setName(e)}setNodeType(e){let t=null;t=this.count===null?Array.isArray(this.getValueFromReference())?ml(null,e):e===`texture`?q(null):e===`cubeTexture`?Bu(null):B(null,e):dl(null,e,this.count),this.group!==null&&t.setGroup(this.group),this.name!==null&&t.setName(this.name),this.node=t}getNodeType(e){return this.node===null&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){let{properties:t}=this,n=e[t[0]];for(let e=1;e<t.length;e++)n=n[t[e]];return n}updateReference(e){return this.reference=this.object===null?e.object:this.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){this.node===null&&this.setNodeType(this.uniformType);let e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}},J=(e,t,n)=>k(new Hu(e,t,n)),Uu=(e,t,n,r)=>k(new Hu(e,t,r,n)),Wu=class extends Hu{static get type(){return`MaterialReferenceNode`}constructor(e,t,n=null){super(e,t,n),this.material=n,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=this.material===null?e.material:this.material,this.reference}},Gu=(e,t,n=null)=>k(new Wu(e,t,n)),Ku=su(),qu=Ul.dFdx(),Ju=Ul.dFdy(),Yu=Ku.dFdx(),Xu=Ku.dFdy(),Zu=K,Qu=Ju.cross(Zu),$u=Zu.cross(qu),ed=Qu.mul(Yu.x).add($u.mul(Xu.x)),td=Qu.mul(Yu.y).add($u.mul(Xu.y)),nd=ed.dot(ed).max(td.dot(td)),rd=nd.equal(0).select(0,nd.inverseSqrt()),id=ed.mul(rd).toVar(`tangentViewFrame`),ad=td.mul(rd).toVar(`bitangentViewFrame`),od=N(e=>(e.geometry.hasAttribute(`tangent`)===!1&&e.geometry.computeTangents(),Zc(`tangent`,`vec4`)))(),sd=od.xyz.toVar(`tangentLocal`),cd=N(({subBuildFn:e,geometry:t,material:n})=>{let r;return r=e===`VERTEX`||t.hasAttribute(`tangent`)?Pl.mul(R(sd,0)).xyz.toVarying(`v_tangentView`).normalize():id,n.flatShading!==!0&&(r=ql(r)),r},`vec3`).once([`NORMAL`,`VERTEX`])().toVar(`tangentView`),ld=N(([e,t],{subBuildFn:n,material:r})=>{let i=e.mul(od.w).xyz;return n===`NORMAL`&&r.flatShading!==!0&&(i=i.toVarying(t)),i}).once([`NORMAL`]),ud=Ua(cd,N(({subBuildFn:e,geometry:t,material:n})=>{let r;return r=e===`VERTEX`||t.hasAttribute(`tangent`)?ld(K.cross(cd),`v_bitangentView`).normalize():ad,n.flatShading!==!0&&(r=ql(r)),r},`vec3`).once([`NORMAL`,`VERTEX`])().toVar(`bitangentView`),K).toVar(`TBNViewMatrix`),dd=N(()=>{let e=ho.cross(Wl);return e=e.cross(ho).normalize(),e=G(e,K,po.mul(no.oneMinus()).oneMinus().pow2().pow2()).normalize(),e}).once()(),fd=A(class extends ki{static get type(){return`NormalMapNode`}constructor(e,t=null){super(`vec3`),this.node=e,this.scaleNode=t,this.normalMapType=0}setup({material:e}){let{normalMapType:t,scaleNode:n}=this,r=this.node.mul(2).sub(1);if(n!==null){let t=n;e.flatShading===!0&&(t=ql(t)),r=L(r.xy.mul(t),r.z)}let i=null;return t===1?i=nu(r):t===0?i=ud.mul(r).normalize():(console.error(`THREE.NodeMaterial: Unsupported normal map type: ${t}`),i=K),i}}).setParameterLength(1,2),pd=N(({textureNode:e,bumpScale:t})=>{let n=t=>e.cache().context({getUV:e=>t(e.uvNode||su()),forceUVContext:!0}),r=P(n(e=>e));return I(P(n(e=>e.add(e.dFdx()))).sub(r),P(n(e=>e.add(e.dFdy()))).sub(r)).mul(t)}),md=N(e=>{let{surf_pos:t,surf_norm:n,dHdxy:r}=e,i=t.dFdx().normalize(),a=t.dFdy().normalize(),o=n,s=a.cross(o),c=o.cross(i),l=i.dot(s).mul(Kl),u=l.sign().mul(r.x.mul(s).add(r.y.mul(c)));return l.abs().mul(n).sub(u).normalize()}),hd=A(class extends ki{static get type(){return`BumpMapNode`}constructor(e,t=null){super(`vec3`),this.textureNode=e,this.scaleNode=t}setup(){let e=this.scaleNode===null?1:this.scaleNode;return md({surf_pos:Ul,surf_norm:K,dHdxy:pd({textureNode:this.textureNode,bumpScale:e})})}}).setParameterLength(1,2),gd=new Map,Y=class e extends D{static get type(){return`MaterialNode`}constructor(e){super(),this.scope=e}getCache(e,t){let n=gd.get(e);return n===void 0&&(n=Gu(e,t),gd.set(e,n)),n}getFloat(e){return this.getCache(e,`float`)}getColor(e){return this.getCache(e,`color`)}getTexture(e){return this.getCache(e===`map`?`map`:e+`Map`,`texture`)}setup(t){let n=t.context.material,r=this.scope,i=null;if(r===e.COLOR){let e=n.color===void 0?L():this.getColor(r);i=n.map&&n.map.isTexture===!0?e.mul(this.getTexture(`map`)):e}else if(r===e.OPACITY){let e=this.getFloat(r);i=n.alphaMap&&n.alphaMap.isTexture===!0?e.mul(this.getTexture(`alpha`)):e}else if(r===e.SPECULAR_STRENGTH)i=n.specularMap&&n.specularMap.isTexture===!0?this.getTexture(`specular`).r:P(1);else if(r===e.SPECULAR_INTENSITY){let e=this.getFloat(r);i=n.specularIntensityMap&&n.specularIntensityMap.isTexture===!0?e.mul(this.getTexture(r).a):e}else if(r===e.SPECULAR_COLOR){let e=this.getColor(r);i=n.specularColorMap&&n.specularColorMap.isTexture===!0?e.mul(this.getTexture(r).rgb):e}else if(r===e.ROUGHNESS){let e=this.getFloat(r);i=n.roughnessMap&&n.roughnessMap.isTexture===!0?e.mul(this.getTexture(r).g):e}else if(r===e.METALNESS){let e=this.getFloat(r);i=n.metalnessMap&&n.metalnessMap.isTexture===!0?e.mul(this.getTexture(r).b):e}else if(r===e.EMISSIVE){let e=this.getFloat(`emissiveIntensity`),t=this.getColor(r).mul(e);i=n.emissiveMap&&n.emissiveMap.isTexture===!0?t.mul(this.getTexture(r)):t}else if(r===e.NORMAL)n.normalMap?(i=fd(this.getTexture(`normal`),this.getCache(`normalScale`,`vec2`)),i.normalMapType=n.normalMapType):i=n.bumpMap?hd(this.getTexture(`bump`).r,this.getFloat(`bumpScale`)):K;else if(r===e.CLEARCOAT){let e=this.getFloat(r);i=n.clearcoatMap&&n.clearcoatMap.isTexture===!0?e.mul(this.getTexture(r).r):e}else if(r===e.CLEARCOAT_ROUGHNESS){let e=this.getFloat(r);i=n.clearcoatRoughnessMap&&n.clearcoatRoughnessMap.isTexture===!0?e.mul(this.getTexture(r).r):e}else if(r===e.CLEARCOAT_NORMAL)i=n.clearcoatNormalMap?fd(this.getTexture(r),this.getCache(r+`Scale`,`vec2`)):K;else if(r===e.SHEEN){let e=this.getColor(`sheenColor`).mul(this.getFloat(`sheen`));i=n.sheenColorMap&&n.sheenColorMap.isTexture===!0?e.mul(this.getTexture(`sheenColor`).rgb):e}else if(r===e.SHEEN_ROUGHNESS){let e=this.getFloat(r);i=n.sheenRoughnessMap&&n.sheenRoughnessMap.isTexture===!0?e.mul(this.getTexture(r).a):e,i=i.clamp(.07,1)}else if(r===e.ANISOTROPY)if(n.anisotropyMap&&n.anisotropyMap.isTexture===!0){let e=this.getTexture(r);i=Ha($d.x,$d.y,$d.y.negate(),$d.x).mul(e.rg.mul(2).sub(I(1)).normalize().mul(e.b))}else i=$d;else if(r===e.IRIDESCENCE_THICKNESS){let e=J(`1`,`float`,n.iridescenceThicknessRange);if(n.iridescenceThicknessMap){let t=J(`0`,`float`,n.iridescenceThicknessRange);i=e.sub(t).mul(this.getTexture(r).g).add(t)}else i=e}else if(r===e.TRANSMISSION){let e=this.getFloat(r);i=n.transmissionMap?e.mul(this.getTexture(r).r):e}else if(r===e.THICKNESS){let e=this.getFloat(r);i=n.thicknessMap?e.mul(this.getTexture(r).g):e}else if(r===e.IOR)i=this.getFloat(r);else if(r===e.LIGHT_MAP)i=this.getTexture(r).rgb.mul(this.getFloat(`lightMapIntensity`));else if(r===e.AO)i=this.getTexture(r).r.sub(1).mul(this.getFloat(`aoMapIntensity`)).add(1);else if(r===e.LINE_DASH_OFFSET)i=n.dashOffset?this.getFloat(r):P(0);else{let e=this.getNodeType(t);i=this.getCache(r,e)}return i}};Y.ALPHA_TEST=`alphaTest`,Y.COLOR=`color`,Y.OPACITY=`opacity`,Y.SHININESS=`shininess`,Y.SPECULAR=`specular`,Y.SPECULAR_STRENGTH=`specularStrength`,Y.SPECULAR_INTENSITY=`specularIntensity`,Y.SPECULAR_COLOR=`specularColor`,Y.REFLECTIVITY=`reflectivity`,Y.ROUGHNESS=`roughness`,Y.METALNESS=`metalness`,Y.NORMAL=`normal`,Y.CLEARCOAT=`clearcoat`,Y.CLEARCOAT_ROUGHNESS=`clearcoatRoughness`,Y.CLEARCOAT_NORMAL=`clearcoatNormal`,Y.EMISSIVE=`emissive`,Y.ROTATION=`rotation`,Y.SHEEN=`sheen`,Y.SHEEN_ROUGHNESS=`sheenRoughness`,Y.ANISOTROPY=`anisotropy`,Y.IRIDESCENCE=`iridescence`,Y.IRIDESCENCE_IOR=`iridescenceIOR`,Y.IRIDESCENCE_THICKNESS=`iridescenceThickness`,Y.IOR=`ior`,Y.TRANSMISSION=`transmission`,Y.THICKNESS=`thickness`,Y.ATTENUATION_DISTANCE=`attenuationDistance`,Y.ATTENUATION_COLOR=`attenuationColor`,Y.LINE_SCALE=`scale`,Y.LINE_DASH_SIZE=`dashSize`,Y.LINE_GAP_SIZE=`gapSize`,Y.LINE_WIDTH=`linewidth`,Y.LINE_DASH_OFFSET=`dashOffset`,Y.POINT_SIZE=`size`,Y.DISPERSION=`dispersion`,Y.LIGHT_MAP=`light`,Y.AO=`ao`;var _d=j(Y,Y.ALPHA_TEST),vd=j(Y,Y.COLOR),yd=j(Y,Y.SHININESS),bd=j(Y,Y.EMISSIVE),xd=j(Y,Y.OPACITY),Sd=j(Y,Y.SPECULAR),Cd=j(Y,Y.SPECULAR_INTENSITY),wd=j(Y,Y.SPECULAR_COLOR),Td=j(Y,Y.SPECULAR_STRENGTH),Ed=j(Y,Y.REFLECTIVITY),Dd=j(Y,Y.ROUGHNESS),Od=j(Y,Y.METALNESS),kd=j(Y,Y.NORMAL),Ad=j(Y,Y.CLEARCOAT),jd=j(Y,Y.CLEARCOAT_ROUGHNESS),Md=j(Y,Y.CLEARCOAT_NORMAL),Nd=j(Y,Y.ROTATION),Pd=j(Y,Y.SHEEN),Fd=j(Y,Y.SHEEN_ROUGHNESS),Id=j(Y,Y.ANISOTROPY),Ld=j(Y,Y.IRIDESCENCE),Rd=j(Y,Y.IRIDESCENCE_IOR),zd=j(Y,Y.IRIDESCENCE_THICKNESS),Bd=j(Y,Y.TRANSMISSION),Vd=j(Y,Y.THICKNESS),Hd=j(Y,Y.IOR),Ud=j(Y,Y.ATTENUATION_DISTANCE),Wd=j(Y,Y.ATTENUATION_COLOR),Gd=j(Y,Y.LINE_SCALE),Kd=j(Y,Y.LINE_DASH_SIZE),qd=j(Y,Y.LINE_GAP_SIZE),Jd=j(Y,Y.LINE_DASH_OFFSET),Yd=j(Y,Y.POINT_SIZE),Xd=j(Y,Y.DISPERSION),Zd=j(Y,Y.LIGHT_MAP),Qd=j(Y,Y.AO),$d=B(new w).onReference(function(e){return e.material}).onRenderUpdate(function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))}),ef=N(e=>e.context.setupModelViewProjection(),`vec4`).once()().toVarying(`v_modelViewProjection`),tf=class extends Nc{constructor(e,t,n=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){let t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){let t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}},nf=class extends Qn{constructor(e,t,n,r=1){super(e,t,n),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=r}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){let e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}},rf=class extends D{static get type(){return`InstanceNode`}constructor(e,t,n=null){super(`void`),this.count=e,this.instanceMatrix=t,this.instanceColor=n,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=E.FRAME,this.buffer=null,this.bufferColor=null}setup(e){let{instanceMatrix:t,instanceColor:n}=this,{count:r}=t,{instanceMatrixNode:i,instanceColorNode:a}=this;if(i===null){if(r<=1e3)i=dl(t.array,`mat4`,Math.max(r,1)).element(el);else{let e=new tf(t.array,16,1);this.buffer=e;let n=t.usage===35048?Rc:Lc;i=Wa(n(e,`vec4`,16,0),n(e,`vec4`,16,4),n(e,`vec4`,16,8),n(e,`vec4`,16,12))}this.instanceMatrixNode=i}if(n&&a===null){let e=new nf(n.array,3),t=n.usage===35048?Rc:Lc;this.bufferColor=e,a=L(t(e,`vec3`,3,0)),this.instanceColorNode=a}let o=i.mul(zl).xyz;if(zl.assign(o),e.hasGeometryAttribute(`normal`)){let e=tu(Yl,i);Yl.assign(e)}this.instanceColorNode!==null&&eo(`vec3`,`vInstanceColor`).assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==35048&&this.buffer!==null&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==35048&&this.bufferColor!==null&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}},af=A(class extends rf{static get type(){return`InstancedMeshNode`}constructor(e){let{count:t,instanceMatrix:n,instanceColor:r}=e;super(t,n,r),this.instancedMesh=e}}).setParameterLength(1),of=A(class extends D{static get type(){return`BatchNode`}constructor(e){super(`void`),this.batchMesh=e,this.batchingIdNode=null}setup(e){this.batchingIdNode===null&&(e.getDrawIndex()===null?this.batchingIdNode=el:this.batchingIdNode=tl);let t=N(([e])=>{let t=F(cu(fu(this.batchMesh._indirectTexture),0).x),n=F(e).mod(t),r=F(e).div(t);return fu(this.batchMesh._indirectTexture,Na(n,r)).x}).setLayout({name:`getIndirectIndex`,type:`uint`,inputs:[{name:`id`,type:`int`}]})(F(this.batchingIdNode)),n=this.batchMesh._matricesTexture,r=F(cu(fu(n),0).x),i=P(t).mul(4).toInt().toVar(),a=i.mod(r),o=i.div(r),s=Wa(fu(n,Na(a,o)),fu(n,Na(a.add(1),o)),fu(n,Na(a.add(2),o)),fu(n,Na(a.add(3),o))),c=this.batchMesh._colorsTexture;if(c!==null){let e=N(([e])=>{let t=F(cu(fu(c),0).x),n=e;return fu(c,Na(n.mod(t),n.div(t))).rgb}).setLayout({name:`getBatchingColor`,type:`vec3`,inputs:[{name:`id`,type:`int`}]})(t);eo(`vec3`,`vBatchColor`).assign(e)}let l=Ua(s);zl.assign(s.mul(zl));let u=Yl.div(L(l[0].dot(l[0]),l[1].dot(l[1]),l[2].dot(l[2]))),d=l.mul(u).xyz;Yl.assign(d),e.hasGeometryAttribute(`tangent`)&&sd.mulAssign(l)}}).setParameterLength(1),sf=new WeakMap,cf=class extends D{static get type(){return`SkinningNode`}constructor(e){super(`void`),this.skinnedMesh=e,this.updateType=E.OBJECT,this.skinIndexNode=Zc(`skinIndex`,`uvec4`),this.skinWeightNode=Zc(`skinWeight`,`vec4`),this.bindMatrixNode=J(`bindMatrix`,`mat4`),this.bindMatrixInverseNode=J(`bindMatrixInverse`,`mat4`),this.boneMatricesNode=Uu(`skeleton.boneMatrices`,`mat4`,e.skeleton.bones.length),this.positionNode=zl,this.toPositionNode=zl,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=this.positionNode){let{skinIndexNode:n,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:a}=this,o=e.element(n.x),s=e.element(n.y),c=e.element(n.z),l=e.element(n.w),u=i.mul(t),d=jo(o.mul(r.x).mul(u),s.mul(r.y).mul(u),c.mul(r.z).mul(u),l.mul(r.w).mul(u));return a.mul(d).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=Yl){let{skinIndexNode:n,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:a}=this,o=e.element(n.x),s=e.element(n.y),c=e.element(n.z),l=e.element(n.w),u=jo(r.x.mul(o),r.y.mul(s),r.z.mul(c),r.w.mul(l));return u=a.mul(u).mul(i),u.transformDirection(t).xyz}getPreviousSkinnedPosition(e){let t=e.object;return this.previousBoneMatricesNode===null&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=Uu(`skeleton.previousBoneMatrices`,`mat4`,t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,Bl)}needsPreviousBoneMatrices(e){let t=e.renderer.getMRT();return t&&t.has(`velocity`)||wr(e.object).useVelocity===!0}setup(e){this.needsPreviousBoneMatrices(e)&&Bl.assign(this.getPreviousSkinnedPosition(e));let t=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(t),e.hasGeometryAttribute(`normal`)){let t=this.getSkinnedNormal();Yl.assign(t),e.hasGeometryAttribute(`tangent`)&&sd.assign(t)}return t}generate(e,t){if(t!==`void`)return super.generate(e,t)}update(e){let t=e.object&&e.object.skeleton?e.object.skeleton:this.skinnedMesh.skeleton;sf.get(t)!==e.frameId&&(sf.set(t,e.frameId),this.previousBoneMatricesNode!==null&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}},lf=e=>k(new cf(e)),uf=class extends gi{constructor(e=null,t=1,n=1,r=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:r},this.magFilter=Re,this.minFilter=Re,this.wrapR=Et,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}},df=new WeakMap,ff=new s,pf=N(({bufferMap:e,influence:t,stride:n,width:r,depth:i,offset:a})=>{let o=F($c).mul(n).add(a),s=o.div(r);return fu(e,Na(o.sub(s.mul(r)),s)).depth(i).xyz.mul(t)});function mf(e){let t=e.morphAttributes.position!==void 0,n=e.morphAttributes.normal!==void 0,r=e.morphAttributes.color!==void 0,i=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,a=i===void 0?0:i.length,o=df.get(e);if(o===void 0||o.count!==a){let i=function(){h.dispose(),df.delete(e),e.removeEventListener(`dispose`,i)};o!==void 0&&o.texture.dispose();let s=e.morphAttributes.position||[],c=e.morphAttributes.normal||[],l=e.morphAttributes.color||[],u=0;t===!0&&(u=1),n===!0&&(u=2),r===!0&&(u=3);let d=e.attributes.position.count*u,f=1,p=4096;d>p&&(f=Math.ceil(d/p),d=p);let m=new Float32Array(d*f*4*a),h=new uf(m,d,f,a);h.type=Un,h.needsUpdate=!0;let g=u*4;for(let e=0;e<a;e++){let i=s[e],a=c[e],o=l[e],u=d*f*4*e;for(let e=0;e<i.count;e++){let s=e*g;t===!0&&(ff.fromBufferAttribute(i,e),m[u+s+0]=ff.x,m[u+s+1]=ff.y,m[u+s+2]=ff.z,m[u+s+3]=0),n===!0&&(ff.fromBufferAttribute(a,e),m[u+s+4]=ff.x,m[u+s+5]=ff.y,m[u+s+6]=ff.z,m[u+s+7]=0),r===!0&&(ff.fromBufferAttribute(o,e),m[u+s+8]=ff.x,m[u+s+9]=ff.y,m[u+s+10]=ff.z,m[u+s+11]=o.itemSize===4?ff.w:1)}}o={count:a,texture:h,stride:u,size:new w(d,f)},df.set(e,o),e.addEventListener(`dispose`,i)}return o}var hf=A(class extends D{static get type(){return`MorphNode`}constructor(e){super(`void`),this.mesh=e,this.morphBaseInfluence=B(1),this.updateType=E.OBJECT}setup(e){let{geometry:t}=e,n=t.morphAttributes.position!==void 0,r=t.hasAttribute(`normal`)&&t.morphAttributes.normal!==void 0,i=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,a=i===void 0?0:i.length,{texture:o,stride:s,size:c}=mf(t);n===!0&&zl.mulAssign(this.morphBaseInfluence),r===!0&&Yl.mulAssign(this.morphBaseInfluence);let l=F(c.width);al(a,({i:e})=>{let t=P(0).toVar();this.mesh.count>1&&this.mesh.morphTexture!==null&&this.mesh.morphTexture!==void 0?t.assign(fu(this.mesh.morphTexture,Na(F(e).add(1),F(el))).r):t.assign(J(`morphTargetInfluences`,`float`).element(e).toVar()),Oa(t.notEqual(0),()=>{n===!0&&zl.addAssign(pf({bufferMap:o,influence:t,stride:s,width:l,depth:e,offset:F(0)})),r===!0&&Yl.addAssign(pf({bufferMap:o,influence:t,stride:s,width:l,depth:e,offset:F(1)}))})})}update(){let e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((e,t)=>e+t,0)}}).setParameterLength(1),gf=class extends D{static get type(){return`LightingNode`}constructor(){super(`vec3`),this.isLightingNode=!0}},_f=class extends gf{static get type(){return`AONode`}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}},vf=A(class extends oc{static get type(){return`LightingContextNode`}constructor(e,t=null,n=null,r=null){super(e),this.lightingModel=t,this.backdropNode=n,this.backdropAlphaNode=r,this._value=null}getContext(){let{backdropNode:e,backdropAlphaNode:t}=this,n={directDiffuse:L().toVar(`directDiffuse`),directSpecular:L().toVar(`directSpecular`),indirectDiffuse:L().toVar(`indirectDiffuse`),indirectSpecular:L().toVar(`indirectSpecular`)};return{radiance:L().toVar(`radiance`),irradiance:L().toVar(`irradiance`),iblIrradiance:L().toVar(`iblIrradiance`),ambientOcclusion:P(1).toVar(`ambientOcclusion`),reflectedLight:n,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||=this.getContext(),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}),yf=class extends gf{static get type(){return`IrradianceNode`}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}},bf=class e extends D{static get type(){return`ClippingNode`}constructor(t=e.DEFAULT){super(),this.scope=t}setup(t){super.setup(t);let{intersectionPlanes:n,unionPlanes:r}=t.clippingContext;return this.hardwareClipping=t.material.hardwareClipping,this.scope===e.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(n,r):this.scope===e.HARDWARE?this.setupHardwareClipping(r,t):this.setupDefault(n,r)}setupAlphaToCoverage(e,t){return N(()=>{let n=P().toVar(`distanceToPlane`),r=P().toVar(`distanceToGradient`),i=P(1).toVar(`clipOpacity`),a=t.length;if(this.hardwareClipping===!1&&a>0){let e=ml(t).setGroup(z);al(a,({i:t})=>{let a=e.element(t);n.assign(Ul.dot(a.xyz).negate().add(a.w)),r.assign(n.fwidth().div(2)),i.mulAssign(nc(r.negate(),r,n))})}let o=e.length;if(o>0){let t=ml(e).setGroup(z),a=P(1).toVar(`intersectionClipOpacity`);al(o,({i:e})=>{let i=t.element(e);n.assign(Ul.dot(i.xyz).negate().add(i.w)),r.assign(n.fwidth().div(2)),a.mulAssign(nc(r.negate(),r,n).oneMinus())}),i.mulAssign(a.oneMinus())}H.a.mulAssign(i),H.a.equal(0).discard()})()}setupDefault(e,t){return N(()=>{let n=t.length;if(this.hardwareClipping===!1&&n>0){let e=ml(t).setGroup(z);al(n,({i:t})=>{let n=e.element(t);Ul.dot(n.xyz).greaterThan(n.w).discard()})}let r=e.length;if(r>0){let t=ml(e).setGroup(z),n=Ma(!0).toVar(`clipped`);al(r,({i:e})=>{let r=t.element(e);n.assign(Ul.dot(r.xyz).greaterThan(r.w).and(n))}),n.discard()}})()}setupHardwareClipping(e,t){let n=e.length;return t.enableHardwareClipping(n),N(()=>{let r=ml(e).setGroup(z),i=hl(t.getClipDistance());al(n,({i:e})=>{let t=r.element(e),n=Ul.dot(t.xyz).sub(t.w).negate();i.element(e).assign(n)})})()}};bf.ALPHA_TO_COVERAGE=`alphaToCoverage`,bf.DEFAULT=`default`,bf.HARDWARE=`hardware`;var xf=()=>k(new bf),Sf=()=>k(new bf(bf.ALPHA_TO_COVERAGE)),Cf=()=>k(new bf(bf.HARDWARE)),wf=`alphaMap.alphaTest.anisotropy.anisotropyMap.anisotropyRotation.aoMap.aoMapIntensity.attenuationColor.attenuationDistance.bumpMap.clearcoat.clearcoatMap.clearcoatNormalMap.clearcoatNormalScale.clearcoatRoughness.color.dispersion.displacementMap.emissive.emissiveIntensity.emissiveMap.envMap.envMapIntensity.gradientMap.ior.iridescence.iridescenceIOR.iridescenceMap.iridescenceThicknessMap.lightMap.lightMapIntensity.map.matcap.metalness.metalnessMap.normalMap.normalScale.opacity.roughness.roughnessMap.sheen.sheenColor.sheenColorMap.sheenRoughnessMap.shininess.specular.specularColor.specularColorMap.specularIntensity.specularIntensityMap.specularMap.thickness.transmission.transmissionMap`.split(`.`),Tf=new WeakMap,Ef=class{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=e.object.isSkinnedMesh===!0,this.refreshUniforms=wf,this.renderId=0}firstInitialization(e){return this.renderObjects.has(e)===!1?(this.getRenderObjectData(e),!0):!1}needsVelocity(e){let t=e.getMRT();return t!==null&&t.has(`velocity`)}getRenderObjectData(e){let t=this.renderObjects.get(e);if(t===void 0){let{geometry:n,material:r,object:i}=e;if(t={material:this.getMaterialData(r),geometry:{id:n.id,attributes:this.getAttributesData(n.attributes),indexVersion:n.index?n.index.version:null,drawRange:{start:n.drawRange.start,count:n.drawRange.count}},worldMatrix:i.matrixWorld.clone()},i.center&&(t.center=i.center.clone()),i.morphTargetInfluences&&(t.morphTargetInfluences=i.morphTargetInfluences.slice()),e.bundle!==null&&(t.version=e.bundle.version),t.material.transmission>0){let{width:n,height:r}=e.context;t.bufferWidth=n,t.bufferHeight=r}t.lights=this.getLightsData(e.lightsNode.getLights()),this.renderObjects.set(e,t)}return t}getAttributesData(e){let t={};for(let n in e)t[n]={version:e[n].version};return t}containsNode(e){let t=e.material;for(let e in t)if(t[e]&&t[e].isNode)return!0;return e.renderer.overrideNodes.modelViewMatrix!==null||e.renderer.overrideNodes.modelNormalViewMatrix!==null}getMaterialData(e){let t={};for(let n of this.refreshUniforms){let r=e[n];r!=null&&(typeof r==`object`&&r.clone!==void 0?r.isTexture===!0?t[n]={id:r.id,version:r.version}:t[n]=r.clone():t[n]=r)}return t}equals(e,t){let{object:n,material:r,geometry:i}=e,a=this.getRenderObjectData(e);if(a.worldMatrix.equals(n.matrixWorld)!==!0)return a.worldMatrix.copy(n.matrixWorld),!1;let o=a.material;for(let e in o){let t=o[e],n=r[e];if(t.equals!==void 0){if(t.equals(n)===!1)return t.copy(n),!1}else if(n.isTexture===!0){if(t.id!==n.id||t.version!==n.version)return t.id=n.id,t.version=n.version,!1}else if(t!==n)return o[e]=n,!1}if(o.transmission>0){let{width:t,height:n}=e.context;if(a.bufferWidth!==t||a.bufferHeight!==n)return a.bufferWidth=t,a.bufferHeight=n,!1}let s=a.geometry,c=i.attributes,l=s.attributes,u=Object.keys(l),d=Object.keys(c);if(s.id!==i.id)return s.id=i.id,!1;if(u.length!==d.length)return a.geometry.attributes=this.getAttributesData(c),!1;for(let e of u){let t=l[e],n=c[e];if(n===void 0)return delete l[e],!1;if(t.version!==n.version)return t.version=n.version,!1}let f=i.index,p=s.indexVersion,m=f?f.version:null;if(p!==m)return s.indexVersion=m,!1;if(s.drawRange.start!==i.drawRange.start||s.drawRange.count!==i.drawRange.count)return s.drawRange.start=i.drawRange.start,s.drawRange.count=i.drawRange.count,!1;if(a.morphTargetInfluences){let e=!1;for(let t=0;t<a.morphTargetInfluences.length;t++)a.morphTargetInfluences[t]!==n.morphTargetInfluences[t]&&(e=!0);if(e)return!0}if(a.lights){for(let e=0;e<t.length;e++)if(a.lights[e].map!==t[e].map)return!1}return a.center&&a.center.equals(n.center)===!1?(a.center.copy(n.center),!0):(e.bundle!==null&&(a.version=e.bundle.version),!0)}getLightsData(e){let t=[];for(let n of e)n.isSpotLight===!0&&n.map!==null&&t.push({map:n.map.version});return t}getLights(e,t){if(Tf.has(e)){let n=Tf.get(e);if(n.renderId===t)return n.lightsData}let n=this.getLightsData(e.getLights());return Tf.set(e,{renderId:t,lightsData:n}),n}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e)||this.needsVelocity(t.renderer))return!0;let{renderId:n}=t;if(this.renderId!==n)return this.renderId=n,!0;let r=e.object.static===!0,i=e.bundle!==null&&e.bundle.static===!0&&this.getRenderObjectData(e).version===e.bundle.version;if(r||i)return!1;let a=this.getLights(e.lightsNode,n);return this.equals(e,a)!==!0}},Df=.05,Of=N(([e])=>gs(U(1e4,_s(U(17,e.x).add(U(.1,e.y)))).mul(jo(.1,Cs(_s(U(13,e.y).add(e.x))))))),kf=N(([e])=>Of(I(Of(e.xy),e.z))),Af=N(([e])=>{let t=zs(Ts(Os(e.xyz)),Ts(ks(e.xyz))),n=P(1).div(P(Df).mul(t)).toVar(`pixScale`),r=I(cs(ps(us(n))),cs(ms(us(n)))),i=I(kf(ps(r.x.mul(e.xyz))),kf(ps(r.y.mul(e.xyz)))),a=gs(us(n)),o=jo(U(a.oneMinus(),i.x),U(a,i.y)),s=Rs(a,a.oneMinus()),c=L(o.mul(o).div(U(2,s).mul(Mo(1,s))),o.sub(U(.5,s)).div(Mo(1,s)),Mo(1,Mo(1,o).mul(Mo(1,o)).div(U(2,s).mul(Mo(1,s)))));return $s(o.lessThan(s.oneMinus()).select(o.lessThan(s).select(c.x,c.y),c.z),1e-6,1)}).setLayout({name:`getAlphaHashThreshold`,type:`float`,inputs:[{name:`position`,type:`vec3`}]}),jf=class extends Xc{static get type(){return`VertexColorNode`}constructor(e){super(null,`vec4`),this.isVertexColorNode=!0,this.index=e}getAttributeName(){let e=this.index;return`color`+(e>0?e:``)}generate(e){let t=this.getAttributeName(e),n=e.hasGeometryAttribute(t),r;return r=n===!0?super.generate(e):e.generateConst(this.nodeType,new s(1,1,1,1)),r}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}},Mf=(e=0)=>k(new jf(e)),Nf=N(([e])=>R(e.rgb.mul(e.a),e.a),{color:`vec4`,return:`vec4`}),Pf=class extends $n{static get type(){return`NodeMaterial`}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,`shadowPositionNode`,{get:()=>this.receivedShadowPositionNode,set:e=>{console.warn(`THREE.NodeMaterial: ".shadowPositionNode" was renamed to ".receivedShadowPositionNode".`),this.receivedShadowPositionNode=e}})}customProgramCacheKey(){return this.type+_r(this)}build(e){this.setup(e)}setupObserver(e){return new Ef(e)}setup(e){e.context.setupNormal=()=>mc(this.setupNormal(e),`NORMAL`,`vec3`),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);let t=e.renderer,n=t.getRenderTarget();e.addStack();let r=mc(this.setupVertex(e),`VERTEX`),i=this.vertexNode||r;e.stack.outputNode=i,this.setupHardwareClipping(e),this.geometryNode!==null&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow(`vertex`,e.removeStack()),e.addStack();let a,o=this.setupClipping(e);if((this.depthWrite===!0||this.depthTest===!0)&&(n===null?t.depth===!0&&this.setupDepth(e):n.depthBuffer===!0&&this.setupDepth(e)),this.fragmentNode===null){this.setupDiffuseColor(e),this.setupVariants(e);let r=this.setupLighting(e);o!==null&&e.stack.add(o);let i=R(r,H.a).max(0);a=this.setupOutput(e,i),yo.assign(a);let s=this.outputNode!==null;if(s&&(a=this.outputNode),n!==null){let e=t.getMRT(),n=this.mrtNode;e===null?n!==null&&(a=n):(s&&yo.assign(a),a=e,n!==null&&(a=e.merge(n)))}}else{let t=this.fragmentNode;t.isOutputStructNode!==!0&&(t=R(t)),a=this.setupOutput(e,t)}e.stack.outputNode=a,e.addFlow(`fragment`,e.removeStack()),e.observer=this.setupObserver(e)}setupClipping(e){if(e.clippingContext===null)return null;let{unionPlanes:t,intersectionPlanes:n}=e.clippingContext,r=null;if(t.length>0||n.length>0){let t=e.renderer.samples;this.alphaToCoverage&&t>1?r=Sf():e.stack.add(xf())}return r}setupHardwareClipping(e){if(this.hardwareClipping=!1,e.clippingContext===null)return;let t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable(`clipDistance`)&&(e.stack.add(Cf()),this.hardwareClipping=!0)}setupDepth(e){let{renderer:t,camera:n}=e,r=this.depthNode;if(r===null){let e=t.getMRT();e&&e.has(`depth`)?r=e.get(`depth`):t.logarithmicDepthBuffer===!0&&(r=n.isPerspectiveCamera?Cu(Ul.z,El,Dl):bu(Ul.z,El,Dl))}r!==null&&Tu.assign(r).toStack()}setupPositionView(){return Pl.mul(zl).xyz}setupModelViewProjection(){return Ol.mul(Ul)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),ef}setupPosition(e){let{object:t,geometry:n}=e;if((n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color)&&hf(t).toStack(),t.isSkinnedMesh===!0&&lf(t).toStack(),this.displacementMap){let e=Gu(`displacementMap`,`texture`),t=Gu(`displacementScale`,`float`),n=Gu(`displacementBias`,`float`);zl.addAssign(Yl.normalize().mul(e.x.mul(t).add(n)))}return t.isBatchedMesh&&of(t).toStack(),t.isInstancedMesh&&t.instanceMatrix&&t.instanceMatrix.isInstancedBufferAttribute===!0&&af(t).toStack(),this.positionNode!==null&&zl.assign(mc(this.positionNode,`POSITION`,`vec3`)),zl}setupDiffuseColor({object:e,geometry:t}){this.maskNode!==null&&Ma(this.maskNode).not().discard();let n=this.colorNode?R(this.colorNode):vd;this.vertexColors===!0&&t.hasAttribute(`color`)&&(n=n.mul(Mf())),e.instanceColor&&(n=eo(`vec3`,`vInstanceColor`).mul(n)),e.isBatchedMesh&&e._colorsTexture&&(n=eo(`vec3`,`vBatchColor`).mul(n)),H.assign(n);let r=this.opacityNode?P(this.opacityNode):xd;H.a.assign(H.a.mul(r));let i=null;(this.alphaTestNode!==null||this.alphaTest>0)&&(i=this.alphaTestNode===null?_d:P(this.alphaTestNode),H.a.lessThanEqual(i).discard()),this.alphaHash===!0&&H.a.lessThan(Af(zl)).discard(),this.transparent===!1&&this.blending===1&&this.alphaToCoverage===!1?H.a.assign(1):i===null&&H.a.lessThanEqual(0).discard()}setupVariants(){}setupOutgoingLight(){return this.lights===!0?L(0):H.rgb}setupNormal(){return this.normalNode?L(this.normalNode):kd}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?Gu(`envMap`,`cubeTexture`):Gu(`envMap`,`texture`)),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new yf(Zd)),t}setupLights(e){let t=[],n=this.setupEnvironment(e);n&&n.isLightingNode&&t.push(n);let r=this.setupLightMap(e);if(r&&r.isLightingNode&&t.push(r),this.aoNode!==null||e.material.aoMap){let e=this.aoNode===null?Qd:this.aoNode;t.push(new _f(e))}let i=this.lightsNode||e.lightsNode;return t.length>0&&(i=e.renderer.lighting.createNode([...i.getLights(),...t])),i}setupLightingModel(){}setupLighting(e){let{material:t}=e,{backdropNode:n,backdropAlphaNode:r,emissiveNode:i}=this,a=this.lights===!0||this.lightsNode!==null?this.setupLights(e):null,o=this.setupOutgoingLight(e);return a&&a.getScope().hasLights?o=vf(a,this.setupLightingModel(e)||null,n,r):n!==null&&(o=L(r===null?n:G(o,n,r))),(i&&i.isNode===!0||t.emissive&&t.emissive.isColor===!0)&&(to.assign(L(i||bd)),o=o.add(to)),o}setupFog(e,t){let n=e.fogNode;return n&&(yo.assign(t),t=R(n.toVar())),t}setupPremultipliedAlpha(e,t){return Nf(t)}setupOutput(e,t){return this.fog===!0&&(t=this.setupFog(e,t)),this.premultipliedAlpha===!0&&(t=this.setupPremultipliedAlpha(e,t)),t}setDefaultValues(e){for(let t in e){let n=e[t];this[t]===void 0&&(this[t]=n,n&&n.clone&&(this[t]=n.clone()))}let t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(let e in t)Object.getOwnPropertyDescriptor(this.constructor.prototype,e)===void 0&&t[e].get!==void 0&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){let t=e===void 0||typeof e==`string`;t&&(e={textures:{},images:{},nodes:{}});let n=$n.prototype.toJSON.call(this,e),r=vr(this);n.inputNodes={};for(let{property:t,childNode:i}of r)n.inputNodes[t]=i.toJSON(e).uuid;function i(e){let t=[];for(let n in e){let r=e[n];delete r.metadata,t.push(r)}return t}if(t){let t=i(e.textures),r=i(e.images),a=i(e.nodes);t.length>0&&(n.textures=t),r.length>0&&(n.images=r),a.length>0&&(n.nodes=a)}return n}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.maskNode=e.maskNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.receivedShadowPositionNode=e.receivedShadowPositionNode,this.castShadowPositionNode=e.castShadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}},Ff=class extends mn{constructor(e=-1,t=1,n=1,r=-1,i=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type=`OrthographicCamera`,this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=r,this.near=i,this.far=a,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,t,n,r,i,a){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=r,this.view.width=i,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){let e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,r=(this.top+this.bottom)/2,i=n-e,a=n+e,o=r+t,s=r-t;if(this.view!==null&&this.view.enabled){let e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;i+=e*this.view.offsetX,a=i+e*this.view.width,o-=t*this.view.offsetY,s=o-t*this.view.height}this.projectionMatrix.makeOrthographic(i,a,o,s,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){let t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,this.view!==null&&(t.object.view=Object.assign({},this.view)),t}},If=new Ff(-1,1,1,-1,0,1),Lf=new class extends nr{constructor(e=!1){super();let t=e===!1?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute(`position`,new rr([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute(`uv`,new rr(t,2))}},Rf=class extends cr{constructor(e=null){super(Lf,e),this.camera=If,this.isQuadMesh=!0}async renderAsync(e){return e.renderAsync(this,If)}render(e){e.render(this,If)}},zf=class e extends D{static get type(){return`EventNode`}constructor(t,n){super(`void`),this.eventType=t,this.callback=n,t===e.OBJECT?this.updateType=E.OBJECT:t===e.MATERIAL&&(this.updateType=E.RENDER)}update(e){this.callback(e)}};zf.OBJECT=`object`,zf.MATERIAL=`material`;var Bf=1/6,Vf=e=>U(Bf,U(e,U(e,e.negate().add(3)).sub(3)).add(1)),Hf=e=>U(Bf,U(e,U(e,U(3,e).sub(6))).add(4)),Uf=e=>U(Bf,U(e,U(e,U(-3,e).add(3)).add(3)).add(1)),Wf=e=>U(Bf,Ks(e,3)),Gf=e=>Vf(e).add(Hf(e)),Kf=e=>Uf(e).add(Wf(e)),qf=e=>jo(-1,Hf(e).div(Vf(e).add(Hf(e)))),Jf=e=>jo(1,Wf(e).div(Uf(e).add(Wf(e)))),Yf=(e,t,n)=>{let r=e.uvNode,i=U(r,t.zw).add(.5),a=ps(i),o=gs(i),s=Gf(o.x),c=Kf(o.x),l=qf(o.x),u=Jf(o.x),d=qf(o.y),f=Jf(o.y),p=I(a.x.add(l),a.y.add(d)).sub(.5).mul(t.xy),m=I(a.x.add(u),a.y.add(d)).sub(.5).mul(t.xy),h=I(a.x.add(l),a.y.add(f)).sub(.5).mul(t.xy),g=I(a.x.add(u),a.y.add(f)).sub(.5).mul(t.xy),_=Gf(o.y).mul(jo(s.mul(e.sample(p).level(n)),c.mul(e.sample(m).level(n)))),v=Kf(o.y).mul(jo(s.mul(e.sample(h).level(n)),c.mul(e.sample(g).level(n))));return _.add(v)},Xf=N(([e,t])=>{let n=I(e.size(F(t))),r=I(e.size(F(t.add(1)))),i=No(1,n),a=No(1,r),o=Yf(e,R(i,n),ps(t)),s=Yf(e,R(a,r),ms(t));return gs(t).mix(o,s)}),Zf=new Ke,Qf=new zn,$f=class e extends D{static get type(){return`SceneNode`}constructor(t=e.BACKGROUND_BLURRINESS,n=null){super(),this.scope=t,this.scene=n}setup(t){let n=this.scope,r=this.scene===null?t.scene:this.scene,i;return n===e.BACKGROUND_BLURRINESS?i=J(`backgroundBlurriness`,`float`,r):n===e.BACKGROUND_INTENSITY?i=J(`backgroundIntensity`,`float`,r):n===e.BACKGROUND_ROTATION?i=B(`mat4`).setName(`backgroundRotation`).setGroup(z).onRenderUpdate(()=>{let e=r.background;return e!==null&&e.isTexture&&e.mapping!==300?(Zf.copy(r.backgroundRotation),Zf.x*=-1,Zf.y*=-1,Zf.z*=-1,Qf.makeRotationFromEuler(Zf)):Qf.identity(),Qf}):console.error(`THREE.SceneNode: Unknown scope:`,n),i}};$f.BACKGROUND_BLURRINESS=`backgroundBlurriness`,$f.BACKGROUND_INTENSITY=`backgroundIntensity`,$f.BACKGROUND_ROTATION=`backgroundRotation`;var ep=j($f,$f.BACKGROUND_BLURRINESS),tp=j($f,$f.BACKGROUND_INTENSITY),np=j($f,$f.BACKGROUND_ROTATION),rp=N(({texture:e,uv:t})=>{let n=L().toVar();return Oa(t.x.lessThan(1e-4),()=>{n.assign(L(1,0,0))}).ElseIf(t.y.lessThan(1e-4),()=>{n.assign(L(0,1,0))}).ElseIf(t.z.lessThan(1e-4),()=>{n.assign(L(0,0,1))}).ElseIf(t.x.greaterThan(.9999),()=>{n.assign(L(-1,0,0))}).ElseIf(t.y.greaterThan(.9999),()=>{n.assign(L(0,-1,0))}).ElseIf(t.z.greaterThan(.9999),()=>{n.assign(L(0,0,-1))}).Else(()=>{let r=e.sample(t.add(L(-.01,0,0))).r.sub(e.sample(t.add(L(.01,0,0))).r),i=e.sample(t.add(L(0,-.01,0))).r.sub(e.sample(t.add(L(0,.01,0))).r),a=e.sample(t.add(L(0,0,-.01))).r.sub(e.sample(t.add(L(0,0,.01))).r);n.assign(L(r,i,a))}),n.normalize()}),ip=A(class extends uu{static get type(){return`Texture3DNode`}constructor(e,t=null,n=null){super(e,t,n),this.isTexture3DNode=!0}getInputType(){return`texture3D`}getDefaultUV(){return L(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){let n=this.value;return e.isFlipY()&&(n.isRenderTargetTexture===!0||n.isFramebufferTexture===!0)&&(t=this.sampler?t.flipY():t.setY(F(cu(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,`vec3`)}generateOffset(e,t){return t.build(e,`ivec3`)}normal(e){return rp({texture:this,uv:e})}}).setParameterLength(1,3),ap=new w,op=class extends uu{static get type(){return`PassTextureNode`}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}},sp=class extends op{static get type(){return`PassMultipleTextureNode`}constructor(e,t,n=!1){super(e,null),this.textureName=t,this.previousTexture=n}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){let e=new this.constructor(this.passNode,this.textureName,this.previousTexture);return e.uvNode=this.uvNode,e.levelNode=this.levelNode,e.biasNode=this.biasNode,e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e}},cp=class e extends ki{static get type(){return`PassNode`}constructor(e,t,n,r={}){super(`vec4`),this.scope=e,this.scene=t,this.camera=n,this.options=r,this._pixelRatio=1,this._width=1,this._height=1;let i=new _i;i.isRenderTargetTexture=!0,i.name=`depth`;let a=new Eu(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Rt,...r});a.texture.name=`output`,a.depthTexture=i,this.renderTarget=a,this._textures={output:a.texture,depth:i},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=B(0),this._cameraFar=B(0),this._mrt=null,this._layers=null,this._resolution=1,this._viewport=null,this._scissor=null,this.isPassNode=!0,this.updateBeforeType=E.FRAME,this.global=!0}setResolution(e){return this._resolution=e,this}getResolution(){return this._resolution}setLayers(e){return this._layers=e,this}getLayers(){return this._layers}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getTexture(e){let t=this._textures[e];return t===void 0&&(t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)),t}getPreviousTexture(e){let t=this._previousTextures[e];return t===void 0&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){let t=this._previousTextures[e];if(t!==void 0){let n=this._textures[e],r=this.renderTarget.textures.indexOf(n);this.renderTarget.textures[r]=t,this._textures[e]=t,this._previousTextures[e]=n,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e=`output`){let t=this._textureNodes[e];return t===void 0&&(t=k(new sp(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e=`output`){let t=this._previousTextureNodes[e];return t===void 0&&(this._textureNodes[e]===void 0&&this.getTextureNode(e),t=k(new sp(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e=`depth`){let t=this._viewZNodes[e];if(t===void 0){let n=this._cameraNear,r=this._cameraFar;this._viewZNodes[e]=t=Su(this.getTextureNode(e),n,r)}return t}getLinearDepthNode(e=`depth`){let t=this._linearDepthNodes[e];if(t===void 0){let n=this._cameraNear,r=this._cameraFar,i=this.getViewZNode(e);this._linearDepthNodes[e]=t=bu(i,n,r)}return t}async compileAsync(e){let t=e.getRenderTarget(),n=e.getMRT();e.setRenderTarget(this.renderTarget),e.setMRT(this._mrt),await e.compileAsync(this.scene,this.camera),e.setRenderTarget(t),e.setMRT(n)}setup({renderer:t}){return this.renderTarget.samples=this.options.samples===void 0?t.samples:this.options.samples,this.renderTarget.texture.type=t.getColorBufferType(),this.scope===e.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){let{renderer:t}=e,{scene:n}=this,r,i,a=t.getOutputRenderTarget();a&&a.isXRRenderTarget===!0?(i=1,r=t.xr.getCamera(),t.xr.updateCamera(r),ap.set(a.width,a.height)):(r=this.camera,i=t.getPixelRatio(),t.getSize(ap)),this._pixelRatio=i,this.setSize(ap.width,ap.height);let o=t.getRenderTarget(),s=t.getMRT(),c=r.layers.mask;for(let e in this._cameraNear.value=r.near,this._cameraFar.value=r.far,this._layers!==null&&(r.layers.mask=this._layers.mask),this._previousTextures)this.toggleTexture(e);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(n,r),t.setRenderTarget(o),t.setMRT(s),r.layers.mask=c}setSize(e,t){this._width=e,this._height=t;let n=this._width*this._pixelRatio*this._resolution,r=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(n,r),this._scissor!==null&&this.renderTarget.scissor.copy(this._scissor),this._viewport!==null&&this.renderTarget.viewport.copy(this._viewport)}setScissor(e,t,n,r){e===null?this._scissor=null:(this._scissor===null&&(this._scissor=new s),e.isVector4?this._scissor.copy(e):this._scissor.set(e,t,n,r),this._scissor.multiplyScalar(this._pixelRatio*this._resolution).floor())}setViewport(e,t,n,r){e===null?this._viewport=null:(this._viewport===null&&(this._viewport=new s),e.isVector4?this._viewport.copy(e):this._viewport.set(e,t,n,r),this._viewport.multiplyScalar(this._pixelRatio*this._resolution).floor())}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}};cp.COLOR=`color`,cp.DEPTH=`depth`;var lp=N(([e,t])=>e.mul(t).clamp()).setLayout({name:`linearToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),up=N(([e,t])=>(e=e.mul(t),e.div(e.add(1)).clamp())).setLayout({name:`reinhardToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),dp=N(([e,t])=>{e=e.mul(t),e=e.sub(.004).max(0);let n=e.mul(e.mul(6.2).add(.5)),r=e.mul(e.mul(6.2).add(1.7)).add(.06);return n.div(r).pow(2.2)}).setLayout({name:`cineonToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),fp=N(([e])=>{let t=e.mul(e.add(.0245786)).sub(90537e-9),n=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(n)}),pp=N(([e,t])=>{let n=Ua(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),r=Ua(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=n.mul(e),e=fp(e),e=r.mul(e),e.clamp()}).setLayout({name:`acesFilmicToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),mp=Ua(L(1.6605,-.1246,-.0182),L(-.5876,1.1329,-.1006),L(-.0728,-.0083,1.1187)),hp=Ua(L(.6274,.0691,.0164),L(.3293,.9195,.088),L(.0433,.0113,.8956)),gp=N(([e])=>{let t=L(e).toVar(),n=L(t.mul(t)).toVar(),r=L(n.mul(n)).toVar();return P(15.5).mul(r.mul(n)).sub(U(40.14,r.mul(t))).add(U(31.96,r).sub(U(6.868,n.mul(t))).add(U(.4298,n).add(U(.1191,t).sub(.00232))))}),_p=N(([e,t])=>{let n=L(e).toVar(),r=Ua(L(.856627153315983,.137318972929847,.11189821299995),L(.0951212405381588,.761241990602591,.0767994186031903),L(.0482516061458583,.101439036467562,.811302368396859)),i=Ua(L(1.1271005818144368,-.1413297634984383,-.14132976349843826),L(-.11060664309660323,1.157823702216272,-.11060664309660294),L(-.016493938717834573,-.016493938717834257,1.2519364065950405)),a=P(-12.47393),o=P(4.026069);return n.mulAssign(t),n.assign(hp.mul(n)),n.assign(r.mul(n)),n.assign(zs(n,1e-10)),n.assign(us(n)),n.assign(n.sub(a).div(o.sub(a))),n.assign($s(n,0,1)),n.assign(gp(n)),n.assign(i.mul(n)),n.assign(Ks(zs(L(0),n),L(2.2))),n.assign(mp.mul(n)),n.assign($s(n,0,1)),n}).setLayout({name:`agxToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),vp=N(([e,t])=>{let n=P(.76),r=P(.15);e=e.mul(t);let i=Rs(e.r,Rs(e.g,e.b)),a=ac(i.lessThan(.08),i.sub(U(6.25,i.mul(i))),.04);e.subAssign(a);let o=zs(e.r,zs(e.g,e.b));Oa(o.lessThan(n),()=>e);let s=Mo(1,n),c=Mo(1,s.mul(s).div(o.add(s.sub(n))));e.mulAssign(c.div(o));let l=Mo(1,No(1,r.mul(o.sub(c)).add(1)));return G(e,L(c),l)}).setLayout({name:`neutralToneMapping`,type:`vec3`,inputs:[{name:`color`,type:`vec3`},{name:`exposure`,type:`float`}]}),yp=class extends D{static get type(){return`CodeNode`}constructor(e=``,t=[],n=``){super(`code`),this.isCodeNode=!0,this.global=!0,this.code=e,this.includes=t,this.language=n}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){let t=this.getIncludes(e);for(let n of t)n.build(e);let n=e.getCodeFromNode(this,this.getNodeType(e));return n.code=this.code,n.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}},bp=class extends yp{static get type(){return`FunctionNode`}constructor(e=``,t=[],n=``){super(e,t,n)}getNodeType(e){return this.getNodeFunction(e).type}getMemberType(e,t){let n=this.getNodeType(e);return e.getStructTypeNode(n).getMemberType(e,t)}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){let t=e.getDataFromNode(this),n=t.nodeFunction;return n===void 0&&(n=e.parser.parseFunction(this.code),t.nodeFunction=n),n}generate(e,t){super.generate(e);let n=this.getNodeFunction(e),r=n.name,i=n.type,a=e.getCodeFromNode(this,i);r!==``&&(a.name=r);let o=e.getPropertyName(a);return a.code=this.getNodeFunction(e).getCode(o)+`
`,t===`property`?o:e.format(`${o}()`,i,t)}};function xp(e){let t,n=e.context.getViewZ;return n!==void 0&&(t=n(this)),(t||Ul.z).negate()}var Sp=N(([e,t],n)=>nc(e,t,xp(n))),Cp=N(([e],t)=>{let n=xp(t);return e.mul(e,n,n).negate().exp().oneMinus()}),wp=N(([e,t])=>R(t.toFloat().mix(yo.rgb,e.toVec3()),yo.a));A(class extends D{constructor(e){super(),this.scope=e}generate(e){let{scope:t}=this,{renderer:n}=e;n.backend.isWebGLBackend===!0?e.addFlowCode(`	// ${t}Barrier 
`):e.addLineFlowCode(`${t}Barrier()`,this)}});var Tp=class extends D{static get type(){return`AtomicFunctionNode`}constructor(e,t,n){super(`uint`),this.method=e,this.pointerNode=t,this.valueNode=n,this.parents=!0}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){let t=e.getNodeProperties(this),n=t.parents,r=this.method,i=this.getNodeType(e),a=this.getInputType(e),o=this.pointerNode,s=this.valueNode,c=[];c.push(`&${o.build(e,a)}`),s!==null&&c.push(s.build(e,a));let l=`${e.getMethod(r,i)}( ${c.join(`, `)} )`;if(n&&n.length===1&&n[0].isStackNode===!0)e.addLineFlowCode(l,this);else return t.constNode===void 0&&(t.constNode=qc(l,i).toConst()),t.constNode.build(e)}};Tp.ATOMIC_LOAD=`atomicLoad`,Tp.ATOMIC_STORE=`atomicStore`,Tp.ATOMIC_ADD=`atomicAdd`,Tp.ATOMIC_SUB=`atomicSub`,Tp.ATOMIC_MAX=`atomicMax`,Tp.ATOMIC_MIN=`atomicMin`,Tp.ATOMIC_AND=`atomicAnd`,Tp.ATOMIC_OR=`atomicOr`,Tp.ATOMIC_XOR=`atomicXor`,A(Tp);var X=class e extends ki{static get type(){return`SubgroupFunctionNode`}constructor(e,t=null,n=null){super(),this.method=e,this.aNode=t,this.bNode=n}getInputType(e){let t=this.aNode?this.aNode.getNodeType(e):null,n=this.bNode?this.bNode.getNodeType(e):null;return(e.isMatrix(t)?0:e.getTypeLength(t))>(e.isMatrix(n)?0:e.getTypeLength(n))?t:n}getNodeType(t){let n=this.method;return n===e.SUBGROUP_ELECT?`bool`:n===e.SUBGROUP_BALLOT?`uvec4`:this.getInputType(t)}generate(t,n){let r=this.method,i=this.getNodeType(t),a=this.getInputType(t),o=this.aNode,s=this.bNode,c=[];if(r===e.SUBGROUP_BROADCAST||r===e.SUBGROUP_SHUFFLE||r===e.QUAD_BROADCAST){let e=s.getNodeType(t);c.push(o.build(t,i),s.build(t,e===`float`?`int`:i))}else r===e.SUBGROUP_SHUFFLE_XOR||r===e.SUBGROUP_SHUFFLE_DOWN||r===e.SUBGROUP_SHUFFLE_UP?c.push(o.build(t,i),s.build(t,`uint`)):(o!==null&&c.push(o.build(t,a)),s!==null&&c.push(s.build(t,a)));let l=c.length===0?`()`:`( ${c.join(`, `)} )`;return t.format(`${t.getMethod(r,i)}${l}`,i,n)}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}};X.SUBGROUP_ELECT=`subgroupElect`,X.SUBGROUP_BALLOT=`subgroupBallot`,X.SUBGROUP_ADD=`subgroupAdd`,X.SUBGROUP_INCLUSIVE_ADD=`subgroupInclusiveAdd`,X.SUBGROUP_EXCLUSIVE_AND=`subgroupExclusiveAdd`,X.SUBGROUP_MUL=`subgroupMul`,X.SUBGROUP_INCLUSIVE_MUL=`subgroupInclusiveMul`,X.SUBGROUP_EXCLUSIVE_MUL=`subgroupExclusiveMul`,X.SUBGROUP_AND=`subgroupAnd`,X.SUBGROUP_OR=`subgroupOr`,X.SUBGROUP_XOR=`subgroupXor`,X.SUBGROUP_MIN=`subgroupMin`,X.SUBGROUP_MAX=`subgroupMax`,X.SUBGROUP_ALL=`subgroupAll`,X.SUBGROUP_ANY=`subgroupAny`,X.SUBGROUP_BROADCAST_FIRST=`subgroupBroadcastFirst`,X.QUAD_SWAP_X=`quadSwapX`,X.QUAD_SWAP_Y=`quadSwapY`,X.QUAD_SWAP_DIAGONAL=`quadSwapDiagonal`,X.SUBGROUP_BROADCAST=`subgroupBroadcast`,X.SUBGROUP_SHUFFLE=`subgroupShuffle`,X.SUBGROUP_SHUFFLE_XOR=`subgroupShuffleXor`,X.SUBGROUP_SHUFFLE_UP=`subgroupShuffleUp`,X.SUBGROUP_SHUFFLE_DOWN=`subgroupShuffleDown`,X.QUAD_BROADCAST=`quadBroadcast`;var Ep;function Dp(e){Ep||=new WeakMap;let t=Ep.get(e);return t===void 0&&Ep.set(e,t={}),t}function Op(e){let t=Dp(e);return t.shadowMatrix||=B(`mat4`).setGroup(z).onRenderUpdate(t=>((e.castShadow!==!0||t.renderer.shadowMap.enabled===!1)&&e.shadow.updateMatrices(e),e.shadow.matrix))}function kp(e,t=Vl){let n=Op(e).mul(t);return n.xyz.div(n.w)}function Ap(e){let t=Dp(e);return t.position||=B(new C).setGroup(z).onRenderUpdate((t,n)=>n.value.setFromMatrixPosition(e.matrixWorld))}function jp(e){let t=Dp(e);return t.targetPosition||=B(new C).setGroup(z).onRenderUpdate((t,n)=>n.value.setFromMatrixPosition(e.target.matrixWorld))}function Mp(e){let t=Dp(e);return t.viewPosition||=B(new C).setGroup(z).onRenderUpdate(({camera:t},n)=>{n.value=n.value||new C,n.value.setFromMatrixPosition(e.matrixWorld),n.value.applyMatrix4(t.matrixWorldInverse)})}var Np=e=>kl.transformDirection(Ap(e).sub(jp(e))),Pp=e=>e.sort((e,t)=>e.id-t.id),Fp=(e,t)=>{for(let n of t)if(n.isAnalyticLightNode&&n.light.id===e)return n;return null},Ip=new WeakMap,Lp=[],Rp=class extends D{static get type(){return`LightsNode`}constructor(){super(`vec3`),this.totalDiffuseNode=$a(`vec3`,`totalDiffuse`),this.totalSpecularNode=$a(`vec3`,`totalSpecular`),this.outgoingLightNode=$a(`vec3`,`outgoingLight`),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){let e=this._lights;for(let t=0;t<e.length;t++){let n=e[t];if(Lp.push(n.id),Lp.push(n.castShadow?1:0),n.isSpotLight===!0){let e=n.map===null?-1:n.map.id,t=n.colorNode?n.colorNode.getCacheKey():-1;Lp.push(e,t)}}let t=hr(Lp);return Lp.length=0,t}getHash(e){if(this._lightNodesHash===null){this._lightNodes===null&&this.setupLightsNode(e);let t=[];for(let e of this._lightNodes)t.push(e.getHash());this._lightNodesHash=`lights-`+t.join(`,`)}return this._lightNodesHash}analyze(e){let t=e.getNodeProperties(this);for(let n of t.nodes)n.build(e);t.outputNode.build(e)}setupLightsNode(e){let t=[],n=this._lightNodes,r=Pp(this._lights),i=e.renderer.library;for(let e of r)if(e.isNode)t.push(k(e));else{let r=null;if(n!==null&&(r=Fp(e.id,n)),r===null){let n=i.getLightNodeClass(e.constructor);if(n===null){console.warn(`LightsNode.setupNodeLights: Light node not found for ${e.constructor.name}`);continue}let r=null;Ip.has(e)?r=Ip.get(e):(r=k(new n(e)),Ip.set(e,r)),t.push(r)}}this._lightNodes=t}setupDirectLight(e,t,n){let{lightingModel:r,reflectedLight:i}=e.context;r.direct({...n,lightNode:t,reflectedLight:i},e)}setupDirectRectAreaLight(e,t,n){let{lightingModel:r,reflectedLight:i}=e.context;r.directRectArea({...n,lightNode:t,reflectedLight:i},e)}setupLights(e,t){for(let n of t)n.build(e)}getLightNodes(e){return this._lightNodes===null&&this.setupLightsNode(e),this._lightNodes}setup(e){let t=e.lightsNode;e.lightsNode=this;let n=this.outgoingLightNode,r=e.context,i=r.lightingModel,a=e.getNodeProperties(this);if(i){let{totalDiffuseNode:t,totalSpecularNode:o}=this;r.outgoingLight=n,a.nodes=e.addStack().nodes,i.start(e);let{backdrop:s,backdropAlpha:c}=r,{directDiffuse:l,directSpecular:u,indirectDiffuse:d,indirectSpecular:f}=r.reflectedLight,p=l.add(d);s!==null&&(p=L(c===null?s:c.mix(p,s)),r.material.transparent=!0),t.assign(p),o.assign(u.add(f)),n.assign(t.add(o)),i.finish(e),n=n.bypass(e.removeStack())}else a.nodes=[];return e.lightsNode=t,n}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}},zp=class extends D{static get type(){return`ShadowBaseNode`}constructor(e){super(),this.light=e,this.updateBeforeType=E.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({context:e,material:t}){Bp.assign(t.receivedShadowPositionNode||e.shadowPositionWorld||Vl)}},Bp=$a(`vec3`,`shadowPositionWorld`);function Vp(e,t={}){return t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.renderTarget=e.getRenderTarget(),t.activeCubeFace=e.getActiveCubeFace(),t.activeMipmapLevel=e.getActiveMipmapLevel(),t.renderObjectFunction=e.getRenderObjectFunction(),t.pixelRatio=e.getPixelRatio(),t.mrt=e.getMRT(),t.clearColor=e.getClearColor(t.clearColor||new T),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.scissorTest=e.getScissorTest(),t}function Hp(e,t){return t=Vp(e,t),e.setMRT(null),e.setRenderObjectFunction(null),e.setClearColor(0,1),e.autoClear=!0,t}function Up(e,t){e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.setRenderTarget(t.renderTarget,t.activeCubeFace,t.activeMipmapLevel),e.setRenderObjectFunction(t.renderObjectFunction),e.setPixelRatio(t.pixelRatio),e.setMRT(t.mrt),e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.setScissorTest(t.scissorTest)}function Wp(e,t={}){return t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial,t}function Gp(e,t){return t=Wp(e,t),e.background=null,e.backgroundNode=null,e.overrideMaterial=null,t}function Kp(e,t){e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial}function qp(e,t,n){return n=Hp(e,n),n=Gp(t,n),n}function Jp(e,t,n){Up(e,n),Kp(t,n)}var Yp=new WeakMap,Xp=N(({depthTexture:e,shadowCoord:t,depthLayer:n})=>{let r=q(e,t.xy).setName(`t_basic`);return e.isArrayTexture&&(r=r.depth(n)),r.compare(t.z)}),Zp=N(({depthTexture:e,shadowCoord:t,shadow:n,depthLayer:r})=>{let i=(t,n)=>{let i=q(e,t);return e.isArrayTexture&&(i=i.depth(r)),i.compare(n)},a=J(`mapSize`,`vec2`,n).setGroup(z),o=J(`radius`,`float`,n).setGroup(z),s=I(1).div(a),c=s.x.negate().mul(o),l=s.y.negate().mul(o),u=s.x.mul(o),d=s.y.mul(o),f=c.div(2),p=l.div(2),m=u.div(2),h=d.div(2);return jo(i(t.xy.add(I(c,l)),t.z),i(t.xy.add(I(0,l)),t.z),i(t.xy.add(I(u,l)),t.z),i(t.xy.add(I(f,p)),t.z),i(t.xy.add(I(0,p)),t.z),i(t.xy.add(I(m,p)),t.z),i(t.xy.add(I(c,0)),t.z),i(t.xy.add(I(f,0)),t.z),i(t.xy,t.z),i(t.xy.add(I(m,0)),t.z),i(t.xy.add(I(u,0)),t.z),i(t.xy.add(I(f,h)),t.z),i(t.xy.add(I(0,h)),t.z),i(t.xy.add(I(m,h)),t.z),i(t.xy.add(I(c,d)),t.z),i(t.xy.add(I(0,d)),t.z),i(t.xy.add(I(u,d)),t.z)).mul(1/17)}),Qp=N(({depthTexture:e,shadowCoord:t,shadow:n,depthLayer:r})=>{let i=(t,n)=>{let i=q(e,t);return e.isArrayTexture&&(i=i.depth(r)),i.compare(n)},a=J(`mapSize`,`vec2`,n).setGroup(z),o=I(1).div(a),s=o.x,c=o.y,l=t.xy,u=gs(l.mul(a).add(.5));return l.subAssign(u.mul(o)),jo(i(l,t.z),i(l.add(I(s,0)),t.z),i(l.add(I(0,c)),t.z),i(l.add(o),t.z),G(i(l.add(I(s.negate(),0)),t.z),i(l.add(I(s.mul(2),0)),t.z),u.x),G(i(l.add(I(s.negate(),c)),t.z),i(l.add(I(s.mul(2),c)),t.z),u.x),G(i(l.add(I(0,c.negate())),t.z),i(l.add(I(0,c.mul(2))),t.z),u.y),G(i(l.add(I(s,c.negate())),t.z),i(l.add(I(s,c.mul(2))),t.z),u.y),G(G(i(l.add(I(s.negate(),c.negate())),t.z),i(l.add(I(s.mul(2),c.negate())),t.z),u.x),G(i(l.add(I(s.negate(),c.mul(2))),t.z),i(l.add(I(s.mul(2),c.mul(2))),t.z),u.x),u.y)).mul(1/9)}),$p=N(({depthTexture:e,shadowCoord:t,depthLayer:n})=>{let r=P(1).toVar(),i=q(e).sample(t.xy);e.isArrayTexture&&(i=i.depth(n)),i=i.rg;let a=Bs(t.z,i.x);return Oa(a.notEqual(P(1)),()=>{let e=t.z.sub(i.x),n=zs(0,i.y.mul(i.y)),o=n.div(n.add(e.mul(e)));o=$s(Mo(o,.3).div(.6499999999999999)),r.assign($s(zs(a,o)))}),r}),em=N(([e,t,n])=>{let r=Vl.sub(e).length();return r=r.sub(t).div(n.sub(t)),r=r.saturate(),r}),tm=e=>{let t=e.shadow.camera,n=J(`near`,`float`,t).setGroup(z),r=J(`far`,`float`,t).setGroup(z);return em(ll(e),n,r)},nm=e=>{let t=Yp.get(e);if(t===void 0){let n=e.isPointLight?tm(e):null;t=new Pf,t.colorNode=R(0,0,0,1),t.depthNode=n,t.isShadowPassMaterial=!0,t.name=`ShadowMaterial`,t.fog=!1,Yp.set(e,t)}return t},rm=new dr,im=[],am=(e,t,n,r)=>{im[0]=e,im[1]=t;let i=rm.get(im);return(i===void 0||i.shadowType!==n||i.useVelocity!==r)&&(i=(i,a,o,s,c,l,...u)=>{(i.castShadow===!0||i.receiveShadow&&n===3)&&(r&&(wr(i).useVelocity=!0),i.onBeforeShadow(e,i,o,t.camera,s,a.overrideMaterial,l),e.renderObject(i,a,o,s,c,l,...u),i.onAfterShadow(e,i,o,t.camera,s,a.overrideMaterial,l))},i.shadowType=n,i.useVelocity=r,rm.set(im,i)),im[0]=null,im[1]=null,i},om=N(({samples:e,radius:t,size:n,shadowPass:r,depthLayer:i})=>{let a=P(0).toVar(`meanVertical`),o=P(0).toVar(`squareMeanVertical`),s=e.lessThanEqual(P(1)).select(P(0),P(2).div(e.sub(1))),c=e.lessThanEqual(P(1)).select(P(0),P(-1));return al({start:F(0),end:F(e),type:`int`,condition:`<`},({i:e})=>{let l=c.add(P(e).mul(s)),u=r.sample(jo(Sl.xy,I(0,l).mul(t)).div(n));r.value.isArrayTexture&&(u=u.depth(i)),u=u.x,a.addAssign(u),o.addAssign(u.mul(u))}),a.divAssign(e),o.divAssign(e),I(a,ds(o.sub(a.mul(a))))}),sm=N(({samples:e,radius:t,size:n,shadowPass:r,depthLayer:i})=>{let a=P(0).toVar(`meanHorizontal`),o=P(0).toVar(`squareMeanHorizontal`),s=e.lessThanEqual(P(1)).select(P(0),P(2).div(e.sub(1))),c=e.lessThanEqual(P(1)).select(P(0),P(-1));return al({start:F(0),end:F(e),type:`int`,condition:`<`},({i:e})=>{let l=c.add(P(e).mul(s)),u=r.sample(jo(Sl.xy,I(l,0).mul(t)).div(n));r.value.isArrayTexture&&(u=u.depth(i)),a.addAssign(u.x),o.addAssign(jo(u.y.mul(u.y),u.x.mul(u.x)))}),a.divAssign(e),o.divAssign(e),I(a,ds(o.sub(a.mul(a))))}),cm=[Xp,Zp,Qp,$p],lm,um=new Rf,dm=class extends zp{static get type(){return`ShadowNode`}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(e,{filterFn:t,depthTexture:n,shadowCoord:r,shadow:i,depthLayer:a}){let o=r.x.greaterThanEqual(0).and(r.x.lessThanEqual(1)).and(r.y.greaterThanEqual(0)).and(r.y.lessThanEqual(1)).and(r.z.lessThanEqual(1)),s=t({depthTexture:n,shadowCoord:r,shadow:i,depthLayer:a});return o.select(s,P(1))}setupShadowCoord(e,t){let{shadow:n}=this,{renderer:r}=e,i=J(`bias`,`float`,n).setGroup(z),a=t,o;if(n.camera.isOrthographicCamera||r.logarithmicDepthBuffer!==!0)a=a.xyz.div(a.w),o=a.z,r.coordinateSystem===2001&&(o=o.mul(2).sub(1));else{let e=a.w;a=a.xy.div(e);let t=J(`near`,`float`,n.camera).setGroup(z),r=J(`far`,`float`,n.camera).setGroup(z);o=Cu(e.negate(),t,r)}return a=L(a.x,a.y.oneMinus(),o.add(i)),a}getShadowFilterFn(e){return cm[e]}setupRenderTarget(e,t){let n=new _i(e.mapSize.width,e.mapSize.height);n.name=`ShadowDepthTexture`,n.compareFunction=513;let r=t.createRenderTarget(e.mapSize.width,e.mapSize.height);return r.texture.name=`ShadowMap`,r.texture.type=e.mapType,r.depthTexture=n,{shadowMap:r,depthTexture:n}}setupShadow(e){let{renderer:t}=e,{light:n,shadow:r}=this,i=t.shadowMap.type,{depthTexture:a,shadowMap:o}=this.setupRenderTarget(r,e);if(r.camera.updateProjectionMatrix(),i===3&&r.isPointLightShadow!==!0){a.compareFunction=null,o.depth>1?(o._vsmShadowMapVertical||(o._vsmShadowMapVertical=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:1030,type:1016,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapVertical.texture.name=`VSMVertical`),this.vsmShadowMapVertical=o._vsmShadowMapVertical,o._vsmShadowMapHorizontal||(o._vsmShadowMapHorizontal=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:1030,type:1016,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapHorizontal.texture.name=`VSMHorizontal`),this.vsmShadowMapHorizontal=o._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:wt,type:Rt,depthBuffer:!1}),this.vsmShadowMapHorizontal=e.createRenderTarget(r.mapSize.width,r.mapSize.height,{format:wt,type:Rt,depthBuffer:!1}));let t=q(a);a.isArrayTexture&&(t=t.depth(this.depthLayer));let n=q(this.vsmShadowMapVertical.texture);a.isArrayTexture&&(n=n.depth(this.depthLayer));let i=J(`blurSamples`,`float`,r).setGroup(z),s=J(`radius`,`float`,r).setGroup(z),c=J(`mapSize`,`vec2`,r).setGroup(z),l=this.vsmMaterialVertical||=new Pf;l.fragmentNode=om({samples:i,radius:s,size:c,shadowPass:t,depthLayer:this.depthLayer}).context(e.getSharedContext()),l.name=`VSMVertical`,l=this.vsmMaterialHorizontal||=new Pf,l.fragmentNode=sm({samples:i,radius:s,size:c,shadowPass:n,depthLayer:this.depthLayer}).context(e.getSharedContext()),l.name=`VSMHorizontal`}let s=J(`intensity`,`float`,r).setGroup(z),c=J(`normalBias`,`float`,r).setGroup(z),l=Op(n).mul(Bp.add($l.mul(c))),u=this.setupShadowCoord(e,l),d=r.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(d===null)throw Error(`THREE.WebGPURenderer: Shadow map type not supported yet.`);let f=i===3&&r.isPointLightShadow!==!0?this.vsmShadowMapHorizontal.texture:a,p=this.setupShadowFilter(e,{filterFn:d,shadowTexture:o.texture,depthTexture:f,shadowCoord:u,shadow:r,depthLayer:this.depthLayer}),m=q(o.texture,u);a.isArrayTexture&&(m=m.depth(this.depthLayer));let h=G(1,p.rgb.mix(m,1),s.mul(m.a)).toVar();return this.shadowMap=o,this.shadow.map=o,h}setup(e){if(e.renderer.shadowMap.enabled!==!1)return N(()=>{let t=this._node;return this.setupShadowPosition(e),t===null&&(this._node=t=this.setupShadow(e)),e.material.shadowNode&&console.warn(`THREE.NodeMaterial: ".shadowNode" is deprecated. Use ".castShadowNode" instead.`),e.material.receivedShadowNode&&(t=e.material.receivedShadowNode(t)),t})()}renderShadow(e){let{shadow:t,shadowMap:n,light:r}=this,{renderer:i,scene:a}=e;t.updateMatrices(r),n.setSize(t.mapSize.width,t.mapSize.height,n.depth),i.render(a,t.camera)}updateShadow(e){let{shadowMap:t,light:n,shadow:r}=this,{renderer:i,scene:a,camera:o}=e,s=i.shadowMap.type;this._depthVersionCached=t.depthTexture.version;let c=r.camera.layers.mask;!(r.camera.layers.mask&4294967294)&&(r.camera.layers.mask=o.layers.mask);let l=i.getRenderObjectFunction(),u=i.getMRT(),d=u?u.has(`velocity`):!1;lm=qp(i,a,lm),a.overrideMaterial=nm(n),i.setRenderObjectFunction(am(i,r,s,d)),i.setClearColor(0,0),i.setRenderTarget(t),this.renderShadow(e),i.setRenderObjectFunction(l),s===3&&r.isPointLightShadow!==!0&&this.vsmPass(i),r.camera.layers.mask=c,Jp(i,a,lm)}vsmPass(e){let{shadow:t}=this,n=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height,n),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height,n),e.setRenderTarget(this.vsmShadowMapVertical),um.material=this.vsmMaterialVertical,um.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),um.material=this.vsmMaterialHorizontal,um.render(e)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,this.vsmShadowMapVertical!==null&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),this.vsmShadowMapHorizontal!==null&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(e){let{shadow:t}=this,n=t.needsUpdate||t.autoUpdate;n&&(this._cameraFrameId[e.camera]===e.frameId&&(n=!1),this._cameraFrameId[e.camera]=e.frameId),n&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}},fm=(e,t)=>k(new dm(e,t)),pm=new T,mm=N(([e,t])=>{let n=e.toVar(),r=Cs(n),i=No(1,zs(r.x,zs(r.y,r.z)));r.mulAssign(i),n.mulAssign(i.mul(t.mul(2).oneMinus()));let a=I(n.xy).toVar(),o=t.mul(1.5).oneMinus();return Oa(r.z.greaterThanEqual(o),()=>{Oa(n.z.greaterThan(0),()=>{a.x.assign(Mo(4,n.x))})}).ElseIf(r.x.greaterThanEqual(o),()=>{let e=ws(n.x);a.x.assign(n.z.mul(e).add(e.mul(2)))}).ElseIf(r.y.greaterThanEqual(o),()=>{let e=ws(n.y);a.x.assign(n.x.add(e.mul(2)).add(2)),a.y.assign(n.z.mul(e).sub(2))}),I(.125,.25).mul(a).add(I(.375,.75)).flipY()}).setLayout({name:`cubeToUV`,type:`vec2`,inputs:[{name:`pos`,type:`vec3`},{name:`texelSizeY`,type:`float`}]}),hm=N(({depthTexture:e,bd3D:t,dp:n,texelSize:r})=>q(e,mm(t,r.y)).compare(n)),gm=N(({depthTexture:e,bd3D:t,dp:n,texelSize:r,shadow:i})=>{let a=J(`radius`,`float`,i).setGroup(z),o=I(-1,1).mul(a).mul(r.y);return q(e,mm(t.add(o.xyy),r.y)).compare(n).add(q(e,mm(t.add(o.yyy),r.y)).compare(n)).add(q(e,mm(t.add(o.xyx),r.y)).compare(n)).add(q(e,mm(t.add(o.yyx),r.y)).compare(n)).add(q(e,mm(t,r.y)).compare(n)).add(q(e,mm(t.add(o.xxy),r.y)).compare(n)).add(q(e,mm(t.add(o.yxy),r.y)).compare(n)).add(q(e,mm(t.add(o.xxx),r.y)).compare(n)).add(q(e,mm(t.add(o.yxx),r.y)).compare(n)).mul(1/9)}),_m=N(({filterFn:e,depthTexture:t,shadowCoord:n,shadow:r})=>{let i=n.xyz.toVar(),a=i.length(),o=B(`float`).setGroup(z).onRenderUpdate(()=>r.camera.near),s=B(`float`).setGroup(z).onRenderUpdate(()=>r.camera.far),c=J(`bias`,`float`,r).setGroup(z),l=B(r.mapSize).setGroup(z),u=P(1).toVar();return Oa(a.sub(s).lessThanEqual(0).and(a.sub(o).greaterThanEqual(0)),()=>{let n=a.sub(o).div(s.sub(o)).toVar();n.addAssign(c);let d=i.normalize(),f=I(1).div(l.mul(I(4,2)));u.assign(e({depthTexture:t,bd3D:d,dp:n,texelSize:f,shadow:r}))}),u}),vm=new s,ym=new w,bm=new w,xm=class extends dm{static get type(){return`PointShadowNode`}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return e===0?hm:gm}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:n,depthTexture:r,shadowCoord:i,shadow:a}){return _m({filterFn:t,shadowTexture:n,depthTexture:r,shadowCoord:i,shadow:a})}renderShadow(e){let{shadow:t,shadowMap:n,light:r}=this,{renderer:i,scene:a}=e,o=t.getFrameExtents();bm.copy(t.mapSize),bm.multiply(o),n.setSize(bm.width,bm.height),ym.copy(t.mapSize);let s=i.autoClear,c=i.getClearColor(pm),l=i.getClearAlpha();i.autoClear=!1,i.setClearColor(t.clearColor,t.clearAlpha),i.clear();let u=t.getViewportCount();for(let e=0;e<u;e++){let o=t.getViewport(e),s=ym.x*o.x,c=bm.y-ym.y-ym.y*o.y;vm.set(s,c,ym.x*o.z,ym.y*o.w),n.viewport.copy(vm),t.updateMatrices(r,e),i.render(a,t.camera)}i.autoClear=s,i.setClearColor(c,l)}},Sm=(e,t)=>k(new xm(e,t)),Cm=class extends gf{static get type(){return`AnalyticLightNode`}constructor(e=null){super(),this.light=e,this.color=new T,this.colorNode=e&&e.colorNode||B(this.color).setGroup(z),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=E.FRAME}getHash(){return this.light.uuid}getLightVector(e){return Mp(this.light).sub(e.context.positionView||Ul)}setupDirect(){}setupDirectRectArea(){}setupShadowNode(){return fm(this.light)}setupShadow(e){let{renderer:t}=e;if(t.shadowMap.enabled===!1)return;let n=this.shadowColorNode;if(n===null){let e=this.light.shadow.shadowNode,t;t=e===void 0?this.setupShadowNode():k(e),this.shadowNode=t,this.shadowColorNode=n=this.colorNode.mul(t),this.baseColorNode=this.colorNode}this.colorNode=n}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):this.shadowNode!==null&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null);let t=this.setupDirect(e),n=this.setupDirectRectArea(e);t&&e.lightsNode.setupDirectLight(e,this,t),n&&e.lightsNode.setupDirectRectAreaLight(e,this,n)}update(){let{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}},wm=N(({lightDistance:e,cutoffDistance:t,decayExponent:n})=>{let r=e.pow(n).max(.01).reciprocal();return t.greaterThan(0).select(r.mul(e.div(t).pow4().oneMinus().clamp().pow2()),r)}),Tm=({color:e,lightVector:t,cutoffDistance:n,decayExponent:r})=>{let i=t.normalize(),a=wm({lightDistance:t.length(),cutoffDistance:n,decayExponent:r});return{lightDirection:i,lightColor:e.mul(a)}},Em=class extends Cm{static get type(){return`PointLightNode`}constructor(e=null){super(e),this.cutoffDistanceNode=B(0).setGroup(z),this.decayExponentNode=B(2).setGroup(z)}update(e){let{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return Sm(this.light)}setupDirect(e){return Tm({color:this.colorNode,lightVector:this.getLightVector(e),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode})}},Dm=P(1),Om=P(-2),km=P(.8),Am=P(-1),jm=P(.4),Mm=P(2),Nm=P(.305),Pm=P(3),Fm=P(.21),Im=P(4),Lm=P(4),Rm=P(16),zm=N(([e])=>{let t=L(Cs(e)).toVar(),n=P(-1).toVar();return Oa(t.x.greaterThan(t.z),()=>{Oa(t.x.greaterThan(t.y),()=>{n.assign(ac(e.x.greaterThan(0),0,3))}).Else(()=>{n.assign(ac(e.y.greaterThan(0),1,4))})}).Else(()=>{Oa(t.z.greaterThan(t.y),()=>{n.assign(ac(e.z.greaterThan(0),2,5))}).Else(()=>{n.assign(ac(e.y.greaterThan(0),1,4))})}),n}).setLayout({name:`getFace`,type:`float`,inputs:[{name:`direction`,type:`vec3`}]}),Bm=N(([e,t])=>{let n=I().toVar();return Oa(t.equal(0),()=>{n.assign(I(e.z,e.y).div(Cs(e.x)))}).ElseIf(t.equal(1),()=>{n.assign(I(e.x.negate(),e.z.negate()).div(Cs(e.y)))}).ElseIf(t.equal(2),()=>{n.assign(I(e.x.negate(),e.y).div(Cs(e.z)))}).ElseIf(t.equal(3),()=>{n.assign(I(e.z.negate(),e.y).div(Cs(e.x)))}).ElseIf(t.equal(4),()=>{n.assign(I(e.x.negate(),e.z).div(Cs(e.y)))}).Else(()=>{n.assign(I(e.x,e.y).div(Cs(e.z)))}),U(.5,n.add(1))}).setLayout({name:`getUV`,type:`vec2`,inputs:[{name:`direction`,type:`vec3`},{name:`face`,type:`float`}]}),Vm=N(([e])=>{let t=P(0).toVar();return Oa(e.greaterThanEqual(km),()=>{t.assign(Dm.sub(e).mul(Am.sub(Om)).div(Dm.sub(km)).add(Om))}).ElseIf(e.greaterThanEqual(jm),()=>{t.assign(km.sub(e).mul(Mm.sub(Am)).div(km.sub(jm)).add(Am))}).ElseIf(e.greaterThanEqual(Nm),()=>{t.assign(jm.sub(e).mul(Pm.sub(Mm)).div(jm.sub(Nm)).add(Mm))}).ElseIf(e.greaterThanEqual(Fm),()=>{t.assign(Nm.sub(e).mul(Im.sub(Pm)).div(Nm.sub(Fm)).add(Pm))}).Else(()=>{t.assign(P(-2).mul(us(U(1.16,e))))}),t}).setLayout({name:`roughnessToMip`,type:`float`,inputs:[{name:`roughness`,type:`float`}]}),Hm=N(([e,t])=>{let n=e.toVar();n.assign(U(2,n).sub(1));let r=L(n,1).toVar();return Oa(t.equal(0),()=>{r.assign(r.zyx)}).ElseIf(t.equal(1),()=>{r.assign(r.xzy),r.xz.mulAssign(-1)}).ElseIf(t.equal(2),()=>{r.x.mulAssign(-1)}).ElseIf(t.equal(3),()=>{r.assign(r.zyx),r.xz.mulAssign(-1)}).ElseIf(t.equal(4),()=>{r.assign(r.xzy),r.xy.mulAssign(-1)}).ElseIf(t.equal(5),()=>{r.z.mulAssign(-1)}),r}).setLayout({name:`getDirection`,type:`vec3`,inputs:[{name:`uv`,type:`vec2`},{name:`face`,type:`float`}]}),Um=N(([e,t,n,r,i,a])=>{let o=P(n),s=L(t),c=$s(Vm(o),Om,a),l=gs(c),u=ps(c),d=L(Wm(e,s,u,r,i,a)).toVar();return Oa(l.notEqual(0),()=>{let t=L(Wm(e,s,u.add(1),r,i,a)).toVar();d.assign(G(d,t,l))}),d}),Wm=N(([e,t,n,r,i,a])=>{let o=P(n).toVar(),s=L(t),c=P(zm(s)).toVar(),l=P(zs(Lm.sub(o),0)).toVar();o.assign(zs(o,Lm));let u=P(cs(o)).toVar(),d=I(Bm(s,c).mul(u.sub(2)).add(1)).toVar();return Oa(c.greaterThan(2),()=>{d.y.addAssign(u),c.subAssign(3)}),d.x.addAssign(c.mul(u)),d.x.addAssign(l.mul(U(3,Rm))),d.y.addAssign(U(4,cs(a).sub(u))),d.x.mulAssign(r),d.y.mulAssign(i),e.sample(d).grad(I(),I())}),Gm=N(({envMap:e,mipInt:t,outputDirection:n,theta:r,axis:i,CUBEUV_TEXEL_WIDTH:a,CUBEUV_TEXEL_HEIGHT:o,CUBEUV_MAX_MIP:s})=>{let c=vs(r);return Wm(e,n.mul(c).add(i.cross(n).mul(_s(r))).add(i.mul(i.dot(n).mul(c.oneMinus()))),t,a,o,s)}),Km=N(({n:e,latitudinal:t,poleAxis:n,outputDirection:r,weights:i,samples:a,dTheta:o,mipInt:s,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})=>{let f=L(ac(t,n,Gs(n,r))).toVar();Oa(f.equal(L(0)),()=>{f.assign(L(r.z,0,r.x.negate()))}),f.assign(hs(f));let p=L().toVar();return p.addAssign(i.element(0).mul(Gm({theta:0,axis:f,outputDirection:r,mipInt:s,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),al({start:F(1),end:e},({i:e})=>{Oa(e.greaterThanEqual(a),()=>{ol()});let t=P(o.mul(P(e))).toVar();p.addAssign(i.element(e).mul(Gm({theta:t.mul(-1),axis:f,outputDirection:r,mipInt:s,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d}))),p.addAssign(i.element(e).mul(Gm({theta:t,axis:f,outputDirection:r,mipInt:s,envMap:c,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:d})))}),R(p,1)}),qm=class e extends nr{constructor(e=1,t=1,n=1,r=1,i=1,a=1){super(),this.type=`BoxGeometry`,this.parameters={width:e,height:t,depth:n,widthSegments:r,heightSegments:i,depthSegments:a};let o=this;r=Math.floor(r),i=Math.floor(i),a=Math.floor(a);let s=[],c=[],l=[],u=[],d=0,f=0;p(`z`,`y`,`x`,-1,-1,n,t,e,a,i,0),p(`z`,`y`,`x`,1,-1,n,t,-e,a,i,1),p(`x`,`z`,`y`,1,1,e,n,t,r,a,2),p(`x`,`z`,`y`,1,-1,e,n,-t,r,a,3),p(`x`,`y`,`z`,1,-1,e,t,n,r,i,4),p(`x`,`y`,`z`,-1,-1,e,t,-n,r,i,5),this.setIndex(s),this.setAttribute(`position`,new rr(c,3)),this.setAttribute(`normal`,new rr(l,3)),this.setAttribute(`uv`,new rr(u,2));function p(e,t,n,r,i,a,p,m,h,g,_){let v=a/h,y=p/g,b=a/2,ee=p/2,x=m/2,te=h+1,ne=g+1,re=0,ie=0,S=new C;for(let a=0;a<ne;a++){let o=a*y-ee;for(let s=0;s<te;s++)S[e]=(s*v-b)*r,S[t]=o*i,S[n]=x,c.push(S.x,S.y,S.z),S[e]=0,S[t]=0,S[n]=m>0?1:-1,l.push(S.x,S.y,S.z),u.push(s/h),u.push(1-a/g),re+=1}for(let e=0;e<g;e++)for(let t=0;t<h;t++){let n=d+t+te*e,r=d+t+te*(e+1),i=d+(t+1)+te*(e+1),a=d+(t+1)+te*e;s.push(n,r,a),s.push(r,i,a),ie+=6}o.addGroup(f,ie,_),f+=ie,d+=re}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}},Jm=4,Ym=[.125,.215,.35,.446,.526,.582],Xm=20,Zm=new Ff(-1,1,1,-1,0,1),Qm=new rn(90,1),$m=new T,eh=null,th=0,nh=0,rh=(1+Math.sqrt(5))/2,ih=1/rh,ah=[new C(-rh,ih,0),new C(rh,ih,0),new C(-ih,0,rh),new C(ih,0,rh),new C(0,rh,-ih),new C(0,rh,ih),new C(-1,1,-1),new C(1,1,-1),new C(-1,1,1),new C(1,1,1)],oh=new C,sh=new WeakMap,ch=[3,1,5,0,4,2],lh=Hm(su(),Zc(`faceIndex`)).normalize(),uh=L(lh.x,lh.y,lh.z),dh=class{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,n=.1,r=100,i={}){let{size:a=256,position:o=oh,renderTarget:s=null}=i;if(this._setSize(a),this._hasInitialized===!1){console.warn(`THREE.PMREMGenerator: .fromScene() called before the backend is initialized. Try using .fromSceneAsync() instead.`);let a=s||this._allocateTarget();return i.renderTarget=a,this.fromSceneAsync(e,t,n,r,i),a}eh=this._renderer.getRenderTarget(),th=this._renderer.getActiveCubeFace(),nh=this._renderer.getActiveMipmapLevel();let c=s||this._allocateTarget();return c.depthBuffer=!0,this._init(c),this._sceneToCubeUV(e,n,r,c,o),t>0&&this._blur(c,0,0,t),this._applyPMREM(c),this._cleanup(c),c}async fromSceneAsync(e,t=0,n=.1,r=100,i={}){return this._hasInitialized===!1&&await this._renderer.init(),this.fromScene(e,t,n,r,i)}fromEquirectangular(e,t=null){if(this._hasInitialized===!1){console.warn(`THREE.PMREMGenerator: .fromEquirectangular() called before the backend is initialized. Try using .fromEquirectangularAsync() instead.`),this._setSizeFromTexture(e);let n=t||this._allocateTarget();return this.fromEquirectangularAsync(e,n),n}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return this._hasInitialized===!1&&await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(this._hasInitialized===!1){console.warn(`THREE.PMREMGenerator: .fromCubemap() called before the backend is initialized. Try using .fromCubemapAsync() instead.`),this._setSizeFromTexture(e);let n=t||this._allocateTarget();return this.fromCubemapAsync(e,t),n}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return this._hasInitialized===!1&&await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=_h(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=vh(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose(),this._backgroundBox!==null&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===301||e.mapping===302?this._setSize(e.image.length===0?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=2**this._lodMax}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(eh,th,nh),e.scissorTest=!1,mh(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),eh=this._renderer.getRenderTarget(),th=this._renderer.getActiveCubeFace(),nh=this._renderer.getActiveMipmapLevel();let n=t||this._allocateTarget();return this._init(n),this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTarget(){return ph(3*Math.max(this._cubeSize,112),4*this._cubeSize)}_init(e){if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==e.width||this._pingPongRenderTarget.height!==e.height){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=ph(e.width,e.height);let{_lodMax:t}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=fh(t)),this._blurMaterial=gh(t,e.width,e.height)}}async _compileMaterial(e){let t=new cr(this._lodPlanes[0],e);await this._renderer.compile(t,Zm)}_sceneToCubeUV(e,t,n,r,i){let a=Qm;a.near=t,a.far=n;let o=[1,1,1,1,-1,1],s=[1,-1,1,-1,1,-1],c=this._renderer,l=c.autoClear;c.getClearColor($m),c.autoClear=!1;let u=this._backgroundBox;if(u===null){let e=new or({name:`PMREM.Background`,side:1,depthWrite:!1,depthTest:!1});u=new cr(new qm,e)}let d=!1,f=e.background;f?f.isColor&&(u.material.color.copy(f),e.background=null,d=!0):(u.material.color.copy($m),d=!0),c.setRenderTarget(r),c.clear(),d&&c.render(u,a);for(let t=0;t<6;t++){let n=t%3;n===0?(a.up.set(0,o[t],0),a.position.set(i.x,i.y,i.z),a.lookAt(i.x+s[t],i.y,i.z)):n===1?(a.up.set(0,0,o[t]),a.position.set(i.x,i.y,i.z),a.lookAt(i.x,i.y+s[t],i.z)):(a.up.set(0,o[t],0),a.position.set(i.x,i.y,i.z),a.lookAt(i.x,i.y,i.z+s[t]));let l=this._cubeSize;mh(r,n*l,t>2?l:0,l,l),c.render(e,a)}c.autoClear=l,e.background=f}_textureToCubeUV(e,t){let n=this._renderer,r=e.mapping===301||e.mapping===302;r?this._cubemapMaterial===null&&(this._cubemapMaterial=_h(e)):this._equirectMaterial===null&&(this._equirectMaterial=vh(e));let i=r?this._cubemapMaterial:this._equirectMaterial;i.fragmentNode.value=e;let a=this._lodMeshes[0];a.material=i;let o=this._cubeSize;mh(t,0,0,3*o,2*o),n.setRenderTarget(t),n.render(a,Zm)}_applyPMREM(e){let t=this._renderer,n=t.autoClear;t.autoClear=!1;let r=this._lodPlanes.length;for(let t=1;t<r;t++){let n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),i=ah[(r-t-1)%ah.length];this._blur(e,t-1,t,n,i)}t.autoClear=n}_blur(e,t,n,r,i){let a=this._pingPongRenderTarget;this._halfBlur(e,a,t,n,r,`latitudinal`,i),this._halfBlur(a,e,n,n,r,`longitudinal`,i)}_halfBlur(e,t,n,r,i,a,o){let s=this._renderer,c=this._blurMaterial;a!==`latitudinal`&&a!==`longitudinal`&&console.error(`blur direction must be either latitudinal or longitudinal!`);let l=this._lodMeshes[r];l.material=c;let u=sh.get(c),d=this._sizeLods[n]-1,f=isFinite(i)?Math.PI/(2*d):2*Math.PI/(2*Xm-1),p=i/f,m=isFinite(i)?1+Math.floor(3*p):Xm;m>Xm&&console.warn(`sigmaRadians, ${i}, is too large and will clip, as it requested ${m} samples when the maximum is set to ${Xm}`);let h=[],g=0;for(let e=0;e<Xm;++e){let t=e/p,n=Math.exp(-t*t/2);h.push(n),e===0?g+=n:e<m&&(g+=2*n)}for(let e=0;e<h.length;e++)h[e]=h[e]/g;e.texture.frame=(e.texture.frame||0)+1,u.envMap.value=e.texture,u.samples.value=m,u.weights.array=h,u.latitudinal.value=a===`latitudinal`?1:0,o&&(u.poleAxis.value=o);let{_lodMax:_}=this;u.dTheta.value=f,u.mipInt.value=_-n;let v=this._sizeLods[r];mh(t,3*v*(r>_-Jm?r-_+Jm:0),4*(this._cubeSize-v),3*v,2*v),s.setRenderTarget(t),s.render(l,Zm)}};function fh(e){let t=[],n=[],r=[],i=[],a=e,o=e-Jm+1+Ym.length;for(let s=0;s<o;s++){let o=2**a;n.push(o);let c=1/o;s>e-Jm?c=Ym[s-e+Jm-1]:s===0&&(c=0),r.push(c);let l=1/(o-2),u=-l,d=1+l,f=[u,u,d,u,d,d,u,u,d,d,u,d],p=new Float32Array(108),m=new Float32Array(72),h=new Float32Array(36);for(let e=0;e<6;e++){let t=e%3*2/3-1,n=e>2?0:-1,r=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0],i=ch[e];p.set(r,18*i),m.set(f,12*i);let a=[i,i,i,i,i,i];h.set(a,6*i)}let g=new nr;g.setAttribute(`position`,new Qn(p,3)),g.setAttribute(`uv`,new Qn(m,2)),g.setAttribute(`faceIndex`,new Qn(h,1)),t.push(g),i.push(new cr(g,null)),a>Jm&&a--}return{lodPlanes:t,sizeLods:n,sigmas:r,lodMeshes:i}}function ph(e,t){let n=new Eu(e,t,{magFilter:Yt,minFilter:Yt,generateMipmaps:!1,type:Rt,format:Ct,colorSpace:p});return n.texture.mapping=306,n.texture.name=`PMREM.cubeUv`,n.texture.isPMREMTexture=!0,n.scissorTest=!0,n}function mh(e,t,n,r,i){e.viewport.set(t,n,r,i),e.scissor.set(t,n,r,i)}function hh(e){let t=new Pf;return t.depthTest=!1,t.depthWrite=!1,t.blending=0,t.name=`PMREM_${e}`,t}function gh(e,t,n){let r=ml(Array(Xm).fill(0)),i=B(new C(0,1,0)),a=B(0),o=P(Xm),s=B(0),c={n:o,latitudinal:s,weights:r,poleAxis:i,outputDirection:uh,dTheta:a,samples:B(1),envMap:q(null),mipInt:B(0),CUBEUV_TEXEL_WIDTH:P(1/t),CUBEUV_TEXEL_HEIGHT:P(1/n),CUBEUV_MAX_MIP:P(e)},l=hh(`blur`);return l.fragmentNode=Km({...c,latitudinal:s.equal(1)}),sh.set(l,c),l}function _h(e){let t=hh(`cubemap`);return t.fragmentNode=Bu(e,uh),t}function vh(e){let t=hh(`equirect`);return t.fragmentNode=q(e,Gl(uh),0),t}var yh=new WeakMap;function bh(e){let t=Math.log2(e)-2,n=1/e;return{texelWidth:1/(3*Math.max(2**t,112)),texelHeight:n,maxMip:t}}function xh(e,t,n){let r=Sh(t),i=r.get(e);if((i===void 0?-1:i.pmremVersion)!==e.pmremVersion){let t=e.image;if(e.isCubeTexture)if(wh(t))i=n.fromCubemap(e,i);else return null;else if(Th(t))i=n.fromEquirectangular(e,i);else return null;i.pmremVersion=e.pmremVersion,r.set(e,i)}return i.texture}function Sh(e){let t=yh.get(e);return t===void 0&&(t=new WeakMap,yh.set(e,t)),t}var Ch=class extends ki{static get type(){return`PMREMNode`}constructor(e,t=null,n=null){super(`vec3`),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=n,this._generator=null;let r=new gi;r.isRenderTargetTexture=!0,this._texture=q(r),this._width=B(0),this._height=B(0),this._maxMip=B(0),this.updateBeforeType=E.RENDER}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){let t=bh(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(e){let t=this._pmrem,n=t?t.pmremVersion:-1,r=this._value;n!==r.pmremVersion&&(t=r.isPMREMTexture===!0?r:xh(r,e.renderer,this._generator),t!==null&&(this._pmrem=t,this.updateFromTexture(t)))}setup(e){this._generator===null&&(this._generator=new dh(e.renderer)),this.updateBefore(e);let t=this.uvNode;t===null&&e.context.getUV&&(t=e.context.getUV(this)),t=Mu.mul(L(t.x,t.y.negate(),t.z));let n=this.levelNode;return n===null&&e.context.getTextureLevel&&(n=e.context.getTextureLevel(this)),Um(this._texture,t,n,this._width,this._height,this._maxMip)}dispose(){super.dispose(),this._generator!==null&&this._generator.dispose()}};function wh(e){if(e==null)return!1;let t=0;for(let n=0;n<6;n++)e[n]!==void 0&&t++;return t===6}function Th(e){return e==null?!1:e.height>0}var Eh=A(Ch).setParameterLength(1,3);N(([e=su()],{renderer:t,material:n})=>{let r=Qs(e.mul(2).sub(1)),i;if(n.alphaToCoverage&&t.samples>1){let e=P(r.fwidth()).toVar();i=nc(e.oneMinus(),e.add(1),r).oneMinus()}else i=ac(r.greaterThan(1),0,1);return i});var Dh=N(({f0:e,f90:t,dotVH:n})=>{let r=n.mul(-5.55473).sub(6.98316).mul(n).exp2();return e.mul(r.oneMinus()).add(t.mul(r))}),Oh=N(({alpha:e,dotNL:t,dotNV:n})=>{let r=e.pow2(),i=t.mul(r.add(r.oneMinus().mul(n.pow2())).sqrt()),a=n.mul(r.add(r.oneMinus().mul(t.pow2())).sqrt());return No(.5,i.add(a).max(ts))}).setLayout({name:`V_GGX_SmithCorrelated`,type:`float`,inputs:[{name:`alpha`,type:`float`},{name:`dotNL`,type:`float`},{name:`dotNV`,type:`float`}]}),kh=N(({alphaT:e,alphaB:t,dotTV:n,dotBV:r,dotTL:i,dotBL:a,dotNV:o,dotNL:s})=>{let c=s.mul(L(e.mul(n),t.mul(r),o).length()),l=o.mul(L(e.mul(i),t.mul(a),s).length());return No(.5,c.add(l)).saturate()}).setLayout({name:`V_GGX_SmithCorrelated_Anisotropic`,type:`float`,inputs:[{name:`alphaT`,type:`float`,qualifier:`in`},{name:`alphaB`,type:`float`,qualifier:`in`},{name:`dotTV`,type:`float`,qualifier:`in`},{name:`dotBV`,type:`float`,qualifier:`in`},{name:`dotTL`,type:`float`,qualifier:`in`},{name:`dotBL`,type:`float`,qualifier:`in`},{name:`dotNV`,type:`float`,qualifier:`in`},{name:`dotNL`,type:`float`,qualifier:`in`}]}),Ah=N(({alpha:e,dotNH:t})=>{let n=e.pow2(),r=t.pow2().mul(n.oneMinus()).oneMinus();return n.div(r.pow2()).mul(1/Math.PI)}).setLayout({name:`D_GGX`,type:`float`,inputs:[{name:`alpha`,type:`float`},{name:`dotNH`,type:`float`}]}),jh=P(1/Math.PI),Mh=N(({alphaT:e,alphaB:t,dotNH:n,dotTH:r,dotBH:i})=>{let a=e.mul(t),o=L(t.mul(r),e.mul(i),a.mul(n)),s=o.dot(o),c=a.div(s);return jh.mul(a.mul(c.pow2()))}).setLayout({name:`D_GGX_Anisotropic`,type:`float`,inputs:[{name:`alphaT`,type:`float`,qualifier:`in`},{name:`alphaB`,type:`float`,qualifier:`in`},{name:`dotNH`,type:`float`,qualifier:`in`},{name:`dotTH`,type:`float`,qualifier:`in`},{name:`dotBH`,type:`float`,qualifier:`in`}]}),Nh=N(({lightDirection:e,f0:t,f90:n,roughness:r,f:i,normalView:a=K,USE_IRIDESCENCE:o,USE_ANISOTROPY:s})=>{let c=r.pow2(),l=e.add(Wl).normalize(),u=a.dot(e).clamp(),d=a.dot(Wl).clamp(),f=a.dot(l).clamp(),p=Dh({f0:t,f90:n,dotVH:Wl.dot(l).clamp()}),m,h;if(va(o)&&(p=co.mix(p,i)),va(s)){let t=mo.dot(e),n=mo.dot(Wl),r=mo.dot(l),i=ho.dot(e),a=ho.dot(Wl),o=ho.dot(l);m=kh({alphaT:fo,alphaB:c,dotTV:n,dotBV:a,dotTL:t,dotBL:i,dotNV:d,dotNL:u}),h=Mh({alphaT:fo,alphaB:c,dotNH:f,dotTH:r,dotBH:o})}else m=Oh({alpha:c,dotNL:u,dotNV:d}),h=Ah({alpha:c,dotNH:f});return p.mul(m).mul(h)}),Ph=N(e=>e.diffuseColor.mul(1/Math.PI)),Fh=N(({roughness:e,dotNV:t})=>{let n=R(-1,-.0275,-.572,.022),r=R(1,.0425,1.04,-.04),i=e.mul(n).add(r),a=i.x.mul(i.x).min(t.mul(-9.28).exp2()).mul(i.x).add(i.y);return I(-1.04,1.04).mul(a).add(i.zw)}).setLayout({name:`DFGApprox`,type:`vec2`,inputs:[{name:`roughness`,type:`float`},{name:`dotNV`,type:`vec3`}]}),Ih=N(({f:e,f90:t,dotVH:n})=>{let r=n.oneMinus().saturate(),i=r.mul(r),a=r.mul(i,i).clamp(0,.9999);return e.sub(L(t).mul(a)).div(a.oneMinus())}).setLayout({name:`Schlick_to_F0`,type:`vec3`,inputs:[{name:`f`,type:`vec3`},{name:`f90`,type:`float`},{name:`dotVH`,type:`float`}]}),Lh=N(e=>{if(e.geometry.hasAttribute(`normal`)===!1)return P(0);let t=Zl.dFdx().abs().max(Zl.dFdy().abs());return t.x.max(t.y).max(t.z)}),Rh=N(e=>{let{roughness:t}=e,n=Lh(),r=t.max(.0525);return r=r.add(n),r=r.min(1),r}),zh=N(([e,t])=>{let n=e.x,r=e.y,i=e.z,a=t.element(0).mul(.886227);return a=a.add(t.element(1).mul(2*.511664).mul(r)),a=a.add(t.element(2).mul(2*.511664).mul(i)),a=a.add(t.element(3).mul(2*.511664).mul(n)),a=a.add(t.element(4).mul(2*.429043).mul(n).mul(r)),a=a.add(t.element(5).mul(2*.429043).mul(r).mul(i)),a=a.add(t.element(6).mul(i.mul(i).mul(.743125).sub(.247708))),a=a.add(t.element(7).mul(2*.429043).mul(n).mul(i)),a=a.add(t.element(8).mul(.429043).mul(U(n,n).sub(U(r,r)))),a}),Bh=new bi,Vh=class extends Mr{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,n){let r=this.renderer,i=this.nodes.getBackgroundNode(e)||e.background,a=!1;if(i===null)r._clearColor.getRGB(Bh),Bh.a=r._clearColor.a;else if(i.isColor===!0)i.getRGB(Bh),Bh.a=1,a=!0;else if(i.isNode===!0){let n=this.get(e),a=i;Bh.copy(r._clearColor);let o=n.backgroundMesh;if(o===void 0){let e=function(){i.removeEventListener(`dispose`,e),o.material.dispose(),o.geometry.dispose()},t=sc(R(a).mul(tp),{getUV:()=>np.mul(Ql),getTextureLevel:()=>ep}),r=ef;r=r.setZ(r.w);let s=new Pf;s.name=`Background.material`,s.side=1,s.depthTest=!1,s.depthWrite=!1,s.allowOverride=!1,s.fog=!1,s.lights=!1,s.vertexNode=r,s.colorNode=t,n.backgroundMeshNode=t,n.backgroundMesh=o=new cr(new sr(1,32,32),s),o.frustumCulled=!1,o.name=`Background.mesh`,o.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},i.addEventListener(`dispose`,e)}let s=a.getCacheKey();n.backgroundCacheKey!==s&&(n.backgroundMeshNode.node=R(a).mul(tp),n.backgroundMeshNode.needsUpdate=!0,o.material.needsUpdate=!0,n.backgroundCacheKey=s),t.unshift(o,o.geometry,o.material,0,0,null,null)}else console.error(`THREE.Renderer: Unsupported background configuration.`,i);let o=r.xr.getEnvironmentBlendMode();if(o===`additive`?Bh.set(0,0,0,1):o===`alpha-blend`&&Bh.set(0,0,0,0),r.autoClear===!0||a===!0){let e=n.clearColorValue;e.r=Bh.r,e.g=Bh.g,e.b=Bh.b,e.a=Bh.a,(r.backend.isWebGLBackend===!0||r.alpha===!0)&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),n.depthClearValue=r._clearDepth,n.stencilClearValue=r._clearStencil,n.clearColor=r.autoClearColor===!0,n.clearDepth=r.autoClearDepth===!0,n.clearStencil=r.autoClearStencil===!0}else n.clearColor=!1,n.clearDepth=!1,n.clearStencil=!1}},Hh=0,Uh=class{constructor(e=``,t=[],n=0,r=[]){this.name=e,this.bindings=t,this.index=n,this.bindingsReference=r,this.id=Hh++}},Wh=class{constructor(e,t,n,r,i,a,o,s,c,l=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=n,this.transforms=l,this.nodeAttributes=r,this.bindings=i,this.updateNodes=a,this.updateBeforeNodes=o,this.updateAfterNodes=s,this.observer=c,this.usedTimes=0}createBindings(){let e=[];for(let t of this.bindings)if(t.bindings[0].groupNode.shared!==!0){let n=new Uh(t.name,[],t.index,t.bindingsReference);e.push(n);for(let e of t.bindings)n.bindings.push(e.clone())}else e.push(t);return e}};function Gh(e){let t={};for(let n in e)for(let r in t[n]={},e[n]){let i=e[n][r];i&&(i.isColor||i.isMatrix3||i.isMatrix4||i.isVector2||i.isVector3||i.isVector4||i.isTexture||i.isQuaternion)?i.isRenderTargetTexture?(console.warn(`UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms().`),t[n][r]=null):t[n][r]=i.clone():Array.isArray(i)?t[n][r]=i.slice():t[n][r]=i}return t}function Kh(e){let t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}var qh=`
void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
`,Jh=`
void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}
`,Yh=class extends $n{constructor(e){super(),this.isShaderMaterial=!0,this.type=`ShaderMaterial`,this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=qh,this.fragmentShader=Jh,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Gh(e.uniforms),this.uniformsGroups=Kh(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){let t=super.toJSON(e);for(let n in t.glslVersion=this.glslVersion,t.uniforms={},this.uniforms){let r=this.uniforms[n].value;r&&r.isTexture?t.uniforms[n]={type:`t`,value:r.toJSON(e).uuid}:r&&r.isColor?t.uniforms[n]={type:`c`,value:r.getHex()}:r&&r.isVector2?t.uniforms[n]={type:`v2`,value:r.toArray()}:r&&r.isVector3?t.uniforms[n]={type:`v3`,value:r.toArray()}:r&&r.isVector4?t.uniforms[n]={type:`v4`,value:r.toArray()}:r&&r.isMatrix3?t.uniforms[n]={type:`m3`,value:r.toArray()}:r&&r.isMatrix4?t.uniforms[n]={type:`m4`,value:r.toArray()}:t.uniforms[n]={value:r}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;let n={};for(let e in this.extensions)this.extensions[e]===!0&&(n[e]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}},Xh=class extends Eu{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}},Zh=-90,Qh=1,$h=class extends it{constructor(e,t,n){super(),this.type=`CubeCamera`,this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;let r=new rn(Zh,Qh,e,t);r.layers=this.layers,this.add(r);let i=new rn(Zh,Qh,e,t);i.layers=this.layers,this.add(i);let a=new rn(Zh,Qh,e,t);a.layers=this.layers,this.add(a);let o=new rn(Zh,Qh,e,t);o.layers=this.layers,this.add(o);let s=new rn(Zh,Qh,e,t);s.layers=this.layers,this.add(s);let c=new rn(Zh,Qh,e,t);c.layers=this.layers,this.add(c)}updateCoordinateSystem(){let e=this.coordinateSystem,t=this.children.concat(),[n,r,i,a,o,s]=t;for(let e of t)this.remove(e);if(e===2e3)n.up.set(0,1,0),n.lookAt(1,0,0),r.up.set(0,1,0),r.lookAt(-1,0,0),i.up.set(0,0,-1),i.lookAt(0,1,0),a.up.set(0,0,1),a.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),s.up.set(0,1,0),s.lookAt(0,0,-1);else if(e===2001)n.up.set(0,-1,0),n.lookAt(-1,0,0),r.up.set(0,-1,0),r.lookAt(1,0,0),i.up.set(0,0,1),i.lookAt(0,1,0),a.up.set(0,0,-1),a.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),s.up.set(0,-1,0),s.lookAt(0,0,-1);else throw Error(`THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: `+e);for(let e of t)this.add(e),e.updateMatrixWorld()}update(e,t){this.parent===null&&this.updateMatrixWorld();let{renderTarget:n,activeMipmapLevel:r}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());let[i,a,o,s,c,l]=this.children,u=e.getRenderTarget(),d=e.getActiveCubeFace(),f=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;let m=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,r),e.render(t,i),e.setRenderTarget(n,1,r),e.render(t,a),e.setRenderTarget(n,2,r),e.render(t,o),e.setRenderTarget(n,3,r),e.render(t,s),e.setRenderTarget(n,4,r),e.render(t,c),n.texture.generateMipmaps=m,e.setRenderTarget(n,5,r),e.render(t,l),e.setRenderTarget(u,d,f),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}},eg=class extends Xh{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;let n={width:e,height:e,depth:1};this.texture=new Lu([n,n,n,n,n,n]),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;let n={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},r=new qm(5,5,5),i=new Yh({name:`CubemapFromEquirect`,uniforms:Gh(n.uniforms),vertexShader:n.vertexShader,fragmentShader:n.fragmentShader,side:1,blending:0});i.uniforms.tEquirect.value=t;let a=new cr(r,i),o=t.minFilter;return t.minFilter===1008&&(t.minFilter=1006),new $h(1,10,this).update(e,a),t.minFilter=o,a.geometry.dispose(),a.material.dispose(),this}clear(e,t=!0,n=!0,r=!0){let i=e.getRenderTarget();for(let i=0;i<6;i++)e.setRenderTarget(this,i),e.clear(t,n,r);e.setRenderTarget(i)}},tg=class extends eg{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){let n=t.minFilter,r=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;let i=new qm(5,5,5),a=Gl(Hl),o=new Pf;o.colorNode=q(t,a,0),o.side=1,o.blending=0;let s=new cr(i,o),c=new ii;c.add(s),t.minFilter===1008&&(t.minFilter=1006);let l=new $h(1,10,this),u=e.getMRT();return e.setMRT(null),l.update(e,c),e.setMRT(u),t.minFilter=n,t.currentGenerateMipmaps=r,s.geometry.dispose(),s.material.dispose(),this}},ng=new WeakMap,rg=class extends ki{static get type(){return`CubeMapNode`}constructor(e){super(`vec3`),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=Bu(null);let t=new Lu;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=E.RENDER}updateBefore(e){let{renderer:t,material:n}=e,r=this.envNode;if(r.isTextureNode||r.isMaterialReferenceNode){let e=r.isTextureNode?r.value:n[r.property];if(e&&e.isTexture){let n=e.mapping;if(n===303||n===304){if(ng.has(e)){let t=ng.get(e);og(t,e.mapping),this._cubeTexture=t}else{let n=e.image;if(ig(n)){let r=new tg(n.height);r.fromEquirectangularTexture(t,e),og(r.texture,e.mapping),this._cubeTexture=r.texture,ng.set(e,r.texture),e.addEventListener(`dispose`,ag)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}};function ig(e){return e==null?!1:e.height>0}function ag(e){let t=e.target;t.removeEventListener(`dispose`,ag);let n=ng.get(t);n!==void 0&&(ng.delete(t),n.dispose())}function og(e,t){t===303?e.mapping=301:t===304&&(e.mapping=302)}var sg=A(rg).setParameterLength(1),cg=class{start(e){e.lightsNode.setupLights(e,e.lightsNode.getLightNodes(e)),this.indirect(e)}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}},lg=class{constructor(e,t,n=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=n}},ug=class{constructor(e,t,n){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=n}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}},dg=class{constructor(e,t,n=!1,r=null){this.isNodeVar=!0,this.name=e,this.type=t,this.readOnly=n,this.count=r}},fg=class extends dg{constructor(e,t,n=null,r=null){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0,this.interpolationType=n,this.interpolationSampling=r}},pg=class{constructor(e,t,n=``){this.name=e,this.type=t,this.code=n,Object.defineProperty(this,`isNodeCode`,{value:!0})}},mg=0,hg=class{constructor(e=null){this.id=mg++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return t===void 0&&this.parent!==null&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}},gg=class{constructor(e,t){this.name=e,this.members=t,this.output=!1}},_g=class{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}},vg=class extends _g{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}},yg=class extends _g{constructor(e,t=new w){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}},bg=class extends _g{constructor(e,t=new C){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}},xg=class extends _g{constructor(e,t=new s){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}},Sg=class extends _g{constructor(e,t=new T){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}},Cg=class extends _g{constructor(e,t=new fr){super(e,t),this.isMatrix2Uniform=!0,this.boundary=8,this.itemSize=4}},wg=class extends _g{constructor(e,t=new qe){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}},Tg=class extends _g{constructor(e,t=new zn){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}},Eg=class extends vg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Dg=class extends yg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Og=class extends bg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},kg=class extends xg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Ag=class extends Sg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},jg=class extends Cg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Mg=class extends wg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Ng=class extends Tg{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Pg=new WeakMap,Fg=new Map([[Int8Array,`int`],[Int16Array,`int`],[Int32Array,`int`],[Uint8Array,`uint`],[Uint16Array,`uint`],[Uint32Array,`uint`],[Float32Array,`float`]]),Ig=e=>/e/g.test(e)?String(e).replace(/\+/g,``):(e=Number(e),e+(e%1?``:`.0`)),Lg=class{constructor(e,t,n){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=n,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.observer=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:``,fragment:``,compute:``},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.types={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.declarations={},this.flow={code:``},this.chaining=[],this.stack=rl(),this.stacks=[],this.tab=`	`,this.currentFunctionNode=null,this.context={material:this.material},this.cache=new hg,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null,this.subBuildLayers=[],this.currentStack=null,this.subBuildFn=null}getBindGroupsCache(){let e=Pg.get(this.renderer);return e===void 0&&(e=new dr,Pg.set(this.renderer,e)),e}createRenderTarget(e,t,n){return new Eu(e,t,n)}createCubeRenderTarget(e,t){return new tg(e,t)}includes(e){return this.nodes.includes(e)}getOutputStructName(){}_getBindGroup(e,t){let n=this.getBindGroupsCache(),r=[],i=!0;for(let e of t)r.push(e),i&&=e.groupNode.shared!==!0;let a;return i?(a=n.get(r),a===void 0&&(a=new Uh(e,r,this.bindingsIndexes[e].group,r),n.set(r,a))):a=new Uh(e,r,this.bindingsIndexes[e].group,r),a}getBindGroupArray(e,t){let n=this.bindings[t],r=n[e];return r===void 0&&(this.bindingsIndexes[e]===void 0&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),n[e]=r=[]),r}getBindings(){let e=this.bindGroups;if(e===null){let t={},n=this.bindings;for(let e of Ti)for(let r in n[e]){let i=n[e][r];(t[r]||(t[r]=[])).push(...i)}for(let n in e=[],t){let r=t[n],i=this._getBindGroup(n,r);e.push(i)}this.bindGroups=e}return e}sortBindingGroups(){let e=this.getBindings();e.sort((e,t)=>e.bindings[0].groupNode.order-t.bindings[0].groupNode.order);for(let t=0;t<e.length;t++){let n=e[t];this.bindingsIndexes[n.name].group=t,n.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){this.nodes.includes(e)===!1&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){this.sequentialNodes.includes(e)===!1&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(let e of this.nodes)e.getUpdateType()!==E.NONE&&this.updateNodes.push(e);for(let e of this.sequentialNodes){let t=e.getUpdateBeforeType(),n=e.getUpdateAfterType();t!==E.NONE&&this.updateBeforeNodes.push(e),n!==E.NONE&&this.updateAfterNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===1006||e.magFilter===1007||e.magFilter===1005||e.magFilter===1008||e.minFilter===1006||e.minFilter===1007||e.minFilter===1005||e.minFilter===1008}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw Error(`NodeBuilder: Invalid node chaining!`)}getMethod(e){return e}getTernary(){return null}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return{...this.context},this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){let n=this.getDataFromNode(e);return n.cache===void 0&&(n.cache=new hg(t?this.getCache():null)),n.cache}isAvailable(){return!1}getVertexIndex(){console.warn(`Abstract function.`)}getInstanceIndex(){console.warn(`Abstract function.`)}getDrawIndex(){console.warn(`Abstract function.`)}getFrontFacing(){console.warn(`Abstract function.`)}getFragCoord(){console.warn(`Abstract function.`)}isFlipY(){return!1}increaseUsage(e){let t=this.getDataFromNode(e);return t.usageCount=t.usageCount===void 0?1:t.usageCount+1,t.usageCount}generateTexture(){console.warn(`Abstract function.`)}generateTextureLod(){console.warn(`Abstract function.`)}generateArrayDeclaration(e,t){return this.getType(e)+`[ `+t+` ]`}generateArray(e,t,n=null){let r=this.generateArrayDeclaration(e,t)+`( `;for(let i=0;i<t;i++){let a=n?n[i]:null;a===null?r+=this.generateConst(e):r+=a.build(this,e),i<t-1&&(r+=`, `)}return r+=` )`,r}generateStruct(e,t,n=null){let r=[];for(let e of t){let{name:t,type:i}=e;n&&n[t]&&n[t].isNode?r.push(n[t].build(this,i)):r.push(this.generateConst(i))}return e+`( `+r.join(`, `)+` )`}generateConst(e,t=null){if(t===null&&(e===`float`||e===`int`||e===`uint`?t=0:e===`bool`?t=!1:e===`color`?t=new T:e===`vec2`?t=new w:e===`vec3`?t=new C:e===`vec4`&&(t=new s)),e===`float`)return Ig(t);if(e===`int`)return`${Math.round(t)}`;if(e===`uint`)return t>=0?`${Math.round(t)}u`:`0u`;if(e===`bool`)return t?`true`:`false`;if(e===`color`)return`${this.getType(`vec3`)}( ${Ig(t.r)}, ${Ig(t.g)}, ${Ig(t.b)} )`;let n=this.getTypeLength(e),r=this.getComponentType(e),i=e=>this.generateConst(r,e);if(n===2)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)} )`;if(n===3)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)} )`;if(n===4&&e!==`mat2`)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)}, ${i(t.w)} )`;if(n>=4&&t&&(t.isMatrix2||t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(i).join(`, `)} )`;if(n>4)return`${this.getType(e)}()`;throw Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return e===`color`?`vec3`:e}hasGeometryAttribute(e){return this.geometry&&this.geometry.getAttribute(e)!==void 0}getAttribute(e,t){let n=this.attributes;for(let t of n)if(t.name===e)return t;let r=new lg(e,t);return this.registerDeclaration(r),n.push(r),r}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return e===`void`||e===`property`||e===`sampler`||e===`samplerComparison`||e===`texture`||e===`cubeTexture`||e===`storageTexture`||e===`depthTexture`||e===`texture3D`}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){let t=e.type;if(e.isDataTexture){if(t===1013)return`int`;if(t===1014)return`uint`}return`float`}getElementType(e){return e===`mat2`?`vec2`:e===`mat3`?`vec3`:e===`mat4`?`vec4`:this.getComponentType(e)}getComponentType(e){if(e=this.getVectorType(e),e===`float`||e===`bool`||e===`int`||e===`uint`)return e;let t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return t===null?null:t[1]===`b`?`bool`:t[1]===`i`?`int`:t[1]===`u`?`uint`:`float`}getVectorType(e){return e===`color`?`vec3`:e===`texture`||e===`cubeTexture`||e===`storageTexture`||e===`texture3D`?`vec4`:e}getTypeFromLength(e,t=`float`){if(e===1)return t;let n=xr(e),r=t===`float`?``:t[0];return/mat2/.test(t)===!0&&(n=n.replace(`vec`,`mat`)),r+n}getTypeFromArray(e){return Fg.get(e.constructor)}isInteger(e){return/int|uint|(i|u)vec/.test(e)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);let n=t.array,r=e.itemSize,i=e.normalized,a;return!(e instanceof tr)&&i!==!0&&(a=this.getTypeFromArray(n)),this.getTypeFromLength(r,a)}getTypeLength(e){let t=this.getVectorType(e),n=/vec([2-4])/.exec(t);return n===null?t===`float`||t===`bool`||t===`int`||t===`uint`?1:/mat2/.test(e)===!0?4:/mat3/.test(e)===!0?9:/mat4/.test(e)===!0?16:0:Number(n[1])}getVectorFromMatrix(e){return e.replace(`mat`,`vec`)}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){let t=this.getComponentType(e);return t===`int`||t===`uint`?e:this.changeComponentType(e,`int`)}addStack(){this.stack=rl(this.stack);let e=Da();return this.stacks.push(e),Ea(this.stack),this.stack}removeStack(){let e=this.stack;return this.stack=e.parent,Ea(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,n=null){n=n===null?e.isGlobal(this)?this.globalCache:this.cache:n;let r=n.getData(e);r===void 0&&(r={},n.setData(e,r)),r[t]===void 0&&(r[t]={});let i=r[t],a=r.any?r.any.subBuilds:null,o=this.getClosestSubBuild(a);return o&&(i.subBuildsCache===void 0&&(i.subBuildsCache={}),i=i.subBuildsCache[o]||(i.subBuildsCache[o]={}),i.subBuilds=a),i}getNodeProperties(e,t=`any`){let n=this.getDataFromNode(e,t);return n.properties||={outputNode:null}}getBufferAttributeFromNode(e,t){let n=this.getDataFromNode(e),r=n.bufferAttribute;return r===void 0&&(r=new lg(`nodeAttribute`+ this.uniforms.index++,t,e),this.bufferAttributes.push(r),n.bufferAttribute=r),r}getStructTypeNode(e,t=this.shaderStage){return this.types[t][e]||null}getStructTypeFromNode(e,t,n=null,r=this.shaderStage){let i=this.getDataFromNode(e,r,this.globalCache),a=i.structType;if(a===void 0){let o=this.structs.index++;n===null&&(n=`StructType`+o),a=new gg(n,t),this.structs[r].push(a),this.types[r][n]=e,i.structType=a}return a}getOutputStructTypeFromNode(e,t){let n=this.getStructTypeFromNode(e,t,`OutputType`,`fragment`);return n.output=!0,n}getUniformFromNode(e,t,n=this.shaderStage,r=null){let i=this.getDataFromNode(e,n,this.globalCache),a=i.uniform;if(a===void 0){let o=this.uniforms.index++;a=new ug(r||`nodeUniform`+o,t,e),this.uniforms[n].push(a),this.registerDeclaration(a),i.uniform=a}return a}getVarFromNode(e,t=null,n=e.getNodeType(this),r=this.shaderStage,i=!1){let a=this.getDataFromNode(e,r),o=this.getSubBuildProperty(`variable`,a.subBuilds),s=a[o];if(s===void 0){let c=i?`_const`:`_var`,l=this.vars[r]||(this.vars[r]=[]),u=this.vars[c]||(this.vars[c]=0);t===null&&(t=(i?`nodeConst`:`nodeVar`)+u,this.vars[c]++),o!==`variable`&&(t=this.getSubBuildProperty(t,a.subBuilds));let d=e.getArrayCount(this);s=new dg(t,n,i,d),i||l.push(s),this.registerDeclaration(s),a[o]=s}return s}isDeterministic(e){if(e.isMathNode)return this.isDeterministic(e.aNode)&&(e.bNode?this.isDeterministic(e.bNode):!0)&&(e.cNode?this.isDeterministic(e.cNode):!0);if(e.isOperatorNode)return this.isDeterministic(e.aNode)&&(e.bNode?this.isDeterministic(e.bNode):!0);if(e.isArrayNode){if(e.values!==null){for(let t of e.values)if(!this.isDeterministic(t))return!1}return!0}else if(e.isConstNode)return!0;return!1}getVaryingFromNode(e,t=null,n=e.getNodeType(this),r=null,i=null){let a=this.getDataFromNode(e,`any`),o=this.getSubBuildProperty(`varying`,a.subBuilds),s=a[o];if(s===void 0){let e=this.varyings,c=e.length;t===null&&(t=`nodeVarying`+c),o!==`varying`&&(t=this.getSubBuildProperty(t,a.subBuilds)),s=new fg(t,n,r,i),e.push(s),this.registerDeclaration(s),a[o]=s}return s}registerDeclaration(e){let t=this.shaderStage,n=this.declarations[t]||(this.declarations[t]={}),r=this.getPropertyName(e),i=1,a=r;for(;n[a]!==void 0;)a=r+`_`+ i++;i>1&&(e.name=a,console.warn(`THREE.TSL: Declaration name '${r}' of '${e.type}' already in use. Renamed to '${a}'.`)),n[a]=e}getCodeFromNode(e,t,n=this.shaderStage){let r=this.getDataFromNode(e),i=r.code;if(i===void 0){let e=this.codes[n]||(this.codes[n]=[]),a=e.length;i=new pg(`nodeCode`+a,t),e.push(i),r.code=i}return i}addFlowCodeHierarchy(e,t){let{flowCodes:n,flowCodeBlock:r}=this.getDataFromNode(e),i=!0,a=t;for(;a;){if(r.get(a)===!0){i=!1;break}a=this.getDataFromNode(a).parentNodeBlock}if(i)for(let e of n)this.addLineFlowCode(e)}addLineFlowCodeBlock(e,t,n){let r=this.getDataFromNode(e),i=r.flowCodes||=[],a=r.flowCodeBlock||=new WeakMap;i.push(t),a.set(n,!0)}addLineFlowCode(e,t=null){return e===``?this:(t!==null&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e+=`;
`),this.flow.code+=e,this)}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+=`	`,this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){let t=e.getNodeType(this),n=this.flowChildNode(e,t);return this.flowsData.set(e,n),n}addInclude(e){this.currentFunctionNode!==null&&this.currentFunctionNode.includes.push(e)}buildFunctionNode(e){let t=new bp,n=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=n,t}flowShaderNode(e){let t=e.layout,n={[Symbol.iterator](){let e=0,t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(let e of t.inputs)n[e.name]=new nl(e.type,e.name);e.layout=null;let r=e.call(n),i=this.flowStagesNode(r,t.type);return e.layout=t,i}flowBuildStage(e,t,n=null){let r=this.getBuildStage();this.setBuildStage(t);let i=e.build(this,n);return this.setBuildStage(r),i}flowStagesNode(e,t=null){let n=this.flow,r=this.vars,i=this.declarations,a=this.cache,o=this.buildStage,s=this.stack,c={code:``};this.flow=c,this.vars={},this.declarations={},this.cache=new hg,this.stack=rl();for(let n of wi)this.setBuildStage(n),c.result=e.build(this,t);return c.vars=this.getVars(this.shaderStage),this.flow=n,this.vars=r,this.declarations=i,this.cache=a,this.stack=s,this.setBuildStage(o),c}getFunctionOperator(){return null}buildFunctionCode(){console.warn(`Abstract function.`)}flowChildNode(e,t=null){let n=this.flow,r={code:``};return this.flow=r,r.result=e.build(this,t),this.flow=n,r}flowNodeFromShaderStage(e,t,n=null,r=null){let i=this.tab,a=this.cache,o=this.shaderStage,s=this.context;this.setShaderStage(e);let c={...this.context};delete c.nodeBlock,this.cache=this.globalCache,this.tab=`	`,this.context=c;let l=null;if(this.buildStage===`generate`){let i=this.flowChildNode(t,n);r!==null&&(i.code+=`${this.tab+r} = ${i.result};
`),this.flowCode[e]=this.flowCode[e]+i.code,l=i}else l=t.build(this);return this.setShaderStage(o),this.cache=a,this.tab=i,this.context=s,l}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn(`Abstract function.`)}getVaryings(){console.warn(`Abstract function.`)}getVar(e,t,n=null){return`${n===null?this.getType(e):this.generateArrayDeclaration(e,n)} ${t}`}getVars(e){let t=``,n=this.vars[e];if(n!==void 0)for(let e of n)t+=`${this.getVar(e.type,e.name)}; `;return t}getUniforms(){console.warn(`Abstract function.`)}getCodes(e){let t=this.codes[e],n=``;if(t!==void 0)for(let e of t)n+=e.code+`
`;return n}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn(`Abstract function.`)}get subBuild(){return this.subBuildLayers[this.subBuildLayers.length-1]||null}addSubBuild(e){this.subBuildLayers.push(e)}removeSubBuild(){return this.subBuildLayers.pop()}getClosestSubBuild(e){let t;if(t=e&&e.isNode?e.isShaderCallNodeInternal?e.shaderNode.subBuilds:e.isStackNode?[e.subBuild]:this.getDataFromNode(e,`any`).subBuilds:e instanceof Set?[...e]:e,!t)return null;let n=this.subBuildLayers;for(let e=t.length-1;e>=0;e--){let r=t[e];if(n.includes(r))return r}return null}getSubBuildOutput(e){return this.getSubBuildProperty(`outputNode`,e)}getSubBuildProperty(e=``,t=null){let n;n=t===null?this.subBuildFn:this.getClosestSubBuild(t);let r;return r=n?e?n+`_`+e:n:e,r}build(){let{object:e,material:t,renderer:n}=this;if(t!==null){let e=n.library.fromMaterial(t);e===null&&(console.error(`NodeMaterial: Material "${t.type}" is not compatible.`),e=new Pf),e.build(this)}else this.addFlow(`compute`,e);for(let e of wi){this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage(`vertex`,this.context.vertex);for(let t of Ti){this.setShaderStage(t);let n=this.flowNodes[t];for(let t of n)e===`generate`?this.flowNode(t):t.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if(t===`float`||t===`int`||t===`uint`)return new Eg(e);if(t===`vec2`||t===`ivec2`||t===`uvec2`)return new Dg(e);if(t===`vec3`||t===`ivec3`||t===`uvec3`)return new Og(e);if(t===`vec4`||t===`ivec4`||t===`uvec4`)return new kg(e);if(t===`color`)return new Ag(e);if(t===`mat2`)return new jg(e);if(t===`mat3`)return new Mg(e);if(t===`mat4`)return new Ng(e);throw Error(`Uniform "${t}" not declared.`)}format(e,t,n){if(t=this.getVectorType(t),n=this.getVectorType(n),t===n||n===null||this.isReference(n))return e;let r=this.getTypeLength(t),i=this.getTypeLength(n);return r===16&&i===9?`${this.getType(n)}( ${e}[ 0 ].xyz, ${e}[ 1 ].xyz, ${e}[ 2 ].xyz )`:r===9&&i===4?`${this.getType(n)}( ${e}[ 0 ].xy, ${e}[ 1 ].xy )`:r>4||i>4||i===0?e:r===i?`${this.getType(n)}( ${e} )`:r>i?(e=n===`bool`?`all( ${e} )`:`${e}.${`xyz`.slice(0,i)}`,this.format(e,this.getTypeFromLength(i,this.getComponentType(t)),n)):i===4&&r>1?`${this.getType(n)}( ${this.format(e,t,`vec3`)}, 1.0 )`:r===2?`${this.getType(n)}( ${this.format(e,t,`vec2`)}, 0.0 )`:(r===1&&i>1&&t!==this.getComponentType(n)&&(e=`${this.getType(this.getComponentType(n))}( ${e} )`),`${this.getType(n)}( ${e} )`)}getSignature(){return`// Three.js r180 - Node System
`}},Rg=class{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let n=e.get(t);return n===void 0&&(n={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,n)),n}updateBeforeNode(e){let t=e.getUpdateBeforeType(),n=e.updateReference(this);if(t===E.FRAME){let{frameMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.frameId&&e.updateBefore(this)!==!1&&t.set(n,this.frameId)}else if(t===E.RENDER){let{renderMap:t}=this._getMaps(this.updateBeforeMap,n);t.get(n)!==this.renderId&&e.updateBefore(this)!==!1&&t.set(n,this.renderId)}else t===E.OBJECT&&e.updateBefore(this)}updateAfterNode(e){let t=e.getUpdateAfterType(),n=e.updateReference(this);if(t===E.FRAME){let{frameMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.frameId&&e.updateAfter(this)!==!1&&t.set(n,this.frameId)}else if(t===E.RENDER){let{renderMap:t}=this._getMaps(this.updateAfterMap,n);t.get(n)!==this.renderId&&e.updateAfter(this)!==!1&&t.set(n,this.renderId)}else t===E.OBJECT&&e.updateAfter(this)}updateNode(e){let t=e.getUpdateType(),n=e.updateReference(this);if(t===E.FRAME){let{frameMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.frameId&&e.update(this)!==!1&&t.set(n,this.frameId)}else if(t===E.RENDER){let{renderMap:t}=this._getMaps(this.updateMap,n);t.get(n)!==this.renderId&&e.update(this)!==!1&&t.set(n,this.renderId)}else t===E.OBJECT&&e.update(this)}update(){this.frameId++,this.lastTime===void 0&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}},zg=class{constructor(e,t,n=null,r=``,i=!1){this.type=e,this.name=t,this.count=n,this.qualifier=r,this.isConst=i}};zg.isNodeFunctionInput=!0;var Bg=class extends Cm{static get type(){return`DirectionalLightNode`}constructor(e=null){super(e)}setupDirect(){let e=this.colorNode;return{lightDirection:Np(this.light),lightColor:e}}},Vg=new zn,Hg=new zn,Ug=null,Wg=class extends Cm{static get type(){return`RectAreaLightNode`}constructor(e=null){super(e),this.halfHeight=B(new C).setGroup(z),this.halfWidth=B(new C).setGroup(z),this.updateType=E.RENDER}update(e){super.update(e);let{light:t}=this,n=e.camera.matrixWorldInverse;Hg.identity(),Vg.copy(t.matrixWorld),Vg.premultiply(n),Hg.extractRotation(Vg),this.halfWidth.value.set(t.width*.5,0,0),this.halfHeight.value.set(0,t.height*.5,0),this.halfWidth.value.applyMatrix4(Hg),this.halfHeight.value.applyMatrix4(Hg)}setupDirectRectArea(e){let t,n;e.isAvailable(`float32Filterable`)?(t=q(Ug.LTC_FLOAT_1),n=q(Ug.LTC_FLOAT_2)):(t=q(Ug.LTC_HALF_1),n=q(Ug.LTC_HALF_2));let{colorNode:r,light:i}=this;return{lightColor:r,lightPosition:Mp(i),halfWidth:this.halfWidth,halfHeight:this.halfHeight,ltc_1:t,ltc_2:n}}static setLTC(e){Ug=e}},Gg=class extends Cm{static get type(){return`SpotLightNode`}constructor(e=null){super(e),this.coneCosNode=B(0).setGroup(z),this.penumbraCosNode=B(0).setGroup(z),this.cutoffDistanceNode=B(0).setGroup(z),this.decayExponentNode=B(0).setGroup(z),this.colorNode=B(this.color).setGroup(z)}update(e){super.update(e);let{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e,t){let{coneCosNode:n,penumbraCosNode:r}=this;return nc(n,r,t)}getLightCoord(e){let t=e.getNodeProperties(this),n=t.projectionUV;return n===void 0&&(n=kp(this.light,e.context.positionWorld),t.projectionUV=n),n}setupDirect(e){let{colorNode:t,cutoffDistanceNode:n,decayExponentNode:r,light:i}=this,a=this.getLightVector(e),o=a.normalize(),s=o.dot(Np(i)),c=this.getSpotAttenuation(e,s),l=wm({lightDistance:a.length(),cutoffDistance:n,decayExponent:r}),u=t.mul(c).mul(l),d,f;return i.colorNode?(f=this.getLightCoord(e),d=i.colorNode(f)):i.map&&(f=this.getLightCoord(e),d=q(i.map,f.xy).onRenderUpdate(()=>i.map)),d&&(u=f.mul(2).sub(1).abs().lessThan(1).all().select(u.mul(d),u)),{lightColor:u,lightDirection:o}}},Kg=class extends Gg{static get type(){return`IESSpotLightNode`}getSpotAttenuation(e,t){let n=this.light.iesMap,r=null;return r=n&&n.isTexture===!0?q(n,I(t.acos().mul(1/Math.PI),0),0).r:super.getSpotAttenuation(t),r}},qg=N(([e,t])=>{let n=e.abs().sub(t);return Ts(zs(n,0)).add(Rs(zs(n.x,n.y),0))}),Jg=class extends Gg{static get type(){return`ProjectorLightNode`}update(e){super.update(e);let t=this.light;if(this.penumbraCosNode.value=Math.min(Math.cos(t.angle*(1-t.penumbra)),.99999),t.aspect===null){let e=1;t.map!==null&&(e=t.map.width/t.map.height),t.shadow.aspect=e}else t.shadow.aspect=t.aspect}getSpotAttenuation(e){let t=P(0),n=this.penumbraCosNode,r=Op(this.light).mul(e.context.positionWorld||Vl);return Oa(r.w.greaterThan(0),()=>{let e=qg(r.xyz.div(r.w).xy.sub(I(.5)),I(.5)),i=No(-1,Mo(1,xs(n)).sub(1));t.assign(ec(e.mul(-2).mul(i)))}),t}},Yg=class extends Cm{static get type(){return`AmbientLightNode`}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}},Xg=class extends Cm{static get type(){return`HemisphereLightNode`}constructor(e=null){super(e),this.lightPositionNode=Ap(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=B(new T).setGroup(z)}update(e){let{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){let{colorNode:t,groundColorNode:n,lightDirectionNode:r}=this,i=G(n,t,$l.dot(r).mul(.5).add(.5));e.context.irradiance.addAssign(i)}},Zg=class extends Cm{static get type(){return`LightProbeNode`}constructor(e=null){super(e);let t=[];for(let e=0;e<9;e++)t.push(new C);this.lightProbe=ml(t)}update(e){let{light:t}=this;super.update(e);for(let e=0;e<9;e++)this.lightProbe.array[e].copy(t.sh.coefficients[e]).multiplyScalar(t.intensity)}setup(e){let t=zh($l,this.lightProbe);e.context.irradiance.addAssign(t)}},Qg=new WeakMap,$g=class extends gf{static get type(){return`EnvironmentNode`}constructor(e=null){super(),this.envNode=e}setup(e){let{material:t}=e,n=this.envNode;if(n.isTextureNode||n.isMaterialReferenceNode){let e=n.isTextureNode?n.value:t[n.property],r=Qg.get(e);r===void 0&&(r=Eh(e),Qg.set(e,r)),n=r}let r=t.useAnisotropy===!0||t.anisotropy>0?dd:K,i=n.context(e_(no,r)).mul(ju),a=n.context(t_($l)).mul(Math.PI).mul(ju),o=Hc(i),s=Hc(a);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(s);let c=e.context.lightingModel.clearcoatRadiance;if(c){let e=Hc(n.context(e_(ao,eu)).mul(ju));c.addAssign(e)}}},e_=(e,t)=>{let n=null;return{getUV:()=>(n===null&&(n=Wl.negate().reflect(t),n=e.mul(e).mix(n,t).normalize(),n=n.transformDirection(kl)),n),getTextureLevel:()=>e}},t_=e=>({getUV:()=>e,getTextureLevel:()=>P(1)}),n_=class extends gf{static get type(){return`BasicEnvironmentNode`}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=sg(this.envNode)}},r_=class{parseFunction(){console.warn(`Abstract function.`)}},i_=class{constructor(e,t,n=``,r=``){this.type=e,this.inputs=t,this.name=n,this.precision=r}getCode(){console.warn(`Abstract function.`)}};i_.isNodeFunction=!0;var a_=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,o_=/[a-z_0-9]+/gi,s_=`#pragma main`,c_=e=>{e=e.trim();let t=e.indexOf(s_),n=t===-1?e:e.slice(t+12),r=n.match(a_);if(r!==null&&r.length===5){let i=r[4],a=[],o=null;for(;(o=o_.exec(i))!==null;)a.push(o);let s=[],c=0;for(;c<a.length;){let e=a[c][0]===`const`;e===!0&&c++;let t=a[c][0];t===`in`||t===`out`||t===`inout`?c++:t=``;let n=a[c++][0],r=Number.parseInt(a[c][0]);Number.isNaN(r)===!1?c++:r=null;let i=a[c++][0];s.push(new zg(n,i,r,t,e))}let l=n.substring(r[0].length),u=r[3]===void 0?``:r[3];return{type:r[2],inputs:s,name:u,precision:r[1]===void 0?``:r[1],inputsCode:i,blockCode:l,headerCode:t===-1?``:e.slice(0,t)}}else throw Error(`FunctionNode: Function is not a GLSL code.`)},l_=class extends i_{constructor(e){let{type:t,inputs:n,name:r,precision:i,inputsCode:a,blockCode:o,headerCode:s}=c_(e);super(t,n,r,i),this.inputsCode=a,this.blockCode=o,this.headerCode=s}getCode(e=this.name){let t,n=this.blockCode;if(n!==``){let{type:r,inputsCode:i,headerCode:a,precision:o}=this,s=`${r} ${e} ( ${i.trim()} )`;o!==``&&(s=`${o} ${s}`),t=a+s+n}else t=``;return t}},u_=class extends r_{parseFunction(e){return new l_(e)}},d_=class extends cg{constructor(){super()}indirect({context:e}){let t=e.ambientOcclusion,n=e.reflectedLight,r=e.irradianceLightMap;n.indirectDiffuse.assign(R(0)),r?n.indirectDiffuse.addAssign(r):n.indirectDiffuse.addAssign(R(1,1,1,0)),n.indirectDiffuse.mulAssign(t),n.indirectDiffuse.mulAssign(H.rgb)}finish(e){let{material:t,context:n}=e,r=n.outgoingLight,i=e.context.environment;if(i)switch(t.combine){case 0:r.rgb.assign(G(r.rgb,r.rgb.mul(i.rgb),Td.mul(Ed)));break;case 1:r.rgb.assign(G(r.rgb,i.rgb,Td.mul(Ed)));break;case 2:r.rgb.addAssign(i.rgb.mul(Td.mul(Ed)));break;default:console.warn(`THREE.BasicLightingModel: Unsupported .combine value:`,t.combine);break}}},f_=()=>P(.25),p_=N(({dotNH:e})=>vo.mul(P(.5)).add(1).mul(P(1/Math.PI)).mul(e.pow(vo))),m_=N(({lightDirection:e})=>{let t=e.add(Wl).normalize(),n=K.dot(t).clamp(),r=Dh({f0:go,f90:1,dotVH:Wl.dot(t).clamp()}),i=f_(),a=p_({dotNH:n});return r.mul(i).mul(a)}),h_=class extends d_{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:n}){let r=K.dot(e).clamp().mul(t);n.directDiffuse.addAssign(r.mul(Ph({diffuseColor:H.rgb}))),this.specular===!0&&n.directSpecular.addAssign(r.mul(m_({lightDirection:e})).mul(Td))}indirect(e){let{ambientOcclusion:t,irradiance:n,reflectedLight:r}=e.context;r.indirectDiffuse.addAssign(n.mul(Ph({diffuseColor:H}))),r.indirectDiffuse.mulAssign(t)}},g_=N(e=>{let{dotNV:t,specularColor:n,specularF90:r,roughness:i}=e,a=Fh({dotNV:t,roughness:i});return n.mul(a.x).add(r.mul(a.y))}),__=N(({roughness:e,dotNH:t})=>{let n=e.pow2(),r=P(1).div(n),i=t.pow2().oneMinus().max(.0078125);return P(2).add(r).mul(i.pow(r.mul(.5))).div(2*Math.PI)}).setLayout({name:`D_Charlie`,type:`float`,inputs:[{name:`roughness`,type:`float`},{name:`dotNH`,type:`float`}]}),v_=N(({dotNV:e,dotNL:t})=>P(1).div(P(4).mul(t.add(e).sub(t.mul(e))))).setLayout({name:`V_Neubelt`,type:`float`,inputs:[{name:`dotNV`,type:`float`},{name:`dotNL`,type:`float`}]}),y_=N(({lightDirection:e})=>{let t=e.add(Wl).normalize(),n=K.dot(e).clamp(),r=K.dot(Wl).clamp(),i=__({roughness:so,dotNH:K.dot(t).clamp()}),a=v_({dotNV:r,dotNL:n});return oo.mul(i).mul(a)}),b_=N(({N:e,V:t,roughness:n})=>{let r=I(n,e.dot(t).saturate().oneMinus().sqrt());return r.assign(r.mul(.984375).add(.0078125)),r}).setLayout({name:`LTC_Uv`,type:`vec2`,inputs:[{name:`N`,type:`vec3`},{name:`V`,type:`vec3`},{name:`roughness`,type:`float`}]}),x_=N(({f:e})=>{let t=e.length();return zs(t.mul(t).add(e.z).div(t.add(1)),0)}).setLayout({name:`LTC_ClippedSphereFormFactor`,type:`float`,inputs:[{name:`f`,type:`vec3`}]}),S_=N(({v1:e,v2:t})=>{let n=e.dot(t),r=n.abs().toVar(),i=r.mul(.0145206).add(.4965155).mul(r).add(.8543985).toVar(),a=r.add(4.1616724).mul(r).add(3.417594).toVar(),o=i.div(a),s=n.greaterThan(0).select(o,zs(n.mul(n).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(o));return e.cross(t).mul(s)}).setLayout({name:`LTC_EdgeVectorFormFactor`,type:`vec3`,inputs:[{name:`v1`,type:`vec3`},{name:`v2`,type:`vec3`}]}),C_=N(({N:e,V:t,P:n,mInv:r,p0:i,p1:a,p2:o,p3:s})=>{let c=a.sub(i).toVar(),l=s.sub(i).toVar(),u=c.cross(l),d=L().toVar();return Oa(u.dot(n.sub(i)).greaterThanEqual(0),()=>{let c=t.sub(e.mul(t.dot(e))).normalize(),l=e.cross(c).negate(),u=r.mul(Ua(c,l,e).transpose()).toVar(),f=u.mul(i.sub(n)).normalize().toVar(),p=u.mul(a.sub(n)).normalize().toVar(),m=u.mul(o.sub(n)).normalize().toVar(),h=u.mul(s.sub(n)).normalize().toVar(),g=L(0).toVar();g.addAssign(S_({v1:f,v2:p})),g.addAssign(S_({v1:p,v2:m})),g.addAssign(S_({v1:m,v2:h})),g.addAssign(S_({v1:h,v2:f})),d.assign(L(x_({f:g})))}),d}).setLayout({name:`LTC_Evaluate`,type:`vec3`,inputs:[{name:`N`,type:`vec3`},{name:`V`,type:`vec3`},{name:`P`,type:`vec3`},{name:`mInv`,type:`mat3`},{name:`p0`,type:`vec3`},{name:`p1`,type:`vec3`},{name:`p2`,type:`vec3`},{name:`p3`,type:`vec3`}]}),w_=N(([e,t,n,r,i])=>{let a=L(tc(t.negate(),hs(e),No(1,r))),o=L(Ts(i[0].xyz),Ts(i[1].xyz),Ts(i[2].xyz));return hs(a).mul(n.mul(o))}).setLayout({name:`getVolumeTransmissionRay`,type:`vec3`,inputs:[{name:`n`,type:`vec3`},{name:`v`,type:`vec3`},{name:`thickness`,type:`float`},{name:`ior`,type:`float`},{name:`modelMatrix`,type:`mat4`}]}),T_=N(([e,t])=>e.mul($s(t.mul(2).sub(2),0,1))).setLayout({name:`applyIorToRoughness`,type:`float`,inputs:[{name:`roughness`,type:`float`},{name:`ior`,type:`float`}]}),E_=gu(),D_=gu(),O_=N(([e,t,n],{material:r})=>Xf((r.side===1?E_:D_).sample(e),us(xl.x).mul(T_(t,n)))),k_=N(([e,t,n])=>(Oa(n.notEqual(0),()=>ss(ls(t).negate().div(n).negate().mul(e))),L(1))).setLayout({name:`volumeAttenuation`,type:`vec3`,inputs:[{name:`transmissionDistance`,type:`float`},{name:`attenuationColor`,type:`vec3`},{name:`attenuationDistance`,type:`float`}]}),A_=N(([e,t,n,r,i,a,o,s,c,l,u,d,f,p,m])=>{let h,g;if(m){h=R().toVar(),g=L().toVar();let i=u.sub(1).mul(m.mul(.025)),a=L(u.sub(i),u,u.add(i));al({start:0,end:3},({i})=>{let u=a.element(i),m=w_(e,t,d,u,s),_=o.add(m),v=l.mul(c.mul(R(_,1))),y=I(v.xy.div(v.w)).toVar();y.addAssign(1),y.divAssign(2),y.assign(I(y.x,y.y.oneMinus()));let b=O_(y,n,u);h.element(i).assign(b.element(i)),h.a.addAssign(b.a),g.element(i).assign(r.element(i).mul(k_(Ts(m),f,p).element(i)))}),h.a.divAssign(3)}else{let i=w_(e,t,d,u,s),a=o.add(i),m=l.mul(c.mul(R(a,1))),_=I(m.xy.div(m.w)).toVar();_.addAssign(1),_.divAssign(2),_.assign(I(_.x,_.y.oneMinus())),h=O_(_,n,u),g=r.mul(k_(Ts(i),f,p))}let _=g.rgb.mul(h.rgb),v=L(g_({dotNV:e.dot(t).clamp(),specularColor:i,specularF90:a,roughness:n})),y=g.r.add(g.g,g.b).div(3);return R(v.oneMinus().mul(_),h.a.oneMinus().mul(y).oneMinus())}),j_=Ua(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),M_=e=>{let t=e.sqrt();return L(1).add(t).div(L(1).sub(t))},N_=(e,t)=>e.sub(t).div(e.add(t)).pow2(),P_=(e,t)=>{let n=e.mul(2*Math.PI*1e-9),r=L(54856e-17,44201e-17,52481e-17),i=L(1681e3,1795300,2208400),a=L(43278e5,93046e5,66121e5),o=P(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(n.mul(2239900).add(t.x).cos()).mul(n.pow2().mul(-45282e5).exp()),s=r.mul(a.mul(2*Math.PI).sqrt()).mul(i.mul(n).add(t).cos()).mul(n.pow2().negate().mul(a).exp());return s=L(s.x.add(o),s.y,s.z).div(1.0685e-7),j_.mul(s)},F_=N(({outsideIOR:e,eta2:t,cosTheta1:n,thinFilmThickness:r,baseF0:i})=>{let a=G(e,t,nc(0,.03,r)),o=e.div(a).pow2().mul(n.pow2().oneMinus()).oneMinus();Oa(o.lessThan(0),()=>L(1));let s=o.sqrt(),c=Dh({f0:N_(a,e),f90:1,dotVH:n}),l=c.oneMinus(),u=a.lessThan(e).select(Math.PI,0),d=P(Math.PI).sub(u),f=M_(i.clamp(0,.9999)),p=Dh({f0:N_(f,a.toVec3()),f90:1,dotVH:s}),m=L(f.x.lessThan(a).select(Math.PI,0),f.y.lessThan(a).select(Math.PI,0),f.z.lessThan(a).select(Math.PI,0)),h=a.mul(r,s,2),g=L(d).add(m),_=c.mul(p).clamp(1e-5,.9999),v=_.sqrt(),y=l.pow2().mul(p).div(L(1).sub(_)),b=c.add(y).toVar(),ee=y.sub(l).toVar();return al({start:1,end:2,condition:`<=`,name:`m`},({m:e})=>{ee.mulAssign(v);let t=P_(P(e).mul(h),P(e).mul(g)).mul(2);b.addAssign(ee.mul(t))}),b.max(L(0))}).setLayout({name:`evalIridescence`,type:`vec3`,inputs:[{name:`outsideIOR`,type:`float`},{name:`eta2`,type:`float`},{name:`cosTheta1`,type:`float`},{name:`thinFilmThickness`,type:`float`},{name:`baseF0`,type:`vec3`}]}),I_=N(({normal:e,viewDir:t,roughness:n})=>{let r=e.dot(t).saturate(),i=n.pow2(),a=ac(n.lessThan(.25),P(-339.2).mul(i).add(P(161.4).mul(n)).sub(25.9),P(-8.48).mul(i).add(P(14.3).mul(n)).sub(9.95)),o=ac(n.lessThan(.25),P(44).mul(i).sub(P(23.7).mul(n)).add(3.26),P(1.97).mul(i).sub(P(3.27).mul(n)).add(.72));return ac(n.lessThan(.25),0,P(.1).mul(n).sub(.025)).add(a.mul(r).add(o).exp()).mul(1/Math.PI).saturate()}),L_=L(.04),R_=P(1),z_=class extends cg{constructor(e=!1,t=!1,n=!1,r=!1,i=!1,a=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=n,this.anisotropy=r,this.transmission=i,this.dispersion=a,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(this.clearcoat===!0&&(this.clearcoatRadiance=L().toVar(`clearcoatRadiance`),this.clearcoatSpecularDirect=L().toVar(`clearcoatSpecularDirect`),this.clearcoatSpecularIndirect=L().toVar(`clearcoatSpecularIndirect`)),this.sheen===!0&&(this.sheenSpecularDirect=L().toVar(`sheenSpecularDirect`),this.sheenSpecularIndirect=L().toVar(`sheenSpecularIndirect`)),this.iridescence===!0){let e=K.dot(Wl).clamp();this.iridescenceFresnel=F_({outsideIOR:P(1),eta2:lo,cosTheta1:e,thinFilmThickness:uo,baseF0:go}),this.iridescenceF0=Ih({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(this.transmission===!0){let t=Vl,n=Al.sub(Vl).normalize(),r=$l,i=e.context;i.backdrop=A_(r,n,no,H,go,_o,t,Ml,kl,Ol,So,wo,Eo,To,this.dispersion?Do:null),i.backdropAlpha=Co,H.a.mulAssign(G(1,i.backdrop.a,Co))}super.start(e)}computeMultiscattering(e,t,n){let r=Fh({roughness:no,dotNV:K.dot(Wl).clamp()}),i=(this.iridescenceF0?co.mix(go,this.iridescenceF0):go).mul(r.x).add(n.mul(r.y)),a=r.x.add(r.y).oneMinus(),o=go.add(go.oneMinus().mul(.047619)),s=i.mul(o).div(a.mul(o).oneMinus());e.addAssign(i),t.addAssign(s.mul(a))}direct({lightDirection:e,lightColor:t,reflectedLight:n}){let r=K.dot(e).clamp().mul(t);if(this.sheen===!0&&this.sheenSpecularDirect.addAssign(r.mul(y_({lightDirection:e}))),this.clearcoat===!0){let n=eu.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(n.mul(Nh({lightDirection:e,f0:L_,f90:R_,roughness:ao,normalView:eu})))}n.directDiffuse.addAssign(r.mul(Ph({diffuseColor:H.rgb}))),n.directSpecular.addAssign(r.mul(Nh({lightDirection:e,f0:go,f90:1,roughness:no,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:n,halfHeight:r,reflectedLight:i,ltc_1:a,ltc_2:o}){let s=t.add(n).sub(r),c=t.sub(n).sub(r),l=t.sub(n).add(r),u=t.add(n).add(r),d=K,f=Wl,p=Ul.toVar(),m=b_({N:d,V:f,roughness:no}),h=a.sample(m).toVar(),g=o.sample(m).toVar(),_=Ua(L(h.x,0,h.y),L(0,1,0),L(h.z,0,h.w)).toVar(),v=go.mul(g.x).add(go.oneMinus().mul(g.y)).toVar();i.directSpecular.addAssign(e.mul(v).mul(C_({N:d,V:f,P:p,mInv:_,p0:s,p1:c,p2:l,p3:u}))),i.directDiffuse.addAssign(e.mul(H).mul(C_({N:d,V:f,P:p,mInv:Ua(1,0,0,0,1,0,0,0,1),p0:s,p1:c,p2:l,p3:u})))}indirect(e){this.indirectDiffuse(e),this.indirectSpecular(e),this.ambientOcclusion(e)}indirectDiffuse(e){let{irradiance:t,reflectedLight:n}=e.context;n.indirectDiffuse.addAssign(t.mul(Ph({diffuseColor:H})))}indirectSpecular(e){let{radiance:t,iblIrradiance:n,reflectedLight:r}=e.context;if(this.sheen===!0&&this.sheenSpecularIndirect.addAssign(n.mul(oo,I_({normal:K,viewDir:Wl,roughness:so}))),this.clearcoat===!0){let e=g_({dotNV:eu.dot(Wl).clamp(),specularColor:L_,specularF90:R_,roughness:ao});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(e))}let i=L().toVar(`singleScattering`),a=L().toVar(`multiScattering`),o=n.mul(1/Math.PI);this.computeMultiscattering(i,a,_o);let s=i.add(a),c=H.mul(s.r.max(s.g).max(s.b).oneMinus());r.indirectSpecular.addAssign(t.mul(i)),r.indirectSpecular.addAssign(a.mul(o)),r.indirectDiffuse.addAssign(c.mul(o))}ambientOcclusion(e){let{ambientOcclusion:t,reflectedLight:n}=e.context,r=K.dot(Wl).clamp().add(t),i=no.mul(-16).oneMinus().negate().exp2(),a=t.sub(r.pow(i).oneMinus()).clamp();this.clearcoat===!0&&this.clearcoatSpecularIndirect.mulAssign(t),this.sheen===!0&&this.sheenSpecularIndirect.mulAssign(t),n.indirectDiffuse.mulAssign(t),n.indirectSpecular.mulAssign(a)}finish({context:e}){let{outgoingLight:t}=e;if(this.clearcoat===!0){let e=Dh({dotVH:eu.dot(Wl).clamp(),f0:L_,f90:R_}),n=t.mul(io.mul(e).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(io));t.assign(n)}if(this.sheen===!0){let e=oo.r.max(oo.g).max(oo.b).mul(.157).oneMinus(),n=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(n)}}},B_=new WeakMap,V_=[],H_=[],U_=class extends Mr{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new Rg,this.nodeBuilderCache=new Map,this.callHashCache=new dr,this.groupsData=new dr,this.cacheLib={}}updateGroup(e){let t=e.groupNode,n=t.name;if(n===Za.name)return!0;if(n===z.name){let t=this.get(e),n=this.nodeFrame.renderId;return t.renderId===n?!1:(t.renderId=n,!0)}if(n===Xa.name){let t=this.get(e),n=this.nodeFrame.frameId;return t.frameId===n?!1:(t.frameId=n,!0)}V_[0]=t,V_[1]=e;let r=this.groupsData.get(V_);return r===void 0&&this.groupsData.set(V_,r={}),V_.length=0,r.version===t.version?!1:(r.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){let t=this.get(e),n=t.nodeBuilderState;if(n===void 0){let{nodeBuilderCache:r}=this,i=this.getForRenderCacheKey(e);if(n=r.get(i),n===void 0){let t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview&&t.enableMultiview(),t.build(),n=this._createNodeBuilderState(t),r.set(i,n)}n.usedTimes++,t.nodeBuilderState=n}return n}delete(e){if(e.isRenderObject){let t=this.get(e).nodeBuilderState;t.usedTimes--,t.usedTimes===0&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){let t=this.get(e),n=t.nodeBuilderState;if(n===void 0){let r=this.backend.createNodeBuilder(e,this.renderer);r.build(),n=this._createNodeBuilderState(r),t.nodeBuilderState=n}return n}_createNodeBuilderState(e){return new Wh(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.observer,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{let n=this.get(e);n.environmentNode&&(t=n.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{let n=this.get(e);n.backgroundNode&&(t=n.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){V_[0]=e,V_[1]=t;let n=this.renderer.info.calls,r=this.callHashCache.get(V_)||{};if(r.callId!==n){let i=this.getEnvironmentNode(e),a=this.getFogNode(e);t&&H_.push(t.getCacheKey(!0)),i&&H_.push(i.getCacheKey()),a&&H_.push(a.getCacheKey()),H_.push(this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview?1:0),H_.push(this.renderer.shadowMap.enabled?1:0),r.callId=n,r.cacheKey=hr(H_),this.callHashCache.set(V_,r),H_.length=0}return V_.length=0,r.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){let t=this.get(e),n=e.background;if(n){let r=e.backgroundBlurriness===0&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&t.backgroundBlurriness===0;(t.background!==n||r)&&(t.backgroundNode=this.getCacheNode(`background`,n,()=>{if(n.isCubeTexture===!0||n.mapping===303||n.mapping===304||n.mapping===306){if(e.backgroundBlurriness>0||n.mapping===306)return Eh(n);{let e;return e=n.isCubeTexture===!0?Bu(n):q(n),sg(e)}}else{if(n.isTexture===!0)return q(n,bl.flipY()).setUpdateMatrix(!0);n.isColor!==!0&&console.error(`WebGPUNodes: Unsupported background configuration.`,n)}},r),t.background=n,t.backgroundBlurriness=e.backgroundBlurriness)}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,n,r=!1){let i=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap),a=i.get(t);return(a===void 0||r)&&(a=n(),i.set(t,a)),a}updateFog(e){let t=this.get(e),n=e.fog;n?t.fog!==n&&(t.fogNode=this.getCacheNode(`fog`,n,()=>{if(n.isFogExp2)return wp(J(`color`,`color`,n).setGroup(z),Cp(J(`density`,`float`,n).setGroup(z)));if(n.isFog)return wp(J(`color`,`color`,n).setGroup(z),Sp(J(`near`,`float`,n).setGroup(z),J(`far`,`float`,n).setGroup(z)));console.error(`THREE.Renderer: Unsupported fog configuration.`,n)}),t.fog=n):(delete t.fogNode,delete t.fog)}updateEnvironment(e){let t=this.get(e),n=e.environment;n?t.environment!==n&&(t.environmentNode=this.getCacheNode(`environment`,n,()=>{if(n.isCubeTexture===!0)return Bu(n);if(n.isTexture===!0)return q(n);console.error(`Nodes: Unsupported environment configuration.`,n)}),t.environment=n):t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,n=null,r=null,i=null){let a=this.nodeFrame;return a.renderer=e,a.scene=t,a.object=n,a.camera=r,a.material=i,a}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){let e=this.renderer;return e.toneMapping+`,`+e.currentColorSpace+`,`+e.xr.isPresenting}hasOutputChange(e){return B_.get(e)!==this.getOutputCacheKey()}getOutputNode(e){let t=this.renderer,n=this.getOutputCacheKey(),r=e.isArrayTexture?ip(e,L(bl,hl(`gl_ViewID_OVR`))).renderOutput(t.toneMapping,t.currentColorSpace):q(e,bl).renderOutput(t.toneMapping,t.currentColorSpace);return B_.set(e,n),r}updateBefore(e){let t=e.getNodeBuilderState();for(let n of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(n)}updateAfter(e){let t=e.getNodeBuilderState();for(let n of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(n)}updateForCompute(e){let t=this.getNodeFrame(),n=this.getForCompute(e);for(let e of n.updateNodes)t.updateNode(e)}updateForRender(e){let t=this.getNodeFrameForRender(e),n=e.getNodeBuilderState();for(let e of n.updateNodes)t.updateNode(e)}needsRefresh(e){let t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new Rg,this.nodeBuilderCache=new Map,this.cacheLib={}}},W_=new Sn,G_=class e{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey=``,this.shadowPass=!1,this.viewNormalMatrix=new qe,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,e!==null&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,n){let r=e.length;for(let i=0;i<r;i++){W_.copy(e[i]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);let r=t[n+i],a=W_.normal;r.x=-a.x,r.y=-a.y,r.z=-a.z,r.w=W_.constant}}updateGlobal(e,t){this.shadowPass=e.overrideMaterial!==null&&e.overrideMaterial.isShadowPassMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let n=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);let r=t.clippingPlanes,i=r.length,a,o;if(this.clipIntersection?(a=this.intersectionPlanes,o=e.intersectionPlanes.length):(a=this.unionPlanes,o=e.unionPlanes.length),a.length!==o+i){a.length=o+i;for(let e=0;e<i;e++)a[o+e]=new s;n=!0}this.projectPlanes(r,a,o),n&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(t){if(this.shadowPass&&!t.clipShadows)return this;let n=this.clippingGroupContexts.get(t);return n===void 0&&(n=new e(this),this.clippingGroupContexts.set(t,n)),n.update(this,t),n}get unionClippingCount(){return this.unionPlanes.length}},K_=class{constructor(e,t){this.bundleGroup=e,this.camera=t}},q_=[],J_=class{constructor(){this.bundles=new dr}get(e,t){let n=this.bundles;q_[0]=e,q_[1]=t;let r=n.get(q_);return r===void 0&&(r=new K_(e,t),n.set(q_,r)),q_.length=0,r}dispose(){this.bundles=new dr}},Y_=class{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null,n=this.getMaterialNodeClass(e.type);if(n!==null)for(let r in t=new n,e)t[r]=e[r];return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,n){if(n.has(t)){console.warn(`Redefinition of node ${t}`);return}if(typeof e!=`function`)throw Error(`Node class ${e.name} is not a class.`);if(typeof t==`function`||typeof t==`object`)throw Error(`Base class ${t} is not a class.`);n.set(t,e)}addClass(e,t,n){if(n.has(t)){console.warn(`Redefinition of node ${t.name}`);return}if(typeof e!=`function`)throw Error(`Node class ${e.name} is not a class.`);if(typeof t!=`function`)throw Error(`Base class ${t.name} is not a class.`);n.set(t,e)}},X_=new Rp,Z_=[],Q_=class extends dr{constructor(){super()}createNode(e=[]){return new Rp().setLights(e)}getNode(e,t){if(e.isQuadMesh)return X_;Z_[0]=e,Z_[1]=t;let n=this.get(Z_);return n===void 0&&(n=this.createNode(),this.set(Z_,n)),Z_.length=0,n}},$_=class extends rn{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}},ev=class extends it{constructor(){super(),this.isGroup=!0,this.type=`Group`}},tv={type:`move`},nv=class{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new ev,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new ev,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new C,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new C),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new ev,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new C,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new C),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){let t=this._hand;if(t)for(let n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:`connected`,data:e}),this}disconnect(e){return this.dispatchEvent({type:`disconnected`,data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,t,n){let r=null,i=null,a=null,o=this._targetRay,s=this._grip,c=this._hand;if(e&&t.session.visibilityState!==`visible-blurred`){if(c&&e.hand){a=!0;for(let r of e.hand.values()){let e=t.getJointPose(r,n),i=this._getHandJoint(c,r);e!==null&&(i.matrix.fromArray(e.transform.matrix),i.matrix.decompose(i.position,i.rotation,i.scale),i.matrixWorldNeedsUpdate=!0,i.jointRadius=e.radius),i.visible=e!==null}let r=c.joints[`index-finger-tip`],i=c.joints[`thumb-tip`],o=r.position.distanceTo(i.position),s=.02,l=.005;c.inputState.pinching&&o>s+l?(c.inputState.pinching=!1,this.dispatchEvent({type:`pinchend`,handedness:e.handedness,target:this})):!c.inputState.pinching&&o<=s-l&&(c.inputState.pinching=!0,this.dispatchEvent({type:`pinchstart`,handedness:e.handedness,target:this}))}else s!==null&&e.gripSpace&&(i=t.getPose(e.gripSpace,n),i!==null&&(s.matrix.fromArray(i.transform.matrix),s.matrix.decompose(s.position,s.rotation,s.scale),s.matrixWorldNeedsUpdate=!0,i.linearVelocity?(s.hasLinearVelocity=!0,s.linearVelocity.copy(i.linearVelocity)):s.hasLinearVelocity=!1,i.angularVelocity?(s.hasAngularVelocity=!0,s.angularVelocity.copy(i.angularVelocity)):s.hasAngularVelocity=!1));o!==null&&(r=t.getPose(e.targetRaySpace,n),r===null&&i!==null&&(r=i),r!==null&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(tv)))}return o!==null&&(o.visible=r!==null),s!==null&&(s.visible=i!==null),c!==null&&(c.visible=a!==null),this}_getHandJoint(e,t){if(e.joints[t.jointName]===void 0){let n=new ev;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}},rv=class extends Eu{constructor(e=1,t=1,n={}){super(e,t,n),this.isXRRenderTarget=!0,this._hasExternalTextures=!1,this._autoAllocateDepthBuffer=!0,this._isOpaqueFramebuffer=!1}copy(e){return super.copy(e),this._hasExternalTextures=e._hasExternalTextures,this._autoAllocateDepthBuffer=e._autoAllocateDepthBuffer,this._isOpaqueFramebuffer=e._isOpaqueFramebuffer,this}},iv=class e extends nr{constructor(e=1,t=1,n=1,r=32,i=1,a=!1,o=0,s=Math.PI*2){super(),this.type=`CylinderGeometry`,this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:r,heightSegments:i,openEnded:a,thetaStart:o,thetaLength:s};let c=this;r=Math.floor(r),i=Math.floor(i);let l=[],u=[],d=[],f=[],p=0,m=[],h=n/2,g=0;_(),a===!1&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(l),this.setAttribute(`position`,new rr(u,3)),this.setAttribute(`normal`,new rr(d,3)),this.setAttribute(`uv`,new rr(f,2));function _(){let a=new C,_=new C,v=0,y=(t-e)/n;for(let c=0;c<=i;c++){let l=[],g=c/i,v=g*(t-e)+e;for(let e=0;e<=r;e++){let t=e/r,i=t*s+o,c=Math.sin(i),m=Math.cos(i);_.x=v*c,_.y=-g*n+h,_.z=v*m,u.push(_.x,_.y,_.z),a.set(c,y,m).normalize(),d.push(a.x,a.y,a.z),f.push(t,1-g),l.push(p++)}m.push(l)}for(let n=0;n<r;n++)for(let r=0;r<i;r++){let a=m[r][n],o=m[r+1][n],s=m[r+1][n+1],c=m[r][n+1];(e>0||r!==0)&&(l.push(a,o,c),v+=3),(t>0||r!==i-1)&&(l.push(o,s,c),v+=3)}c.addGroup(g,v,0),g+=v}function v(n){let i=p,a=new w,m=new C,_=0,v=n===!0?e:t,y=n===!0?1:-1;for(let e=1;e<=r;e++)u.push(0,h*y,0),d.push(0,y,0),f.push(.5,.5),p++;let b=p;for(let e=0;e<=r;e++){let t=e/r*s+o,n=Math.cos(t),i=Math.sin(t);m.x=v*i,m.y=h*y,m.z=v*n,u.push(m.x,m.y,m.z),d.push(0,y,0),a.x=n*.5+.5,a.y=i*.5*y+.5,f.push(a.x,a.y),p++}for(let e=0;e<r;e++){let t=i+e,r=b+e;n===!0?l.push(r,r+1,t):l.push(r+1,r,t),_+=3}c.addGroup(g,_,n===!0?1:2),g+=_}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}},av=class e extends nr{constructor(e=1,t=1,n=1,r=1){super(),this.type=`PlaneGeometry`,this.parameters={width:e,height:t,widthSegments:n,heightSegments:r};let i=e/2,a=t/2,o=Math.floor(n),s=Math.floor(r),c=o+1,l=s+1,u=e/o,d=t/s,f=[],p=[],m=[],h=[];for(let e=0;e<l;e++){let t=e*d-a;for(let n=0;n<c;n++){let r=n*u-i;p.push(r,-t,0),m.push(0,0,1),h.push(n/o),h.push(1-e/s)}}for(let e=0;e<s;e++)for(let t=0;t<o;t++){let n=t+c*e,r=t+c*(e+1),i=t+1+c*(e+1),a=t+1+c*e;f.push(n,r,a),f.push(r,i,a)}this.setIndex(f),this.setAttribute(`position`,new rr(p,3)),this.setAttribute(`normal`,new rr(m,3)),this.setAttribute(`uv`,new rr(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.width,t.height,t.widthSegments,t.heightSegments)}},ov=new C,sv=new C,cv=class extends be{constructor(e,t=!1){super(),this.enabled=!1,this.isPresenting=!1,this.cameraAutoUpdate=!0,this._renderer=e,this._cameraL=new rn,this._cameraL.viewport=new s,this._cameraR=new rn,this._cameraR.viewport=new s,this._cameras=[this._cameraL,this._cameraR],this._cameraXR=new $_,this._currentDepthNear=null,this._currentDepthFar=null,this._controllers=[],this._controllerInputSources=[],this._xrRenderTarget=null,this._layers=[],this._sessionUsesLayers=!1,this._supportsGlBinding=typeof XRWebGLBinding<`u`,this._frameBufferTargets=null,this._createXRLayer=hv.bind(this),this._gl=null,this._currentAnimationContext=null,this._currentAnimationLoop=null,this._currentPixelRatio=null,this._currentSize=new w,this._onSessionEvent=fv.bind(this),this._onSessionEnd=pv.bind(this),this._onInputSourcesChange=mv.bind(this),this._onAnimationFrame=gv.bind(this),this._referenceSpace=null,this._referenceSpaceType=`local-floor`,this._customReferenceSpace=null,this._framebufferScaleFactor=1,this._foveation=1,this._session=null,this._glBaseLayer=null,this._glBinding=null,this._glProjLayer=null,this._xrFrame=null,this._supportsLayers=this._supportsGlBinding&&`createProjectionLayer`in XRWebGLBinding.prototype,this._useMultiviewIfPossible=t,this._useMultiview=!1}getController(e){return this._getController(e).getTargetRaySpace()}getControllerGrip(e){return this._getController(e).getGripSpace()}getHand(e){return this._getController(e).getHandSpace()}getFoveation(){if(!(this._glProjLayer===null&&this._glBaseLayer===null))return this._foveation}setFoveation(e){this._foveation=e,this._glProjLayer!==null&&(this._glProjLayer.fixedFoveation=e),this._glBaseLayer!==null&&this._glBaseLayer.fixedFoveation!==void 0&&(this._glBaseLayer.fixedFoveation=e)}getFramebufferScaleFactor(){return this._framebufferScaleFactor}setFramebufferScaleFactor(e){this._framebufferScaleFactor=e,this.isPresenting===!0&&console.warn(`THREE.XRManager: Cannot change framebuffer scale while presenting.`)}getReferenceSpaceType(){return this._referenceSpaceType}setReferenceSpaceType(e){this._referenceSpaceType=e,this.isPresenting===!0&&console.warn(`THREE.XRManager: Cannot change reference space type while presenting.`)}getReferenceSpace(){return this._customReferenceSpace||this._referenceSpace}setReferenceSpace(e){this._customReferenceSpace=e}getCamera(){return this._cameraXR}getEnvironmentBlendMode(){if(this._session!==null)return this._session.environmentBlendMode}getBinding(){return this._glBinding===null&&this._supportsGlBinding&&(this._glBinding=new XRWebGLBinding(this._session,this._gl)),this._glBinding}getFrame(){return this._xrFrame}useMultiview(){return this._useMultiview}createQuadLayer(e,t,n,r,i,a,o,s={}){let c=new av(e,t),l=new rv(i,a,{format:Ct,type:ge,depthTexture:new _i(i,a,s.stencil?xt:an,void 0,void 0,void 0,void 0,void 0,void 0,s.stencil?In:Ln),stencilBuffer:s.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});l._autoAllocateDepthBuffer=!0;let u=new or({color:16777215,side:0});u.map=l.texture,u.map.offset.y=1,u.map.repeat.y=-1;let d=new cr(c,u);d.position.copy(n),d.quaternion.copy(r);let f={type:`quad`,width:e,height:t,translation:n,quaternion:r,pixelwidth:i,pixelheight:a,plane:d,material:u,rendercall:o,renderTarget:l};if(this._layers.push(f),this._session!==null){f.plane.material=new or({color:16777215,side:0}),f.plane.material.blending=5,f.plane.material.blendEquation=100,f.plane.material.blendSrc=200,f.plane.material.blendDst=200,f.xrlayer=this._createXRLayer(f);let e=this._session.renderState.layers;e.unshift(f.xrlayer),this._session.updateRenderState({layers:e})}else l.isXRRenderTarget=!1;return d}createCylinderLayer(e,t,n,r,i,a,o,s,c={}){let l=new iv(e,e,e*t/n,64,64,!0,Math.PI-t/2,t),u=new rv(a,o,{format:Ct,type:ge,depthTexture:new _i(a,o,c.stencil?xt:an,void 0,void 0,void 0,void 0,void 0,void 0,c.stencil?In:Ln),stencilBuffer:c.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});u._autoAllocateDepthBuffer=!0;let d=new or({color:16777215,side:1});d.map=u.texture,d.map.offset.y=1,d.map.repeat.y=-1;let f=new cr(l,d);f.position.copy(r),f.quaternion.copy(i);let p={type:`cylinder`,radius:e,centralAngle:t,aspectratio:n,translation:r,quaternion:i,pixelwidth:a,pixelheight:o,plane:f,material:d,rendercall:s,renderTarget:u};if(this._layers.push(p),this._session!==null){p.plane.material=new or({color:16777215,side:1}),p.plane.material.blending=5,p.plane.material.blendEquation=100,p.plane.material.blendSrc=200,p.plane.material.blendDst=200,p.xrlayer=this._createXRLayer(p);let e=this._session.renderState.layers;e.unshift(p.xrlayer),this._session.updateRenderState({layers:e})}else u.isXRRenderTarget=!1;return f}renderLayers(){let e=new C,t=new Vt,n=this._renderer,r=this.isPresenting,i=n.getOutputRenderTarget(),a=n._frameBufferTarget;this.isPresenting=!1;let o=new w;n.getSize(o);let s=n._quad;for(let r of this._layers)if(r.renderTarget.isXRRenderTarget=this._session!==null,r.renderTarget._hasExternalTextures=r.renderTarget.isXRRenderTarget,r.renderTarget.isXRRenderTarget&&this._sessionUsesLayers){r.xrlayer.transform=new XRRigidTransform(r.plane.getWorldPosition(e),r.plane.getWorldQuaternion(t));let i=this._glBinding.getSubImage(r.xrlayer,this._xrFrame);n.backend.setXRRenderTargetTextures(r.renderTarget,i.colorTexture,void 0),n._setXRLayerSize(r.renderTarget.width,r.renderTarget.height),n.setOutputRenderTarget(r.renderTarget),n.setRenderTarget(null),n._frameBufferTarget=null,this._frameBufferTargets||=new WeakMap;let{frameBufferTarget:a,quad:o}=this._frameBufferTargets.get(r.renderTarget)||{frameBufferTarget:null,quad:null};a?(n._frameBufferTarget=a,n._quad=o):(n._quad=new Rf(new Pf),this._frameBufferTargets.set(r.renderTarget,{frameBufferTarget:n._getFrameBufferTarget(),quad:n._quad})),r.rendercall(),n._frameBufferTarget=null}else n.setRenderTarget(r.renderTarget),r.rendercall();n.setRenderTarget(null),n.setOutputRenderTarget(i),n._frameBufferTarget=a,n._setXRLayerSize(o.x,o.y),n._quad=s,this.isPresenting=r}getSession(){return this._session}async setSession(e){let t=this._renderer,n=t.backend;this._gl=t.getContext();let r=this._gl,i=r.getContextAttributes();if(this._session=e,e!==null){if(n.isWebGPUBackend===!0)throw Error(`THREE.XRManager: XR is currently not supported with a WebGPU backend. Use WebGL by passing "{ forceWebGL: true }" to the constructor of the renderer.`);if(e.addEventListener(`select`,this._onSessionEvent),e.addEventListener(`selectstart`,this._onSessionEvent),e.addEventListener(`selectend`,this._onSessionEvent),e.addEventListener(`squeeze`,this._onSessionEvent),e.addEventListener(`squeezestart`,this._onSessionEvent),e.addEventListener(`squeezeend`,this._onSessionEvent),e.addEventListener(`end`,this._onSessionEnd),e.addEventListener(`inputsourceschange`,this._onInputSourcesChange),await n.makeXRCompatible(),this._currentPixelRatio=t.getPixelRatio(),t.getSize(this._currentSize),this._currentAnimationContext=t._animation.getContext(),this._currentAnimationLoop=t._animation.getAnimationLoop(),t._animation.stop(),this._supportsLayers===!0){let n=null,a=null,o=null;t.depth&&(o=t.stencil?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24,n=t.stencil?1027:1026,a=t.stencil?1020:1014);let s={colorFormat:r.RGBA8,depthFormat:o,scaleFactor:this._framebufferScaleFactor,clearOnAccess:!1};this._useMultiviewIfPossible&&t.hasFeature(`OVR_multiview2`)&&(s.textureType=`texture-array`,this._useMultiview=!0),this._glBinding=this.getBinding();let c=this._glBinding.createProjectionLayer(s),l=[c];this._glProjLayer=c,t.setPixelRatio(1),t._setXRLayerSize(c.textureWidth,c.textureHeight);let u=this._useMultiview?2:1,d=new _i(c.textureWidth,c.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,n,u);if(this._xrRenderTarget=new rv(c.textureWidth,c.textureHeight,{format:1023,type:1009,colorSpace:t.outputColorSpace,depthTexture:d,stencilBuffer:t.stencil,samples:i.antialias?4:0,resolveDepthBuffer:c.ignoreDepthValues===!1,resolveStencilBuffer:c.ignoreDepthValues===!1,depth:this._useMultiview?2:1,multiview:this._useMultiview}),this._xrRenderTarget._hasExternalTextures=!0,this._xrRenderTarget.depth=this._useMultiview?2:1,this._sessionUsesLayers=e.enabledFeatures.includes(`layers`),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType()),this._sessionUsesLayers)for(let e of this._layers)e.plane.material=new or({color:16777215,side:e.type===`cylinder`?1:0}),e.plane.material.blending=5,e.plane.material.blendEquation=100,e.plane.material.blendSrc=200,e.plane.material.blendDst=200,e.xrlayer=this._createXRLayer(e),l.unshift(e.xrlayer);e.updateRenderState({layers:l})}else{let n={antialias:t.samples>0,alpha:!0,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:this.getFramebufferScaleFactor()},i=new XRWebGLLayer(e,r,n);this._glBaseLayer=i,e.updateRenderState({baseLayer:i}),t.setPixelRatio(1),t._setXRLayerSize(i.framebufferWidth,i.framebufferHeight),this._xrRenderTarget=new rv(i.framebufferWidth,i.framebufferHeight,{format:Ct,type:ge,colorSpace:t.outputColorSpace,stencilBuffer:t.stencil,resolveDepthBuffer:i.ignoreDepthValues===!1,resolveStencilBuffer:i.ignoreDepthValues===!1}),this._xrRenderTarget._isOpaqueFramebuffer=!0,this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType())}this.setFoveation(this.getFoveation()),t._animation.setAnimationLoop(this._onAnimationFrame),t._animation.setContext(e),t._animation.start(),this.isPresenting=!0,this.dispatchEvent({type:`sessionstart`})}}updateCamera(e){let t=this._session;if(t===null)return;let n=e.near,r=e.far,i=this._cameraXR,a=this._cameraL,o=this._cameraR;i.near=o.near=a.near=n,i.far=o.far=a.far=r,i.isMultiViewCamera=this._useMultiview,(this._currentDepthNear!==i.near||this._currentDepthFar!==i.far)&&(t.updateRenderState({depthNear:i.near,depthFar:i.far}),this._currentDepthNear=i.near,this._currentDepthFar=i.far),i.layers.mask=e.layers.mask|6,a.layers.mask=i.layers.mask&3,o.layers.mask=i.layers.mask&5;let s=e.parent,c=i.cameras;uv(i,s);for(let e=0;e<c.length;e++)uv(c[e],s);c.length===2?lv(i,a,o):i.projectionMatrix.copy(a.projectionMatrix),dv(e,i,s)}_getController(e){let t=this._controllers[e];return t===void 0&&(t=new nv,this._controllers[e]=t),t}};function lv(e,t,n){ov.setFromMatrixPosition(t.matrixWorld),sv.setFromMatrixPosition(n.matrixWorld);let r=ov.distanceTo(sv),i=t.projectionMatrix.elements,a=n.projectionMatrix.elements,o=i[14]/(i[10]-1),s=i[14]/(i[10]+1),c=(i[9]+1)/i[5],l=(i[9]-1)/i[5],u=(i[8]-1)/i[0],d=(a[8]+1)/a[0],f=o*u,p=o*d,m=r/(-u+d),h=m*-u;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(h),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),i[10]===-1)e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{let t=o+m,n=s+m,i=f-h,a=p+(r-h),u=c*s/n*t,d=l*s/n*t;e.projectionMatrix.makePerspective(i,a,u,d,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}function uv(e,t){t===null?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}function dv(e,t,n){n===null?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld)),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=_*2*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}function fv(e){let t=this._controllerInputSources.indexOf(e.inputSource);if(t===-1)return;let n=this._controllers[t];if(n!==void 0){let t=this.getReferenceSpace();n.update(e.inputSource,e.frame,t),n.dispatchEvent({type:e.type,data:e.inputSource})}}function pv(){let e=this._session,t=this._renderer;e.removeEventListener(`select`,this._onSessionEvent),e.removeEventListener(`selectstart`,this._onSessionEvent),e.removeEventListener(`selectend`,this._onSessionEvent),e.removeEventListener(`squeeze`,this._onSessionEvent),e.removeEventListener(`squeezestart`,this._onSessionEvent),e.removeEventListener(`squeezeend`,this._onSessionEvent),e.removeEventListener(`end`,this._onSessionEnd),e.removeEventListener(`inputsourceschange`,this._onInputSourcesChange);for(let e=0;e<this._controllers.length;e++){let t=this._controllerInputSources[e];t!==null&&(this._controllerInputSources[e]=null,this._controllers[e].disconnect(t))}if(this._currentDepthNear=null,this._currentDepthFar=null,t._resetXRState(),this._session=null,this._xrRenderTarget=null,this._sessionUsesLayers===!0)for(let e of this._layers)e.renderTarget=new rv(e.pixelwidth,e.pixelheight,{format:Ct,type:ge,depthTexture:new _i(e.pixelwidth,e.pixelheight,e.stencilBuffer?xt:an,void 0,void 0,void 0,void 0,void 0,void 0,e.stencilBuffer?In:Ln),stencilBuffer:e.stencilBuffer,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),e.renderTarget.isXRRenderTarget=!1,e.plane.material=e.material,e.material.map=e.renderTarget.texture,e.material.map.offset.y=1,e.material.map.repeat.y=-1,delete e.xrlayer;this.isPresenting=!1,this._useMultiview=!1,t._animation.stop(),t._animation.setAnimationLoop(this._currentAnimationLoop),t._animation.setContext(this._currentAnimationContext),t._animation.start(),t.setPixelRatio(this._currentPixelRatio),t.setSize(this._currentSize.width,this._currentSize.height,!1),this.dispatchEvent({type:`sessionend`})}function mv(e){let t=this._controllers,n=this._controllerInputSources;for(let r=0;r<e.removed.length;r++){let i=e.removed[r],a=n.indexOf(i);a>=0&&(n[a]=null,t[a].disconnect(i))}for(let r=0;r<e.added.length;r++){let i=e.added[r],a=n.indexOf(i);if(a===-1){for(let e=0;e<t.length;e++)if(e>=n.length){n.push(i),a=e;break}else if(n[e]===null){n[e]=i,a=e;break}if(a===-1)break}let o=t[a];o&&o.connect(i)}}function hv(e){return e.type===`quad`?this._glBinding.createQuadLayer({transform:new XRRigidTransform(e.translation,e.quaternion),width:e.width/2,height:e.height/2,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1}):this._glBinding.createCylinderLayer({transform:new XRRigidTransform(e.translation,e.quaternion),radius:e.radius,centralAngle:e.centralAngle,aspectRatio:e.aspectRatio,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1})}function gv(e,t){if(t===void 0)return;let n=this._cameraXR,r=this._renderer,i=r.backend,a=this._glBaseLayer,o=this.getReferenceSpace(),c=t.getViewerPose(o);if(this._xrFrame=t,c!==null){let e=c.views;this._glBaseLayer!==null&&i.setXRTarget(a.framebuffer);let t=!1;e.length!==n.cameras.length&&(n.cameras.length=0,t=!0);for(let r=0;r<e.length;r++){let o=e[r],c;if(this._supportsLayers===!0){let e=this._glBinding.getViewSubImage(this._glProjLayer,o);c=e.viewport,r===0&&i.setXRRenderTargetTextures(this._xrRenderTarget,e.colorTexture,this._glProjLayer.ignoreDepthValues&&!this._useMultiview?void 0:e.depthStencilTexture)}else c=a.getViewport(o);let l=this._cameras[r];l===void 0&&(l=new rn,l.layers.enable(r),l.viewport=new s,this._cameras[r]=l),l.matrix.fromArray(o.transform.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale),l.projectionMatrix.fromArray(o.projectionMatrix),l.projectionMatrixInverse.copy(l.projectionMatrix).invert(),l.viewport.set(c.x,c.y,c.width,c.height),r===0&&(n.matrix.copy(l.matrix),n.matrix.decompose(n.position,n.quaternion,n.scale)),t===!0&&n.cameras.push(l)}r.setOutputRenderTarget(this._xrRenderTarget)}for(let e=0;e<this._controllers.length;e++){let n=this._controllerInputSources[e],r=this._controllers[e];n!==null&&r!==void 0&&r.update(n,t,o)}this._currentAnimationLoop&&this._currentAnimationLoop(e,t),t.detectedPlanes&&this.dispatchEvent({type:`planesdetected`,data:t}),this._xrFrame=null}var _v=new zn,vv=new ie,yv=class e{constructor(){this.coordinateSystem=Xt}intersectsObject(e,t){if(!t.isArrayCamera||t.cameras.length===0)return!1;for(let n=0;n<t.cameras.length;n++){let r=t.cameras[n];if(_v.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vv.setFromProjectionMatrix(_v,r.coordinateSystem,r.reversedDepth),vv.intersectsObject(e))return!0}return!1}intersectsSprite(e,t){if(!t||!t.cameras||t.cameras.length===0)return!1;for(let n=0;n<t.cameras.length;n++){let r=t.cameras[n];if(_v.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vv.setFromProjectionMatrix(_v,r.coordinateSystem,r.reversedDepth),vv.intersectsSprite(e))return!0}return!1}intersectsSphere(e,t){if(!t||!t.cameras||t.cameras.length===0)return!1;for(let n=0;n<t.cameras.length;n++){let r=t.cameras[n];if(_v.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vv.setFromProjectionMatrix(_v,r.coordinateSystem,r.reversedDepth),vv.intersectsSphere(e))return!0}return!1}intersectsBox(e,t){if(!t||!t.cameras||t.cameras.length===0)return!1;for(let n=0;n<t.cameras.length;n++){let r=t.cameras[n];if(_v.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vv.setFromProjectionMatrix(_v,r.coordinateSystem,r.reversedDepth),vv.intersectsBox(e))return!0}return!1}containsPoint(e,t){if(!t||!t.cameras||t.cameras.length===0)return!1;for(let n=0;n<t.cameras.length;n++){let r=t.cameras[n];if(_v.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),vv.setFromProjectionMatrix(_v,r.coordinateSystem,r.reversedDepth),vv.containsPoint(e))return!0}return!1}clone(){return new e}},bv=new ii,xv=new w,Sv=new s,Cv=new ie,wv=new yv,Tv=new zn,Ev=new s,Dv=class{constructor(e,t={}){this.isRenderer=!0;let{logarithmicDepthBuffer:n=!1,alpha:r=!0,depth:i=!0,stencil:a=!1,antialias:o=!1,samples:c=0,getFallback:l=null,colorBufferType:u=Rt,multiview:d=!1}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=c||o===!0?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=r,this.logarithmicDepthBuffer=n,this.outputColorSpace=ft,this.toneMapping=0,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=i,this.stencil=a,this.info=new Vr,this.overrideNodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new Y_,this.lighting=new Q_,this._getFallback=l,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new s(0,0,this._width,this._height),this._scissor=new s(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new Rf(new Pf),this._quad.material.name=`Renderer_output`,this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null,this._clearColor=new bi(0,0,0,this.alpha===!0?0:1),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._outputRenderTarget=null,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._colorBufferType=u,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:1},this.xr=new cv(this,d),this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,n)=>{await this.compileAsync(e,t);let r=this._renderLists.get(e,t),i=this._renderContexts.get(e,t,this._renderTarget),a=e.overrideMaterial||n.material,{fragmentShader:o,vertexShader:s}=this._objects.get(n,a,e,t,r.lightsNode,i,i.clippingContext).getNodeBuilderState();return{fragmentShader:o,vertexShader:s}}}}async init(){if(this._initialized)throw Error(`Renderer: Backend has already been initialized.`);return this._initPromise===null&&(this._initPromise=new Promise(async(e,t)=>{let n=this.backend;try{await n.init(this)}catch(e){if(this._getFallback!==null)try{this.backend=n=this._getFallback(e),await n.init(this)}catch(e){t(e);return}else{t(e);return}}this._nodes=new U_(this,n),this._animation=new ur(this._nodes,this.info),this._attributes=new Lr(n),this._background=new Vh(this,this._nodes),this._geometries=new Br(this._attributes,this.info),this._textures=new yi(this,n,this.info),this._pipelines=new qr(n,this._nodes),this._bindings=new Jr(n,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new jr(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new ei(this.lighting),this._bundles=new J_,this._renderContexts=new ci,this._animation.start(),this._initialized=!0,e(this)})),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,n=null){if(this._isDeviceLost===!0)return;this._initialized===!1&&await this.init();let r=this._nodes.nodeFrame,i=r.renderId,a=this._currentRenderContext,o=this._currentRenderObjectFunction,s=this._compilationPromises,c=e.isScene===!0?e:bv;n===null&&(n=e);let l=this._renderTarget,u=this._renderContexts.get(n,t,l),d=this._activeMipmapLevel,f=[];this._currentRenderContext=u,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=f,r.renderId++,r.update(),u.depth=this.depth,u.stencil=this.stencil,u.clippingContext||=new G_,u.clippingContext.updateGlobal(c,t),c.onBeforeRender(this,e,t,l);let p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p,u.clippingContext),n!==e&&n.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&p.pushLight(e)}),p.finish(),l!==null){this._textures.updateRenderTarget(l,d);let e=this._textures.get(l);u.textures=e.textures,u.depthTexture=e.depthTexture}else u.textures=null,u.depthTexture=null;this._background.update(c,p,u);let m=p.opaque,h=p.transparent,g=p.transparentDoublePass,_=p.lightsNode;this.opaque===!0&&m.length>0&&this._renderObjects(m,t,c,_),this.transparent===!0&&h.length>0&&this._renderTransparents(h,g,t,c,_),r.renderId=i,this._currentRenderContext=a,this._currentRenderObjectFunction=o,this._compilationPromises=s,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(f)}async renderAsync(e,t){this._initialized===!1&&await this.init(),this._renderScene(e,t)}async waitForGPU(){await this.backend.waitForGPU()}set highPrecision(e){e===!0?(this.overrideNodes.modelViewMatrix=Il,this.overrideNodes.modelNormalViewMatrix=Ll):this.highPrecision&&(this.overrideNodes.modelViewMatrix=null,this.overrideNodes.modelNormalViewMatrix=null)}get highPrecision(){return this.overrideNodes.modelViewMatrix===Il&&this.overrideNodes.modelNormalViewMatrix===Ll}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getColorBufferType(){return this._colorBufferType}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:

Message: ${e.message}`;e.reason&&(t+=`
Reason: ${e.reason}`),console.error(t),this._isDeviceLost=!0}_renderBundle(e,t,n){let{bundleGroup:r,camera:i,renderList:a}=e,o=this._currentRenderContext,s=this._bundles.get(r,i),c=this.backend.get(s);c.renderContexts===void 0&&(c.renderContexts=new Set);let l=r.version!==c.version,u=c.renderContexts.has(o)===!1||l;if(c.renderContexts.add(o),u){this.backend.beginBundle(o),(c.renderObjects===void 0||l)&&(c.renderObjects=[]),this._currentRenderBundle=s;let{transparentDoublePass:e,transparent:u,opaque:d}=a;this.opaque===!0&&d.length>0&&this._renderObjects(d,i,t,n),this.transparent===!0&&u.length>0&&this._renderTransparents(u,e,i,t,n),this._currentRenderBundle=null,this.backend.finishBundle(o,s),c.version=r.version}else{let{renderObjects:e}=c;for(let t=0,n=e.length;t<n;t++){let n=e[t];this._nodes.needsRefresh(n)&&(this._nodes.updateBefore(n),this._nodes.updateForRender(n),this._bindings.updateForRender(n),this._nodes.updateAfter(n))}}this.backend.addBundle(o,s)}render(e,t){if(this._initialized===!1)return console.warn(`THREE.Renderer: .render() called before the backend is initialized. Try using .renderAsync() instead.`),this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){let{currentToneMapping:e,currentColorSpace:t}=this,n=e!==0,r=t!==Zn.workingColorSpace;if(n===!1&&r===!1)return null;let{width:i,height:a}=this.getDrawingBufferSize(xv),{depth:o,stencil:s}=this,c=this._frameBufferTarget;c===null&&(c=new Eu(i,a,{depthBuffer:o,stencilBuffer:s,type:this._colorBufferType,format:1023,colorSpace:Zn.workingColorSpace,generateMipmaps:!1,minFilter:1006,magFilter:1006,samples:this.samples}),c.isPostProcessingRenderTarget=!0,this._frameBufferTarget=c);let l=this.getOutputRenderTarget();return c.depthBuffer=o,c.stencilBuffer=s,l===null?c.setSize(i,a,1):c.setSize(l.width,l.height,l.depth),c.viewport.copy(this._viewport),c.scissor.copy(this._scissor),c.viewport.multiplyScalar(this._pixelRatio),c.scissor.multiplyScalar(this._pixelRatio),c.scissorTest=this._scissorTest,c.multiview=l===null?!1:l.multiview,c.resolveDepthBuffer=l===null?!0:l.resolveDepthBuffer,c._autoAllocateDepthBuffer=l===null?!1:l._autoAllocateDepthBuffer,c}_renderScene(e,t,n=!0){if(this._isDeviceLost===!0)return;let r=n?this._getFrameBufferTarget():null,i=this._nodes.nodeFrame,a=i.renderId,o=this._currentRenderContext,s=this._currentRenderObjectFunction,c=e.isScene===!0?e:bv,l=this._renderTarget||this._outputRenderTarget,u=this._activeCubeFace,d=this._activeMipmapLevel,f;r===null?f=l:(f=r,this.setRenderTarget(f));let p=this._renderContexts.get(e,t,f);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,i.renderId=this.info.calls;let m=this.coordinateSystem,h=this.xr;if(t.coordinateSystem!==m&&h.isPresenting===!1&&(t.coordinateSystem=m,t.updateProjectionMatrix(),t.isArrayCamera))for(let e of t.cameras)e.coordinateSystem=m,e.updateProjectionMatrix();e.matrixWorldAutoUpdate===!0&&e.updateMatrixWorld(),t.parent===null&&t.matrixWorldAutoUpdate===!0&&t.updateMatrixWorld(),h.enabled===!0&&h.isPresenting===!0&&(h.cameraAutoUpdate===!0&&h.updateCamera(t),t=h.getCamera());let g=this._viewport,_=this._scissor,v=this._pixelRatio;f!==null&&(g=f.viewport,_=f.scissor,v=1),this.getDrawingBufferSize(xv),Sv.set(0,0,xv.width,xv.height);let y=g.minDepth===void 0?0:g.minDepth,b=g.maxDepth===void 0?1:g.maxDepth;p.viewportValue.copy(g).multiplyScalar(v).floor(),p.viewportValue.width>>=d,p.viewportValue.height>>=d,p.viewportValue.minDepth=y,p.viewportValue.maxDepth=b,p.viewport=p.viewportValue.equals(Sv)===!1,p.scissorValue.copy(_).multiplyScalar(v).floor(),p.scissor=this._scissorTest&&p.scissorValue.equals(Sv)===!1,p.scissorValue.width>>=d,p.scissorValue.height>>=d,p.clippingContext||=new G_,p.clippingContext.updateGlobal(c,t),c.onBeforeRender(this,e,t,f);let ee=t.isArrayCamera?wv:Cv;t.isArrayCamera||(Tv.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ee.setFromProjectionMatrix(Tv,t.coordinateSystem,t.reversedDepth));let x=this._renderLists.get(e,t);if(x.begin(),this._projectObject(e,t,0,x,p.clippingContext),x.finish(),this.sortObjects===!0&&x.sort(this._opaqueSort,this._transparentSort),f!==null){this._textures.updateRenderTarget(f,d);let e=this._textures.get(f);p.textures=e.textures,p.depthTexture=e.depthTexture,p.width=e.width,p.height=e.height,p.renderTarget=f,p.depth=f.depthBuffer,p.stencil=f.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=xv.width,p.height=xv.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=d,p.height>>=d,p.activeCubeFace=u,p.activeMipmapLevel=d,p.occlusionQueryCount=x.occlusionQueryCount,p.scissorValue.max(Ev.set(0,0,0,0)),p.scissorValue.x+p.scissorValue.width>p.width&&(p.scissorValue.width=Math.max(p.width-p.scissorValue.x,0)),p.scissorValue.y+p.scissorValue.height>p.height&&(p.scissorValue.height=Math.max(p.height-p.scissorValue.y,0)),this._background.update(c,x,p),p.camera=t,this.backend.beginRender(p);let{bundles:te,lightsNode:ne,transparentDoublePass:re,transparent:ie,opaque:S}=x;return te.length>0&&this._renderBundles(te,c,ne),this.opaque===!0&&S.length>0&&this._renderObjects(S,t,c,ne),this.transparent===!0&&ie.length>0&&this._renderTransparents(ie,re,t,c,ne),this.backend.finishRender(p),i.renderId=a,this._currentRenderContext=o,this._currentRenderObjectFunction=s,r!==null&&(this.setRenderTarget(l,u,d),this._renderOutput(f)),c.onAfterRender(this,e,t,f),p}_setXRLayerSize(e,t){this._width=e,this._height=t,this.setViewport(0,0,e,t)}_renderOutput(e){let t=this._quad;this._nodes.hasOutputChange(e.texture)&&(t.material.fragmentNode=this._nodes.getOutputNode(e.texture),t.material.needsUpdate=!0);let n=this.autoClear,r=this.xr.enabled;this.autoClear=!1,this.xr.enabled=!1,this._renderScene(t,t.camera,!1),this.autoClear=n,this.xr.enabled=r}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){this._initialized===!1&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,n){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this._pixelRatio=n,this.domElement.width=Math.floor(e*n),this.domElement.height=Math.floor(t*n),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setSize(e,t,n=!0){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),n===!0&&(this.domElement.style.width=e+`px`,this.domElement.style.height=t+`px`),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){let t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,n,r){let i=this._scissor;e.isVector4?i.copy(e):i.set(e,t,n,r)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,n,r,i=0,a=1){let o=this._viewport;e.isVector4?o.copy(e):o.set(e,t,n,r),o.minDepth=i,o.maxDepth=a}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){let t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,n=!0){if(this._initialized===!1)return console.warn(`THREE.Renderer: .clear() called before the backend is initialized. Try using .clearAsync() instead.`),this.clearAsync(e,t,n);let r=this._renderTarget||this._getFrameBufferTarget(),i=null;if(r!==null){this._textures.updateRenderTarget(r);let e=this._textures.get(r);i=this._renderContexts.getForClear(r),i.textures=e.textures,i.depthTexture=e.depthTexture,i.width=e.width,i.height=e.height,i.renderTarget=r,i.depth=r.depthBuffer,i.stencil=r.stencilBuffer,i.clearColorValue=this.backend.getClearColor(),i.activeCubeFace=this.getActiveCubeFace(),i.activeMipmapLevel=this.getActiveMipmapLevel()}this.backend.clear(e,t,n,i),r!==null&&this._renderTarget===null&&this._renderOutput(r)}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,n=!0){this._initialized===!1&&await this.init(),this.clear(e,t,n)}async clearColorAsync(){this.clearAsync(!0,!1,!1)}async clearDepthAsync(){this.clearAsync(!1,!0,!1)}async clearStencilAsync(){this.clearAsync(!1,!1,!0)}get currentToneMapping(){return this.isOutputTarget?this.toneMapping:0}get currentColorSpace(){return this.isOutputTarget?this.outputColorSpace:Zn.workingColorSpace}get isOutputTarget(){return this._renderTarget===this._outputRenderTarget||this._renderTarget===null}dispose(){this._initialized===!0&&(this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),this._frameBufferTarget!==null&&this._frameBufferTarget.dispose(),Object.values(this.backend.timestampQueryPool).forEach(e=>{e!==null&&e.dispose()})),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,n=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=n}getRenderTarget(){return this._renderTarget}setOutputRenderTarget(e){this._outputRenderTarget=e}getOutputRenderTarget(){return this._outputRenderTarget}_resetXRState(){this.backend.setXRTarget(null),this.setOutputRenderTarget(null),this.setRenderTarget(null),this._frameBufferTarget.dispose(),this._frameBufferTarget=null}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e,t=null){if(this._isDeviceLost===!0)return;if(this._initialized===!1)return console.warn(`THREE.Renderer: .compute() called before the backend is initialized. Try using .computeAsync() instead.`),this.computeAsync(e);let n=this._nodes.nodeFrame,r=n.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,n.renderId=this.info.calls;let i=this.backend,a=this._pipelines,o=this._bindings,s=this._nodes,c=Array.isArray(e)?e:[e];if(c[0]===void 0||c[0].isComputeNode!==!0)throw Error(`THREE.Renderer: .compute() expects a ComputeNode.`);i.beginCompute(e);for(let n of c){if(a.has(n)===!1){let e=()=>{n.removeEventListener(`dispose`,e),a.delete(n),o.delete(n),s.delete(n)};n.addEventListener(`dispose`,e);let t=n.onInitFunction;t!==null&&t.call(n,{renderer:this})}s.updateForCompute(n),o.updateForCompute(n);let r=o.getForCompute(n),c=a.getForCompute(n,r);i.compute(e,n,r,c,t)}i.finishCompute(e),n.renderId=r}async computeAsync(e,t=null){this._initialized===!1&&await this.init(),this.compute(e,t)}async hasFeatureAsync(e){return this._initialized===!1&&await this.init(),this.backend.hasFeature(e)}async resolveTimestampsAsync(e=`render`){return this._initialized===!1&&await this.init(),this.backend.resolveTimestampsAsync(e)}hasFeature(e){return this._initialized===!1?(console.warn(`THREE.Renderer: .hasFeature() called before the backend is initialized. Try using .hasFeatureAsync() instead.`),!1):this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){this._initialized===!1&&await this.init(),this._textures.updateTexture(e)}initTexture(e){this._initialized===!1&&console.warn(`THREE.Renderer: .initTexture() called before the backend is initialized. Try using .initTextureAsync() instead.`),this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(t!==null)if(t.isVector2)t=Ev.set(t.x,t.y,e.image.width,e.image.height).floor();else if(t.isVector4)t=Ev.copy(t).floor();else{console.error(`THREE.Renderer.copyFramebufferToTexture: Invalid rectangle.`);return}else t=Ev.set(0,0,e.image.width,e.image.height);let n=this._currentRenderContext,r;n===null?(r=this._renderTarget||this._getFrameBufferTarget(),r!==null&&(this._textures.updateRenderTarget(r),n=this._textures.get(r))):r=n.renderTarget,this._textures.updateTexture(e,{renderTarget:r}),this.backend.copyFramebufferToTexture(e,n,t)}copyTextureToTexture(e,t,n=null,r=null,i=0,a=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,n,r,i,a)}async readRenderTargetPixelsAsync(e,t,n,r,i,a=0,o=0){return this.backend.copyTextureToBuffer(e.textures[a],t,n,r,i,o)}_projectObject(e,t,n,r,i){if(e.visible===!1)return;if(e.layers.test(t.layers)){if(e.isGroup)n=e.renderOrder,e.isClippingGroup&&e.enabled&&(i=i.getGroupContext(e));else if(e.isLOD)e.autoUpdate===!0&&e.update(t);else if(e.isLight)r.pushLight(e);else if(e.isSprite){let a=t.isArrayCamera?wv:Cv;if(!e.frustumCulled||a.intersectsSprite(e,t)){this.sortObjects===!0&&Ev.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Tv);let{geometry:t,material:a}=e;a.visible&&r.push(e,t,a,n,Ev.z,null,i)}}else if(e.isLineLoop)console.error(`THREE.Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.`);else if(e.isMesh||e.isLine||e.isPoints){let a=t.isArrayCamera?wv:Cv;if(!e.frustumCulled||a.intersectsObject(e,t)){let{geometry:t,material:a}=e;if(this.sortObjects===!0&&(t.boundingSphere===null&&t.computeBoundingSphere(),Ev.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(Tv)),Array.isArray(a)){let o=t.groups;for(let s=0,c=o.length;s<c;s++){let c=o[s],l=a[c.materialIndex];l&&l.visible&&r.push(e,t,l,n,Ev.z,c,i)}}else a.visible&&r.push(e,t,a,n,Ev.z,null,i)}}}if(e.isBundleGroup===!0&&this.backend.beginBundle!==void 0){let n=r;r=this._renderLists.get(e,t),r.begin(),n.pushBundle({bundleGroup:e,camera:t,renderList:r}),r.finish()}let a=e.children;for(let e=0,o=a.length;e<o;e++)this._projectObject(a[e],t,n,r,i)}_renderBundles(e,t,n){for(let r of e)this._renderBundle(r,t,n)}_renderTransparents(e,t,n,r,i){if(t.length>0){for(let{material:e}of t)e.side=1;this._renderObjects(t,n,r,i,`backSide`);for(let{material:e}of t)e.side=0;this._renderObjects(e,n,r,i);for(let{material:e}of t)e.side=2}else this._renderObjects(e,n,r,i)}_renderObjects(e,t,n,r,i=null){for(let a=0,o=e.length;a<o;a++){let{object:o,geometry:s,material:c,group:l,clippingContext:u}=e[a];this._currentRenderObjectFunction(o,n,t,s,c,l,r,u,i)}}renderObject(e,t,n,r,i,a,o,s=null,c=null){let l,u,d;if(e.onBeforeRender(this,t,n,r,i,a),i.allowOverride===!0&&t.overrideMaterial!==null){let e=t.overrideMaterial;i.positionNode&&i.positionNode.isNode&&(l=e.positionNode,e.positionNode=i.positionNode),e.alphaTest=i.alphaTest,e.alphaMap=i.alphaMap,e.transparent=i.transparent||i.transmission>0,e.isShadowPassMaterial&&(e.side=i.shadowSide===null?i.side:i.shadowSide,i.depthNode&&i.depthNode.isNode&&(d=e.depthNode,e.depthNode=i.depthNode),i.castShadowNode&&i.castShadowNode.isNode&&(u=e.colorNode,e.colorNode=i.castShadowNode),i.castShadowPositionNode&&i.castShadowPositionNode.isNode&&(l=e.positionNode,e.positionNode=i.castShadowPositionNode)),i=e}i.transparent===!0&&i.side===2&&i.forceSinglePass===!1?(i.side=1,this._handleObjectFunction(e,i,t,n,o,a,s,`backSide`),i.side=0,this._handleObjectFunction(e,i,t,n,o,a,s,c),i.side=2):this._handleObjectFunction(e,i,t,n,o,a,s,c),l!==void 0&&(t.overrideMaterial.positionNode=l),d!==void 0&&(t.overrideMaterial.depthNode=d),u!==void 0&&(t.overrideMaterial.colorNode=u),e.onAfterRender(this,t,n,r,i,a)}_renderObjectDirect(e,t,n,r,i,a,o,s){let c=this._objects.get(e,t,n,r,i,this._currentRenderContext,o,s);c.drawRange=e.geometry.drawRange,c.group=a;let l=this._nodes.needsRefresh(c);l&&(this._nodes.updateBefore(c),this._geometries.updateForRender(c),this._nodes.updateForRender(c),this._bindings.updateForRender(c)),this._pipelines.updateForRender(c),this._currentRenderBundle!==null&&(this.backend.get(this._currentRenderBundle).renderObjects.push(c),c.bundle=this._currentRenderBundle.bundleGroup),this.backend.draw(c,this.info),l&&this._nodes.updateAfter(c)}_createObjectPipeline(e,t,n,r,i,a,o,s){let c=this._objects.get(e,t,n,r,i,this._currentRenderContext,o,s);c.drawRange=e.geometry.drawRange,c.group=a,this._nodes.updateBefore(c),this._geometries.updateForRender(c),this._nodes.updateForRender(c),this._bindings.updateForRender(c),this._pipelines.getForRender(c,this._compilationPromises),this._nodes.updateAfter(c)}get compile(){return this.compileAsync}},Ov=class{constructor(e=``){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}};function kv(e){return e+(Pr-e%Pr)%Pr}var Av=class extends Ov{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return kv(this._buffer.byteLength)}get buffer(){return this._buffer}update(){return!0}},jv=class extends Av{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}},Mv=0,Nv=class extends jv{constructor(e,t){super(`UniformBuffer_`+ Mv++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}},Pv=class extends jv{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){let t=this.uniforms.indexOf(e);return t!==-1&&this.uniforms.splice(t,1),this}get values(){return this._values===null&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(e===null){let t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){let e=this.bytesPerElement,t=0;for(let n=0,r=this.uniforms.length;n<r;n++){let r=this.uniforms[n],i=r.boundary,a=r.itemSize*e,o=t%Pr,s=o%i,c=o+s;t+=s,c!==0&&Pr-c<a&&(t+=Pr-c),r.offset=t/e,t+=a}return Math.ceil(t/Pr)*Pr}update(){let e=!1;for(let t of this.uniforms)this.updateByType(t)===!0&&(e=!0);return e}updateByType(e){if(e.isNumberUniform)return this.updateNumber(e);if(e.isVector2Uniform)return this.updateVector2(e);if(e.isVector3Uniform)return this.updateVector3(e);if(e.isVector4Uniform)return this.updateVector4(e);if(e.isColorUniform)return this.updateColor(e);if(e.isMatrix3Uniform)return this.updateMatrix3(e);if(e.isMatrix4Uniform)return this.updateMatrix4(e);console.error(`THREE.WebGPUUniformsGroup: Unsupported uniform type.`,e)}updateNumber(e){let t=!1,n=this.values,r=e.getValue(),i=e.offset,a=e.getType();if(n[i]!==r){let e=this._getBufferForType(a);e[i]=n[i]=r,t=!0}return t}updateVector2(e){let t=!1,n=this.values,r=e.getValue(),i=e.offset,a=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y){let e=this._getBufferForType(a);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,t=!0}return t}updateVector3(e){let t=!1,n=this.values,r=e.getValue(),i=e.offset,a=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y||n[i+2]!==r.z){let e=this._getBufferForType(a);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,e[i+2]=n[i+2]=r.z,t=!0}return t}updateVector4(e){let t=!1,n=this.values,r=e.getValue(),i=e.offset,a=e.getType();if(n[i+0]!==r.x||n[i+1]!==r.y||n[i+2]!==r.z||n[i+4]!==r.w){let e=this._getBufferForType(a);e[i+0]=n[i+0]=r.x,e[i+1]=n[i+1]=r.y,e[i+2]=n[i+2]=r.z,e[i+3]=n[i+3]=r.w,t=!0}return t}updateColor(e){let t=!1,n=this.values,r=e.getValue(),i=e.offset;if(n[i+0]!==r.r||n[i+1]!==r.g||n[i+2]!==r.b){let e=this.buffer;e[i+0]=n[i+0]=r.r,e[i+1]=n[i+1]=r.g,e[i+2]=n[i+2]=r.b,t=!0}return t}updateMatrix3(e){let t=!1,n=this.values,r=e.getValue().elements,i=e.offset;if(n[i+0]!==r[0]||n[i+1]!==r[1]||n[i+2]!==r[2]||n[i+4]!==r[3]||n[i+5]!==r[4]||n[i+6]!==r[5]||n[i+8]!==r[6]||n[i+9]!==r[7]||n[i+10]!==r[8]){let e=this.buffer;e[i+0]=n[i+0]=r[0],e[i+1]=n[i+1]=r[1],e[i+2]=n[i+2]=r[2],e[i+4]=n[i+4]=r[3],e[i+5]=n[i+5]=r[4],e[i+6]=n[i+6]=r[5],e[i+8]=n[i+8]=r[6],e[i+9]=n[i+9]=r[7],e[i+10]=n[i+10]=r[8],t=!0}return t}updateMatrix4(e){let t=!1,n=this.values,r=e.getValue().elements,i=e.offset;return Iv(n,r,i)===!1&&(this.buffer.set(r,i),Fv(n,r,i),t=!0),t}_getBufferForType(e){return e===`int`||e===`ivec2`||e===`ivec3`||e===`ivec4`?new Int32Array(this.buffer.buffer):e===`uint`||e===`uvec2`||e===`uvec3`||e===`uvec4`?new Uint32Array(this.buffer.buffer):this.buffer}};function Fv(e,t,n){for(let r=0,i=t.length;r<i;r++)e[n+r]=t[r]}function Iv(e,t,n){for(let r=0,i=t.length;r<i;r++)if(e[n+r]!==t[r])return!1;return!0}var Lv=0,Rv=class extends Pv{constructor(e,t){super(e),this.id=Lv++,this.groupNode=t,this.isNodeUniformsGroup=!0}},zv=class extends Ov{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.generation=null,this.isSampler=!0}set texture(e){if(this._texture===e)return;let t=()=>{this._texture=null,this.generation=null,this.version=0};this._texture&&this._texture.removeEventListener(`dispose`,t),this._texture=e,this.generation=null,this.version=0,this._texture&&this._texture.addEventListener(`dispose`,t)}get texture(){return this._texture}update(){let{texture:e,version:t}=this;return t===e.version?!1:(this.version=e.version,!0)}clone(){let e=super.clone();return e._texture=null,e.texture=this.texture,e}},Bv=0,Vv=class extends zv{constructor(e,t){super(e,t),this.id=Bv++,this.store=!1,this.isSampledTexture=!0}},Hv=class extends Vv{constructor(e,t,n,r=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n,this.access=r}update(){let{textureNode:e}=this;return this.texture===e.value?super.update():(this.texture=e.value,!0)}},Uv=class extends Hv{constructor(e,t,n,r=null){super(e,t,n,r),this.isSampledCubeTexture=!0}},Wv=class extends Hv{constructor(e,t,n,r=null){super(e,t,n,r),this.isSampledTexture3D=!0}},Gv=class extends gi{constructor(e=null,t=1,n=1,r,i,a,o,s,c=Re,l=Re,u,d){super(null,a,o,s,c,l,r,i,u,d),this.isDataTexture=!0,this.image={data:e,width:t,height:n},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}},Kv={textureDimensions:`textureSize`,equals:`equal`,bitcast_float_int:`floatBitsToInt`,bitcast_int_float:`intBitsToFloat`,bitcast_uint_float:`uintBitsToFloat`,bitcast_float_uint:`floatBitsToUint`},qv={low:`lowp`,medium:`mediump`,high:`highp`},Jv={swizzleAssign:!0,storageBuffer:!1},Yv={perspective:`smooth`,linear:`noperspective`},Xv={centroid:`centroid`},Zv=`
precision highp float;
precision highp int;
precision highp sampler2D;
precision highp sampler3D;
precision highp samplerCube;
precision highp sampler2DArray;

precision highp usampler2D;
precision highp usampler3D;
precision highp usamplerCube;
precision highp usampler2DArray;

precision highp isampler2D;
precision highp isampler3D;
precision highp isamplerCube;
precision highp isampler2DArray;

precision lowp sampler2DShadow;
precision lowp sampler2DArrayShadow;
precision lowp samplerCubeShadow;
`,Qv=class extends Lg{constructor(e,t){super(e,t,new u_),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]}}needsToWorkingColorSpace(e){return e.isVideoTexture===!0&&e.colorSpace!==``}getMethod(e){return Kv[e]||e}getBitcastMethod(e,t){return Kv[`bitcast_${t}_${e}`]}getTernary(e,t,n){return`${e} ? ${t} : ${n}`}getOutputStructName(){return``}buildFunctionCode(e){let t=e.layout,n=this.flowShaderNode(e),r=[];for(let e of t.inputs)r.push(this.getType(e.type)+` `+e.name);return`${this.getType(t.type)} ${t.name}( ${r.join(`, `)} ) {

	${n.vars}

${n.code}
	return ${n.result};

}`}setupPBO(e){let t=e.value;if(t.pbo===void 0){let e=t.array,r=t.count*t.itemSize,{itemSize:i}=t,o=t.array.constructor.name.toLowerCase().includes(`int`),s=o?we:Mt;i===2?s=o?n:wt:i===3?s=o?ae:a:i===4&&(s=o?1033:1023);let c={Float32Array:Un,Uint8Array:ge,Uint16Array:Dn,Uint32Array:an,Int8Array:mt,Int16Array:Ft,Int32Array:kn,Uint8ClampedArray:ge},l=2**Math.ceil(Math.log2(Math.sqrt(r/i))),u=Math.ceil(r/i/l);l*u*i<r&&u++;let d=l*u*i,f=new e.constructor(d);f.set(e,0),t.array=f;let p=new Gv(t.array,l,u,s,c[t.array.constructor.name]||1015);p.needsUpdate=!0,p.isPBOTexture=!0;let m=new uu(p,null,null);m.setPrecision(`high`),t.pboNode=m,t.pbo=m.value,this.getUniformFromNode(t.pboNode,`texture`,this.shaderStage,this.context.nodeName)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&e.node.isTextureNode!==!0&&e.node.isBufferNode!==!0?t.charAt(0)+`_`+e.name:super.getPropertyName(e,t)}generatePBO(e){let{node:t,indexNode:n}=e,r=t.value;if(this.renderer.backend.has(r)){let e=this.renderer.backend.get(r);e.pbo=r.pbo}let i=this.getUniformFromNode(r.pboNode,`texture`,this.shaderStage,this.context.nodeName),a=this.getPropertyName(i);this.increaseUsage(n);let o=n.build(this,`uint`),s=this.getDataFromNode(e),c=s.propertyName;if(c===void 0){let n=this.getVarFromNode(e);c=this.getPropertyName(n);let i=this.getDataFromNode(t),l=i.propertySizeName;l===void 0&&(l=c+`Size`,this.getVarFromNode(t,l,`uint`),this.addLineFlowCode(`${l} = uint( textureSize( ${a}, 0 ).x )`,e),i.propertySizeName=l);let{itemSize:u}=r,d=`.`+Ei.join(``).slice(0,u),f=`ivec2(${o} % ${l}, ${o} / ${l})`,p=this.generateTextureLoad(null,a,f,null,null,`0`),m=`vec4`;r.pbo.type===1014?m=`uvec4`:r.pbo.type===1013&&(m=`ivec4`),this.addLineFlowCode(`${c} = ${m}(${p})${d}`,e),s.propertyName=c}return c}generateTextureLoad(e,t,n,r,i,a=`0`){let o;return o=r?i?`texelFetchOffset( ${t}, ivec3( ${n}, ${r} ), ${a}, ${i} )`:`texelFetch( ${t}, ivec3( ${n}, ${r} ), ${a} )`:i?`texelFetchOffset( ${t}, ${n}, ${a}, ${i} )`:`texelFetch( ${t}, ${n}, ${a} )`,e!==null&&e.isDepthTexture&&(o+=`.x`),o}generateTexture(e,t,n,r,i){return r&&(n=`vec3( ${n}, ${r} )`),e.isDepthTexture?i?`textureOffset( ${t}, ${n}, ${i} ).x`:`texture( ${t}, ${n} ).x`:i?`textureOffset( ${t}, ${n}, ${i} )`:`texture( ${t}, ${n} )`}generateTextureLevel(e,t,n,r,i){return i?`textureLodOffset( ${t}, ${n}, ${r}, ${i} )`:`textureLod( ${t}, ${n}, ${r} )`}generateTextureBias(e,t,n,r,i){return i?`textureOffset( ${t}, ${n}, ${i}, ${r} )`:`texture( ${t}, ${n}, ${r} )`}generateTextureGrad(e,t,n,r,i){return i?`textureGradOffset( ${t}, ${n}, ${r[0]}, ${r[1]}, ${i} )`:`textureGrad( ${t}, ${n}, ${r[0]}, ${r[1]} )`}generateTextureCompare(e,t,n,r,i,a,o=this.shaderStage){if(o===`fragment`)return i?a?`textureOffset( ${t}, vec4( ${n}, ${i}, ${r} ), ${a} )`:`texture( ${t}, vec4( ${n}, ${i}, ${r} ) )`:a?`textureOffset( ${t}, vec3( ${n}, ${r} ), ${a} )`:`texture( ${t}, vec3( ${n}, ${r} ) )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${o} shader.`)}getVars(e){let t=[],n=this.vars[e];if(n!==void 0)for(let e of n)t.push(`${this.getVar(e.type,e.name,e.count)};`);return t.join(`
	`)}getUniforms(e){let t=this.uniforms[e],n=[],r={};for(let i of t){let t=null,a=!1;if(i.type===`texture`||i.type===`texture3D`){let e=i.node.value,n=``;(e.isDataTexture===!0||e.isData3DTexture===!0)&&(e.type===1014?n=`u`:e.type===1013&&(n=`i`)),t=i.type===`texture3D`&&e.isArrayTexture===!1?`${n}sampler3D ${i.name};`:e.compareFunction?e.isArrayTexture===!0?`sampler2DArrayShadow ${i.name};`:`sampler2DShadow ${i.name};`:e.isArrayTexture===!0||e.isDataArrayTexture===!0||e.isCompressedArrayTexture===!0?`${n}sampler2DArray ${i.name};`:`${n}sampler2D ${i.name};`}else if(i.type===`cubeTexture`)t=`samplerCube ${i.name};`;else if(i.type===`buffer`){let e=i.node,n=this.getType(e.bufferType),r=e.bufferCount,a=r>0?r:``;t=`${e.name} {
	${n} ${i.name}[${a}];
};
`}else t=`${this.getVectorType(i.type)} ${this.getPropertyName(i,e)};`,a=!0;let o=i.node.precision;if(o!==null&&(t=qv[o]+` `+t),a){t=`	`+t;let e=i.groupNode.name;(r[e]||(r[e]=[])).push(t)}else t=`uniform `+t,n.push(t)}let i=``;for(let t in r){let n=r[t];i+=this._getGLSLUniformStruct(e+`_`+t,n.join(`
`))+`
`}return i+=n.join(`
`),i}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==1013){let n=e;e.isInterleavedBufferAttribute&&(n=e.data);let r=n.array;r instanceof Uint32Array||r instanceof Int32Array||(t=t.slice(1))}return t}getAttributes(e){let t=``;if(e===`vertex`||e===`compute`){let e=this.getAttributesArray(),n=0;for(let r of e)t+=`layout( location = ${n++} ) in ${r.type} ${r.name};
`}return t}getStructMembers(e){let t=[];for(let n of e.members)t.push(`	${n.type} ${n.name};`);return t.join(`
`)}getStructs(e){let t=[],n=this.structs[e],r=[];for(let e of n)if(e.output)for(let t of e.members)r.push(`layout( location = ${t.index} ) out ${t.type} ${t.name};`);else{let n=`struct `+e.name+` {
`;n+=this.getStructMembers(e),n+=`
};
`,t.push(n)}return r.length===0&&r.push(`layout( location = 0 ) out vec4 fragColor;`),`
`+r.join(`
`)+`

`+t.join(`
`)}getVaryings(e){let t=``,n=this.varyings;if(e===`vertex`||e===`compute`)for(let r of n){e===`compute`&&(r.needsInterpolation=!0);let n=this.getType(r.type);if(r.needsInterpolation)if(r.interpolationType){let e=Yv[r.interpolationType]||r.interpolationType,i=Xv[r.interpolationSampling]||``;t+=`${e} ${i} out ${n} ${r.name};
`}else{let e=n.includes(`int`)||n.includes(`uv`)||n.includes(`iv`)?`flat `:``;t+=`${e}out ${n} ${r.name};
`}else t+=`${n} ${r.name};
`}else if(e===`fragment`){for(let e of n)if(e.needsInterpolation){let n=this.getType(e.type);if(e.interpolationType){let r=Yv[e.interpolationType]||e.interpolationType,i=Xv[e.interpolationSampling]||``;t+=`${r} ${i} in ${n} ${e.name};
`}else{let r=n.includes(`int`)||n.includes(`uv`)||n.includes(`iv`)?`flat `:``;t+=`${r}in ${n} ${e.name};
`}}}for(let n of this.builtins[e])t+=`${n};
`;return t}getVertexIndex(){return`uint( gl_VertexID )`}getInstanceIndex(){return`uint( gl_InstanceID )`}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce((e,t)=>e*t,1)}u`}getDrawIndex(){return this.renderer.backend.extensions.has(`WEBGL_multi_draw`)?`uint( gl_DrawID )`:null}getFrontFacing(){return`gl_FrontFacing`}getFragCoord(){return`gl_FragCoord.xy`}getFragDepth(){return`gl_FragDepth`}enableExtension(e,t,n=this.shaderStage){let r=this.extensions[n]||(this.extensions[n]=new Map);r.has(e)===!1&&r.set(e,{name:e,behavior:t})}getExtensions(e){let t=[];if(e===`vertex`){let t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has(`WEBGL_multi_draw`)&&this.enableExtension(`GL_ANGLE_multi_draw`,`require`,e)}let n=this.extensions[e];if(n!==void 0)for(let{name:e,behavior:r}of n.values())t.push(`#extension ${e} : ${r}`);return t.join(`
`)}getClipDistance(){return`gl_ClipDistance`}isAvailable(e){let t=Jv[e];if(t===void 0){let n;switch(t=!1,e){case`float32Filterable`:n=`OES_texture_float_linear`;break;case`clipDistance`:n=`WEBGL_clip_cull_distance`;break}if(n!==void 0){let e=this.renderer.backend.extensions;e.has(n)&&(e.get(n),t=!0)}Jv[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension(`GL_ANGLE_clip_cull_distance`,`require`),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}enableMultiview(){this.enableExtension(`GL_OVR_multiview2`,`require`,`fragment`),this.enableExtension(`GL_OVR_multiview2`,`require`,`vertex`),this.builtins.vertex.push(`layout(num_views = 2) in`)}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){let e=this.transforms,t=``;for(let n=0;n<e.length;n++){let r=e[n],i=this.getPropertyName(r.attributeNode);i&&(t+=`${r.varyingName} = ${i};
	`)}return t}_getGLSLUniformStruct(e,t){return`
layout( std140 ) uniform ${e} {
${t}
};`}_getGLSLVertexCode(e){return`#version 300 es

${this.getSignature()}

// extensions
${e.extensions}

// precision
${Zv}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// attributes
${e.attributes}

// codes
${e.codes}

void main() {

	// vars
	${e.vars}

	// transforms
	${e.transforms}

	// flow
	${e.flow}

	gl_PointSize = 1.0;

}
`}_getGLSLFragmentCode(e){return`#version 300 es

${this.getSignature()}

// extensions
${e.extensions}

// precision
${Zv}

// uniforms
${e.uniforms}

// varyings
${e.varyings}

// codes
${e.codes}

// structs
${e.structs}

void main() {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}buildCode(){let e=this.material===null?{compute:{}}:{fragment:{},vertex:{}};for(let t in this.sortBindingGroups(),e){let n=`// code

`;n+=this.flowCode[t];let r=this.flowNodes[t],i=r[r.length-1];for(let e of r){let r=this.getFlowData(e),a=e.name;a&&(n.length>0&&(n+=`
`),n+=`	// flow -> ${a}
	`),n+=`${r.code}
	`,e===i&&t!==`compute`&&(n+=`// result
	`,t===`vertex`?(n+=`gl_Position = `,n+=`${r.result};`):t===`fragment`&&(e.outputNode.isOutputStructNode||(n+=`fragColor = `,n+=`${r.result};`)))}let a=e[t];a.extensions=this.getExtensions(t),a.uniforms=this.getUniforms(t),a.attributes=this.getAttributes(t),a.varyings=this.getVaryings(t),a.vars=this.getVars(t),a.structs=this.getStructs(t),a.codes=this.getCodes(t),a.transforms=this.getTransforms(t),a.flow=n}this.material===null?this.computeShader=this._getGLSLVertexCode(e.compute):(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment))}getUniformFromNode(e,t,n,r=null){let i=super.getUniformFromNode(e,t,n,r),a=this.getDataFromNode(e,n,this.globalCache),o=a.uniformGPU;if(o===void 0){let r=e.groupNode,s=r.name,c=this.getBindGroupArray(s,n);if(t===`texture`)o=new Hv(i.name,i.node,r),c.push(o);else if(t===`cubeTexture`)o=new Uv(i.name,i.node,r),c.push(o);else if(t===`texture3D`)o=new Wv(i.name,i.node,r),c.push(o);else if(t===`buffer`){e.name=`NodeBuffer_${e.id}`,i.name=`buffer${e.id}`;let t=new Nv(e,r);t.name=e.name,c.push(t),o=t}else{let e=this.uniformGroups[n]||(this.uniformGroups[n]={}),a=e[s];a===void 0&&(a=new Rv(n+`_`+s,r),e[s]=a,c.push(a)),o=this.getNodeUniform(i,t),a.addUniform(o)}a.uniformGPU=o}return i}},$v=null,ey=null,ty=class{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null,this.timestampQueryPool={render:null,compute:null},this.trackTimestamp=e.trackTimestamp===!0}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}destroySampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}async copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}getTimestampUID(e){let t=this.get(e),n=e.isComputeNode===!0?`c`:`r`;return n+=`:`+t.frameCalls+`:`+e.id,n}isOccluded(){}async resolveTimestampsAsync(e=`render`){if(!this.trackTimestamp){er(`WebGPURenderer: Timestamp tracking is disabled.`);return}let t=this.timestampQueryPool[e];if(!t){er(`WebGPURenderer: No timestamp query pool for type '${e}' found.`);return}let n=await t.resolveQueriesAsync();return this.renderer.info[e].timestamp=n,n}async waitForGPU(){}async getArrayBufferAsync(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return $v||=new w,this.renderer.getDrawingBufferSize($v)}setScissorTest(){}getClearColor(){let e=this.renderer;return ey||=new bi,e.getClearColor(ey),ey.getRGB(ey),ey}getDomElement(){let e=this.domElement;return e===null&&(e=this.parameters.canvas===void 0?ir():this.parameters.canvas,`setAttribute`in e&&e.setAttribute(`data-engine`,`three.js r180 webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return t===void 0&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}},ny=0,ry=class{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[this.activeBufferIndex^1]}switchBuffers(){this.activeBufferIndex^=1}},iy=class{constructor(e){this.backend=e}createAttribute(e,t){let n=this.backend,{gl:r}=n,i=e.array,a=e.usage||r.STATIC_DRAW,o=e.isInterleavedBufferAttribute?e.data:e,s=n.get(o),c=s.bufferGPU;c===void 0&&(c=this._createBuffer(r,t,i,a),s.bufferGPU=c,s.bufferType=t,s.version=o.version);let l;if(i instanceof Float32Array)l=r.FLOAT;else if(typeof Float16Array<`u`&&i instanceof Float16Array)l=r.HALF_FLOAT;else if(i instanceof Uint16Array)l=e.isFloat16BufferAttribute?r.HALF_FLOAT:r.UNSIGNED_SHORT;else if(i instanceof Int16Array)l=r.SHORT;else if(i instanceof Uint32Array)l=r.UNSIGNED_INT;else if(i instanceof Int32Array)l=r.INT;else if(i instanceof Int8Array)l=r.BYTE;else if(i instanceof Uint8Array)l=r.UNSIGNED_BYTE;else if(i instanceof Uint8ClampedArray)l=r.UNSIGNED_BYTE;else throw Error(`THREE.WebGLBackend: Unsupported buffer data format: `+i);let u={bufferGPU:c,bufferType:t,type:l,byteLength:i.byteLength,bytesPerElement:i.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:l===r.INT||l===r.UNSIGNED_INT||e.gpuType===1013,id:ny++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){let e=this._createBuffer(r,t,i,a);u=new ry(u,e)}n.set(e,u)}updateAttribute(e){let t=this.backend,{gl:n}=t,r=e.array,i=e.isInterleavedBufferAttribute?e.data:e,a=t.get(i),o=a.bufferType,s=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(n.bindBuffer(o,a.bufferGPU),s.length===0)n.bufferSubData(o,0,r);else{for(let e=0,t=s.length;e<t;e++){let t=s[e];n.bufferSubData(o,t.start*r.BYTES_PER_ELEMENT,r,t.start,t.count)}i.clearUpdateRanges()}n.bindBuffer(o,null),a.version=i.version}destroyAttribute(e){let t=this.backend,{gl:n}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);let r=t.get(e);n.deleteBuffer(r.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){let t=this.backend,{gl:n}=t,r=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:i}=t.get(r),a=e.array,o=a.byteLength;n.bindBuffer(n.COPY_READ_BUFFER,i);let s=n.createBuffer();n.bindBuffer(n.COPY_WRITE_BUFFER,s),n.bufferData(n.COPY_WRITE_BUFFER,o,n.STREAM_READ),n.copyBufferSubData(n.COPY_READ_BUFFER,n.COPY_WRITE_BUFFER,0,0,o),await t.utils._clientWaitAsync();let c=new e.array.constructor(a.length);return n.bindBuffer(n.COPY_WRITE_BUFFER,s),n.getBufferSubData(n.COPY_WRITE_BUFFER,0,c),n.deleteBuffer(s),n.bindBuffer(n.COPY_READ_BUFFER,null),n.bindBuffer(n.COPY_WRITE_BUFFER,null),c.buffer}_createBuffer(e,t,n,r){let i=e.createBuffer();return e.bindBuffer(t,i),e.bufferData(t,n,r),e.bindBuffer(t,null),i}},ay,oy,sy=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){let e=this.gl;ay={100:e.FUNC_ADD,101:e.FUNC_SUBTRACT,102:e.FUNC_REVERSE_SUBTRACT},oy={200:e.ZERO,201:e.ONE,202:e.SRC_COLOR,204:e.SRC_ALPHA,210:e.SRC_ALPHA_SATURATE,208:e.DST_COLOR,206:e.DST_ALPHA,203:e.ONE_MINUS_SRC_COLOR,205:e.ONE_MINUS_SRC_ALPHA,209:e.ONE_MINUS_DST_COLOR,207:e.ONE_MINUS_DST_ALPHA};let t=e.getParameter(e.SCISSOR_BOX),n=e.getParameter(e.VIEWPORT);this.currentScissor=new s().fromArray(t),this.currentViewport=new s().fromArray(n),this._tempVec4=new s}enable(e){let{enabled:t}=this;t[e]!==!0&&(this.gl.enable(e),t[e]=!0)}disable(e){let{enabled:t}=this;t[e]!==!1&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){let{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){let{gl:t}=this;e===0?this.disable(t.CULL_FACE):(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===1?t.cullFace(t.BACK):e===2?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))),this.currentCullFace=e}setLineWidth(e){let{currentLineWidth:t,gl:n}=this;e!==t&&(n.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,n,r,i,a,o,s){let{gl:c}=this;if(e===0){this.currentBlendingEnabled===!0&&(this.disable(c.BLEND),this.currentBlendingEnabled=!1);return}if(this.currentBlendingEnabled===!1&&(this.enable(c.BLEND),this.currentBlendingEnabled=!0),e!==5){if(e!==this.currentBlending||s!==this.currentPremultipledAlpha){if((this.currentBlendEquation!==100||this.currentBlendEquationAlpha!==100)&&(c.blendEquation(c.FUNC_ADD),this.currentBlendEquation=100,this.currentBlendEquationAlpha=100),s)switch(e){case 1:c.blendFuncSeparate(c.ONE,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA);break;case 2:c.blendFunc(c.ONE,c.ONE);break;case 3:c.blendFuncSeparate(c.ZERO,c.ONE_MINUS_SRC_COLOR,c.ZERO,c.ONE);break;case 4:c.blendFuncSeparate(c.DST_COLOR,c.ONE_MINUS_SRC_ALPHA,c.ZERO,c.ONE);break;default:console.error(`THREE.WebGLState: Invalid blending: `,e);break}else switch(e){case 1:c.blendFuncSeparate(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA,c.ONE,c.ONE_MINUS_SRC_ALPHA);break;case 2:c.blendFuncSeparate(c.SRC_ALPHA,c.ONE,c.ONE,c.ONE);break;case 3:console.error(`THREE.WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true`);break;case 4:console.error(`THREE.WebGLState: MultiplyBlending requires material.premultipliedAlpha = true`);break;default:console.error(`THREE.WebGLState: Invalid blending: `,e);break}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=s}return}i||=t,a||=n,o||=r,(t!==this.currentBlendEquation||i!==this.currentBlendEquationAlpha)&&(c.blendEquationSeparate(ay[t],ay[i]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=i),(n!==this.currentBlendSrc||r!==this.currentBlendDst||a!==this.currentBlendSrcAlpha||o!==this.currentBlendDstAlpha)&&(c.blendFuncSeparate(oy[n],oy[r],oy[a],oy[o]),this.currentBlendSrc=n,this.currentBlendDst=r,this.currentBlendSrcAlpha=a,this.currentBlendDstAlpha=o),this.currentBlending=e,this.currentPremultipledAlpha=!1}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){let{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){let{gl:t}=this;switch(e){case 0:t.depthFunc(t.NEVER);break;case 1:t.depthFunc(t.ALWAYS);break;case 2:t.depthFunc(t.LESS);break;case 3:t.depthFunc(t.LEQUAL);break;case 4:t.depthFunc(t.EQUAL);break;case 5:t.depthFunc(t.GEQUAL);break;case 6:t.depthFunc(t.GREATER);break;case 7:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}this.currentDepthFunc=e}}scissor(e,t,n,r){let i=this._tempVec4.set(e,t,n,r);if(this.currentScissor.equals(i)===!1){let{gl:e}=this;e.scissor(i.x,i.y,i.z,i.w),this.currentScissor.copy(i)}}viewport(e,t,n,r){let i=this._tempVec4.set(e,t,n,r);if(this.currentViewport.equals(i)===!1){let{gl:e}=this;e.viewport(i.x,i.y,i.z,i.w),this.currentViewport.copy(i)}}setScissorTest(e){let t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}setStencilTest(e){let{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,n){(this.currentStencilFunc!==e||this.currentStencilRef!==t||this.currentStencilFuncMask!==n)&&(this.gl.stencilFunc(e,t,n),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=n)}setStencilOp(e,t,n){(this.currentStencilFail!==e||this.currentStencilZFail!==t||this.currentStencilZPass!==n)&&(this.gl.stencilOp(e,t,n),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=n)}setMaterial(e,t,n){let{gl:r}=this;e.side===2?this.disable(r.CULL_FACE):this.enable(r.CULL_FACE);let i=e.side===1;t&&(i=!i),this.setFlipSided(i),e.blending===1&&e.transparent===!1?this.setBlending(0):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);let a=e.stencilWrite;if(this.setStencilTest(a),a&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),e.alphaToCoverage===!0&&this.backend.renderer.samples>1?this.enable(r.SAMPLE_ALPHA_TO_COVERAGE):this.disable(r.SAMPLE_ALPHA_TO_COVERAGE),n>0&&this.currentClippingPlanes!==n)for(let e=0;e<8;e++)e<n?this.enable(12288+e):this.disable(12288+e)}setPolygonOffset(e,t,n){let{gl:r}=this;e?(this.enable(r.POLYGON_OFFSET_FILL),(this.currentPolygonOffsetFactor!==t||this.currentPolygonOffsetUnits!==n)&&(r.polygonOffset(t,n),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=n)):this.disable(r.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram===e?!1:(this.gl.useProgram(e),this.currentProgram=e,!0)}setVertexState(e,t=null){let n=this.gl;return this.currentVAO!==e||this.currentIndex!==t?(n.bindVertexArray(e),t!==null&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.currentVAO=e,this.currentIndex=t,!0):!1}resetVertexState(){let e=this.gl;e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(e,t){let{gl:n,currentBoundFramebuffers:r}=this;return r[e]===t?!1:(n.bindFramebuffer(e,t),r[e]=t,e===n.DRAW_FRAMEBUFFER&&(r[n.FRAMEBUFFER]=t),e===n.FRAMEBUFFER&&(r[n.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){let{gl:n}=this,r=[],i=!1;if(e.textures!==null){r=this.currentDrawbuffers.get(t),r===void 0&&(r=[],this.currentDrawbuffers.set(t,r));let a=e.textures;if(r.length!==a.length||r[0]!==n.COLOR_ATTACHMENT0){for(let e=0,t=a.length;e<t;e++)r[e]=n.COLOR_ATTACHMENT0+e;r.length=a.length,i=!0}}else r[0]!==n.BACK&&(r[0]=n.BACK,i=!0);i&&n.drawBuffers(r)}activeTexture(e){let{gl:t,currentTextureSlot:n,maxTextures:r}=this;e===void 0&&(e=t.TEXTURE0+r-1),n!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,n){let{gl:r,currentTextureSlot:i,currentBoundTextures:a,maxTextures:o}=this;n===void 0&&(n=i===null?r.TEXTURE0+o-1:i);let s=a[n];s===void 0&&(s={type:void 0,texture:void 0},a[n]=s),(s.type!==e||s.texture!==t)&&(i!==n&&(r.activeTexture(n),this.currentTextureSlot=n),r.bindTexture(e,t),s.type=e,s.texture=t)}bindBufferBase(e,t,n){let{gl:r}=this,i=`${e}-${t}`;return this.currentBoundBufferBases[i]===n?!1:(r.bindBufferBase(e,t,n),this.currentBoundBufferBases[i]=n,!0)}unbindTexture(){let{gl:e,currentTextureSlot:t,currentBoundTextures:n}=this,r=n[t];r!==void 0&&r.type!==void 0&&(e.bindTexture(r.type,null),r.type=void 0,r.texture=void 0)}},cy=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=``){let{gl:n,extensions:r}=this,i,a=Zn.getTransfer(t);if(e===1009)return n.UNSIGNED_BYTE;if(e===1017)return n.UNSIGNED_SHORT_4_4_4_4;if(e===1018)return n.UNSIGNED_SHORT_5_5_5_1;if(e===35902)return n.UNSIGNED_INT_5_9_9_9_REV;if(e===35899)return n.UNSIGNED_INT_10F_11F_11F_REV;if(e===1010)return n.BYTE;if(e===1011)return n.SHORT;if(e===1012)return n.UNSIGNED_SHORT;if(e===1013)return n.INT;if(e===1014)return n.UNSIGNED_INT;if(e===1015)return n.FLOAT;if(e===1016)return n.HALF_FLOAT;if(e===1021)return n.ALPHA;if(e===1022)return n.RGB;if(e===1023)return n.RGBA;if(e===1026)return n.DEPTH_COMPONENT;if(e===1027)return n.DEPTH_STENCIL;if(e===1028)return n.RED;if(e===1029)return n.RED_INTEGER;if(e===1030)return n.RG;if(e===1031)return n.RG_INTEGER;if(e===1033)return n.RGBA_INTEGER;if(e===33776||e===33777||e===33778||e===33779)if(a===`srgb`)if(i=r.get(`WEBGL_compressed_texture_s3tc_srgb`),i!==null){if(e===33776)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===33777)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===33778)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===33779)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null;else if(i=r.get(`WEBGL_compressed_texture_s3tc`),i!==null){if(e===33776)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===33777)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===33778)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===33779)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(e===35840||e===35841||e===35842||e===35843)if(i=r.get(`WEBGL_compressed_texture_pvrtc`),i!==null){if(e===35840)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===35841)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===35842)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===35843)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(e===36196||e===37492||e===37496)if(i=r.get(`WEBGL_compressed_texture_etc`),i!==null){if(e===36196||e===37492)return a===`srgb`?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(e===37496)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}else return null;if(e===37808||e===37809||e===37810||e===37811||e===37812||e===37813||e===37814||e===37815||e===37816||e===37817||e===37818||e===37819||e===37820||e===37821)if(i=r.get(`WEBGL_compressed_texture_astc`),i!==null){if(e===37808)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===37809)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===37810)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===37811)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===37812)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===37813)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===37814)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===37815)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===37816)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===37817)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===37818)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===37819)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===37820)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===37821)return a===`srgb`?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null;if(e===36492)if(i=r.get(`EXT_texture_compression_bptc`),i!==null){if(e===36492)return a===`srgb`?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT}else return null;if(e===36283||e===36284||e===36285||e===36286)if(i=r.get(`EXT_texture_compression_rgtc`),i!==null){if(e===36283)return i.COMPRESSED_RED_RGTC1_EXT;if(e===36284)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===36285)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===36286)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}else return null;return e===1020?n.UNSIGNED_INT_24_8:n[e]===void 0?null:n[e]}_clientWaitAsync(){let{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((n,r)=>{function i(){let a=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(a===e.WAIT_FAILED){e.deleteSync(t),r();return}if(a===e.TIMEOUT_EXPIRED){requestAnimationFrame(i);return}e.deleteSync(t),n()}i()})}};function ly(e,t,r,i){let o=uy(i);switch(r){case nt:return e*t;case Mt:return e*t/o.components*o.byteLength;case we:return e*t/o.components*o.byteLength;case wt:return e*t*2/o.components*o.byteLength;case n:return e*t*2/o.components*o.byteLength;case a:return e*t*3/o.components*o.byteLength;case Ct:return e*t*4/o.components*o.byteLength;case Be:return e*t*4/o.components*o.byteLength;case Pe:case It:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Wt:case _n:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case pt:case je:return Math.max(e,16)*Math.max(t,8)/4;case Hn:case g:return Math.max(e,8)*Math.max(t,8)/2;case Tn:case Gn:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Me:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Je:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case gt:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case Ne:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case ot:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case ve:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case gn:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Fe:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case kt:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Le:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case cn:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Qt:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case l:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case Bt:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case Ht:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case Ue:case Oe:case An:return Math.ceil(e/4)*Math.ceil(t/4)*16;case Kt:case _e:return Math.ceil(e/4)*Math.ceil(t/4)*8;case yt:case d:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw Error(`Unable to determine texture byte length for ${r} format.`)}function uy(e){switch(e){case ge:case mt:return{byteLength:1,components:1};case Dn:case Ft:case Rt:return{byteLength:2,components:1};case v:case pe:return{byteLength:2,components:4};case an:case kn:case Un:return{byteLength:4,components:1};case bn:case hn:return{byteLength:4,components:3}}throw Error(`Unknown texture type ${e}.`)}var dy=!1,fy,py,my,hy=class{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},dy===!1&&(this._init(),dy=!0)}_init(){let e=this.gl;fy={[fe]:e.REPEAT,[Et]:e.CLAMP_TO_EDGE,[t]:e.MIRRORED_REPEAT},py={[Re]:e.NEAREST,[Ve]:e.NEAREST_MIPMAP_NEAREST,[xn]:e.NEAREST_MIPMAP_LINEAR,[Yt]:e.LINEAR,[Ze]:e.LINEAR_MIPMAP_NEAREST,[ut]:e.LINEAR_MIPMAP_LINEAR},my={512:e.NEVER,519:e.ALWAYS,513:e.LESS,515:e.LEQUAL,514:e.EQUAL,518:e.GEQUAL,516:e.GREATER,517:e.NOTEQUAL}}getGLTextureType(e){let{gl:t}=this,n;return n=e.isCubeTexture===!0?t.TEXTURE_CUBE_MAP:e.isArrayTexture===!0||e.isDataArrayTexture===!0||e.isCompressedArrayTexture===!0?t.TEXTURE_2D_ARRAY:e.isData3DTexture===!0?t.TEXTURE_3D:t.TEXTURE_2D,n}getInternalFormat(e,t,n,r,i=!1){let{gl:a,extensions:o}=this;if(e!==null){if(a[e]!==void 0)return a[e];console.warn(`THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '`+e+`'`)}let s=t;if(t===a.RED&&(n===a.FLOAT&&(s=a.R32F),n===a.HALF_FLOAT&&(s=a.R16F),n===a.UNSIGNED_BYTE&&(s=a.R8),n===a.UNSIGNED_SHORT&&(s=a.R16),n===a.UNSIGNED_INT&&(s=a.R32UI),n===a.BYTE&&(s=a.R8I),n===a.SHORT&&(s=a.R16I),n===a.INT&&(s=a.R32I)),t===a.RED_INTEGER&&(n===a.UNSIGNED_BYTE&&(s=a.R8UI),n===a.UNSIGNED_SHORT&&(s=a.R16UI),n===a.UNSIGNED_INT&&(s=a.R32UI),n===a.BYTE&&(s=a.R8I),n===a.SHORT&&(s=a.R16I),n===a.INT&&(s=a.R32I)),t===a.RG&&(n===a.FLOAT&&(s=a.RG32F),n===a.HALF_FLOAT&&(s=a.RG16F),n===a.UNSIGNED_BYTE&&(s=a.RG8),n===a.UNSIGNED_SHORT&&(s=a.RG16),n===a.UNSIGNED_INT&&(s=a.RG32UI),n===a.BYTE&&(s=a.RG8I),n===a.SHORT&&(s=a.RG16I),n===a.INT&&(s=a.RG32I)),t===a.RG_INTEGER&&(n===a.UNSIGNED_BYTE&&(s=a.RG8UI),n===a.UNSIGNED_SHORT&&(s=a.RG16UI),n===a.UNSIGNED_INT&&(s=a.RG32UI),n===a.BYTE&&(s=a.RG8I),n===a.SHORT&&(s=a.RG16I),n===a.INT&&(s=a.RG32I)),t===a.RGB){let e=i?Mn:Zn.getTransfer(r);n===a.FLOAT&&(s=a.RGB32F),n===a.HALF_FLOAT&&(s=a.RGB16F),n===a.UNSIGNED_BYTE&&(s=a.RGB8),n===a.UNSIGNED_SHORT&&(s=a.RGB16),n===a.UNSIGNED_INT&&(s=a.RGB32UI),n===a.BYTE&&(s=a.RGB8I),n===a.SHORT&&(s=a.RGB16I),n===a.INT&&(s=a.RGB32I),n===a.UNSIGNED_BYTE&&(s=e===`srgb`?a.SRGB8:a.RGB8),n===a.UNSIGNED_SHORT_5_6_5&&(s=a.RGB565),n===a.UNSIGNED_SHORT_5_5_5_1&&(s=a.RGB5_A1),n===a.UNSIGNED_SHORT_4_4_4_4&&(s=a.RGB4),n===a.UNSIGNED_INT_5_9_9_9_REV&&(s=a.RGB9_E5),n===a.UNSIGNED_INT_10F_11F_11F_REV&&(s=a.R11F_G11F_B10F)}if(t===a.RGB_INTEGER&&(n===a.UNSIGNED_BYTE&&(s=a.RGB8UI),n===a.UNSIGNED_SHORT&&(s=a.RGB16UI),n===a.UNSIGNED_INT&&(s=a.RGB32UI),n===a.BYTE&&(s=a.RGB8I),n===a.SHORT&&(s=a.RGB16I),n===a.INT&&(s=a.RGB32I)),t===a.RGBA){let e=i?Mn:Zn.getTransfer(r);n===a.FLOAT&&(s=a.RGBA32F),n===a.HALF_FLOAT&&(s=a.RGBA16F),n===a.UNSIGNED_BYTE&&(s=a.RGBA8),n===a.UNSIGNED_SHORT&&(s=a.RGBA16),n===a.UNSIGNED_INT&&(s=a.RGBA32UI),n===a.BYTE&&(s=a.RGBA8I),n===a.SHORT&&(s=a.RGBA16I),n===a.INT&&(s=a.RGBA32I),n===a.UNSIGNED_BYTE&&(s=e===`srgb`?a.SRGB8_ALPHA8:a.RGBA8),n===a.UNSIGNED_SHORT_4_4_4_4&&(s=a.RGBA4),n===a.UNSIGNED_SHORT_5_5_5_1&&(s=a.RGB5_A1)}return t===a.RGBA_INTEGER&&(n===a.UNSIGNED_BYTE&&(s=a.RGBA8UI),n===a.UNSIGNED_SHORT&&(s=a.RGBA16UI),n===a.UNSIGNED_INT&&(s=a.RGBA32UI),n===a.BYTE&&(s=a.RGBA8I),n===a.SHORT&&(s=a.RGBA16I),n===a.INT&&(s=a.RGBA32I)),t===a.DEPTH_COMPONENT&&(n===a.UNSIGNED_SHORT&&(s=a.DEPTH_COMPONENT16),n===a.UNSIGNED_INT&&(s=a.DEPTH_COMPONENT24),n===a.FLOAT&&(s=a.DEPTH_COMPONENT32F)),t===a.DEPTH_STENCIL&&n===a.UNSIGNED_INT_24_8&&(s=a.DEPTH24_STENCIL8),(s===a.R16F||s===a.R32F||s===a.RG16F||s===a.RG32F||s===a.RGBA16F||s===a.RGBA32F)&&o.get(`EXT_color_buffer_float`),s}setTextureParameters(e,t){let{gl:n,extensions:r,backend:i}=this,a=Zn.getPrimaries(Zn.workingColorSpace),o=t.colorSpace===``?null:Zn.getPrimaries(t.colorSpace),s=t.colorSpace===``||a===o?n.NONE:n.BROWSER_DEFAULT_WEBGL;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t.flipY),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_ALIGNMENT,t.unpackAlignment),n.pixelStorei(n.UNPACK_COLORSPACE_CONVERSION_WEBGL,s),n.texParameteri(e,n.TEXTURE_WRAP_S,fy[t.wrapS]),n.texParameteri(e,n.TEXTURE_WRAP_T,fy[t.wrapT]),(e===n.TEXTURE_3D||e===n.TEXTURE_2D_ARRAY)&&(t.isArrayTexture||n.texParameteri(e,n.TEXTURE_WRAP_R,fy[t.wrapR])),n.texParameteri(e,n.TEXTURE_MAG_FILTER,py[t.magFilter]);let c=t.mipmaps!==void 0&&t.mipmaps.length>0,l=t.minFilter===1006&&c?ut:t.minFilter;if(n.texParameteri(e,n.TEXTURE_MIN_FILTER,py[l]),t.compareFunction&&(n.texParameteri(e,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE),n.texParameteri(e,n.TEXTURE_COMPARE_FUNC,my[t.compareFunction])),r.has(`EXT_texture_filter_anisotropic`)===!0){if(t.magFilter===1003||t.minFilter!==1005&&t.minFilter!==1008||t.type===1015&&r.has(`OES_texture_float_linear`)===!1)return;if(t.anisotropy>1){let a=r.get(`EXT_texture_filter_anisotropic`);n.texParameterf(e,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,i.getMaxAnisotropy()))}}}createDefaultTexture(e){let{gl:t,backend:n,defaultTextures:r}=this,i=this.getGLTextureType(e),a=r[i];a===void 0&&(a=t.createTexture(),n.state.bindTexture(i,a),t.texParameteri(i,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(i,t.TEXTURE_MAG_FILTER,t.NEAREST),r[i]=a),n.set(e,{textureGPU:a,glTextureType:i,isDefault:!0})}createTexture(e,t){let{gl:n,backend:r}=this,{levels:i,width:a,height:o,depth:s}=t,c=r.utils.convert(e.format,e.colorSpace),l=r.utils.convert(e.type),u=this.getInternalFormat(e.internalFormat,c,l,e.colorSpace,e.isVideoTexture),d=n.createTexture(),f=this.getGLTextureType(e);r.state.bindTexture(f,d),this.setTextureParameters(f,e),e.isArrayTexture||e.isDataArrayTexture||e.isCompressedArrayTexture?n.texStorage3D(n.TEXTURE_2D_ARRAY,i,u,a,o,s):e.isData3DTexture?n.texStorage3D(n.TEXTURE_3D,i,u,a,o,s):e.isVideoTexture||n.texStorage2D(f,i,u,a,o),r.set(e,{textureGPU:d,glTextureType:f,glFormat:c,glType:l,glInternalFormat:u})}copyBufferToTexture(e,t){let{gl:n,backend:r}=this,{textureGPU:i,glTextureType:a,glFormat:o,glType:s}=r.get(t),{width:c,height:l}=t.source.data;n.bindBuffer(n.PIXEL_UNPACK_BUFFER,e),r.state.bindTexture(a,i),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),n.texSubImage2D(a,0,0,0,c,l,o,s,0),n.bindBuffer(n.PIXEL_UNPACK_BUFFER,null),r.state.unbindTexture()}updateTexture(e,t){let{gl:n}=this,{width:r,height:i}=t,{textureGPU:a,glTextureType:o,glFormat:s,glType:c,glInternalFormat:l}=this.backend.get(e);if(!(e.isRenderTargetTexture||a===void 0))if(this.backend.state.bindTexture(o,a),this.setTextureParameters(o,e),e.isCompressedTexture){let r=e.mipmaps,i=t.image;for(let t=0;t<r.length;t++){let a=r[t];e.isCompressedArrayTexture?e.format===n.RGBA?n.texSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,a.width,a.height,i.depth,s,c,a.data):s===null?console.warn(`THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()`):n.compressedTexSubImage3D(n.TEXTURE_2D_ARRAY,t,0,0,0,a.width,a.height,i.depth,s,a.data):s===null?console.warn(`Unsupported compressed texture format`):n.compressedTexSubImage2D(n.TEXTURE_2D,t,0,0,a.width,a.height,s,a.data)}}else if(e.isCubeTexture){let a=t.images,o=e.mipmaps;for(let e=0;e<6;e++){let t=gy(a[e]);n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,r,i,s,c,t);for(let t=0;t<o.length;t++){let r=o[t],i=gy(r.images[e]);n.texSubImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+e,t+1,0,0,i.width,i.height,s,c,i)}}}else if(e.isDataArrayTexture||e.isArrayTexture){let r=t.image;if(e.layerUpdates.size>0){let t=ly(r.width,r.height,e.format,e.type);for(let i of e.layerUpdates){let e=r.data.subarray(i*t/r.data.BYTES_PER_ELEMENT,(i+1)*t/r.data.BYTES_PER_ELEMENT);n.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,i,r.width,r.height,1,s,c,e)}e.clearLayerUpdates()}else n.texSubImage3D(n.TEXTURE_2D_ARRAY,0,0,0,0,r.width,r.height,r.depth,s,c,r.data)}else if(e.isData3DTexture){let e=t.image;n.texSubImage3D(n.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,s,c,e.data)}else if(e.isVideoTexture)e.update(),n.texImage2D(o,0,l,s,c,t.image);else{let a=e.mipmaps;if(a.length>0)for(let e=0,t=a.length;e<t;e++){let t=a[e],r=gy(t);n.texSubImage2D(o,e,0,0,t.width,t.height,s,c,r)}else{let e=gy(t.image);n.texSubImage2D(o,0,0,0,r,i,s,c,e)}}}generateMipmaps(e){let{gl:t,backend:n}=this,{textureGPU:r,glTextureType:i}=n.get(e);n.state.bindTexture(i,r),t.generateMipmap(i)}deallocateRenderBuffers(e){let{gl:t,backend:n}=this;if(e){let r=n.get(e);if(r.renderBufferStorageSetup=void 0,r.framebuffers){for(let e in r.framebuffers)t.deleteFramebuffer(r.framebuffers[e]);delete r.framebuffers}if(r.depthRenderbuffer&&(t.deleteRenderbuffer(r.depthRenderbuffer),delete r.depthRenderbuffer),r.stencilRenderbuffer&&(t.deleteRenderbuffer(r.stencilRenderbuffer),delete r.stencilRenderbuffer),r.msaaFrameBuffer&&(t.deleteFramebuffer(r.msaaFrameBuffer),delete r.msaaFrameBuffer),r.msaaRenderbuffers){for(let e=0;e<r.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(r.msaaRenderbuffers[e]);delete r.msaaRenderbuffers}}}destroyTexture(e){let{gl:t,backend:n}=this,{textureGPU:r,renderTarget:i}=n.get(e);this.deallocateRenderBuffers(i),t.deleteTexture(r),n.delete(e)}copyTextureToTexture(e,t,n=null,r=null,i=0,a=0){let{gl:o,backend:s}=this,{state:c}=this.backend,{textureGPU:l,glTextureType:u,glType:d,glFormat:f}=s.get(t);c.bindTexture(u,l);let p,m,h,g,_,v,y,b,ee,x=e.isCompressedTexture?e.mipmaps[a]:e.image;if(n!==null)p=n.max.x-n.min.x,m=n.max.y-n.min.y,h=n.isBox3?n.max.z-n.min.z:1,g=n.min.x,_=n.min.y,v=n.isBox3?n.min.z:0;else{let t=2**-i;p=Math.floor(x.width*t),m=Math.floor(x.height*t),h=e.isDataArrayTexture||e.isArrayTexture?x.depth:e.isData3DTexture?Math.floor(x.depth*t):1,g=0,_=0,v=0}r===null?(y=0,b=0,ee=0):(y=r.x,b=r.y,ee=r.z),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t.flipY),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),o.pixelStorei(o.UNPACK_ALIGNMENT,t.unpackAlignment);let te=o.getParameter(o.UNPACK_ROW_LENGTH),ne=o.getParameter(o.UNPACK_IMAGE_HEIGHT),re=o.getParameter(o.UNPACK_SKIP_PIXELS),ie=o.getParameter(o.UNPACK_SKIP_ROWS),S=o.getParameter(o.UNPACK_SKIP_IMAGES);o.pixelStorei(o.UNPACK_ROW_LENGTH,x.width),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,x.height),o.pixelStorei(o.UNPACK_SKIP_PIXELS,g),o.pixelStorei(o.UNPACK_SKIP_ROWS,_),o.pixelStorei(o.UNPACK_SKIP_IMAGES,v);let ae=t.isDataArrayTexture||t.isData3DTexture||t.isArrayTexture;if(e.isRenderTargetTexture||e.isDepthTexture){let n=s.get(e),r=s.get(t),i=s.get(n.renderTarget),a=s.get(r.renderTarget),l=i.framebuffers[n.cacheKey],u=a.framebuffers[r.cacheKey];c.bindFramebuffer(o.READ_FRAMEBUFFER,l),c.bindFramebuffer(o.DRAW_FRAMEBUFFER,u);let d=o.COLOR_BUFFER_BIT;e.isDepthTexture&&(d=o.DEPTH_BUFFER_BIT),o.blitFramebuffer(g,_,p,m,y,b,p,m,d,o.NEAREST),c.bindFramebuffer(o.READ_FRAMEBUFFER,null),c.bindFramebuffer(o.DRAW_FRAMEBUFFER,null)}else ae?e.isDataTexture||e.isData3DTexture?o.texSubImage3D(u,a,y,b,ee,p,m,h,f,d,x.data):t.isCompressedArrayTexture?o.compressedTexSubImage3D(u,a,y,b,ee,p,m,h,f,x.data):o.texSubImage3D(u,a,y,b,ee,p,m,h,f,d,x):e.isDataTexture?o.texSubImage2D(u,a,y,b,p,m,f,d,x.data):e.isCompressedTexture?o.compressedTexSubImage2D(u,a,y,b,x.width,x.height,f,x.data):o.texSubImage2D(u,a,y,b,p,m,f,d,x);o.pixelStorei(o.UNPACK_ROW_LENGTH,te),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,ne),o.pixelStorei(o.UNPACK_SKIP_PIXELS,re),o.pixelStorei(o.UNPACK_SKIP_ROWS,ie),o.pixelStorei(o.UNPACK_SKIP_IMAGES,S),a===0&&t.generateMipmaps&&o.generateMipmap(u),c.unbindTexture()}copyFramebufferToTexture(e,t,n){let{gl:r}=this,{state:i}=this.backend,{textureGPU:a}=this.backend.get(e),{x:o,y:s,z:c,w:l}=n,u=e.isDepthTexture===!0||t.renderTarget&&t.renderTarget.samples>0,d=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(u){let n=o!==0||s!==0,u,f;if(e.isDepthTexture===!0?(u=r.DEPTH_BUFFER_BIT,f=r.DEPTH_ATTACHMENT,t.stencil&&(u|=r.STENCIL_BUFFER_BIT)):(u=r.COLOR_BUFFER_BIT,f=r.COLOR_ATTACHMENT0),n){let e=this.backend.get(t.renderTarget),n=e.framebuffers[t.getCacheKey()],f=e.msaaFrameBuffer;i.bindFramebuffer(r.DRAW_FRAMEBUFFER,n),i.bindFramebuffer(r.READ_FRAMEBUFFER,f);let p=d-s-l;r.blitFramebuffer(o,p,o+c,p+l,o,p,o+c,p+l,u,r.NEAREST),i.bindFramebuffer(r.READ_FRAMEBUFFER,n),i.bindTexture(r.TEXTURE_2D,a),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,o,p,c,l),i.unbindTexture()}else{let e=r.createFramebuffer();i.bindFramebuffer(r.DRAW_FRAMEBUFFER,e),r.framebufferTexture2D(r.DRAW_FRAMEBUFFER,f,r.TEXTURE_2D,a,0),r.blitFramebuffer(0,0,c,l,0,0,c,l,u,r.NEAREST),r.deleteFramebuffer(e)}}else i.bindTexture(r.TEXTURE_2D,a),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,o,d-l-s,c,l),i.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t,n,r=!1){let{gl:i}=this,a=t.renderTarget,{depthTexture:o,depthBuffer:s,stencilBuffer:c,width:l,height:u}=a;if(i.bindRenderbuffer(i.RENDERBUFFER,e),s&&!c){let t=i.DEPTH_COMPONENT24;r===!0?this.extensions.get(`WEBGL_multisampled_render_to_texture`).renderbufferStorageMultisampleEXT(i.RENDERBUFFER,a.samples,t,l,u):n>0?(o&&o.isDepthTexture&&o.type===i.FLOAT&&(t=i.DEPTH_COMPONENT32F),i.renderbufferStorageMultisample(i.RENDERBUFFER,n,t,l,u)):i.renderbufferStorage(i.RENDERBUFFER,t,l,u),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e)}else s&&c&&(n>0?i.renderbufferStorageMultisample(i.RENDERBUFFER,n,i.DEPTH24_STENCIL8,l,u):i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,l,u),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e));i.bindRenderbuffer(i.RENDERBUFFER,null)}async copyTextureToBuffer(e,t,n,r,i,a){let{backend:o,gl:s}=this,{textureGPU:c,glFormat:l,glType:u}=this.backend.get(e),d=s.createFramebuffer();s.bindFramebuffer(s.READ_FRAMEBUFFER,d);let f=e.isCubeTexture?s.TEXTURE_CUBE_MAP_POSITIVE_X+a:s.TEXTURE_2D;s.framebufferTexture2D(s.READ_FRAMEBUFFER,s.COLOR_ATTACHMENT0,f,c,0);let p=this._getTypedArrayType(u),m=this._getBytesPerTexel(u,l),h=r*i*m,g=s.createBuffer();s.bindBuffer(s.PIXEL_PACK_BUFFER,g),s.bufferData(s.PIXEL_PACK_BUFFER,h,s.STREAM_READ),s.readPixels(t,n,r,i,l,u,0),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),await o.utils._clientWaitAsync();let _=new p(h/p.BYTES_PER_ELEMENT);return s.bindBuffer(s.PIXEL_PACK_BUFFER,g),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,_),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),s.deleteFramebuffer(d),_}_getTypedArrayType(e){let{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4||e===t.UNSIGNED_SHORT_5_5_5_1||e===t.UNSIGNED_SHORT_5_6_5||e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){let{gl:n}=this,r=0;if(e===n.UNSIGNED_BYTE&&(r=1),(e===n.UNSIGNED_SHORT_4_4_4_4||e===n.UNSIGNED_SHORT_5_5_5_1||e===n.UNSIGNED_SHORT_5_6_5||e===n.UNSIGNED_SHORT||e===n.HALF_FLOAT)&&(r=2),(e===n.UNSIGNED_INT||e===n.FLOAT)&&(r=4),t===n.RGBA)return r*4;if(t===n.RGB)return r*3;if(t===n.ALPHA)return r}};function gy(e){return e.isDataTexture?e.image.data:typeof HTMLImageElement<`u`&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<`u`&&e instanceof HTMLCanvasElement||typeof ImageBitmap<`u`&&e instanceof ImageBitmap||typeof OffscreenCanvas<`u`&&e instanceof OffscreenCanvas?e:e.data}var _y=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return t===void 0&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}},vy=class{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(this.maxAnisotropy!==null)return this.maxAnisotropy;let e=this.backend.gl,t=this.backend.extensions;if(t.has(`EXT_texture_filter_anisotropic`)===!0){let n=t.get(`EXT_texture_filter_anisotropic`);this.maxAnisotropy=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}},yy={WEBGL_multi_draw:`WEBGL_multi_draw`,WEBGL_compressed_texture_astc:`texture-compression-astc`,WEBGL_compressed_texture_etc:`texture-compression-etc2`,WEBGL_compressed_texture_etc1:`texture-compression-etc1`,WEBGL_compressed_texture_pvrtc:`texture-compression-pvrtc`,WEBKIT_WEBGL_compressed_texture_pvrtc:`texture-compression-pvrtc`,WEBGL_compressed_texture_s3tc:`texture-compression-bc`,EXT_texture_compression_bptc:`texture-compression-bptc`,EXT_disjoint_timer_query_webgl2:`timestamp-query`,OVR_multiview2:`OVR_multiview2`},by=class{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){let{gl:n,mode:r,object:i,type:a,info:o,index:s}=this;s===0?n.drawArrays(r,e,t):n.drawElements(r,t,a,e),o.update(i,t,1)}renderInstances(e,t,n){let{gl:r,mode:i,type:a,index:o,object:s,info:c}=this;n!==0&&(o===0?r.drawArraysInstanced(i,e,t,n):r.drawElementsInstanced(i,t,a,e,n),c.update(s,t,n))}renderMultiDraw(e,t,n){let{extensions:r,mode:i,object:a,info:o}=this;if(n===0)return;let s=r.get(`WEBGL_multi_draw`);if(s===null)for(let r=0;r<n;r++)this.render(e[r],t[r]);else{this.index===0?s.multiDrawArraysWEBGL(i,e,0,t,0,n):s.multiDrawElementsWEBGL(i,t,0,this.type,e,0,n);let r=0;for(let e=0;e<n;e++)r+=t[e];o.update(a,r,1)}}renderMultiDrawInstances(e,t,n,r){let{extensions:i,mode:a,object:o,info:s}=this;if(n===0)return;let c=i.get(`WEBGL_multi_draw`);if(c===null)for(let i=0;i<n;i++)this.renderInstances(e[i],t[i],r[i]);else{this.index===0?c.multiDrawArraysInstancedWEBGL(a,e,0,t,0,r,0,n):c.multiDrawElementsInstancedWEBGL(a,t,0,this.type,e,0,r,0,n);let i=0;for(let e=0;e<n;e++)i+=t[e]*r[e];s.update(o,i,1)}}},xy=class{constructor(e=256){this.trackTimestamp=!0,this.maxQueries=e,this.currentQueryIndex=0,this.queryOffsets=new Map,this.isDisposed=!1,this.lastValue=0,this.pendingResolve=!1}allocateQueriesForContext(){}async resolveQueriesAsync(){}dispose(){}},Sy=class extends xy{constructor(e,t,n=2048){if(super(n),this.gl=e,this.type=t,this.ext=e.getExtension(`EXT_disjoint_timer_query_webgl2`)||e.getExtension(`EXT_disjoint_timer_query`),!this.ext){console.warn(`EXT_disjoint_timer_query not supported; timestamps will be disabled.`),this.trackTimestamp=!1;return}this.queries=[];for(let t=0;t<this.maxQueries;t++)this.queries.push(e.createQuery());this.activeQuery=null,this.queryStates=new Map}allocateQueriesForContext(e){if(!this.trackTimestamp)return null;if(this.currentQueryIndex+2>this.maxQueries)return er(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;let t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryStates.set(t,`inactive`),this.queryOffsets.set(e,t),t}beginQuery(e){if(!this.trackTimestamp||this.isDisposed)return;let t=this.queryOffsets.get(e);if(t==null||this.activeQuery!==null)return;let n=this.queries[t];if(n)try{this.queryStates.get(t)===`inactive`&&(this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,n),this.activeQuery=t,this.queryStates.set(t,`started`))}catch(e){console.error(`Error in beginQuery:`,e),this.activeQuery=null,this.queryStates.set(t,`inactive`)}}endQuery(e){if(!this.trackTimestamp||this.isDisposed)return;let t=this.queryOffsets.get(e);if(t!=null&&this.activeQuery===t)try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.queryStates.set(t,`ended`),this.activeQuery=null}catch(e){console.error(`Error in endQuery:`,e),this.queryStates.set(t,`inactive`),this.activeQuery=null}}async resolveQueriesAsync(){if(!this.trackTimestamp||this.pendingResolve)return this.lastValue;this.pendingResolve=!0;try{let e=[];for(let[t,n]of this.queryStates)if(n===`ended`){let n=this.queries[t];e.push(this.resolveQuery(n))}if(e.length===0)return this.lastValue;let t=(await Promise.all(e)).reduce((e,t)=>e+t,0);return this.lastValue=t,this.currentQueryIndex=0,this.queryOffsets.clear(),this.queryStates.clear(),this.activeQuery=null,t}catch(e){return console.error(`Error resolving queries:`,e),this.lastValue}finally{this.pendingResolve=!1}}async resolveQuery(e){return new Promise(t=>{if(this.isDisposed){t(this.lastValue);return}let n,r=!1,i=()=>{n&&=(clearTimeout(n),null)},a=e=>{r||(r=!0,i(),t(e))},o=()=>{if(this.isDisposed){a(this.lastValue);return}try{if(this.gl.getParameter(this.ext.GPU_DISJOINT_EXT)){a(this.lastValue);return}if(!this.gl.getQueryParameter(e,this.gl.QUERY_RESULT_AVAILABLE)){n=setTimeout(o,1);return}let r=this.gl.getQueryParameter(e,this.gl.QUERY_RESULT);t(Number(r)/1e6)}catch(e){console.error(`Error checking query:`,e),t(this.lastValue)}};o()})}dispose(){if(!this.isDisposed&&(this.isDisposed=!0,this.trackTimestamp)){for(let e of this.queries)this.gl.deleteQuery(e);this.queries=[],this.queryStates.clear(),this.queryOffsets.clear(),this.lastValue=0,this.activeQuery=null}}},Cy=class extends ty{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this._currentContext=null,this._knownBindings=new WeakSet,this._supportsInvalidateFramebuffer=typeof navigator>`u`?!1:/OculusBrowser/g.test(navigator.userAgent),this._xrFramebuffer=null}init(e){super.init(e);let t=this.parameters,n={antialias:e.samples>0,alpha:!0,depth:e.depth,stencil:e.stencil},r=t.context===void 0?e.domElement.getContext(`webgl2`,n):t.context;function i(t){t.preventDefault();let n={api:`WebGL`,message:t.statusMessage||`Unknown reason`,reason:null,originalEvent:t};e.onDeviceLost(n)}this._onContextLost=i,e.domElement.addEventListener(`webglcontextlost`,i,!1),this.gl=r,this.extensions=new _y(this),this.capabilities=new vy(this),this.attributeUtils=new iy(this),this.textureUtils=new hy(this),this.bufferRenderer=new by(this),this.state=new sy(this),this.utils=new cy(this),this.extensions.get(`EXT_color_buffer_float`),this.extensions.get(`WEBGL_clip_cull_distance`),this.extensions.get(`OES_texture_float_linear`),this.extensions.get(`EXT_color_buffer_half_float`),this.extensions.get(`WEBGL_multisampled_render_to_texture`),this.extensions.get(`WEBGL_render_shared_exponent`),this.extensions.get(`WEBGL_multi_draw`),this.extensions.get(`OVR_multiview2`),this.disjoint=this.extensions.get(`EXT_disjoint_timer_query_webgl2`),this.parallel=this.extensions.get(`KHR_parallel_shader_compile`)}get coordinateSystem(){return Xt}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async waitForGPU(){await this.utils._clientWaitAsync()}async makeXRCompatible(){this.gl.getContextAttributes().xrCompatible!==!0&&await this.gl.makeXRCompatible()}setXRTarget(e){this._xrFramebuffer=e}setXRRenderTargetTextures(e,t,n=null){let r=this.gl;if(this.set(e.texture,{textureGPU:t,glInternalFormat:r.RGBA8}),n!==null){let t=e.stencilBuffer?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24;this.set(e.depthTexture,{textureGPU:n,glInternalFormat:t}),this.extensions.has(`WEBGL_multisampled_render_to_texture`)===!0&&e._autoAllocateDepthBuffer===!0&&e.multiview===!1&&console.warn(`THREE.WebGLBackend: Render-to-texture extension was disabled because an external texture was provided`),e._autoAllocateDepthBuffer=!1}}initTimestampQuery(e,t){if(!this.disjoint||!this.trackTimestamp)return;this.timestampQueryPool[e]||(this.timestampQueryPool[e]=new Sy(this.gl,e,2048));let n=this.timestampQueryPool[e];n.allocateQueriesForContext(t)!==null&&n.beginQuery(t)}prepareTimestampBuffer(e,t){!this.disjoint||!this.trackTimestamp||this.timestampQueryPool[e].endQuery(t)}getContext(){return this.gl}beginRender(e){let{state:t}=this,n=this.get(e);if(n.frameCalls=this.renderer.info.render.frameCalls,e.viewport)this.updateViewport(e);else{let{width:e,height:n}=this.getDrawingBufferSize();t.viewport(0,0,e,n)}if(e.scissor){let{x:n,y:r,width:i,height:a}=e.scissorValue;t.scissor(n,e.height-a-r,i,a)}this.initTimestampQuery(S.RENDER,this.getTimestampUID(e)),n.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1);let r=e.occlusionQueryCount;r>0&&(n.currentOcclusionQueries=n.occlusionQueries,n.currentOcclusionQueryObjects=n.occlusionQueryObjects,n.lastOcclusionObject=null,n.occlusionQueries=Array(r),n.occlusionQueryObjects=Array(r),n.occlusionQueryIndex=0)}finishRender(e){let{gl:t,state:n}=this,r=this.get(e),i=r.previousContext;n.resetVertexState();let a=e.occlusionQueryCount;a>0&&(a>r.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));let o=e.textures;if(o!==null)for(let e=0;e<o.length;e++){let t=o[e];t.generateMipmaps&&this.generateMipmaps(t)}if(this._currentContext=i,this._resolveRenderTarget(e),i!==null)if(this._setFramebuffer(i),i.viewport)this.updateViewport(i);else{let{width:e,height:t}=this.getDrawingBufferSize();n.viewport(0,0,e,t)}this.prepareTimestampBuffer(S.RENDER,this.getTimestampUID(e))}resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueries:n,currentOcclusionQueryObjects:r}=t;if(n&&r){let e=new WeakSet,{gl:i}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;let a=()=>{let o=0;for(let t=0;t<n.length;t++){let a=n[t];a!==null&&i.getQueryParameter(a,i.QUERY_RESULT_AVAILABLE)&&(i.getQueryParameter(a,i.QUERY_RESULT)===0&&e.add(r[t]),n[t]=null,i.deleteQuery(a),o++)}o<n.length?requestAnimationFrame(a):t.occluded=e};a()}}isOccluded(e,t){let n=this.get(e);return n.occluded&&n.occluded.has(t)}updateViewport(e){let{state:t}=this,{x:n,y:r,width:i,height:a}=e.viewportValue;t.viewport(n,e.height-a-r,i,a)}setScissorTest(e){this.state.setScissorTest(e)}getClearColor(){let e=super.getClearColor();return e.r*=e.a,e.g*=e.a,e.b*=e.a,e}clear(e,t,n,r=null,i=!0,a=!0){let{gl:o,renderer:s}=this;r===null&&(r={textures:null,clearColorValue:this.getClearColor()});let c=0;if(e&&(c|=o.COLOR_BUFFER_BIT),t&&(c|=o.DEPTH_BUFFER_BIT),n&&(c|=o.STENCIL_BUFFER_BIT),c!==0){let l;l=r.clearColorValue?r.clearColorValue:this.getClearColor();let u=s.getClearDepth(),d=s.getClearStencil();if(t&&this.state.setDepthMask(!0),r.textures===null)o.clearColor(l.r,l.g,l.b,l.a),o.clear(c);else{if(i&&this._setFramebuffer(r),e)for(let e=0;e<r.textures.length;e++)e===0?o.clearBufferfv(o.COLOR,e,[l.r,l.g,l.b,l.a]):o.clearBufferfv(o.COLOR,e,[0,0,0,1]);t&&n?o.clearBufferfi(o.DEPTH_STENCIL,0,u,d):t?o.clearBufferfv(o.DEPTH,0,[u]):n&&o.clearBufferiv(o.STENCIL,0,[d]),i&&a&&this._resolveRenderTarget(r)}}}beginCompute(e){let{state:t,gl:n}=this,r=this.get(e);r.frameCalls=this.renderer.info.compute.frameCalls,t.bindFramebuffer(n.FRAMEBUFFER,null),this.initTimestampQuery(S.COMPUTE,this.getTimestampUID(e))}compute(e,t,n,r,i=null){let{state:a,gl:o}=this;this.discard===!1&&(o.enable(o.RASTERIZER_DISCARD),this.discard=!0);let{programGPU:s,transformBuffers:c,attributes:l}=this.get(r),u=this._getVaoKey(l),d=this.vaoCache[u];d===void 0?this.vaoCache[u]=this._createVao(l):a.setVertexState(d),a.useProgram(s),this._bindUniforms(n);let f=this._getTransformFeedback(c);o.bindTransformFeedback(o.TRANSFORM_FEEDBACK,f),o.beginTransformFeedback(o.POINTS),i=i===null?t.count:i,Array.isArray(i)&&(er(`WebGLBackend.compute(): The count parameter must be a single number, not an array.`),i=i[0]),l[0].isStorageInstancedBufferAttribute?o.drawArraysInstanced(o.POINTS,0,1,i):o.drawArrays(o.POINTS,0,i),o.endTransformFeedback(),o.bindTransformFeedback(o.TRANSFORM_FEEDBACK,null);for(let e=0;e<c.length;e++){let t=c[e];t.pbo&&this.has(t.pbo)&&this.textureUtils.copyBufferToTexture(t.transformBuffer,t.pbo),t.switchBuffers()}}finishCompute(e){let t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(S.COMPUTE,this.getTimestampUID(e)),this._currentContext&&this._setFramebuffer(this._currentContext)}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.isArrayTexture&&e.camera.isArrayCamera}draw(e){let{object:t,pipeline:n,material:r,context:i,hardwareClippingPlanes:a}=e,{programGPU:o}=this.get(n),{gl:s,state:c}=this,l=this.get(i),u=e.getDrawParameters();if(u===null)return;this._bindUniforms(e.getBindings());let d=t.isMesh&&t.matrixWorld.determinant()<0;c.setMaterial(r,d,a),c.useProgram(o);let f=e.getAttributes(),p=this.get(f),m=p.vaoGPU;if(m===void 0){let e=this._getVaoKey(f);m=this.vaoCache[e],m===void 0&&(m=this._createVao(f),this.vaoCache[e]=m,p.vaoGPU=m)}let h=e.getIndex(),g=h===null?null:this.get(h).bufferGPU;c.setVertexState(m,g);let _=l.lastOcclusionObject;if(_!==t&&_!==void 0){if(_!==null&&_.occlusionTest===!0&&(s.endQuery(s.ANY_SAMPLES_PASSED),l.occlusionQueryIndex++),t.occlusionTest===!0){let e=s.createQuery();s.beginQuery(s.ANY_SAMPLES_PASSED,e),l.occlusionQueries[l.occlusionQueryIndex]=e,l.occlusionQueryObjects[l.occlusionQueryIndex]=t}l.lastOcclusionObject=t}let v=this.bufferRenderer;t.isPoints?v.mode=s.POINTS:t.isLineSegments?v.mode=s.LINES:t.isLine?v.mode=s.LINE_STRIP:t.isLineLoop?v.mode=s.LINE_LOOP:r.wireframe===!0?(c.setLineWidth(r.wireframeLinewidth*this.renderer.getPixelRatio()),v.mode=s.LINES):v.mode=s.TRIANGLES;let{vertexCount:y,instanceCount:b}=u,{firstVertex:ee}=u;if(v.object=t,h!==null){ee*=h.array.BYTES_PER_ELEMENT;let e=this.get(h);v.index=h.count,v.type=e.type}else v.index=0;let x=()=>{t.isBatchedMesh?t._multiDrawInstances===null?this.hasFeature(`WEBGL_multi_draw`)?v.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):er(`THREE.WebGLRenderer: WEBGL_multi_draw not supported.`):(er(`THREE.WebGLBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.`),v.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances)):b>1?v.renderInstances(ee,y,b):v.render(ee,y)};if(e.camera.isArrayCamera===!0&&e.camera.cameras.length>0&&e.camera.isMultiViewCamera===!1){let n=this.get(e.camera),r=e.camera.cameras,i=e.getBindingGroup(`cameraIndex`).bindings[0];if(n.indexesGPU===void 0||n.indexesGPU.length!==r.length){let e=new Uint32Array([0,0,0,0]),t=[];for(let n=0,i=r.length;n<i;n++){let r=s.createBuffer();e[0]=n,s.bindBuffer(s.UNIFORM_BUFFER,r),s.bufferData(s.UNIFORM_BUFFER,e,s.STATIC_DRAW),t.push(r)}n.indexesGPU=t}let a=this.get(i),o=this.renderer.getPixelRatio(),l=this._currentContext.renderTarget,u=this._isRenderCameraDepthArray(this._currentContext),d=this._currentContext.activeCubeFace;if(u){let e=this.get(l.depthTexture);if(e.clearedRenderId!==this.renderer._nodes.nodeFrame.renderId){e.clearedRenderId=this.renderer._nodes.nodeFrame.renderId;let{stencilBuffer:t}=l;for(let e=0,n=r.length;e<n;e++)this.renderer._activeCubeFace=e,this._currentContext.activeCubeFace=e,this._setFramebuffer(this._currentContext),this.clear(!1,!0,t,this._currentContext,!1,!1);this.renderer._activeCubeFace=d,this._currentContext.activeCubeFace=d}}for(let i=0,l=r.length;i<l;i++){let l=r[i];if(t.layers.test(l.layers)){u&&(this.renderer._activeCubeFace=i,this._currentContext.activeCubeFace=i,this._setFramebuffer(this._currentContext));let t=l.viewport;if(t!==void 0){let n=t.x*o,r=t.y*o,i=t.width*o,a=t.height*o;c.viewport(Math.floor(n),Math.floor(e.context.height-a-r),Math.floor(i),Math.floor(a))}c.bindBufferBase(s.UNIFORM_BUFFER,a.index,n.indexesGPU[i]),x()}this._currentContext.activeCubeFace=d,this.renderer._activeCubeFace=d}}else x()}needsRenderUpdate(){return!1}getRenderCacheKey(){return``}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,n,r,i,a){return this.textureUtils.copyTextureToBuffer(e,t,n,r,i,a)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new Qv(e,t)}createProgram(e){let t=this.gl,{stage:n,code:r}=e,i=n===`fragment`?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(i,r),t.compileShader(i),this.set(e,{shaderGPU:i})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){let n=this.gl,r=e.pipeline,{fragmentProgram:i,vertexProgram:a}=r,o=n.createProgram(),s=this.get(i).shaderGPU,c=this.get(a).shaderGPU;if(n.attachShader(o,s),n.attachShader(o,c),n.linkProgram(o),this.set(r,{programGPU:o,fragmentShader:s,vertexShader:c}),t!==null&&this.parallel){let i=new Promise(t=>{let i=this.parallel,a=()=>{n.getProgramParameter(o,i.COMPLETION_STATUS_KHR)?(this._completeCompile(e,r),t()):requestAnimationFrame(a)};a()});t.push(i);return}this._completeCompile(e,r)}_handleSource(e,t){let n=e.split(`
`),r=[],i=Math.max(t-6,0),a=Math.min(t+6,n.length);for(let e=i;e<a;e++){let i=e+1;r.push(`${i===t?`>`:` `} ${i}: ${n[e]}`)}return r.join(`
`)}_getShaderErrors(e,t,n){let r=e.getShaderParameter(t,e.COMPILE_STATUS),i=(e.getShaderInfoLog(t)||``).trim();if(r&&i===``)return``;let a=/ERROR: 0:(\d+)/.exec(i);if(a){let r=parseInt(a[1]);return n.toUpperCase()+`

`+i+`

`+this._handleSource(e.getShaderSource(t),r)}else return i}_logProgramError(e,t,n){if(this.renderer.debug.checkShaderErrors){let r=this.gl,i=(r.getProgramInfoLog(e)||``).trim();if(r.getProgramParameter(e,r.LINK_STATUS)===!1)if(typeof this.renderer.debug.onShaderError==`function`)this.renderer.debug.onShaderError(r,e,n,t);else{let a=this._getShaderErrors(r,n,`vertex`),o=this._getShaderErrors(r,t,`fragment`);console.error(`THREE.WebGLProgram: Shader Error `+r.getError()+` - VALIDATE_STATUS `+r.getProgramParameter(e,r.VALIDATE_STATUS)+`

Program Info Log: `+i+`
`+a+`
`+o)}else i!==``&&console.warn(`THREE.WebGLProgram: Program Info Log:`,i)}}_completeCompile(e,t){let{state:n,gl:r}=this,{programGPU:i,fragmentShader:a,vertexShader:o}=this.get(t);r.getProgramParameter(i,r.LINK_STATUS)===!1&&this._logProgramError(i,a,o),n.useProgram(i);let s=e.getBindings();this._setupBindings(s,i),this.set(t,{programGPU:i})}createComputePipeline(e,t){let{state:n,gl:r}=this,i={stage:`fragment`,code:`#version 300 es
precision highp float;
void main() {}`};this.createProgram(i);let{computeProgram:a}=e,o=r.createProgram(),s=this.get(i).shaderGPU,c=this.get(a).shaderGPU,l=a.transforms,u=[],d=[];for(let e=0;e<l.length;e++){let t=l[e];u.push(t.varyingName),d.push(t.attributeNode)}r.attachShader(o,s),r.attachShader(o,c),r.transformFeedbackVaryings(o,u,r.SEPARATE_ATTRIBS),r.linkProgram(o),r.getProgramParameter(o,r.LINK_STATUS)===!1&&this._logProgramError(o,s,c),n.useProgram(o),this._setupBindings(t,o);let f=a.attributes,p=[],m=[];for(let e=0;e<f.length;e++){let t=f[e].node.attribute;p.push(t),this.has(t)||this.attributeUtils.createAttribute(t,r.ARRAY_BUFFER)}for(let e=0;e<d.length;e++){let t=d[e].attribute;this.has(t)||this.attributeUtils.createAttribute(t,r.ARRAY_BUFFER);let n=this.get(t);m.push(n)}this.set(e,{programGPU:o,transformBuffers:m,attributes:p})}createBindings(e,t){if(this._knownBindings.has(t)===!1){this._knownBindings.add(t);let e=0,n=0;for(let r of t){this.set(r,{textures:n,uniformBuffers:e});for(let t of r.bindings)t.isUniformBuffer&&e++,t.isSampledTexture&&n++}}this.updateBindings(e,t)}updateBindings(e){let{gl:t}=this,n=this.get(e),r=n.uniformBuffers,i=n.textures;for(let n of e.bindings){let e=this.get(n);if(n.isUniformsGroup||n.isUniformBuffer){let i=n.buffer,{bufferGPU:a}=this.get(i);a===void 0?(a=t.createBuffer(),t.bindBuffer(t.UNIFORM_BUFFER,a),t.bufferData(t.UNIFORM_BUFFER,i,t.DYNAMIC_DRAW),this.set(i,{bufferGPU:a})):(t.bindBuffer(t.UNIFORM_BUFFER,a),t.bufferSubData(t.UNIFORM_BUFFER,0,i)),e.index=r++,e.bufferGPU=a,this.set(n,e)}else if(n.isSampledTexture){let{textureGPU:t,glTextureType:r}=this.get(n.texture);e.index=i++,e.textureGPU=t,e.glTextureType=r,this.set(n,e)}}}updateBinding(e){let t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){let n=this.get(e).bufferGPU,r=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,n),t.bufferData(t.UNIFORM_BUFFER,r,t.DYNAMIC_DRAW)}}createIndexAttribute(e){let t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;let t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;let t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){let t=Object.keys(yy).filter(t=>yy[t]===e),n=this.extensions;for(let e=0;e<t.length;e++)if(n.has(t[e]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,n=null,r=null,i=0,a=0){this.textureUtils.copyTextureToTexture(e,t,n,r,i,a)}copyFramebufferToTexture(e,t,n){this.textureUtils.copyFramebufferToTexture(e,t,n)}_setFramebuffer(e){let{gl:t,state:n}=this,r=null;if(e.textures!==null){let i=e.renderTarget,a=this.get(i),{samples:o,depthBuffer:s,stencilBuffer:c}=i,l=i.isWebGLCubeRenderTarget===!0,u=i.isRenderTarget3D===!0,d=i.depth>1,f=i.isXRRenderTarget===!0,p=f===!0&&i._hasExternalTextures===!0,m=a.msaaFrameBuffer,h=a.depthRenderbuffer,g=this.extensions.get(`WEBGL_multisampled_render_to_texture`),_=this.extensions.get(`OVR_multiview2`),v=this._useMultisampledExtension(i),y=ri(e),b;if(l?(a.cubeFramebuffers||={},b=a.cubeFramebuffers[y]):f&&p===!1?b=this._xrFramebuffer:(a.framebuffers||={},b=a.framebuffers[y]),b===void 0){b=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,b);let r=e.textures,s=[];if(l){a.cubeFramebuffers[y]=b;let{textureGPU:e}=this.get(r[0]),n=this.renderer._activeCubeFace,i=this.renderer._activeMipmapLevel;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+n,e,i)}else{a.framebuffers[y]=b;for(let n=0;n<r.length;n++){let a=r[n],s=this.get(a);s.renderTarget=e.renderTarget,s.cacheKey=y;let c=t.COLOR_ATTACHMENT0+n;if(i.multiview)_.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,c,s.textureGPU,0,o,0,2);else if(u||d){let e=this.renderer._activeCubeFace,n=this.renderer._activeMipmapLevel;t.framebufferTextureLayer(t.FRAMEBUFFER,c,s.textureGPU,n,e)}else if(v)g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,c,t.TEXTURE_2D,s.textureGPU,0,o);else{let e=this.renderer._activeMipmapLevel;t.framebufferTexture2D(t.FRAMEBUFFER,c,t.TEXTURE_2D,s.textureGPU,e)}}}let f=c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(i._autoAllocateDepthBuffer===!0){let n=t.createRenderbuffer();this.textureUtils.setupRenderBufferStorage(n,e,0,v),a.xrDepthRenderbuffer=n,s.push(c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT),t.bindRenderbuffer(t.RENDERBUFFER,n),t.framebufferRenderbuffer(t.FRAMEBUFFER,f,t.RENDERBUFFER,n)}else if(e.depthTexture!==null){s.push(c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT);let n=this.get(e.depthTexture);if(n.renderTarget=e.renderTarget,n.cacheKey=y,i.multiview)_.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,f,n.textureGPU,0,o,0,2);else if(p&&v)g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,f,t.TEXTURE_2D,n.textureGPU,0,o);else if(e.depthTexture.isArrayTexture){let e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,f,n.textureGPU,0,e)}else t.framebufferTexture2D(t.FRAMEBUFFER,f,t.TEXTURE_2D,n.textureGPU,0)}a.depthInvalidationArray=s}else{if(this._isRenderCameraDepthArray(e)){n.bindFramebuffer(t.FRAMEBUFFER,b);let r=this.renderer._activeCubeFace,i=this.get(e.depthTexture),a=c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTextureLayer(t.FRAMEBUFFER,a,i.textureGPU,0,r)}if((f||v||i.multiview)&&i._isOpaqueFramebuffer!==!0){n.bindFramebuffer(t.FRAMEBUFFER,b);let r=this.get(e.textures[0]);i.multiview?_.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,r.textureGPU,0,o,0,2):v?g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r.textureGPU,0);let s=c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(i._autoAllocateDepthBuffer===!0){let e=a.xrDepthRenderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,s,t.RENDERBUFFER,e)}else{let n=this.get(e.depthTexture);i.multiview?_.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,s,n.textureGPU,0,o,0,2):v?g.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,s,t.TEXTURE_2D,n.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,s,t.TEXTURE_2D,n.textureGPU,0)}}}if(o>0&&v===!1&&!i.multiview){if(m===void 0){let r=[];m=t.createFramebuffer(),n.bindFramebuffer(t.FRAMEBUFFER,m);let i=[],l=e.textures;for(let n=0;n<l.length;n++){i[n]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,i[n]),r.push(t.COLOR_ATTACHMENT0+n);let a=e.textures[n],s=this.get(a);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,s.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+n,t.RENDERBUFFER,i[n])}if(t.bindRenderbuffer(t.RENDERBUFFER,null),a.msaaFrameBuffer=m,a.msaaRenderbuffers=i,s&&h===void 0){h=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(h,e,o),a.depthRenderbuffer=h;let n=c?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;r.push(n)}a.invalidationArray=r}r=a.msaaFrameBuffer}else r=b;n.drawBuffers(e,b)}n.bindFramebuffer(t.FRAMEBUFFER,r)}_getVaoKey(e){let t=``;for(let n=0;n<e.length;n++){let r=this.get(e[n]);t+=`:`+r.id}return t}_createVao(e){let{gl:t}=this,n=t.createVertexArray();t.bindVertexArray(n);for(let n=0;n<e.length;n++){let r=e[n],i=this.get(r);t.bindBuffer(t.ARRAY_BUFFER,i.bufferGPU),t.enableVertexAttribArray(n);let a,o;r.isInterleavedBufferAttribute===!0?(a=r.data.stride*i.bytesPerElement,o=r.offset*i.bytesPerElement):(a=0,o=0),i.isInteger?t.vertexAttribIPointer(n,r.itemSize,i.type,a,o):t.vertexAttribPointer(n,r.itemSize,i.type,r.normalized,a,o),r.isInstancedBufferAttribute&&!r.isInterleavedBufferAttribute?t.vertexAttribDivisor(n,r.meshPerAttribute):r.isInterleavedBufferAttribute&&r.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(n,r.data.meshPerAttribute)}return t.bindBuffer(t.ARRAY_BUFFER,null),n}_getTransformFeedback(e){let t=``;for(let n=0;n<e.length;n++)t+=`:`+e[n].id;let n=this.transformFeedbackCache[t];if(n!==void 0)return n;let{gl:r}=this;n=r.createTransformFeedback(),r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,n);for(let t=0;t<e.length;t++){let n=e[t];r.bindBufferBase(r.TRANSFORM_FEEDBACK_BUFFER,t,n.transformBuffer)}return r.bindTransformFeedback(r.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=n,n}_setupBindings(e,t){let n=this.gl;for(let r of e)for(let e of r.bindings){let r=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){let i=n.getUniformBlockIndex(t,e.name);n.uniformBlockBinding(t,i,r)}else if(e.isSampledTexture){let i=n.getUniformLocation(t,e.name);n.uniform1i(i,r)}}}_bindUniforms(e){let{gl:t,state:n}=this;for(let r of e)for(let e of r.bindings){let r=this.get(e),i=r.index;e.isUniformsGroup||e.isUniformBuffer?n.bindBufferBase(t.UNIFORM_BUFFER,i,r.bufferGPU):e.isSampledTexture&&n.bindTexture(r.glTextureType,r.textureGPU,t.TEXTURE0+i)}}_resolveRenderTarget(e){let{gl:t,state:n}=this,r=e.renderTarget;if(e.textures!==null&&r){let i=this.get(r);if(r.samples>0&&this._useMultisampledExtension(r)===!1){let a=i.framebuffers[e.getCacheKey()],o=t.COLOR_BUFFER_BIT;r.resolveDepthBuffer&&(r.depthBuffer&&(o|=t.DEPTH_BUFFER_BIT),r.stencilBuffer&&r.resolveStencilBuffer&&(o|=t.STENCIL_BUFFER_BIT));let s=i.msaaFrameBuffer,c=i.msaaRenderbuffers,l=e.textures,u=l.length>1;if(n.bindFramebuffer(t.READ_FRAMEBUFFER,s),n.bindFramebuffer(t.DRAW_FRAMEBUFFER,a),u)for(let e=0;e<l.length;e++)t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,null),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0);for(let n=0;n<l.length;n++){if(u){let{textureGPU:e}=this.get(l[n]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,c[n]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)}if(e.scissor){let{x:n,y:r,width:i,height:a}=e.scissorValue,s=e.height-a-r;t.blitFramebuffer(n,s,n+i,s+a,n,s,n+i,s+a,o,t.NEAREST)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,o,t.NEAREST)}if(u)for(let e=0;e<l.length;e++){let{textureGPU:n}=this.get(l[e]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,c[e]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,n,0)}this._supportsInvalidateFramebuffer===!0&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,i.invalidationArray)}else if(r.resolveDepthBuffer===!1&&i.framebuffers){let r=i.framebuffers[e.getCacheKey()];n.bindFramebuffer(t.DRAW_FRAMEBUFFER,r),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,i.depthInvalidationArray)}}}_useMultisampledExtension(e){return e.multiview===!0?!0:e.samples>0&&this.extensions.has(`WEBGL_multisampled_render_to_texture`)===!0&&e._autoAllocateDepthBuffer!==!1}dispose(){let e=this.extensions.get(`WEBGL_lose_context`);e&&e.loseContext(),this.renderer.domElement.removeEventListener(`webglcontextlost`,this._onContextLost)}},wy={PointList:`point-list`,LineList:`line-list`,LineStrip:`line-strip`,TriangleList:`triangle-list`,TriangleStrip:`triangle-strip`},Ty={Never:`never`,Less:`less`,Equal:`equal`,LessEqual:`less-equal`,Greater:`greater`,NotEqual:`not-equal`,GreaterEqual:`greater-equal`,Always:`always`},Ey={Store:`store`},Z={Load:`load`,Clear:`clear`},Dy={CCW:`ccw`,CW:`cw`},Oy={None:`none`,Back:`back`},ky={Uint16:`uint16`,Uint32:`uint32`},Q={R8Unorm:`r8unorm`,R8Snorm:`r8snorm`,R8Uint:`r8uint`,R8Sint:`r8sint`,R16Uint:`r16uint`,R16Sint:`r16sint`,R16Float:`r16float`,RG8Unorm:`rg8unorm`,RG8Snorm:`rg8snorm`,RG8Uint:`rg8uint`,RG8Sint:`rg8sint`,R32Uint:`r32uint`,R32Sint:`r32sint`,R32Float:`r32float`,RG16Uint:`rg16uint`,RG16Sint:`rg16sint`,RG16Float:`rg16float`,RGBA8Unorm:`rgba8unorm`,RGBA8UnormSRGB:`rgba8unorm-srgb`,RGBA8Snorm:`rgba8snorm`,RGBA8Uint:`rgba8uint`,RGBA8Sint:`rgba8sint`,BGRA8Unorm:`bgra8unorm`,BGRA8UnormSRGB:`bgra8unorm-srgb`,RGB9E5UFloat:`rgb9e5ufloat`,RGB10A2Unorm:`rgb10a2unorm`,RG11B10UFloat:`rg11b10ufloat`,RG32Uint:`rg32uint`,RG32Sint:`rg32sint`,RG32Float:`rg32float`,RGBA16Uint:`rgba16uint`,RGBA16Sint:`rgba16sint`,RGBA16Float:`rgba16float`,RGBA32Uint:`rgba32uint`,RGBA32Sint:`rgba32sint`,RGBA32Float:`rgba32float`,Depth16Unorm:`depth16unorm`,Depth24Plus:`depth24plus`,Depth24PlusStencil8:`depth24plus-stencil8`,Depth32Float:`depth32float`,Depth32FloatStencil8:`depth32float-stencil8`,BC1RGBAUnorm:`bc1-rgba-unorm`,BC1RGBAUnormSRGB:`bc1-rgba-unorm-srgb`,BC2RGBAUnorm:`bc2-rgba-unorm`,BC2RGBAUnormSRGB:`bc2-rgba-unorm-srgb`,BC3RGBAUnorm:`bc3-rgba-unorm`,BC3RGBAUnormSRGB:`bc3-rgba-unorm-srgb`,BC4RUnorm:`bc4-r-unorm`,BC4RSnorm:`bc4-r-snorm`,BC5RGUnorm:`bc5-rg-unorm`,BC5RGSnorm:`bc5-rg-snorm`,BC6HRGBUFloat:`bc6h-rgb-ufloat`,BC6HRGBFloat:`bc6h-rgb-float`,BC7RGBAUnorm:`bc7-rgba-unorm`,BC7RGBAUnormSRGB:`bc7-rgba-unorm-srgb`,ETC2RGB8Unorm:`etc2-rgb8unorm`,ETC2RGB8UnormSRGB:`etc2-rgb8unorm-srgb`,ETC2RGB8A1Unorm:`etc2-rgb8a1unorm`,ETC2RGB8A1UnormSRGB:`etc2-rgb8a1unorm-srgb`,ETC2RGBA8Unorm:`etc2-rgba8unorm`,ETC2RGBA8UnormSRGB:`etc2-rgba8unorm-srgb`,EACR11Unorm:`eac-r11unorm`,EACR11Snorm:`eac-r11snorm`,EACRG11Unorm:`eac-rg11unorm`,EACRG11Snorm:`eac-rg11snorm`,ASTC4x4Unorm:`astc-4x4-unorm`,ASTC4x4UnormSRGB:`astc-4x4-unorm-srgb`,ASTC5x4Unorm:`astc-5x4-unorm`,ASTC5x4UnormSRGB:`astc-5x4-unorm-srgb`,ASTC5x5Unorm:`astc-5x5-unorm`,ASTC5x5UnormSRGB:`astc-5x5-unorm-srgb`,ASTC6x5Unorm:`astc-6x5-unorm`,ASTC6x5UnormSRGB:`astc-6x5-unorm-srgb`,ASTC6x6Unorm:`astc-6x6-unorm`,ASTC6x6UnormSRGB:`astc-6x6-unorm-srgb`,ASTC8x5Unorm:`astc-8x5-unorm`,ASTC8x5UnormSRGB:`astc-8x5-unorm-srgb`,ASTC8x6Unorm:`astc-8x6-unorm`,ASTC8x6UnormSRGB:`astc-8x6-unorm-srgb`,ASTC8x8Unorm:`astc-8x8-unorm`,ASTC8x8UnormSRGB:`astc-8x8-unorm-srgb`,ASTC10x5Unorm:`astc-10x5-unorm`,ASTC10x5UnormSRGB:`astc-10x5-unorm-srgb`,ASTC10x6Unorm:`astc-10x6-unorm`,ASTC10x6UnormSRGB:`astc-10x6-unorm-srgb`,ASTC10x8Unorm:`astc-10x8-unorm`,ASTC10x8UnormSRGB:`astc-10x8-unorm-srgb`,ASTC10x10Unorm:`astc-10x10-unorm`,ASTC10x10UnormSRGB:`astc-10x10-unorm-srgb`,ASTC12x10Unorm:`astc-12x10-unorm`,ASTC12x10UnormSRGB:`astc-12x10-unorm-srgb`,ASTC12x12Unorm:`astc-12x12-unorm`,ASTC12x12UnormSRGB:`astc-12x12-unorm-srgb`},Ay={ClampToEdge:`clamp-to-edge`,Repeat:`repeat`,MirrorRepeat:`mirror-repeat`},jy={Linear:`linear`,Nearest:`nearest`},$={Zero:`zero`,One:`one`,Src:`src`,OneMinusSrc:`one-minus-src`,SrcAlpha:`src-alpha`,OneMinusSrcAlpha:`one-minus-src-alpha`,Dst:`dst`,OneMinusDst:`one-minus-dst`,DstAlpha:`dst-alpha`,OneMinusDstAlpha:`one-minus-dst-alpha`,SrcAlphaSaturated:`src-alpha-saturated`,Constant:`constant`,OneMinusConstant:`one-minus-constant`},My={Add:`add`,Subtract:`subtract`,ReverseSubtract:`reverse-subtract`,Min:`min`,Max:`max`},Ny={None:0,All:15},Py={Keep:`keep`,Zero:`zero`,Replace:`replace`,Invert:`invert`,IncrementClamp:`increment-clamp`,DecrementClamp:`decrement-clamp`,IncrementWrap:`increment-wrap`,DecrementWrap:`decrement-wrap`},Fy={Storage:`storage`,ReadOnlyStorage:`read-only-storage`},Iy={WriteOnly:`write-only`,ReadOnly:`read-only`,ReadWrite:`read-write`},Ly={NonFiltering:`non-filtering`,Comparison:`comparison`},Ry={Float:`float`,UnfilterableFloat:`unfilterable-float`,Depth:`depth`,SInt:`sint`,UInt:`uint`},zy={TwoD:`2d`,ThreeD:`3d`},By={TwoD:`2d`,TwoDArray:`2d-array`,Cube:`cube`,ThreeD:`3d`},Vy={All:`all`},Hy={Vertex:`vertex`,Instance:`instance`},Uy={CoreFeaturesAndLimits:`core-features-and-limits`,DepthClipControl:`depth-clip-control`,Depth32FloatStencil8:`depth32float-stencil8`,TextureCompressionBC:`texture-compression-bc`,TextureCompressionBCSliced3D:`texture-compression-bc-sliced-3d`,TextureCompressionETC2:`texture-compression-etc2`,TextureCompressionASTC:`texture-compression-astc`,TextureCompressionASTCSliced3D:`texture-compression-astc-sliced-3d`,TimestampQuery:`timestamp-query`,IndirectFirstInstance:`indirect-first-instance`,ShaderF16:`shader-f16`,RG11B10UFloat:`rg11b10ufloat-renderable`,BGRA8UNormStorage:`bgra8unorm-storage`,Float32Filterable:`float32-filterable`,Float32Blendable:`float32-blendable`,ClipDistances:`clip-distances`,DualSourceBlending:`dual-source-blending`,Subgroups:`subgroups`,TextureFormatsTier1:`texture-formats-tier1`,TextureFormatsTier2:`texture-formats-tier2`},Wy=class extends zv{constructor(e,t,n){super(e,t?t.value:null),this.textureNode=t,this.groupNode=n}update(){this.texture=this.textureNode.value}},Gy=class extends Av{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}},Ky=0,qy=class extends Gy{constructor(e,t){super(`StorageBuffer_`+ Ky++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:Si.READ_WRITE,this.groupNode=t}get buffer(){return this.nodeUniform.value}},Jy=class extends Mr{constructor(e){super(),this.device=e,this.mipmapSampler=e.createSampler({minFilter:jy.Linear}),this.flipYSampler=e.createSampler({minFilter:jy.Nearest}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:`mipmapVertex`,code:`
struct VarysStruct {
	@builtin( position ) Position: vec4<f32>,
	@location( 0 ) vTex : vec2<f32>
};

@vertex
fn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {

	var Varys : VarysStruct;

	var pos = array< vec2<f32>, 4 >(
		vec2<f32>( -1.0,  1.0 ),
		vec2<f32>(  1.0,  1.0 ),
		vec2<f32>( -1.0, -1.0 ),
		vec2<f32>(  1.0, -1.0 )
	);

	var tex = array< vec2<f32>, 4 >(
		vec2<f32>( 0.0, 0.0 ),
		vec2<f32>( 1.0, 0.0 ),
		vec2<f32>( 0.0, 1.0 ),
		vec2<f32>( 1.0, 1.0 )
	);

	Varys.vTex = tex[ vertexIndex ];
	Varys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );

	return Varys;

}
`}),this.mipmapFragmentShaderModule=e.createShaderModule({label:`mipmapFragment`,code:`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vTex );

}
`}),this.flipYFragmentShaderModule=e.createShaderModule({label:`flipYFragment`,code:`
@group( 0 ) @binding( 0 )
var imgSampler : sampler;

@group( 0 ) @binding( 1 )
var img : texture_2d<f32>;

@fragment
fn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {

	return textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );

}
`})}getTransferPipeline(e){let t=this.transferPipelines[e];return t===void 0&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:`main`},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:`main`,targets:[{format:e}]},primitive:{topology:wy.TriangleStrip,stripIndexFormat:ky.Uint32},layout:`auto`}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return t===void 0&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:`main`},fragment:{module:this.flipYFragmentShaderModule,entryPoint:`main`,targets:[{format:e}]},primitive:{topology:wy.TriangleStrip,stripIndexFormat:ky.Uint32},layout:`auto`}),this.flipYPipelines[e]=t),t}flipY(e,t,n=0){let r=t.format,{width:i,height:a}=t.size,o=this.getTransferPipeline(r),s=this.getFlipYPipeline(r),c=this.device.createTexture({size:{width:i,height:a,depthOrArrayLayers:1},format:r,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),l=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:By.TwoD,baseArrayLayer:n}),u=c.createView({baseMipLevel:0,mipLevelCount:1,dimension:By.TwoD,baseArrayLayer:0}),d=this.device.createCommandEncoder({}),f=(e,t,n)=>{let r=e.getBindGroupLayout(0),i=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),a=d.beginRenderPass({colorAttachments:[{view:n,loadOp:Z.Clear,storeOp:Ey.Store,clearValue:[0,0,0,0]}]});a.setPipeline(e),a.setBindGroup(0,i),a.draw(4,1,0,0),a.end()};f(o,l,u),f(s,u,l),this.device.queue.submit([d.finish()]),c.destroy()}generateMipmaps(e,t,n=0){let r=this.get(e);r.useCount===void 0&&(r.useCount=0,r.layers=[]);let i=r.layers[n]||this._mipmapCreateBundles(e,t,n),a=this.device.createCommandEncoder({});this._mipmapRunBundles(a,i),this.device.queue.submit([a.finish()]),r.useCount!==0&&(r.layers[n]=i),r.useCount++}_mipmapCreateBundles(e,t,n){let r=this.getTransferPipeline(t.format),i=r.getBindGroupLayout(0),a=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:By.TwoD,baseArrayLayer:n}),o=[];for(let s=1;s<t.mipLevelCount;s++){let c=this.device.createBindGroup({layout:i,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:a}]}),l=e.createView({baseMipLevel:s,mipLevelCount:1,dimension:By.TwoD,baseArrayLayer:n}),u={colorAttachments:[{view:l,loadOp:Z.Clear,storeOp:Ey.Store,clearValue:[0,0,0,0]}]},d=this.device.createRenderBundleEncoder({colorFormats:[t.format]});d.setPipeline(r),d.setBindGroup(0,c),d.draw(4,1,0,0),o.push({renderBundles:[d.finish()],passDescriptor:u}),a=l}return o}_mipmapRunBundles(e,t){let n=t.length;for(let r=0;r<n;r++){let n=t[r],i=e.beginRenderPass(n.passDescriptor);i.executeBundles(n.renderBundles),i.end()}}},Yy={512:`never`,513:`less`,514:`equal`,515:`less-equal`,516:`greater`,518:`greater-equal`,519:`always`,517:`not-equal`},Xy=[0,1,3,2,4,5],Zy=class{constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new _i,this.depthTexture.name=`depthBuffer`}createSampler(e){let t=this.backend,n=t.device,r=t.get(e),i={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};i.magFilter===jy.Linear&&i.minFilter===jy.Linear&&i.mipmapFilter===jy.Linear&&(i.maxAnisotropy=e.anisotropy),e.isDepthTexture&&e.compareFunction!==null&&(i.compare=Yy[e.compareFunction]),r.sampler=n.createSampler(i)}createDefaultTexture(e){let t,n=Qy(e);t=e.isCubeTexture?this._getDefaultCubeTextureGPU(n):this._getDefaultTextureGPU(n),this.backend.get(e).texture=t}createTexture(e,t={}){let n=this.backend,r=n.get(e);if(r.initialized)throw Error(`WebGPUTextureUtils: Texture already initialized.`);if(e.isExternalTexture){r.texture=e.sourceTexture,r.initialized=!0;return}t.needsMipmaps===void 0&&(t.needsMipmaps=!1),t.levels===void 0&&(t.levels=1),t.depth===void 0&&(t.depth=1);let{width:i,height:a,depth:o,levels:s}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());let c=this._getDimension(e),l=e.internalFormat||t.format||Qy(e,n.device);r.format=l;let{samples:u,primarySamples:d,isMSAA:f}=n.utils.getTextureSampleData(e),p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;e.isStorageTexture===!0&&(p|=GPUTextureUsage.STORAGE_BINDING),e.isCompressedTexture!==!0&&e.isCompressedArrayTexture!==!0&&l!==Q.RGB9E5UFloat&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);let m={label:e.name,size:{width:i,height:a,depthOrArrayLayers:o},mipLevelCount:s,sampleCount:d,dimension:c,format:l,usage:p};if(l===void 0){console.warn(`WebGPURenderer: Texture format not supported.`),this.createDefaultTexture(e);return}if(e.isCubeTexture&&(m.textureBindingViewDimension=By.Cube),r.texture=n.device.createTexture(m),f){let e=Object.assign({},m);e.label+=`-msaa`,e.sampleCount=u,e.mipLevelCount=1,r.msaaTexture=n.device.createTexture(e)}r.initialized=!0,r.textureDescriptorGPU=m}destroyTexture(e){let t=this.backend,n=t.get(e);n.texture!==void 0&&n.texture.destroy(),n.msaaTexture!==void 0&&n.msaaTexture.destroy(),t.delete(e)}destroySampler(e){let t=this.backend.get(e);delete t.sampler}generateMipmaps(e){let t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else{let n=e.image.depth||1;for(let e=0;e<n;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();let e=this.backend,{width:t,height:n}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:`colorBuffer`,size:{width:t,height:n,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){let n=this.backend,{width:r,height:i}=n.getDrawingBufferSize(),a=this.depthTexture,o=n.get(a).texture,s,c;if(t?(s=1027,c=1020):e&&(s=1026,c=1014),o!==void 0){if(a.image.width===r&&a.image.height===i&&a.format===s&&a.type===c)return o;this.destroyTexture(a)}return a.name=`depthBuffer`,a.format=s,a.type=c,a.image.width=r,a.image.height=i,this.createTexture(a,{width:r,height:i}),n.get(a).texture}updateTexture(e,t){let n=this.backend.get(e),r=e.mipmaps,{textureDescriptorGPU:i}=n;if(!(e.isRenderTargetTexture||i===void 0)){if(e.isDataTexture)if(r.length>0)for(let t=0,a=r.length;t<a;t++){let a=r[t];this._copyBufferToTexture(a,n.texture,i,0,e.flipY,0,t)}else this._copyBufferToTexture(t.image,n.texture,i,0,e.flipY);else if(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)for(let r=0;r<t.image.depth;r++)this._copyBufferToTexture(t.image,n.texture,i,r,e.flipY,r);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,n.texture,i);else if(e.isCubeTexture)this._copyCubeMapToTexture(e,n.texture,i);else if(r.length>0)for(let t=0,a=r.length;t<a;t++){let a=r[t];this._copyImageToTexture(a,n.texture,i,0,e.flipY,e.premultiplyAlpha,t)}else this._copyImageToTexture(t.image,n.texture,i,0,e.flipY,e.premultiplyAlpha);n.version=e.version}}async copyTextureToBuffer(e,t,n,r,i,a){let o=this.backend.device,s=this.backend.get(e),c=s.texture,l=s.textureDescriptorGPU.format,u=this._getBytesPerTexel(l),d=r*u;d=Math.ceil(d/256)*256;let f=o.createBuffer({size:(i-1)*d+r*u,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p=o.createCommandEncoder();p.copyTextureToBuffer({texture:c,origin:{x:t,y:n,z:a}},{buffer:f,bytesPerRow:d},{width:r,height:i});let m=this._getTypedArrayType(l);return o.queue.submit([p.finish()]),await f.mapAsync(GPUMapMode.READ),new m(f.getMappedRange())}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(t===void 0){let n=new gi;n.minFilter=Re,n.magFilter=Re,this.createTexture(n,{width:1,height:1,format:e}),this.defaultTexture[e]=t=n}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(t===void 0){let n=new Lu;n.minFilter=Re,n.magFilter=Re,this.createTexture(n,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=n}return this.backend.get(t).texture}_copyCubeMapToTexture(e,t,n){let r=e.images,i=e.mipmaps;for(let a=0;a<6;a++){let o=r[a],s=e.flipY===!0?Xy[a]:a;o.isDataTexture?this._copyBufferToTexture(o.image,t,n,s,e.flipY):this._copyImageToTexture(o,t,n,s,e.flipY,e.premultiplyAlpha);for(let r=0;r<i.length;r++){let o=i[r].images[a];o.isDataTexture?this._copyBufferToTexture(o.image,t,n,s,e.flipY,0,r+1):this._copyImageToTexture(o,t,n,s,e.flipY,e.premultiplyAlpha,r+1)}}}_copyImageToTexture(e,t,n,r,i,a,o=0){let s=this.backend.device,c=o>0?e.width:n.size.width,l=o>0?e.height:n.size.height;s.queue.copyExternalImageToTexture({source:e,flipY:i},{texture:t,mipLevel:o,origin:{x:0,y:0,z:r},premultipliedAlpha:a},{width:c,height:l,depthOrArrayLayers:1})}_getPassUtils(){let e=this._passUtils;return e===null&&(this._passUtils=e=new Jy(this.backend.device)),e}_generateMipmaps(e,t,n=0){this._getPassUtils().generateMipmaps(e,t,n)}_flipY(e,t,n=0){this._getPassUtils().flipY(e,t,n)}_copyBufferToTexture(e,t,n,r,i,a=0,o=0){let s=this.backend.device,c=e.data,l=this._getBytesPerTexel(n.format),u=e.width*l;s.queue.writeTexture({texture:t,mipLevel:o,origin:{x:0,y:0,z:r}},c,{offset:e.width*e.height*l*a,bytesPerRow:u},{width:e.width,height:e.height,depthOrArrayLayers:1}),i===!0&&this._flipY(t,n,r)}_copyCompressedBufferToTexture(e,t,n){let r=this.backend.device,i=this._getBlockData(n.format),a=n.size.depthOrArrayLayers>1;for(let o=0;o<e.length;o++){let s=e[o],c=s.width,l=s.height,u=a?n.size.depthOrArrayLayers:1,d=Math.ceil(c/i.width)*i.byteLength,f=d*Math.ceil(l/i.height);for(let e=0;e<u;e++)r.queue.writeTexture({texture:t,mipLevel:o,origin:{x:0,y:0,z:e}},s.data,{offset:e*f,bytesPerRow:d,rowsPerImage:Math.ceil(l/i.height)},{width:Math.ceil(c/i.width)*i.width,height:Math.ceil(l/i.height)*i.height,depthOrArrayLayers:1})}}_getBlockData(e){if(e===Q.BC1RGBAUnorm||e===Q.BC1RGBAUnormSRGB)return{byteLength:8,width:4,height:4};if(e===Q.BC2RGBAUnorm||e===Q.BC2RGBAUnormSRGB||e===Q.BC3RGBAUnorm||e===Q.BC3RGBAUnormSRGB)return{byteLength:16,width:4,height:4};if(e===Q.BC4RUnorm||e===Q.BC4RSnorm)return{byteLength:8,width:4,height:4};if(e===Q.BC5RGUnorm||e===Q.BC5RGSnorm||e===Q.BC6HRGBUFloat||e===Q.BC6HRGBFloat||e===Q.BC7RGBAUnorm||e===Q.BC7RGBAUnormSRGB)return{byteLength:16,width:4,height:4};if(e===Q.ETC2RGB8Unorm||e===Q.ETC2RGB8UnormSRGB||e===Q.ETC2RGB8A1Unorm||e===Q.ETC2RGB8A1UnormSRGB)return{byteLength:8,width:4,height:4};if(e===Q.ETC2RGBA8Unorm||e===Q.ETC2RGBA8UnormSRGB)return{byteLength:16,width:4,height:4};if(e===Q.EACR11Unorm||e===Q.EACR11Snorm)return{byteLength:8,width:4,height:4};if(e===Q.EACRG11Unorm||e===Q.EACRG11Snorm||e===Q.ASTC4x4Unorm||e===Q.ASTC4x4UnormSRGB)return{byteLength:16,width:4,height:4};if(e===Q.ASTC5x4Unorm||e===Q.ASTC5x4UnormSRGB)return{byteLength:16,width:5,height:4};if(e===Q.ASTC5x5Unorm||e===Q.ASTC5x5UnormSRGB)return{byteLength:16,width:5,height:5};if(e===Q.ASTC6x5Unorm||e===Q.ASTC6x5UnormSRGB)return{byteLength:16,width:6,height:5};if(e===Q.ASTC6x6Unorm||e===Q.ASTC6x6UnormSRGB)return{byteLength:16,width:6,height:6};if(e===Q.ASTC8x5Unorm||e===Q.ASTC8x5UnormSRGB)return{byteLength:16,width:8,height:5};if(e===Q.ASTC8x6Unorm||e===Q.ASTC8x6UnormSRGB)return{byteLength:16,width:8,height:6};if(e===Q.ASTC8x8Unorm||e===Q.ASTC8x8UnormSRGB)return{byteLength:16,width:8,height:8};if(e===Q.ASTC10x5Unorm||e===Q.ASTC10x5UnormSRGB)return{byteLength:16,width:10,height:5};if(e===Q.ASTC10x6Unorm||e===Q.ASTC10x6UnormSRGB)return{byteLength:16,width:10,height:6};if(e===Q.ASTC10x8Unorm||e===Q.ASTC10x8UnormSRGB)return{byteLength:16,width:10,height:8};if(e===Q.ASTC10x10Unorm||e===Q.ASTC10x10UnormSRGB)return{byteLength:16,width:10,height:10};if(e===Q.ASTC12x10Unorm||e===Q.ASTC12x10UnormSRGB)return{byteLength:16,width:12,height:10};if(e===Q.ASTC12x12Unorm||e===Q.ASTC12x12UnormSRGB)return{byteLength:16,width:12,height:12}}_convertAddressMode(e){let t=Ay.ClampToEdge;return e===1e3?t=Ay.Repeat:e===1002&&(t=Ay.MirrorRepeat),t}_convertFilterMode(e){let t=jy.Linear;return(e===1003||e===1004||e===1005)&&(t=jy.Nearest),t}_getBytesPerTexel(e){if(e===Q.R8Unorm||e===Q.R8Snorm||e===Q.R8Uint||e===Q.R8Sint)return 1;if(e===Q.R16Uint||e===Q.R16Sint||e===Q.R16Float||e===Q.RG8Unorm||e===Q.RG8Snorm||e===Q.RG8Uint||e===Q.RG8Sint)return 2;if(e===Q.R32Uint||e===Q.R32Sint||e===Q.R32Float||e===Q.RG16Uint||e===Q.RG16Sint||e===Q.RG16Float||e===Q.RGBA8Unorm||e===Q.RGBA8UnormSRGB||e===Q.RGBA8Snorm||e===Q.RGBA8Uint||e===Q.RGBA8Sint||e===Q.BGRA8Unorm||e===Q.BGRA8UnormSRGB||e===Q.RGB9E5UFloat||e===Q.RGB10A2Unorm||e===Q.RG11B10UFloat||e===Q.Depth32Float||e===Q.Depth24Plus||e===Q.Depth24PlusStencil8||e===Q.Depth32FloatStencil8)return 4;if(e===Q.RG32Uint||e===Q.RG32Sint||e===Q.RG32Float||e===Q.RGBA16Uint||e===Q.RGBA16Sint||e===Q.RGBA16Float)return 8;if(e===Q.RGBA32Uint||e===Q.RGBA32Sint||e===Q.RGBA32Float)return 16}_getTypedArrayType(e){if(e===Q.R8Uint)return Uint8Array;if(e===Q.R8Sint)return Int8Array;if(e===Q.R8Unorm)return Uint8Array;if(e===Q.R8Snorm)return Int8Array;if(e===Q.RG8Uint)return Uint8Array;if(e===Q.RG8Sint)return Int8Array;if(e===Q.RG8Unorm)return Uint8Array;if(e===Q.RG8Snorm)return Int8Array;if(e===Q.RGBA8Uint)return Uint8Array;if(e===Q.RGBA8Sint)return Int8Array;if(e===Q.RGBA8Unorm||e===Q.RGBA8UnormSRGB)return Uint8Array;if(e===Q.RGBA8Snorm)return Int8Array;if(e===Q.R16Uint)return Uint16Array;if(e===Q.R16Sint)return Int16Array;if(e===Q.RG16Uint)return Uint16Array;if(e===Q.RG16Sint)return Int16Array;if(e===Q.RGBA16Uint)return Uint16Array;if(e===Q.RGBA16Sint)return Int16Array;if(e===Q.R16Float||e===Q.RG16Float||e===Q.RGBA16Float)return Uint16Array;if(e===Q.R32Uint)return Uint32Array;if(e===Q.R32Sint)return Int32Array;if(e===Q.R32Float)return Float32Array;if(e===Q.RG32Uint)return Uint32Array;if(e===Q.RG32Sint)return Int32Array;if(e===Q.RG32Float)return Float32Array;if(e===Q.RGBA32Uint)return Uint32Array;if(e===Q.RGBA32Sint)return Int32Array;if(e===Q.RGBA32Float)return Float32Array;if(e===Q.BGRA8Unorm||e===Q.BGRA8UnormSRGB)return Uint8Array;if(e===Q.RGB10A2Unorm||e===Q.RGB9E5UFloat||e===Q.RG11B10UFloat)return Uint32Array;if(e===Q.Depth32Float)return Float32Array;if(e===Q.Depth24Plus||e===Q.Depth24PlusStencil8)return Uint32Array;if(e===Q.Depth32FloatStencil8)return Float32Array}_getDimension(e){let t;return t=e.is3DTexture||e.isData3DTexture?zy.ThreeD:zy.TwoD,t}};function Qy(e,t=null){let r=e.format,i=e.type,o=e.colorSpace,s=Zn.getTransfer(o),c;if(e.isCompressedTexture===!0||e.isCompressedArrayTexture===!0)switch(r){case Pe:case It:c=s===`srgb`?Q.BC1RGBAUnormSRGB:Q.BC1RGBAUnorm;break;case Wt:c=s===`srgb`?Q.BC2RGBAUnormSRGB:Q.BC2RGBAUnorm;break;case _n:c=s===`srgb`?Q.BC3RGBAUnormSRGB:Q.BC3RGBAUnorm;break;case Kt:c=Q.BC4RUnorm;break;case _e:c=Q.BC4RSnorm;break;case yt:c=Q.BC5RGUnorm;break;case d:c=Q.BC5RGSnorm;break;case Ue:c=s===`srgb`?Q.BC7RGBAUnormSRGB:Q.BC7RGBAUnorm;break;case Gn:case Tn:c=s===`srgb`?Q.ETC2RGB8UnormSRGB:Q.ETC2RGB8Unorm;break;case Me:c=s===`srgb`?Q.ETC2RGBA8UnormSRGB:Q.ETC2RGBA8Unorm;break;case Je:c=s===`srgb`?Q.ASTC4x4UnormSRGB:Q.ASTC4x4Unorm;break;case gt:c=s===`srgb`?Q.ASTC5x4UnormSRGB:Q.ASTC5x4Unorm;break;case Ne:c=s===`srgb`?Q.ASTC5x5UnormSRGB:Q.ASTC5x5Unorm;break;case ot:c=s===`srgb`?Q.ASTC6x5UnormSRGB:Q.ASTC6x5Unorm;break;case ve:c=s===`srgb`?Q.ASTC6x6UnormSRGB:Q.ASTC6x6Unorm;break;case gn:c=s===`srgb`?Q.ASTC8x5UnormSRGB:Q.ASTC8x5Unorm;break;case Fe:c=s===`srgb`?Q.ASTC8x6UnormSRGB:Q.ASTC8x6Unorm;break;case kt:c=s===`srgb`?Q.ASTC8x8UnormSRGB:Q.ASTC8x8Unorm;break;case Le:c=s===`srgb`?Q.ASTC10x5UnormSRGB:Q.ASTC10x5Unorm;break;case cn:c=s===`srgb`?Q.ASTC10x6UnormSRGB:Q.ASTC10x6Unorm;break;case Qt:c=s===`srgb`?Q.ASTC10x8UnormSRGB:Q.ASTC10x8Unorm;break;case l:c=s===`srgb`?Q.ASTC10x10UnormSRGB:Q.ASTC10x10Unorm;break;case Bt:c=s===`srgb`?Q.ASTC12x10UnormSRGB:Q.ASTC12x10Unorm;break;case Ht:c=s===`srgb`?Q.ASTC12x12UnormSRGB:Q.ASTC12x12Unorm;break;case Ct:c=s===`srgb`?Q.RGBA8UnormSRGB:Q.RGBA8Unorm;break;default:console.error(`WebGPURenderer: Unsupported texture format.`,r)}else switch(r){case Ct:switch(i){case mt:c=Q.RGBA8Snorm;break;case Ft:c=Q.RGBA16Sint;break;case Dn:c=Q.RGBA16Uint;break;case an:c=Q.RGBA32Uint;break;case kn:c=Q.RGBA32Sint;break;case ge:c=s===`srgb`?Q.RGBA8UnormSRGB:Q.RGBA8Unorm;break;case Rt:c=Q.RGBA16Float;break;case Un:c=Q.RGBA32Float;break;default:console.error(`WebGPURenderer: Unsupported texture type with RGBAFormat.`,i)}break;case a:switch(i){case bn:c=Q.RGB9E5UFloat;break;case hn:c=Q.RG11B10UFloat;break;default:console.error(`WebGPURenderer: Unsupported texture type with RGBFormat.`,i)}break;case Mt:switch(i){case mt:c=Q.R8Snorm;break;case Ft:c=Q.R16Sint;break;case Dn:c=Q.R16Uint;break;case an:c=Q.R32Uint;break;case kn:c=Q.R32Sint;break;case ge:c=Q.R8Unorm;break;case Rt:c=Q.R16Float;break;case Un:c=Q.R32Float;break;default:console.error(`WebGPURenderer: Unsupported texture type with RedFormat.`,i)}break;case wt:switch(i){case mt:c=Q.RG8Snorm;break;case Ft:c=Q.RG16Sint;break;case Dn:c=Q.RG16Uint;break;case an:c=Q.RG32Uint;break;case kn:c=Q.RG32Sint;break;case ge:c=Q.RG8Unorm;break;case Rt:c=Q.RG16Float;break;case Un:c=Q.RG32Float;break;default:console.error(`WebGPURenderer: Unsupported texture type with RGFormat.`,i)}break;case Ln:switch(i){case Dn:c=Q.Depth16Unorm;break;case an:c=Q.Depth24Plus;break;case Un:c=Q.Depth32Float;break;default:console.error(`WebGPURenderer: Unsupported texture type with DepthFormat.`,i)}break;case In:switch(i){case xt:c=Q.Depth24PlusStencil8;break;case Un:t&&t.features.has(Uy.Depth32FloatStencil8)===!1&&console.error(`WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.`),c=Q.Depth32FloatStencil8;break;default:console.error(`WebGPURenderer: Unsupported texture type with DepthStencilFormat.`,i)}break;case we:switch(i){case kn:c=Q.R32Sint;break;case an:c=Q.R32Uint;break;default:console.error(`WebGPURenderer: Unsupported texture type with RedIntegerFormat.`,i)}break;case n:switch(i){case kn:c=Q.RG32Sint;break;case an:c=Q.RG32Uint;break;default:console.error(`WebGPURenderer: Unsupported texture type with RGIntegerFormat.`,i)}break;case Be:switch(i){case kn:c=Q.RGBA32Sint;break;case an:c=Q.RGBA32Uint;break;default:console.error(`WebGPURenderer: Unsupported texture type with RGBAIntegerFormat.`,i)}break;default:console.error(`WebGPURenderer: Unsupported texture format.`,r)}return c}var $y=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,eb=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/gi,tb={f32:`float`,i32:`int`,u32:`uint`,bool:`bool`,"vec2<f32>":`vec2`,"vec2<i32>":`ivec2`,"vec2<u32>":`uvec2`,"vec2<bool>":`bvec2`,vec2f:`vec2`,vec2i:`ivec2`,vec2u:`uvec2`,vec2b:`bvec2`,"vec3<f32>":`vec3`,"vec3<i32>":`ivec3`,"vec3<u32>":`uvec3`,"vec3<bool>":`bvec3`,vec3f:`vec3`,vec3i:`ivec3`,vec3u:`uvec3`,vec3b:`bvec3`,"vec4<f32>":`vec4`,"vec4<i32>":`ivec4`,"vec4<u32>":`uvec4`,"vec4<bool>":`bvec4`,vec4f:`vec4`,vec4i:`ivec4`,vec4u:`uvec4`,vec4b:`bvec4`,"mat2x2<f32>":`mat2`,mat2x2f:`mat2`,"mat3x3<f32>":`mat3`,mat3x3f:`mat3`,"mat4x4<f32>":`mat4`,mat4x4f:`mat4`,sampler:`sampler`,texture_1d:`texture`,texture_2d:`texture`,texture_2d_array:`texture`,texture_multisampled_2d:`cubeTexture`,texture_depth_2d:`depthTexture`,texture_depth_2d_array:`depthTexture`,texture_depth_multisampled_2d:`depthTexture`,texture_depth_cube:`depthTexture`,texture_depth_cube_array:`depthTexture`,texture_3d:`texture3D`,texture_cube:`cubeTexture`,texture_cube_array:`cubeTexture`,texture_storage_1d:`storageTexture`,texture_storage_2d:`storageTexture`,texture_storage_2d_array:`storageTexture`,texture_storage_3d:`storageTexture`},nb=e=>{e=e.trim();let t=e.match($y);if(t!==null&&t.length===4){let n=t[2],r=[],i=null;for(;(i=eb.exec(n))!==null;)r.push({name:i[1],type:i[2]});let a=[];for(let e=0;e<r.length;e++){let{name:t,type:n}=r[e],i=n;i.startsWith(`ptr`)?i=`pointer`:(i.startsWith(`texture`)&&(i=n.split(`<`)[0]),i=tb[i]),a.push(new zg(i,t))}let o=e.substring(t[0].length),s=t[3]||`void`,c=t[1]===void 0?``:t[1];return{type:tb[s]||s,inputs:a,name:c,inputsCode:n,blockCode:o,outputType:s}}else throw Error(`FunctionNode: Function is not a WGSL code.`)},rb=class extends i_{constructor(e){let{type:t,inputs:n,name:r,inputsCode:i,blockCode:a,outputType:o}=nb(e);super(t,n,r),this.inputsCode=i,this.blockCode=a,this.outputType=o}getCode(e=this.name){let t=this.outputType===`void`?``:`-> `+this.outputType;return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}},ib=class extends r_{parseFunction(e){return new rb(e)}},ab=typeof self<`u`?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},ob={[Si.READ_ONLY]:`read`,[Si.WRITE_ONLY]:`write`,[Si.READ_WRITE]:`read_write`},sb={[fe]:`repeat`,[Et]:`clamp`,[t]:`mirror`},cb={vertex:ab?ab.VERTEX:1,fragment:ab?ab.FRAGMENT:2,compute:ab?ab.COMPUTE:4},lb={instance:!0,swizzleAssign:!1,storageBuffer:!0},ub={"^^":`tsl_xor`},db={float:`f32`,int:`i32`,uint:`u32`,bool:`bool`,color:`vec3<f32>`,vec2:`vec2<f32>`,ivec2:`vec2<i32>`,uvec2:`vec2<u32>`,bvec2:`vec2<bool>`,vec3:`vec3<f32>`,ivec3:`vec3<i32>`,uvec3:`vec3<u32>`,bvec3:`vec3<bool>`,vec4:`vec4<f32>`,ivec4:`vec4<i32>`,uvec4:`vec4<u32>`,bvec4:`vec4<bool>`,mat2:`mat2x2<f32>`,mat3:`mat3x3<f32>`,mat4:`mat4x4<f32>`},fb={},pb={tsl_xor:new yp(`fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }`),mod_float:new yp(`fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }`),mod_vec2:new yp(`fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }`),mod_vec3:new yp(`fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }`),mod_vec4:new yp(`fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }`),equals_bool:new yp(`fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }`),equals_bvec2:new yp(`fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }`),equals_bvec3:new yp(`fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }`),equals_bvec4:new yp(`fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }`),repeatWrapping_float:new yp(`fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }`),mirrorWrapping_float:new yp(`fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }`),clampWrapping_float:new yp(`fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }`),biquadraticTexture:new yp(`
fn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {

	let res = vec2f( iRes );

	let uvScaled = coord * res;
	let uvWrapping = ( ( uvScaled % res ) + res ) % res;

	// https://www.shadertoy.com/view/WtyXRy

	let uv = uvWrapping - 0.5;
	let iuv = floor( uv );
	let f = fract( uv );

	let rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );
	let rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );
	let rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );
	let rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );

	return mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );

}
`)},mb={dFdx:`dpdx`,dFdy:`- dpdy`,mod_float:`tsl_mod_float`,mod_vec2:`tsl_mod_vec2`,mod_vec3:`tsl_mod_vec3`,mod_vec4:`tsl_mod_vec4`,equals_bool:`tsl_equals_bool`,equals_bvec2:`tsl_equals_bvec2`,equals_bvec3:`tsl_equals_bvec3`,equals_bvec4:`tsl_equals_bvec4`,inversesqrt:`inverseSqrt`,bitcast:`bitcast<f32>`},hb=``;(typeof navigator<`u`&&/Firefox|Deno/g.test(navigator.userAgent))!==!0&&(hb+=`diagnostic( off, derivative_uniformity );
`);var gb=class extends Lg{constructor(e,t){super(e,t,new ib),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}_generateTextureSample(e,t,n,r,i,a=this.shaderStage){return a===`fragment`?r?i?`textureSample( ${t}, ${t}_sampler, ${n}, ${r}, ${i} )`:`textureSample( ${t}, ${t}_sampler, ${n}, ${r} )`:i?`textureSample( ${t}, ${t}_sampler, ${n}, ${i} )`:`textureSample( ${t}, ${t}_sampler, ${n} )`:this.generateTextureSampleLevel(e,t,n,`0`,r)}generateTextureSampleLevel(e,t,n,r,i,a){return this.isUnfilterable(e)===!1?a?`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${r}, ${a} )`:`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${r} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,n,a,r):this.generateTextureLod(e,t,n,i,a,r)}generateWrapFunction(e){let t=`tsl_coord_${sb[e.wrapS]}S_${sb[e.wrapT]}_${e.isData3DTexture?`3d`:`2d`}T`,n=fb[t];if(n===void 0){let r=[],i=e.isData3DTexture?`vec3f`:`vec2f`,a=`fn ${t}( coord : ${i} ) -> ${i} {

	return ${i}(
`,o=(e,t)=>{e===1e3?(r.push(pb.repeatWrapping_float),a+=`		tsl_repeatWrapping_float( coord.${t} )`):e===1001?(r.push(pb.clampWrapping_float),a+=`		tsl_clampWrapping_float( coord.${t} )`):e===1002?(r.push(pb.mirrorWrapping_float),a+=`		tsl_mirrorWrapping_float( coord.${t} )`):(a+=`		coord.${t}`,console.warn(`WebGPURenderer: Unsupported texture wrap type "${e}" for vertex shader.`))};o(e.wrapS,`x`),a+=`,
`,o(e.wrapT,`y`),e.isData3DTexture&&(a+=`,
`,o(e.wrapR,`z`)),a+=`
	);

}
`,fb[t]=n=new yp(a,r)}return n.build(this),t}generateArrayDeclaration(e,t){return`array< ${this.getType(e)}, ${t} >`}generateTextureDimension(e,t,n){let r=this.getDataFromNode(e,this.shaderStage,this.globalCache);r.dimensionsSnippet===void 0&&(r.dimensionsSnippet={});let i=r.dimensionsSnippet[n];if(r.dimensionsSnippet[n]===void 0){let a,o,{primarySamples:s}=this.renderer.backend.utils.getTextureSampleData(e),c=s>1;o=e.isData3DTexture?`vec3<u32>`:`vec2<u32>`,a=c||e.isStorageTexture?t:`${t}${n?`, u32( ${n} )`:``}`,i=new dc(new Kc(`textureDimensions( ${a} )`,o)),r.dimensionsSnippet[n]=i,(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)&&(r.arrayLayerCount=new dc(new Kc(`textureNumLayers(${t})`,`u32`))),e.isTextureCube&&(r.cubeFaceCount=new dc(new Kc(`6u`,`u32`)))}return i.build(this)}generateFilteredTexture(e,t,n,r,i=`0u`){this._include(`biquadraticTexture`);let a=this.generateWrapFunction(e),o=this.generateTextureDimension(e,t,i);return r&&(n=`${n} + vec2<f32>(${r}) / ${o}`),`tsl_biquadraticTexture( ${t}, ${a}( ${n} ), ${o}, u32( ${i} ) )`}generateTextureLod(e,t,n,r,i,a=`0u`){let o=this.generateWrapFunction(e),s=this.generateTextureDimension(e,t,a),c=e.isData3DTexture?`vec3`:`vec2`;i&&(n=`${n} + ${c}<f32>(${i}) / ${c}<f32>( ${s} )`);let l=`${c}<u32>( ${o}( ${n} ) * ${c}<f32>( ${s} ) )`;return this.generateTextureLoad(e,t,l,r,null,a)}generateTextureLoad(e,t,n,r,i,a=`0u`){let o;return i&&(n=`${n} + ${i}`),r?o=`textureLoad( ${t}, ${n}, ${r}, u32( ${a} ) )`:(o=`textureLoad( ${t}, ${n}, u32( ${a} ) )`,this.renderer.backend.compatibilityMode&&e.isDepthTexture&&(o+=`.x`)),o}generateTextureStore(e,t,n,r,i){let a;return a=r?`textureStore( ${t}, ${n}, ${r}, ${i} )`:`textureStore( ${t}, ${n}, ${i} )`,a}isSampleCompare(e){return e.isDepthTexture===!0&&e.compareFunction!==null}isUnfilterable(e){return this.getComponentTypeFromTexture(e)!==`float`||!this.isAvailable(`float32Filterable`)&&e.isDataTexture===!0&&e.type===1015||this.isSampleCompare(e)===!1&&e.minFilter===1003&&e.magFilter===1003||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,n,r,i,a=this.shaderStage){let o=null;return o=this.isUnfilterable(e)?this.generateTextureLod(e,t,n,r,i,`0`,a):this._generateTextureSample(e,t,n,r,i,a),o}generateTextureGrad(e,t,n,r,i,a,o=this.shaderStage){if(o===`fragment`)return a?`textureSampleGrad( ${t}, ${t}_sampler, ${n},  ${r[0]}, ${r[1]}, ${a} )`:`textureSampleGrad( ${t}, ${t}_sampler, ${n},  ${r[0]}, ${r[1]} )`;console.error(`WebGPURenderer: THREE.TextureNode.gradient() does not support ${o} shader.`)}generateTextureCompare(e,t,n,r,i,a,o=this.shaderStage){if(o===`fragment`)return e.isDepthTexture===!0&&e.isArrayTexture===!0?a?`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${i}, ${r}, ${a} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${i}, ${r} )`:a?`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${r}, ${a} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${n}, ${r} )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${o} shader.`)}generateTextureLevel(e,t,n,r,i,a){return this.isUnfilterable(e)===!1?a?`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${r}, ${a} )`:`textureSampleLevel( ${t}, ${t}_sampler, ${n}, ${r} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,n,a,r):this.generateTextureLod(e,t,n,i,a,r)}generateTextureBias(e,t,n,r,i,a,o=this.shaderStage){if(o===`fragment`)return a?`textureSampleBias( ${t}, ${t}_sampler, ${n}, ${r}, ${a} )`:`textureSampleBias( ${t}, ${t}_sampler, ${n}, ${r} )`;console.error(`WebGPURenderer: THREE.TextureNode.biasNode does not support ${o} shader.`)}getPropertyName(e,t=this.shaderStage){if(e.isNodeVarying===!0&&e.needsInterpolation===!0){if(t===`vertex`)return`varyings.${e.name}`}else if(e.isNodeUniform===!0){let t=e.name,n=e.type;return n===`texture`||n===`cubeTexture`||n===`storageTexture`||n===`texture3D`?t:n===`buffer`||n===`storageBuffer`||n===`indirectStorageBuffer`?this.isCustomStruct(e)?t:t+`.value`:e.groupNode.name+`.`+t}return super.getPropertyName(e)}getOutputStructName(){return`output`}getFunctionOperator(e){let t=ub[e];return t===void 0?null:(this._include(t),t)}getNodeAccess(e,t){return t===`compute`?e.access:e.isAtomic===!0?(console.warn(`WebGPURenderer: Atomic operations are only supported in compute shaders.`),Si.READ_WRITE):Si.READ_ONLY}getStorageAccess(e,t){return ob[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,n,r=null){let i=super.getUniformFromNode(e,t,n,r),a=this.getDataFromNode(e,n,this.globalCache);if(a.uniformGPU===void 0){let o,s=e.groupNode,c=s.name,l=this.getBindGroupArray(c,n);if(t===`texture`||t===`cubeTexture`||t===`storageTexture`||t===`texture3D`){let r=null,a=this.getNodeAccess(e,n);if(t===`texture`||t===`storageTexture`?r=e.value.is3DTexture===!0?new Wv(i.name,i.node,s,a):new Hv(i.name,i.node,s,a):t===`cubeTexture`?r=new Uv(i.name,i.node,s,a):t===`texture3D`&&(r=new Wv(i.name,i.node,s,a)),r.store=e.isStorageTextureNode===!0,r.setVisibility(cb[n]),this.isUnfilterable(e.value)===!1&&r.store===!1){let e=new Wy(`${i.name}_sampler`,i.node,s);e.setVisibility(cb[n]),l.push(e,r),o=[e,r]}else l.push(r),o=[r]}else if(t===`buffer`||t===`storageBuffer`||t===`indirectStorageBuffer`){let a=new(t===`buffer`?Nv:qy)(e,s);a.setVisibility(cb[n]),l.push(a),o=a,i.name=r||`NodeBuffer_`+i.id}else{let e=this.uniformGroups[n]||(this.uniformGroups[n]={}),r=e[c];r===void 0&&(r=new Rv(c,s),r.setVisibility(cb[n]),e[c]=r,l.push(r)),o=this.getNodeUniform(i,t),r.addUniform(o)}a.uniformGPU=o}return i}getBuiltin(e,t,n,r=this.shaderStage){let i=this.builtins[r]||(this.builtins[r]=new Map);return i.has(e)===!1&&i.set(e,{name:e,property:t,type:n}),t}hasBuiltin(e,t=this.shaderStage){return this.builtins[t]!==void 0&&this.builtins[t].has(e)}getVertexIndex(){return this.shaderStage===`vertex`?this.getBuiltin(`vertex_index`,`vertexIndex`,`u32`,`attribute`):`vertexIndex`}buildFunctionCode(e){let t=e.layout,n=this.flowShaderNode(e),r=[];for(let e of t.inputs)r.push(e.name+` : `+this.getType(e.type));let i=`fn ${t.name}( ${r.join(`, `)} ) -> ${this.getType(t.type)} {
${n.vars}
${n.code}
`;return n.result&&(i+=`	return ${n.result};
`),i+=`
}
`,i}getInstanceIndex(){return this.shaderStage===`vertex`?this.getBuiltin(`instance_index`,`instanceIndex`,`u32`,`attribute`):`instanceIndex`}getInvocationLocalIndex(){return this.getBuiltin(`local_invocation_index`,`invocationLocalIndex`,`u32`,`attribute`)}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin(`subgroup_size`,`subgroupSize`,`u32`,`attribute`)}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin(`subgroup_invocation_id`,`invocationSubgroupIndex`,`u32`,`attribute`)}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin(`subgroup_id`,`subgroupIndex`,`u32`,`attribute`)}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin(`front_facing`,`isFront`,`bool`)}getFragCoord(){return this.getBuiltin(`position`,`fragCoord`,`vec4<f32>`)+`.xy`}getFragDepth(){return`output.`+this.getBuiltin(`frag_depth`,`depth`,`f32`,`output`)}getClipDistance(){return`varyings.hw_clip_distances`}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){let t=[],n=this.directives[e];if(n!==void 0)for(let e of n)t.push(`enable ${e};`);return t.join(`
`)}enableSubGroups(){this.enableDirective(`subgroups`)}enableSubgroupsF16(){this.enableDirective(`subgroups-f16`)}enableClipDistances(){this.enableDirective(`clip_distances`)}enableShaderF16(){this.enableDirective(`f16`)}enableDualSourceBlending(){this.enableDirective(`dual_source_blending`)}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin(`clip_distances`,`hw_clip_distances`,`array<f32, ${e} >`,`vertex`)}getBuiltins(e){let t=[],n=this.builtins[e];if(n!==void 0)for(let{name:e,property:r,type:i}of n.values())t.push(`@builtin( ${e} ) ${r} : ${i}`);return t.join(`,
	`)}getScopedArray(e,t,n,r){return this.scopedArrays.has(e)===!1&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:n,bufferCount:r}),e}getScopedArrays(e){if(e!==`compute`)return;let t=[];for(let{name:e,scope:n,bufferType:r,bufferCount:i}of this.scopedArrays.values()){let a=this.getType(r);t.push(`var<${n}> ${e}: array< ${a}, ${i} >;`)}return t.join(`
`)}getAttributes(e){let t=[];if(e===`compute`&&(this.getBuiltin(`global_invocation_id`,`globalId`,`vec3<u32>`,`attribute`),this.getBuiltin(`workgroup_id`,`workgroupId`,`vec3<u32>`,`attribute`),this.getBuiltin(`local_invocation_id`,`localId`,`vec3<u32>`,`attribute`),this.getBuiltin(`num_workgroups`,`numWorkgroups`,`vec3<u32>`,`attribute`),this.renderer.hasFeature(`subgroups`)&&(this.enableDirective(`subgroups`,e),this.getBuiltin(`subgroup_size`,`subgroupSize`,`u32`,`attribute`))),e===`vertex`||e===`compute`){let e=this.getBuiltins(`attribute`);e&&t.push(e);let n=this.getAttributesArray();for(let e=0,r=n.length;e<r;e++){let r=n[e],i=r.name,a=this.getType(r.type);t.push(`@location( ${e} ) ${i} : ${a}`)}}return t.join(`,
	`)}getStructMembers(e){let t=[];for(let n of e.members){let r=e.output?`@location( `+n.index+` ) `:``,i=this.getType(n.type);n.atomic&&(i=`atomic< `+i+` >`),t.push(`	${r+n.name} : ${i}`)}return e.output&&t.push(`	${this.getBuiltins(`output`)}`),t.join(`,
`)}getStructs(e){let t=``,n=this.structs[e];if(n.length>0){let e=[];for(let t of n){let n=`struct ${t.name} {
`;n+=this.getStructMembers(t),n+=`
};`,e.push(n)}t=`
`+e.join(`

`)+`
`}return t}getVar(e,t,n=null){let r=`var ${t} : `;return n===null?r+=this.getType(e):r+=this.generateArrayDeclaration(e,n),r}getVars(e){let t=[],n=this.vars[e];if(n!==void 0)for(let e of n)t.push(`	${this.getVar(e.type,e.name,e.count)};`);return`
${t.join(`
`)}
`}getVaryings(e){let t=[];if(e===`vertex`&&this.getBuiltin(`position`,`Vertex`,`vec4<f32>`,`vertex`),e===`vertex`||e===`fragment`){let n=this.varyings,r=this.vars[e];for(let i=0;i<n.length;i++){let a=n[i];if(a.needsInterpolation){let e=`@location( ${i} )`;if(a.interpolationType){let t=a.interpolationSampling===null?` )`:`, ${a.interpolationSampling} )`;e+=` @interpolate( ${a.interpolationType}${t}`}else /^(int|uint|ivec|uvec)/.test(a.type)&&(e+=` @interpolate( ${this.renderer.backend.compatibilityMode?`flat, either`:`flat`} )`);t.push(`${e} ${a.name} : ${this.getType(a.type)}`)}else e===`vertex`&&r.includes(a)===!1&&r.push(a)}}let n=this.getBuiltins(e);n&&t.push(n);let r=t.join(`,
	`);return e===`vertex`?this._getWGSLStruct(`VaryingsStruct`,`	`+r):r}isCustomStruct(e){let t=e.value,n=e.node,r=(t.isBufferAttribute||t.isInstancedBufferAttribute)&&n.structTypeNode!==null,i=n.value&&n.value.array&&typeof n.value.itemSize==`number`&&n.value.array.length>n.value.itemSize;return r&&!i}getUniforms(e){let t=this.uniforms[e],n=[],r=[],i=[],a={};for(let i of t){let t=i.groupNode.name,o=this.bindingsIndexes[t];if(i.type===`texture`||i.type===`cubeTexture`||i.type===`storageTexture`||i.type===`texture3D`){let t=i.node.value;this.isUnfilterable(t)===!1&&i.node.isStorageTextureNode!==!0&&(this.isSampleCompare(t)?n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${i.name}_sampler : sampler_comparison;`):n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${i.name}_sampler : sampler;`));let r,a=``,{primarySamples:s}=this.renderer.backend.utils.getTextureSampleData(t);if(s>1&&(a=`_multisampled`),t.isCubeTexture===!0)r=`texture_cube<f32>`;else if(t.isDepthTexture===!0)r=this.renderer.backend.compatibilityMode&&t.compareFunction===null?`texture${a}_2d<f32>`:`texture_depth${a}_2d${t.isArrayTexture===!0?`_array`:``}`;else if(i.node.isStorageTextureNode===!0){let n=Qy(t),a=this.getStorageAccess(i.node,e),o=i.node.value.is3DTexture,s=i.node.value.isArrayTexture;r=`texture_storage_${o?`3d`:`2d${s?`_array`:``}`}<${n}, ${a}>`}else if(t.isArrayTexture===!0||t.isDataArrayTexture===!0||t.isCompressedArrayTexture===!0)r=`texture_2d_array<f32>`;else if(t.is3DTexture===!0||t.isData3DTexture===!0)r=`texture_3d<f32>`;else{let e=this.getComponentTypeFromTexture(t).charAt(0);r=`texture${a}_2d<${e}32>`}n.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var ${i.name} : ${r};`)}else if(i.type===`buffer`||i.type===`storageBuffer`||i.type===`indirectStorageBuffer`){let t=i.node,n=this.getType(t.getNodeType(this)),a=t.bufferCount,s=a>0&&i.type===`buffer`?`, `+a:``,c=t.isStorageBufferNode?`storage, ${this.getStorageAccess(t,e)}`:`uniform`;if(this.isCustomStruct(i))r.push(`@binding( ${o.binding++} ) @group( ${o.group} ) var<${c}> ${i.name} : ${n};`);else{let e=`	value : array< ${t.isAtomic?`atomic<${n}>`:`${n}`}${s} >`;r.push(this._getWGSLStructBinding(i.name,e,c,o.binding++,o.group))}}else{let e=this.getType(this.getVectorType(i.type)),t=i.groupNode.name;(a[t]||(a[t]={index:o.binding++,id:o.group,snippets:[]})).snippets.push(`	${i.name} : ${e}`)}}for(let e in a){let t=a[e];i.push(this._getWGSLStructBinding(e,t.snippets.join(`,
`),`uniform`,t.index,t.id))}let o=n.join(`
`);return o+=r.join(`
`),o+=i.join(`
`),o}buildCode(){let e=this.material===null?{compute:{}}:{fragment:{},vertex:{}};for(let t in this.sortBindingGroups(),e){this.shaderStage=t;let n=e[t];n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.structs=this.getStructs(t),n.vars=this.getVars(t),n.codes=this.getCodes(t),n.directives=this.getDirectives(t),n.scopedArrays=this.getScopedArrays(t);let r=`// code

`;r+=this.flowCode[t];let i=this.flowNodes[t],a=i[i.length-1],o=a.outputNode,s=o!==void 0&&o.isOutputStructNode===!0;for(let e of i){let i=this.getFlowData(e),c=e.name;if(c&&(r.length>0&&(r+=`
`),r+=`	// flow -> ${c}
`),r+=`${i.code}
	`,e===a&&t!==`compute`){if(r+=`// result

	`,t===`vertex`)r+=`varyings.Vertex = ${i.result};`;else if(t===`fragment`)if(s)n.returnType=o.getNodeType(this),n.structs+=`var<private> output : `+n.returnType+`;`,r+=`return ${i.result};`;else{let e=`	@location(0) color: vec4<f32>`,t=this.getBuiltins(`output`);t&&(e+=`,
	`+t),n.returnType=`OutputStruct`,n.structs+=this._getWGSLStruct(`OutputStruct`,e),n.structs+=`
var<private> output : OutputStruct;`,r+=`output.color = ${i.result};

	return output;`}}}n.flow=r}if(this.shaderStage=null,this.material!==null)this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment);else{let t=this.object.workgroupSize;this.computeShader=this._getWGSLComputeCode(e.compute,t)}}getMethod(e,t=null){let n;return t!==null&&(n=this._getWGSLMethod(e+`_`+t)),n===void 0&&(n=this._getWGSLMethod(e)),n||e}getBitcastMethod(e){return`bitcast<${this.getType(e)}>`}getTernary(e,t,n){return`select( ${n}, ${t}, ${e} )`}getType(e){return db[e]||e}isAvailable(e){let t=lb[e];return t===void 0&&(e===`float32Filterable`?t=this.renderer.hasFeature(`float32-filterable`):e===`clipDistance`&&(t=this.renderer.hasFeature(`clip-distances`)),lb[e]=t),t}_getWGSLMethod(e){return pb[e]!==void 0&&this._include(e),mb[e]}_include(e){let t=pb[e];return t.build(this),this.currentFunctionNode!==null&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}
// directives
${e.directives}

// structs
${e.structs}

// uniforms
${e.uniforms}

// varyings
${e.varyings}
var<private> varyings : VaryingsStruct;

// codes
${e.codes}

@vertex
fn main( ${e.attributes} ) -> VaryingsStruct {

	// vars
	${e.vars}

	// flow
	${e.flow}

	return varyings;

}
`}_getWGSLFragmentCode(e){return`${this.getSignature()}
// global
${hb}

// structs
${e.structs}

// uniforms
${e.uniforms}

// codes
${e.codes}

@fragment
fn main( ${e.varyings} ) -> ${e.returnType} {

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLComputeCode(e,t){let[n,r,i]=t;return`${this.getSignature()}
// directives
${e.directives}

// system
var<private> instanceIndex : u32;

// locals
${e.scopedArrays}

// structs
${e.structs}

// uniforms
${e.uniforms}

// codes
${e.codes}

@compute @workgroup_size( ${n}, ${r}, ${i} )
fn main( ${e.attributes} ) {

	// system
	instanceIndex = globalId.x
		+ globalId.y * ( ${n} * numWorkgroups.x )
		+ globalId.z * ( ${n} * numWorkgroups.x ) * ( ${r} * numWorkgroups.y );

	// vars
	${e.vars}

	// flow
	${e.flow}

}
`}_getWGSLStruct(e,t){return`
struct ${e} {
${t}
};`}_getWGSLStructBinding(e,t,n,r=0,i=0){let a=e+`Struct`;return`${this._getWGSLStruct(a,t)}
@binding( ${r} ) @group( ${i} )
var<${n}> ${e} : ${a};`}},_b=class{constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return e.depthTexture===null?e.depth&&e.stencil?t=Q.Depth24PlusStencil8:e.depth&&(t=Q.Depth24Plus):t=this.getTextureFormatGPU(e.depthTexture),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){let e=this.backend.renderer,n=e.getRenderTarget();t=n?n.samples:e.samples}else e.renderTarget&&(t=e.renderTarget.samples);t||=1;let n=t>1&&e.renderTarget!==null&&e.isDepthTexture!==!0&&e.isFramebufferTexture!==!0;return{samples:t,primarySamples:n?1:t,isMSAA:n}}getCurrentColorFormat(e){let t;return t=e.textures===null?this.getPreferredCanvasFormat():this.getTextureFormatGPU(e.textures[0]),t}getCurrentColorSpace(e){return e.textures===null?this.backend.renderer.outputColorSpace:e.textures[0].colorSpace}getPrimitiveTopology(e,t){if(e.isPoints)return wy.PointList;if(e.isLineSegments||e.isMesh&&t.wireframe===!0)return wy.LineList;if(e.isLine)return wy.LineStrip;if(e.isMesh)return wy.TriangleList}getSampleCount(e){return e>=4?4:1}getSampleCountRenderContext(e){return e.textures===null?this.getSampleCount(this.backend.renderer.samples):this.getSampleCount(e.sampleCount)}getPreferredCanvasFormat(){let e=this.backend.parameters.outputType;if(e===void 0)return navigator.gpu.getPreferredCanvasFormat();if(e===1009)return Q.BGRA8Unorm;if(e===1016)return Q.RGBA16Float;throw Error(`Unsupported outputType`)}},vb=new Map([[Int8Array,[`sint8`,`snorm8`]],[Uint8Array,[`uint8`,`unorm8`]],[Int16Array,[`sint16`,`snorm16`]],[Uint16Array,[`uint16`,`unorm16`]],[Int32Array,[`sint32`,`snorm32`]],[Uint32Array,[`uint32`,`unorm32`]],[Float32Array,[`float32`]]]);typeof Float16Array<`u`&&vb.set(Float16Array,[`float16`]);var yb=new Map([[tr,[`float16`]]]),bb=new Map([[Int32Array,`sint32`],[Int16Array,`sint32`],[Uint32Array,`uint32`],[Uint16Array,`uint32`],[Float32Array,`float32`]]),xb=class{constructor(e){this.backend=e}createAttribute(e,t){let n=this._getBufferAttribute(e),r=this.backend,i=r.get(n),a=i.buffer;if(a===void 0){let o=r.device,s=n.array;if(e.normalized===!1){if(s.constructor===Int16Array||s.constructor===Int8Array)s=new Int32Array(s);else if((s.constructor===Uint16Array||s.constructor===Uint8Array)&&(s=new Uint32Array(s),t&GPUBufferUsage.INDEX))for(let e=0;e<s.length;e++)s[e]===65535&&(s[e]=4294967295)}if(n.array=s,(n.isStorageBufferAttribute||n.isStorageInstancedBufferAttribute)&&n.itemSize===3){s=new s.constructor(n.count*4);for(let e=0;e<n.count;e++)s.set(n.array.subarray(e*3,e*3+3),e*4);n.itemSize=4,n.array=s,i._force3to4BytesAlignment=!0}let c=s.byteLength,l=c+(4-c%4)%4;a=o.createBuffer({label:n.name,size:l,usage:t,mappedAtCreation:!0}),new s.constructor(a.getMappedRange()).set(s),a.unmap(),i.buffer=a}}updateAttribute(e){let t=this._getBufferAttribute(e),n=this.backend,r=n.device,i=n.get(t),a=n.get(t).buffer,o=t.array;if(i._force3to4BytesAlignment===!0){o=new o.constructor(t.count*4);for(let e=0;e<t.count;e++)o.set(t.array.subarray(e*3,e*3+3),e*4);t.array=o}let s=this._isTypedArray(o),c=t.updateRanges;if(c.length===0)r.queue.writeBuffer(a,0,o,0);else{let e=s?1:o.BYTES_PER_ELEMENT;for(let t=0,n=c.length;t<n;t++){let n=c[t],l,u;if(i._force3to4BytesAlignment===!0){let t=Math.floor(n.start/3),r=Math.ceil(n.count/3);l=t*4*e,u=r*4*e}else l=n.start*e,u=n.count*e;let d=l*(s?o.BYTES_PER_ELEMENT:1);r.queue.writeBuffer(a,d,o,l,u)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){let t=e.getAttributes(),n=new Map;for(let e=0;e<t.length;e++){let r=t[e],i=r.array.BYTES_PER_ELEMENT,a=this._getBufferAttribute(r),o=n.get(a);if(o===void 0){let e,t;r.isInterleavedBufferAttribute===!0?(e=r.data.stride*i,t=r.data.isInstancedInterleavedBuffer?Hy.Instance:Hy.Vertex):(e=r.itemSize*i,t=r.isInstancedBufferAttribute?Hy.Instance:Hy.Vertex),r.normalized===!1&&(r.array.constructor===Int16Array||r.array.constructor===Uint16Array)&&(e=4),o={arrayStride:e,attributes:[],stepMode:t},n.set(a,o)}let s=this._getVertexFormat(r),c=r.isInterleavedBufferAttribute===!0?r.offset*i:0;o.attributes.push({shaderLocation:e,offset:c,format:s})}return Array.from(n.values())}destroyAttribute(e){let t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){let t=this.backend,n=t.device,r=t.get(this._getBufferAttribute(e)).buffer,i=r.size,a=n.createBuffer({label:`${e.name}_readback`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=n.createCommandEncoder({label:`readback_encoder_${e.name}`});o.copyBufferToBuffer(r,0,a,0,i);let s=o.finish();n.queue.submit([s]),await a.mapAsync(GPUMapMode.READ);let c=a.getMappedRange(),l=new e.array.constructor(c.slice(0));return a.unmap(),l.buffer}_getVertexFormat(e){let{itemSize:t,normalized:n}=e,r=e.array.constructor,i=e.constructor,a;if(t===1)a=bb.get(r);else{let e=(yb.get(i)||vb.get(r))[n?1:0];if(e){let n=r.BYTES_PER_ELEMENT*t,i=Math.floor((n+3)/4)*4/r.BYTES_PER_ELEMENT;if(i%1)throw Error(`THREE.WebGPUAttributeUtils: Bad vertex format item size.`);a=`${e}x${i}`}}return a||console.error(`THREE.WebGPUAttributeUtils: Vertex format not supported yet.`),a}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}},Sb=class{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){let t=this.backend,n=t.device,r=[],i=0;for(let n of e.bindings){let e={binding:i++,visibility:n.visibility};if(n.isUniformBuffer||n.isStorageBuffer){let t={};n.isStorageBuffer&&(n.visibility&4&&(n.access===Si.READ_WRITE||n.access===Si.WRITE_ONLY)?t.type=Fy.Storage:t.type=Fy.ReadOnlyStorage),e.buffer=t}else if(n.isSampledTexture&&n.store){let t={};t.format=this.backend.get(n.texture).texture.format;let r=n.access;r===Si.READ_WRITE?t.access=Iy.ReadWrite:r===Si.WRITE_ONLY?t.access=Iy.WriteOnly:t.access=Iy.ReadOnly,n.texture.isArrayTexture?t.viewDimension=By.TwoDArray:n.texture.is3DTexture&&(t.viewDimension=By.ThreeD),e.storageTexture=t}else if(n.isSampledTexture){let r={},{primarySamples:i}=t.utils.getTextureSampleData(n.texture);if(i>1&&(r.multisampled=!0,n.texture.isDepthTexture||(r.sampleType=Ry.UnfilterableFloat)),n.texture.isDepthTexture)t.compatibilityMode&&n.texture.compareFunction===null?r.sampleType=Ry.UnfilterableFloat:r.sampleType=Ry.Depth;else if(n.texture.isDataTexture||n.texture.isDataArrayTexture||n.texture.isData3DTexture){let e=n.texture.type;e===1013?r.sampleType=Ry.SInt:e===1014?r.sampleType=Ry.UInt:e===1015&&(this.backend.hasFeature(`float32-filterable`)?r.sampleType=Ry.Float:r.sampleType=Ry.UnfilterableFloat)}n.isSampledCubeTexture?r.viewDimension=By.Cube:n.texture.isArrayTexture||n.texture.isDataArrayTexture||n.texture.isCompressedArrayTexture?r.viewDimension=By.TwoDArray:n.isSampledTexture3D&&(r.viewDimension=By.ThreeD),e.texture=r}else if(n.isSampler){let r={};n.texture.isDepthTexture&&(n.texture.compareFunction===null?t.compatibilityMode&&(r.type=Ly.NonFiltering):r.type=Ly.Comparison),e.sampler=r}else console.error(`WebGPUBindingUtils: Unsupported binding "${n}".`);r.push(e)}return n.createBindGroupLayout({entries:r})}createBindings(e,t,n,r=0){let{backend:i,bindGroupLayoutCache:a}=this,o=i.get(e),s=a.get(e.bindingsReference);s===void 0&&(s=this.createBindingsLayout(e),a.set(e.bindingsReference,s));let c;n>0&&(o.groups===void 0&&(o.groups=[],o.versions=[]),o.versions[n]===r&&(c=o.groups[n])),c===void 0&&(c=this.createBindGroup(e,s),n>0&&(o.groups[n]=c,o.versions[n]=r)),o.group=c,o.layout=s}updateBinding(e){let t=this.backend,n=t.device,r=e.buffer,i=t.get(e).buffer;n.queue.writeBuffer(i,0,r,0)}createBindGroupIndex(e,t){let n=this.backend.device,r=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,i=e[0],a=n.createBuffer({label:`bindingCameraIndex_`+i,size:16,usage:r});n.queue.writeBuffer(a,0,e,0);let o=[{binding:0,resource:{buffer:a}}];return n.createBindGroup({label:`bindGroupCameraIndex_`+i,layout:t,entries:o})}createBindGroup(e,t){let n=this.backend,r=n.device,i=0,a=[];for(let t of e.bindings){if(t.isUniformBuffer){let e=n.get(t);if(e.buffer===void 0){let n=t.byteLength,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST;e.buffer=r.createBuffer({label:`bindingBuffer_`+t.name,size:n,usage:i})}a.push({binding:i,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){let e=n.get(t);if(e.buffer===void 0){let r=t.attribute;e.buffer=n.get(r).buffer}a.push({binding:i,resource:{buffer:e.buffer}})}else if(t.isSampledTexture){let e=n.get(t.texture),o;if(e.externalTexture!==void 0)o=r.importExternalTexture({source:e.externalTexture});else{let n=t.store?1:e.texture.mipLevelCount,r=`view-${e.texture.width}-${e.texture.height}`;if(e.texture.depthOrArrayLayers>1&&(r+=`-${e.texture.depthOrArrayLayers}`),r+=`-${n}`,o=e[r],o===void 0){let i=Vy.All,a;a=t.isSampledCubeTexture?By.Cube:t.isSampledTexture3D?By.ThreeD:t.texture.isArrayTexture||t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?By.TwoDArray:By.TwoD,o=e[r]=e.texture.createView({aspect:i,dimension:a,mipLevelCount:n})}}a.push({binding:i,resource:o})}else if(t.isSampler){let e=n.get(t.texture);a.push({binding:i,resource:e.sampler})}i++}return r.createBindGroup({label:`bindGroup_`+e.name,layout:t,entries:a})}},Cb=class{constructor(e){this.backend=e,this._activePipelines=new WeakMap}setPipeline(e,t){this._activePipelines.get(e)!==t&&(e.setPipeline(t),this._activePipelines.set(e,t))}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){let{object:n,material:r,geometry:i,pipeline:a}=e,{vertexProgram:o,fragmentProgram:s}=a,c=this.backend,l=c.device,u=c.utils,d=c.get(a),f=[];for(let t of e.getBindings()){let e=c.get(t);f.push(e.layout)}let p=c.attributeUtils.createShaderVertexBuffers(e),m;r.blending!==0&&(r.blending!==1||r.transparent!==!1)&&(m=this._getBlending(r));let h={};r.stencilWrite===!0&&(h={compare:this._getStencilCompare(r),failOp:this._getStencilOperation(r.stencilFail),depthFailOp:this._getStencilOperation(r.stencilZFail),passOp:this._getStencilOperation(r.stencilZPass)});let g=this._getColorWriteMask(r),_=[];if(e.context.textures!==null){let t=e.context.textures;for(let e=0;e<t.length;e++){let n=u.getTextureFormatGPU(t[e]);_.push({format:n,blend:m,writeMask:g})}}else{let t=u.getCurrentColorFormat(e.context);_.push({format:t,blend:m,writeMask:g})}let v=c.get(o).module,y=c.get(s).module,b=this._getPrimitiveState(n,i,r),ee=this._getDepthCompare(r),x=u.getCurrentDepthStencilFormat(e.context),te=this._getSampleCount(e.context),ne={label:`renderPipeline_${r.name||r.type}_${r.id}`,vertex:Object.assign({},v,{buffers:p}),fragment:Object.assign({},y,{targets:_}),primitive:b,multisample:{count:te,alphaToCoverageEnabled:r.alphaToCoverage&&te>1},layout:l.createPipelineLayout({bindGroupLayouts:f})},re={},ie=e.context.depth,S=e.context.stencil;if((ie===!0||S===!0)&&(ie===!0&&(re.format=x,re.depthWriteEnabled=r.depthWrite,re.depthCompare=ee),S===!0&&(re.stencilFront=h,re.stencilBack={},re.stencilReadMask=r.stencilFuncMask,re.stencilWriteMask=r.stencilWriteMask),r.polygonOffset===!0&&(re.depthBias=r.polygonOffsetUnits,re.depthBiasSlopeScale=r.polygonOffsetFactor,re.depthBiasClamp=0),ne.depthStencil=re),t===null)d.pipeline=l.createRenderPipeline(ne);else{let e=new Promise(e=>{l.createRenderPipelineAsync(ne).then(t=>{d.pipeline=t,e()})});t.push(e)}}createBundleEncoder(e,t=`renderBundleEncoder`){let{utils:n,device:r}=this.backend,i=n.getCurrentDepthStencilFormat(e),a=n.getCurrentColorFormat(e),o=this._getSampleCount(e),s={label:t,colorFormats:[a],depthStencilFormat:i,sampleCount:o};return r.createRenderBundleEncoder(s)}createComputePipeline(e,t){let n=this.backend,r=n.device,i=n.get(e.computeProgram).module,a=n.get(e),o=[];for(let e of t){let t=n.get(e);o.push(t.layout)}a.pipeline=r.createComputePipeline({compute:i,layout:r.createPipelineLayout({bindGroupLayouts:o})})}_getBlending(e){let t,n,r=e.blending,i=e.blendSrc,a=e.blendDst,o=e.blendEquation;if(r===5){let r=e.blendSrcAlpha===null?i:e.blendSrcAlpha,s=e.blendDstAlpha===null?a:e.blendDstAlpha,c=e.blendEquationAlpha===null?o:e.blendEquationAlpha;t={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(a),operation:this._getBlendOperation(o)},n={srcFactor:this._getBlendFactor(r),dstFactor:this._getBlendFactor(s),operation:this._getBlendOperation(c)}}else{let i=e.premultipliedAlpha,a=(e,r,i,a)=>{t={srcFactor:e,dstFactor:r,operation:My.Add},n={srcFactor:i,dstFactor:a,operation:My.Add}};if(i)switch(r){case 1:a($.One,$.OneMinusSrcAlpha,$.One,$.OneMinusSrcAlpha);break;case 2:a($.One,$.One,$.One,$.One);break;case 3:a($.Zero,$.OneMinusSrc,$.Zero,$.One);break;case 4:a($.Dst,$.OneMinusSrcAlpha,$.Zero,$.One);break}else switch(r){case 1:a($.SrcAlpha,$.OneMinusSrcAlpha,$.One,$.OneMinusSrcAlpha);break;case 2:a($.SrcAlpha,$.One,$.One,$.One);break;case 3:console.error(`THREE.WebGPURenderer: SubtractiveBlending requires material.premultipliedAlpha = true`);break;case 4:console.error(`THREE.WebGPURenderer: MultiplyBlending requires material.premultipliedAlpha = true`);break}}if(t!==void 0&&n!==void 0)return{color:t,alpha:n};console.error(`THREE.WebGPURenderer: Invalid blending: `,r)}_getBlendFactor(e){let t;switch(e){case 200:t=$.Zero;break;case 201:t=$.One;break;case 202:t=$.Src;break;case 203:t=$.OneMinusSrc;break;case 204:t=$.SrcAlpha;break;case 205:t=$.OneMinusSrcAlpha;break;case 208:t=$.Dst;break;case 209:t=$.OneMinusDst;break;case 206:t=$.DstAlpha;break;case 207:t=$.OneMinusDstAlpha;break;case 210:t=$.SrcAlphaSaturated;break;case Fr:t=$.Constant;break;case Ir:t=$.OneMinusConstant;break;default:console.error(`THREE.WebGPURenderer: Blend factor not supported.`,e)}return t}_getStencilCompare(e){let t,n=e.stencilFunc;switch(n){case 512:t=Ty.Never;break;case 519:t=Ty.Always;break;case 513:t=Ty.Less;break;case 515:t=Ty.LessEqual;break;case 514:t=Ty.Equal;break;case 518:t=Ty.GreaterEqual;break;case 516:t=Ty.Greater;break;case 517:t=Ty.NotEqual;break;default:console.error(`THREE.WebGPURenderer: Invalid stencil function.`,n)}return t}_getStencilOperation(e){let t;switch(e){case jn:t=Py.Keep;break;case 0:t=Py.Zero;break;case On:t=Py.Replace;break;case Pn:t=Py.Invert;break;case rt:t=Py.IncrementClamp;break;case r:t=Py.DecrementClamp;break;case De:t=Py.IncrementWrap;break;case tn:t=Py.DecrementWrap;break;default:console.error(`THREE.WebGPURenderer: Invalid stencil operation.`,t)}return t}_getBlendOperation(e){let t;switch(e){case 100:t=My.Add;break;case 101:t=My.Subtract;break;case 102:t=My.ReverseSubtract;break;case 103:t=My.Min;break;case 104:t=My.Max;break;default:console.error(`THREE.WebGPUPipelineUtils: Blend equation not supported.`,e)}return t}_getPrimitiveState(e,t,n){let r={};r.topology=this.backend.utils.getPrimitiveTopology(e,n),t.index!==null&&e.isLine===!0&&e.isLineSegments!==!0&&(r.stripIndexFormat=t.index.array instanceof Uint16Array?ky.Uint16:ky.Uint32);let i=n.side===1;return e.isMesh&&e.matrixWorld.determinant()<0&&(i=!i),r.frontFace=i===!0?Dy.CW:Dy.CCW,r.cullMode=n.side===2?Oy.None:Oy.Back,r}_getColorWriteMask(e){return e.colorWrite===!0?Ny.All:Ny.None}_getDepthCompare(e){let t;if(e.depthTest===!1)t=Ty.Always;else{let n=e.depthFunc;switch(n){case 0:t=Ty.Never;break;case 1:t=Ty.Always;break;case 2:t=Ty.Less;break;case 3:t=Ty.LessEqual;break;case 4:t=Ty.Equal;break;case 5:t=Ty.GreaterEqual;break;case 6:t=Ty.Greater;break;case 7:t=Ty.NotEqual;break;default:console.error(`THREE.WebGPUPipelineUtils: Invalid depth function.`,n)}}return t}},wb=class extends xy{constructor(e,t,n=2048){super(n),this.device=e,this.type=t,this.querySet=this.device.createQuerySet({type:`timestamp`,count:this.maxQueries,label:`queryset_global_timestamp_${t}`});let r=this.maxQueries*8;this.resolveBuffer=this.device.createBuffer({label:`buffer_timestamp_resolve_${t}`,size:r,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=this.device.createBuffer({label:`buffer_timestamp_result_${t}`,size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}allocateQueriesForContext(e){if(!this.trackTimestamp||this.isDisposed)return null;if(this.currentQueryIndex+2>this.maxQueries)return er(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;let t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryOffsets.set(e,t),t}async resolveQueriesAsync(){if(!this.trackTimestamp||this.currentQueryIndex===0||this.isDisposed)return this.lastValue;if(this.pendingResolve)return this.pendingResolve;this.pendingResolve=this._resolveQueries();try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveQueries(){if(this.isDisposed)return this.lastValue;try{if(this.resultBuffer.mapState!==`unmapped`)return this.lastValue;let e=new Map(this.queryOffsets),t=this.currentQueryIndex,n=t*8;this.currentQueryIndex=0,this.queryOffsets.clear();let r=this.device.createCommandEncoder();r.resolveQuerySet(this.querySet,0,t,this.resolveBuffer,0),r.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,n);let i=r.finish();if(this.device.queue.submit([i]),this.resultBuffer.mapState!==`unmapped`)return this.lastValue;if(await this.resultBuffer.mapAsync(GPUMapMode.READ,0,n),this.isDisposed)return this.resultBuffer.mapState===`mapped`&&this.resultBuffer.unmap(),this.lastValue;let a=new BigUint64Array(this.resultBuffer.getMappedRange(0,n)),o=0;for(let[,t]of e){let e=a[t],n=a[t+1],r=Number(n-e)/1e6;o+=r}return this.resultBuffer.unmap(),this.lastValue=o,o}catch(e){return console.error(`Error resolving queries:`,e),this.resultBuffer.mapState===`mapped`&&this.resultBuffer.unmap(),this.lastValue}}async dispose(){if(!this.isDisposed){if(this.isDisposed=!0,this.pendingResolve)try{await this.pendingResolve}catch(e){console.error(`Error waiting for pending resolve:`,e)}if(this.resultBuffer&&this.resultBuffer.mapState===`mapped`)try{this.resultBuffer.unmap()}catch(e){console.error(`Error unmapping buffer:`,e)}this.querySet&&=(this.querySet.destroy(),null),this.resolveBuffer&&=(this.resolveBuffer.destroy(),null),this.resultBuffer&&=(this.resultBuffer.destroy(),null),this.queryOffsets.clear(),this.pendingResolve=null}}},Tb=class extends ty{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=e.alpha===void 0?!0:e.alpha,this.parameters.compatibilityMode=e.compatibilityMode===void 0?!1:e.compatibilityMode,this.parameters.requiredLimits=e.requiredLimits===void 0?{}:e.requiredLimits,this.compatibilityMode=this.parameters.compatibilityMode,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new _b(this),this.attributeUtils=new xb(this),this.bindingUtils=new Sb(this),this.pipelineUtils=new Cb(this),this.textureUtils=new Zy(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);let t=this.parameters,n;if(t.device===void 0){let e={powerPreference:t.powerPreference,featureLevel:t.compatibilityMode?`compatibility`:void 0},r=typeof navigator<`u`?await navigator.gpu.requestAdapter(e):null;if(r===null)throw Error(`WebGPUBackend: Unable to create WebGPU adapter.`);let i=Object.values(Uy),a=[];for(let e of i)r.features.has(e)&&a.push(e);let o={requiredFeatures:a,requiredLimits:t.requiredLimits};n=await r.requestDevice(o)}else n=t.device;n.lost.then(t=>{let n={api:`WebGPU`,message:t.message||`Unknown reason`,reason:t.reason||null,originalEvent:t};e.onDeviceLost(n)});let r=t.context===void 0?e.domElement.getContext(`webgpu`):t.context;this.device=n,this.context=r;let i=t.alpha?`premultiplied`:`opaque`,a=Zn.getToneMappingMode(this.renderer.outputColorSpace);this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:i,toneMapping:{mode:a}}),this.trackTimestamp=this.trackTimestamp&&this.hasFeature(Uy.TimestampQuery),this.updateSize()}get coordinateSystem(){return ze}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(e===null){let t=this.renderer;e={colorAttachments:[{view:null}]},(this.renderer.depth===!0||this.renderer.stencil===!0)&&(e.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()});let n=e.colorAttachments[0];this.renderer.samples>0?n.view=this.colorBuffer.createView():n.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}let t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.image.depth>1&&e.camera.isArrayCamera}_getRenderPassDescriptor(e,t={}){let n=e.renderTarget,r=this.get(n),i=r.descriptors;(i===void 0||r.width!==n.width||r.height!==n.height||r.samples!==n.samples)&&(i={},r.descriptors=i);let a=e.getCacheKey(),o=i[a];if(o===void 0){let t=e.textures,s=[],c,l=this._isRenderCameraDepthArray(e);for(let r=0;r<t.length;r++){let i=this.get(t[r]),a={label:`colorAttachment_${r}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:By.TwoD};if(n.isRenderTarget3D)c=e.activeCubeFace,a.baseArrayLayer=0,a.dimension=By.ThreeD,a.depthOrArrayLayers=t[r].image.depth;else if(n.isRenderTarget&&t[r].image.depth>1)if(l===!0){let t=e.camera.cameras;for(let e=0;e<t.length;e++){let t={...a,baseArrayLayer:e,arrayLayerCount:1,dimension:By.TwoD},n=i.texture.createView(t);s.push({view:n,resolveTarget:void 0,depthSlice:void 0})}}else a.dimension=By.TwoDArray,a.depthOrArrayLayers=t[r].image.depth;if(l!==!0){let e=i.texture.createView(a),t,n;i.msaaTexture===void 0?(t=e,n=void 0):(t=i.msaaTexture.createView(),n=e),s.push({view:t,resolveTarget:n,depthSlice:c})}}if(o={textureViews:s},e.depth){let t=this.get(e.depthTexture),n={};e.depthTexture.isArrayTexture&&(n.dimension=By.TwoD,n.arrayLayerCount=1,n.baseArrayLayer=e.activeCubeFace),o.depthStencilView=t.texture.createView(n)}i[a]=o,r.width=n.width,r.height=n.height,r.samples=n.samples,r.activeMipmapLevel=e.activeMipmapLevel,r.activeCubeFace=e.activeCubeFace}let s={colorAttachments:[]};for(let e=0;e<o.textureViews.length;e++){let n=o.textureViews[e],r={r:0,g:0,b:0,a:1};e===0&&t.clearValue&&(r=t.clearValue),s.colorAttachments.push({view:n.view,depthSlice:n.depthSlice,resolveTarget:n.resolveTarget,loadOp:t.loadOp||Z.Load,storeOp:t.storeOp||Ey.Store,clearValue:r})}return o.depthStencilView&&(s.depthStencilAttachment={view:o.depthStencilView}),s}beginRender(e){let t=this.get(e);t.frameCalls=this.renderer.info.render.frameCalls;let n=this.device,r=e.occlusionQueryCount,i;r>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,i=n.createQuerySet({type:`occlusion`,count:r,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=i,t.occlusionQueryIndex=0,t.occlusionQueryObjects=Array(r),t.lastOcclusionObject=null);let a;a=e.textures===null?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e,{loadOp:Z.Load}),this.initTimestampQuery(S.RENDER,this.getTimestampUID(e),a),a.occlusionQuerySet=i;let o=a.depthStencilAttachment;if(e.textures!==null){let t=a.colorAttachments;for(let n=0;n<t.length;n++){let r=t[n];e.clearColor?(r.clearValue=n===0?e.clearColorValue:{r:0,g:0,b:0,a:1},r.loadOp=Z.Clear):r.loadOp=Z.Load,r.storeOp=Ey.Store}}else{let t=a.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=Z.Clear):t.loadOp=Z.Load,t.storeOp=Ey.Store}e.depth&&(e.clearDepth?(o.depthClearValue=e.clearDepthValue,o.depthLoadOp=Z.Clear):o.depthLoadOp=Z.Load,o.depthStoreOp=Ey.Store),e.stencil&&(e.clearStencil?(o.stencilClearValue=e.clearStencilValue,o.stencilLoadOp=Z.Clear):o.stencilLoadOp=Z.Load,o.stencilStoreOp=Ey.Store);let s=n.createCommandEncoder({label:`renderContext_`+e.id});if(this._isRenderCameraDepthArray(e)===!0){let n=e.camera.cameras;!t.layerDescriptors||t.layerDescriptors.length!==n.length?this._createDepthLayerDescriptors(e,t,a,n):this._updateDepthLayerDescriptors(e,t,n),t.bundleEncoders=[],t.bundleSets=[];for(let r=0;r<n.length;r++){let n=this.pipelineUtils.createBundleEncoder(e,`renderBundleArrayCamera_`+r);t.bundleEncoders.push(n),t.bundleSets.push({attributes:{},bindingGroups:[],pipeline:null,index:null})}t.currentPass=null}else{let n=s.beginRenderPass(a);if(t.currentPass=n,e.viewport&&this.updateViewport(e),e.scissor){let{x:t,y:r,width:i,height:a}=e.scissorValue;n.setScissorRect(t,r,i,a)}}t.descriptor=a,t.encoder=s,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[]}_createDepthLayerDescriptors(e,t,n,r){let i=n.depthStencilAttachment;t.layerDescriptors=[];let a=this.get(e.depthTexture);a.viewCache||=[];for(let o=0;o<r.length;o++){let r={...n,colorAttachments:[{...n.colorAttachments[0],view:n.colorAttachments[o].view}]};if(n.depthStencilAttachment){let t=o;a.viewCache[t]||(a.viewCache[t]=a.texture.createView({dimension:By.TwoD,baseArrayLayer:o,arrayLayerCount:1})),r.depthStencilAttachment={view:a.viewCache[t],depthLoadOp:i.depthLoadOp||Z.Clear,depthStoreOp:i.depthStoreOp||Ey.Store,depthClearValue:i.depthClearValue||1},e.stencil&&(r.depthStencilAttachment.stencilLoadOp=i.stencilLoadOp,r.depthStencilAttachment.stencilStoreOp=i.stencilStoreOp,r.depthStencilAttachment.stencilClearValue=i.stencilClearValue)}else r.depthStencilAttachment={...i};t.layerDescriptors.push(r)}}_updateDepthLayerDescriptors(e,t,n){for(let r=0;r<n.length;r++){let n=t.layerDescriptors[r];if(n.depthStencilAttachment){let t=n.depthStencilAttachment;e.depth&&(e.clearDepth?(t.depthClearValue=e.clearDepthValue,t.depthLoadOp=Z.Clear):t.depthLoadOp=Z.Load),e.stencil&&(e.clearStencil?(t.stencilClearValue=e.clearStencilValue,t.stencilLoadOp=Z.Clear):t.stencilLoadOp=Z.Load)}}}finishRender(e){let t=this.get(e),n=e.occlusionQueryCount;t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),n>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery();let r=t.encoder;if(this._isRenderCameraDepthArray(e)===!0){let n=[];for(let e=0;e<t.bundleEncoders.length;e++){let r=t.bundleEncoders[e];n.push(r.finish())}for(let i=0;i<t.layerDescriptors.length;i++)if(i<n.length){let a=t.layerDescriptors[i],o=r.beginRenderPass(a);if(e.viewport){let{x:t,y:n,width:r,height:i,minDepth:a,maxDepth:s}=e.viewportValue;o.setViewport(t,n,r,i,a,s)}if(e.scissor){let{x:t,y:n,width:r,height:i}=e.scissorValue;o.setScissorRect(t,n,r,i)}o.executeBundles([n[i]]),o.end()}}else t.currentPass&&t.currentPass.end();if(n>0){let r=n*8,i=this.occludedResolveCache.get(r);i===void 0&&(i=this.device.createBuffer({size:r,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(r,i));let a=this.device.createBuffer({size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,n,i,0),t.encoder.copyBufferToBuffer(i,0,a,0,r),t.occlusionQueryBuffer=a,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),e.textures!==null){let t=e.textures;for(let e=0;e<t.length;e++){let n=t[e];n.generateMipmaps===!0&&this.textureUtils.generateMipmaps(n)}}}isOccluded(e,t){let n=this.get(e);return n.occluded&&n.occluded.has(t)}async resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueryBuffer:n,currentOcclusionQueryObjects:r}=t;if(n&&r){let e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await n.mapAsync(GPUMapMode.READ);let i=n.getMappedRange(),a=new BigUint64Array(i);for(let t=0;t<r.length;t++)a[t]===BigInt(0)&&e.add(r[t]);n.destroy(),t.occluded=e}}updateViewport(e){let{currentPass:t}=this.get(e),{x:n,y:r,width:i,height:a,minDepth:o,maxDepth:s}=e.viewportValue;t.setViewport(n,r,i,a,o,s)}getClearColor(){let e=super.getClearColor();return this.renderer.alpha===!0&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}clear(e,t,n,r=null){let i=this.device,a=this.renderer,o=[],s,c,l,u;if(e){let e=this.getClearColor();c={r:e.r,g:e.g,b:e.b,a:e.a}}if(r===null){l=a.depth,u=a.stencil;let t=this._getDefaultRenderPassDescriptor();if(e){o=t.colorAttachments;let e=o[0];e.clearValue=c,e.loadOp=Z.Clear,e.storeOp=Ey.Store}(l||u)&&(s=t.depthStencilAttachment)}else{l=r.depth,u=r.stencil;let i={loadOp:e?Z.Clear:Z.Load,clearValue:e?c:void 0};l&&(i.depthLoadOp=t?Z.Clear:Z.Load,i.depthClearValue=t?a.getClearDepth():void 0,i.depthStoreOp=Ey.Store),u&&(i.stencilLoadOp=n?Z.Clear:Z.Load,i.stencilClearValue=n?a.getClearStencil():void 0,i.stencilStoreOp=Ey.Store);let d=this._getRenderPassDescriptor(r,i);o=d.colorAttachments,s=d.depthStencilAttachment}l&&s&&(t?(s.depthLoadOp=Z.Clear,s.depthClearValue=a.getClearDepth(),s.depthStoreOp=Ey.Store):(s.depthLoadOp=Z.Load,s.depthStoreOp=Ey.Store)),u&&s&&(n?(s.stencilLoadOp=Z.Clear,s.stencilClearValue=a.getClearStencil(),s.stencilStoreOp=Ey.Store):(s.stencilLoadOp=Z.Load,s.stencilStoreOp=Ey.Store));let d=i.createCommandEncoder({label:`clear`});d.beginRenderPass({colorAttachments:o,depthStencilAttachment:s}).end(),i.queue.submit([d.finish()])}beginCompute(e){let t=this.get(e);t.frameCalls=this.renderer.info.compute.frameCalls;let n={label:`computeGroup_`+e.id};this.initTimestampQuery(S.COMPUTE,this.getTimestampUID(e),n),t.cmdEncoderGPU=this.device.createCommandEncoder({label:`computeGroup_`+e.id}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(n)}compute(e,t,n,r,i=null){let a=this.get(t),{passEncoderGPU:o}=this.get(e),s=this.get(r).pipeline;this.pipelineUtils.setPipeline(o,s);for(let e=0,t=n.length;e<t;e++){let t=n[e],r=this.get(t);o.setBindGroup(e,r.group)}let c;if(i===null&&(i=t.count),typeof i==`number`){let e=i;if(a.dispatchSize===void 0||a.count!==e){a.dispatchSize=[0,1,1],a.count=e;let n=t.workgroupSize,r=n[0];for(let e=1;e<n.length;e++)r*=n[e];let i=Math.ceil(e/r),o=this.device.limits.maxComputeWorkgroupsPerDimension;c=[i,1,1],i>o&&(c[0]=Math.min(i,o),c[1]=Math.ceil(i/o)),a.dispatchSize=c}c=a.dispatchSize}else c=i;o.dispatchWorkgroups(c[0],c[1]||1,c[2]||1)}finishCompute(e){let t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}async waitForGPU(){await this.device.queue.onSubmittedWorkDone()}draw(e,t){let{object:n,material:r,context:i,pipeline:a}=e,o=e.getBindings(),s=this.get(i),c=this.get(a).pipeline,l=e.getIndex(),u=l!==null,d=e.getDrawParameters();if(d===null)return;let f=(t,n)=>{this.pipelineUtils.setPipeline(t,c),n.pipeline=c;let a=n.bindingGroups;for(let e=0,n=o.length;e<n;e++){let n=o[e],r=this.get(n);a[n.index]!==n.id&&(t.setBindGroup(n.index,r.group),a[n.index]=n.id)}if(u===!0&&n.index!==l){let e=this.get(l).buffer,r=l.array instanceof Uint16Array?ky.Uint16:ky.Uint32;t.setIndexBuffer(e,r),n.index=l}let d=e.getVertexBuffers();for(let e=0,r=d.length;e<r;e++){let r=d[e];if(n.attributes[e]!==r){let i=this.get(r).buffer;t.setVertexBuffer(e,i),n.attributes[e]=r}}i.stencil===!0&&r.stencilWrite===!0&&s.currentStencilRef!==r.stencilRef&&(t.setStencilReference(r.stencilRef),s.currentStencilRef=r.stencilRef)},p=(r,i)=>{if(f(r,i),n.isBatchedMesh===!0){let e=n._multiDrawStarts,i=n._multiDrawCounts,a=n._multiDrawCount,o=n._multiDrawInstances;o!==null&&er(`THREE.WebGPUBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.`);for(let s=0;s<a;s++){let a=o?o[s]:1,c=a>1?0:s;u===!0?r.drawIndexed(i[s],a,e[s]/l.array.BYTES_PER_ELEMENT,0,c):r.draw(i[s],a,e[s],c),t.update(n,i[s],a)}}else if(u===!0){let{vertexCount:i,instanceCount:a,firstVertex:o}=d,s=e.getIndirect();if(s!==null){let e=this.get(s).buffer;r.drawIndexedIndirect(e,0)}else r.drawIndexed(i,a,o,0,0);t.update(n,i,a)}else{let{vertexCount:i,instanceCount:a,firstVertex:o}=d,s=e.getIndirect();if(s!==null){let e=this.get(s).buffer;r.drawIndirect(e,0)}else r.draw(i,a,o,0);t.update(n,i,a)}};if(e.camera.isArrayCamera&&e.camera.cameras.length>0){let t=this.get(e.camera),r=e.camera.cameras,a=e.getBindingGroup(`cameraIndex`);if(t.indexesGPU===void 0||t.indexesGPU.length!==r.length){let e=this.get(a),n=[],i=new Uint32Array([0,0,0,0]);for(let t=0,a=r.length;t<a;t++){i[0]=t;let r=this.bindingUtils.createBindGroupIndex(i,e.layout);n.push(r)}t.indexesGPU=n}let o=this.renderer.getPixelRatio();for(let e=0,c=r.length;e<c;e++){let c=r[e];if(n.layers.test(c.layers)){let n=c.viewport,r=s.currentPass,l=s.currentSets;if(s.bundleEncoders){let t=s.bundleEncoders[e],n=s.bundleSets[e];r=t,l=n}n&&r.setViewport(Math.floor(n.x*o),Math.floor(n.y*o),Math.floor(n.width*o),Math.floor(n.height*o),i.viewportValue.minDepth,i.viewportValue.maxDepth),a&&t.indexesGPU&&(r.setBindGroup(a.index,t.indexesGPU[e]),l.bindingGroups[a.index]=a.id),p(r,l)}}}else if(s.currentPass){if(s.occlusionQuerySet!==void 0){let e=s.lastOcclusionObject;e!==n&&(e!==null&&e.occlusionTest===!0&&(s.currentPass.endOcclusionQuery(),s.occlusionQueryIndex++),n.occlusionTest===!0&&(s.currentPass.beginOcclusionQuery(s.occlusionQueryIndex),s.occlusionQueryObjects[s.occlusionQueryIndex]=n),s.lastOcclusionObject=n)}p(s.currentPass,s.currentSets)}}needsRenderUpdate(e){let t=this.get(e),{object:n,material:r}=e,i=this.utils,a=i.getSampleCountRenderContext(e.context),o=i.getCurrentColorSpace(e.context),s=i.getCurrentColorFormat(e.context),c=i.getCurrentDepthStencilFormat(e.context),l=i.getPrimitiveTopology(n,r),u=!1;return(t.material!==r||t.materialVersion!==r.version||t.transparent!==r.transparent||t.blending!==r.blending||t.premultipliedAlpha!==r.premultipliedAlpha||t.blendSrc!==r.blendSrc||t.blendDst!==r.blendDst||t.blendEquation!==r.blendEquation||t.blendSrcAlpha!==r.blendSrcAlpha||t.blendDstAlpha!==r.blendDstAlpha||t.blendEquationAlpha!==r.blendEquationAlpha||t.colorWrite!==r.colorWrite||t.depthWrite!==r.depthWrite||t.depthTest!==r.depthTest||t.depthFunc!==r.depthFunc||t.stencilWrite!==r.stencilWrite||t.stencilFunc!==r.stencilFunc||t.stencilFail!==r.stencilFail||t.stencilZFail!==r.stencilZFail||t.stencilZPass!==r.stencilZPass||t.stencilFuncMask!==r.stencilFuncMask||t.stencilWriteMask!==r.stencilWriteMask||t.side!==r.side||t.alphaToCoverage!==r.alphaToCoverage||t.sampleCount!==a||t.colorSpace!==o||t.colorFormat!==s||t.depthStencilFormat!==c||t.primitiveTopology!==l||t.clippingContextCacheKey!==e.clippingContextCacheKey)&&(t.material=r,t.materialVersion=r.version,t.transparent=r.transparent,t.blending=r.blending,t.premultipliedAlpha=r.premultipliedAlpha,t.blendSrc=r.blendSrc,t.blendDst=r.blendDst,t.blendEquation=r.blendEquation,t.blendSrcAlpha=r.blendSrcAlpha,t.blendDstAlpha=r.blendDstAlpha,t.blendEquationAlpha=r.blendEquationAlpha,t.colorWrite=r.colorWrite,t.depthWrite=r.depthWrite,t.depthTest=r.depthTest,t.depthFunc=r.depthFunc,t.stencilWrite=r.stencilWrite,t.stencilFunc=r.stencilFunc,t.stencilFail=r.stencilFail,t.stencilZFail=r.stencilZFail,t.stencilZPass=r.stencilZPass,t.stencilFuncMask=r.stencilFuncMask,t.stencilWriteMask=r.stencilWriteMask,t.side=r.side,t.alphaToCoverage=r.alphaToCoverage,t.sampleCount=a,t.colorSpace=o,t.colorFormat=s,t.depthStencilFormat=c,t.primitiveTopology=l,t.clippingContextCacheKey=e.clippingContextCacheKey,u=!0),u}getRenderCacheKey(e){let{object:t,material:n}=e,r=this.utils,i=e.context,a=t.isMesh&&t.matrixWorld.determinant()<0;return[n.transparent,n.blending,n.premultipliedAlpha,n.blendSrc,n.blendDst,n.blendEquation,n.blendSrcAlpha,n.blendDstAlpha,n.blendEquationAlpha,n.colorWrite,n.depthWrite,n.depthTest,n.depthFunc,n.stencilWrite,n.stencilFunc,n.stencilFail,n.stencilZFail,n.stencilZPass,n.stencilFuncMask,n.stencilWriteMask,n.side,a,r.getSampleCountRenderContext(i),r.getCurrentColorSpace(i),r.getCurrentColorFormat(i),r.getCurrentDepthStencilFormat(i),r.getPrimitiveTopology(t,n),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,n,r,i,a){return this.textureUtils.copyTextureToBuffer(e,t,n,r,i,a)}initTimestampQuery(e,t,n){if(!this.trackTimestamp)return;this.timestampQueryPool[e]||(this.timestampQueryPool[e]=new wb(this.device,e,2048));let r=this.timestampQueryPool[e],i=r.allocateQueriesForContext(t);n.timestampWrites={querySet:r.querySet,beginningOfPassWriteIndex:i,endOfPassWriteIndex:i+1}}createNodeBuilder(e,t){return new gb(e,t)}createProgram(e){let t=this.get(e);t.module={module:this.device.createShaderModule({code:e.code,label:e.stage+(e.name===``?``:`_${e.name}`)}),entryPoint:`main`}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){let t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){let n=this.get(e),r=n.currentPass.finish();this.get(t).bundleGPU=r,n.currentSets=n._currentSets,n.currentPass=n._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,n,r){this.bindingUtils.createBindings(e,t,n,r)}updateBindings(e,t,n,r){this.bindingUtils.createBindings(e,t,n,r)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){let t=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST;(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(t|=GPUBufferUsage.STORAGE),this.attributeUtils.createAttribute(e,t)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,n=null,r=null,i=0,a=0){let o=0,s=0,c=0,l=0,u=0,d=0,f=e.image.width,p=e.image.height,m=1;n!==null&&(n.isBox3===!0?(l=n.min.x,u=n.min.y,d=n.min.z,f=n.max.x-n.min.x,p=n.max.y-n.min.y,m=n.max.z-n.min.z):(l=n.min.x,u=n.min.y,f=n.max.x-n.min.x,p=n.max.y-n.min.y,m=1)),r!==null&&(o=r.x,s=r.y,c=r.z||0);let h=this.device.createCommandEncoder({label:`copyTextureToTexture_`+e.id+`_`+t.id}),g=this.get(e).texture,_=this.get(t).texture;h.copyTextureToTexture({texture:g,mipLevel:i,origin:{x:l,y:u,z:d}},{texture:_,mipLevel:a,origin:{x:o,y:s,z:c}},[f,p,m]),this.device.queue.submit([h.finish()]),a===0&&t.generateMipmaps&&this.textureUtils.generateMipmaps(t)}copyFramebufferToTexture(e,t,n){let r=this.get(t),i=null;i=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();let a=this.get(e).texture;if(i.format!==a.format){console.error(`WebGPUBackend: copyFramebufferToTexture: Source and destination formats do not match.`,i.format,a.format);return}let o;if(r.currentPass?(r.currentPass.end(),o=r.encoder):o=this.device.createCommandEncoder({label:`copyFramebufferToTexture_`+e.id}),o.copyTextureToTexture({texture:i,origin:[n.x,n.y,0]},{texture:a},[n.z,n.w]),r.currentPass){let{descriptor:e}=r;for(let t=0;t<e.colorAttachments.length;t++)e.colorAttachments[t].loadOp=Z.Load;if(t.depth&&(e.depthStencilAttachment.depthLoadOp=Z.Load),t.stencil&&(e.depthStencilAttachment.stencilLoadOp=Z.Load),r.currentPass=o.beginRenderPass(e),r.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor){let{x:e,y:n,width:i,height:a}=t.scissorValue;r.currentPass.setScissorRect(e,n,i,a)}}else this.device.queue.submit([o.finish()]);e.generateMipmaps&&this.textureUtils.generateMipmaps(e)}},Eb=new class extends $n{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type=`MeshPhongMaterial`,this.color=new T(16777215),this.specular=new T(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new T(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ke,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap=`round`,this.wireframeLinejoin=`round`,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Db=class extends Pf{static get type(){return`MeshPhongNodeMaterial`}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(Eb),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new n_(t):null}setupLightingModel(){return new h_}setupVariants(){let e=(this.shininessNode?P(this.shininessNode):yd).max(1e-4);vo.assign(e);let t=this.specularNode||Sd;go.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}},Ob=class extends $n{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type=`MeshStandardMaterial`,this.defines={STANDARD:``},this.color=new T(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new T(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ke,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap=`round`,this.wireframeLinejoin=`round`,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:``},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},kb=new Ob,Ab=class extends Pf{static get type(){return`MeshStandardNodeMaterial`}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(kb),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t===null&&e.environmentNode&&(t=e.environmentNode),t?new $g(t):null}setupLightingModel(){return new z_}setupSpecular(){let e=G(L(.04),H.rgb,ro);go.assign(e),_o.assign(1)}setupVariants(){let e=this.metalnessNode?P(this.metalnessNode):Od;ro.assign(e);let t=this.roughnessNode?P(this.roughnessNode):Dd;t=Rh({roughness:t}),no.assign(t),this.setupSpecular(),H.assign(R(H.rgb.mul(e.oneMinus()),H.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}},jb=new class extends Ob{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:``,PHYSICAL:``},this.type=`MeshPhysicalMaterial`,this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new w(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,`reflectivity`,{get:function(){return ye(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new T(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new T(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new T(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:``,PHYSICAL:``},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}},Mb=class extends Ab{static get type(){return`MeshPhysicalNodeMaterial`}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(jb),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||this.clearcoatNode!==null}get useIridescence(){return this.iridescence>0||this.iridescenceNode!==null}get useSheen(){return this.sheen>0||this.sheenNode!==null}get useAnisotropy(){return this.anisotropy>0||this.anisotropyNode!==null}get useTransmission(){return this.transmission>0||this.transmissionNode!==null}get useDispersion(){return this.dispersion>0||this.dispersionNode!==null}setupSpecular(){let e=this.iorNode?P(this.iorNode):Hd;So.assign(e),go.assign(G(Rs(qs(So.sub(1).div(So.add(1))).mul(wd),L(1)).mul(Cd),H.rgb,ro)),_o.assign(G(Cd,1,ro))}setupLightingModel(){return new z_(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){let e=this.clearcoatNode?P(this.clearcoatNode):Ad,t=this.clearcoatRoughnessNode?P(this.clearcoatRoughnessNode):jd;io.assign(e),ao.assign(Rh({roughness:t}))}if(this.useSheen){let e=this.sheenNode?L(this.sheenNode):Pd,t=this.sheenRoughnessNode?P(this.sheenRoughnessNode):Fd;oo.assign(e),so.assign(t)}if(this.useIridescence){let e=this.iridescenceNode?P(this.iridescenceNode):Ld,t=this.iridescenceIORNode?P(this.iridescenceIORNode):Rd,n=this.iridescenceThicknessNode?P(this.iridescenceThicknessNode):zd;co.assign(e),lo.assign(t),uo.assign(n)}if(this.useAnisotropy){let e=(this.anisotropyNode?I(this.anisotropyNode):Id).toVar();po.assign(e.length()),Oa(po.equal(0),()=>{e.assign(I(1,0))}).Else(()=>{e.divAssign(I(po)),po.assign(po.saturate())}),fo.assign(po.pow2().mix(no.pow2(),1)),mo.assign(ud[0].mul(e.x).add(ud[1].mul(e.y))),ho.assign(ud[1].mul(e.x).sub(ud[0].mul(e.y)))}if(this.useTransmission){let e=this.transmissionNode?P(this.transmissionNode):Bd,t=this.thicknessNode?P(this.thicknessNode):Vd,n=this.attenuationDistanceNode?P(this.attenuationDistanceNode):Ud,r=this.attenuationColorNode?L(this.attenuationColorNode):Wd;if(Co.assign(e),wo.assign(t),To.assign(n),Eo.assign(r),this.useDispersion){let e=this.dispersionNode?P(this.dispersionNode):Xd;Do.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?L(this.clearcoatNormalNode):Md}setup(e){e.context.setupClearcoatNormal=()=>mc(this.setupClearcoatNormal(e),`NORMAL`,`vec3`),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}},Nb=N(({normal:e,lightDirection:t,builder:n})=>{let r=I(e.dot(t).mul(.5).add(.5),0);if(n.material.gradientMap)return L(Gu(`gradientMap`,`texture`).context({getUV:()=>r}).r);{let e=r.fwidth().mul(.5);return G(L(.7),L(1),nc(P(.7).sub(e.x),P(.7).add(e.x),r.x))}}),Pb=class extends cg{direct({lightDirection:e,lightColor:t,reflectedLight:n},r){let i=Nb({normal:Jl,lightDirection:e,builder:r}).mul(t);n.directDiffuse.addAssign(i.mul(Ph({diffuseColor:H.rgb})))}indirect(e){let{ambientOcclusion:t,irradiance:n,reflectedLight:r}=e.context;r.indirectDiffuse.addAssign(n.mul(Ph({diffuseColor:H}))),r.indirectDiffuse.mulAssign(t)}},Fb=new class extends $n{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:``},this.type=`MeshToonMaterial`,this.color=new T(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new T(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap=`round`,this.wireframeLinejoin=`round`,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}},Ib=class extends Pf{static get type(){return`MeshToonNodeMaterial`}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Fb),this.setValues(e)}setupLightingModel(){return new Pb}},Lb=class extends gf{static get type(){return`BasicLightMapNode`}constructor(e=null){super(),this.lightMapNode=e}setup(e){let t=P(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}},Rb=new or,zb=class extends Pf{static get type(){return`MeshBasicNodeMaterial`}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Rb),this.setValues(e)}setupNormal(){return ql(Zl)}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new n_(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new Lb(Zd)),t}setupOutgoingLight(){return H.rgb}setupLightingModel(){return new d_}},Bb=new class extends $n{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type=`MeshLambertMaterial`,this.color=new T(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new T(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ke,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap=`round`,this.wireframeLinejoin=`round`,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Vb=class extends Pf{static get type(){return`MeshLambertNodeMaterial`}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Bb),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return t?new n_(t):null}setupLightingModel(){return new h_(!1)}},Hb=new class extends $n{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type=`MeshNormalMaterial`,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}},Ub=class extends Pf{static get type(){return`MeshNormalNodeMaterial`}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(Hb),this.setValues(e)}setupDiffuseColor(){let e=this.opacityNode?P(this.opacityNode):xd;H.assign(Sc(R(au(K),e),ft))}},Wb=new class extends $n{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:``},this.type=`MeshMatcapMaterial`,this.color=new T(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new w(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:``},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}},Gb=class extends Pf{static get type(){return`MeshMatcapNodeMaterial`}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(Wb),this.setValues(e)}setupVariants(e){let t=ru,n;n=e.material.matcap?Gu(`matcap`,`texture`).context({getUV:()=>t}):L(G(.2,.8,t.y)),H.rgb.mulAssign(n.rgb)}},Kb=new lr,qb=class extends Pf{static get type(){return`LineBasicNodeMaterial`}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(Kb),this.setValues(e)}},Jb=new class extends lr{constructor(e){super(),this.isLineDashedMaterial=!0,this.type=`LineDashedMaterial`,this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}},Yb=class extends Pf{static get type(){return`LineDashedNodeMaterial`}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(Jb),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){let e=this.offsetNode?P(this.offsetNode):Jd,t=this.dashScaleNode?P(this.dashScaleNode):Gd,n=this.dashSizeNode?P(this.dashSizeNode):Kd,r=this.gapSizeNode?P(this.gapSizeNode):qd;bo.assign(n),xo.assign(r);let i=hc(Zc(`lineDistance`).mul(t));(e?i.add(e):i).mod(bo.add(xo)).greaterThan(bo).discard()}},Xb=new class extends $n{constructor(e){super(),this.isSpriteMaterial=!0,this.type=`SpriteMaterial`,this.color=new T(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}},Zb=class extends Pf{static get type(){return`SpriteNodeMaterial`}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.transparent=!0,this.setDefaultValues(Xb),this.setValues(e)}setupPositionView(e){let{object:t,camera:n}=e,{positionNode:r,rotationNode:i,scaleNode:a,sizeAttenuation:o}=this,s=Pl.mul(L(r||0)),c=I(Ml[0].xyz.length(),Ml[1].xyz.length());a!==null&&(c=c.mul(I(a))),n.isPerspectiveCamera&&o===!1&&(c=c.mul(s.z.negate()));let l=Rl.xy;if(t.center&&t.center.isVector2===!0){let e=Tc(`center`,`vec2`,t);l=l.sub(e.sub(.5))}l=l.mul(c);let u=P(i||Nd),d=ou(l,u);return R(s.xy.add(d),s.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}},Qb=new class extends $n{constructor(e){super(),this.isPointsMaterial=!0,this.type=`PointsMaterial`,this.color=new T(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}},$b=new w,ex=class extends Zb{static get type(){return`PointsNodeMaterial`}constructor(e){super(),this.sizeNode=null,this.isPointsNodeMaterial=!0,this.setDefaultValues(Qb),this.setValues(e)}setupPositionView(){let{positionNode:e}=this;return Pl.mul(L(e||zl)).xyz}setupVertexSprite(e){let{material:t,camera:n}=e,{rotationNode:r,scaleNode:i,sizeNode:a,sizeAttenuation:o}=this,s=super.setupVertex(e);if(t.isNodeMaterial!==!0)return s;let c=a===null?Yd:I(a);c=c.mul(yl),n.isPerspectiveCamera&&o===!0&&(c=c.mul(tx.div(Ul.z.negate()))),i&&i.isNode&&(c=c.mul(I(i)));let l=Rl.xy;if(r&&r.isNode){let e=P(r);l=ou(l,e)}return l=l.mul(c),l=l.div(wl.div(2)),l=l.mul(s.w),s=s.add(R(l,0,0)),s}setupVertex(e){return e.object.isPoints?super.setupVertex(e):this.setupVertexSprite(e)}get alphaToCoverage(){return this._useAlphaToCoverage}set alphaToCoverage(e){this._useAlphaToCoverage!==e&&(this._useAlphaToCoverage=e,this.needsUpdate=!0)}},tx=B(1).onFrameUpdate(function({renderer:e}){this.value=.5*e.getSize($b).y}),nx=class extends cg{constructor(){super(),this.shadowNode=P(1).toVar(`shadowMask`)}direct({lightNode:e}){e.shadowNode!==null&&this.shadowNode.mulAssign(e.shadowNode)}finish({context:e}){H.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(H.rgb)}},rx=new class extends $n{constructor(e){super(),this.isShadowMaterial=!0,this.type=`ShadowMaterial`,this.color=new T(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}},ix=class extends Pf{static get type(){return`ShadowNodeMaterial`}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.transparent=!0,this.setDefaultValues(rx),this.setValues(e)}setupLightingModel(){return new nx}},ax=class extends it{constructor(e,t=1){super(),this.isLight=!0,this.type=`Light`,this.color=new T(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){let t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,this.groundColor!==void 0&&(t.object.groundColor=this.groundColor.getHex()),this.distance!==void 0&&(t.object.distance=this.distance),this.angle!==void 0&&(t.object.angle=this.angle),this.decay!==void 0&&(t.object.decay=this.decay),this.penumbra!==void 0&&(t.object.penumbra=this.penumbra),this.shadow!==void 0&&(t.object.shadow=this.shadow.toJSON()),this.target!==void 0&&(t.object.target=this.target.uuid),t}},ox=class extends ax{constructor(e,t,n=0,r=2){super(e,t),this.isPointLight=!0,this.type=`PointLight`,this.distance=n,this.decay=r,this.shadow=new Fn}get power(){return this.intensity*4*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}},sx=class extends Xe{constructor(){super(new Ff(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}},cx=class extends ax{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type=`DirectionalLight`,this.position.copy(it.DEFAULT_UP),this.updateMatrix(),this.target=new it,this.shadow=new sx}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}},lx=class extends ax{constructor(e,t,n=10,r=10){super(e,t),this.isRectAreaLight=!0,this.type=`RectAreaLight`,this.width=n,this.height=r}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){let t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}},ux=class extends Xe{constructor(){super(new rn(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){let t=this.camera,n=_*2*e.angle*this.focus,r=this.mapSize.width/this.mapSize.height*this.aspect,i=e.distance||t.far;(n!==t.fov||r!==t.aspect||i!==t.far)&&(t.fov=n,t.aspect=r,t.far=i,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}},dx=class extends ax{constructor(e,t,n=0,r=Math.PI/3,i=0,a=2){super(e,t),this.isSpotLight=!0,this.type=`SpotLight`,this.position.copy(it.DEFAULT_UP),this.updateMatrix(),this.target=new it,this.distance=n,this.angle=r,this.penumbra=i,this.decay=a,this.map=null,this.shadow=new ux}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}},fx=class extends ax{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type=`AmbientLight`}},px=class extends ax{constructor(e,t,n){super(e,n),this.isHemisphereLight=!0,this.type=`HemisphereLight`,this.position.copy(it.DEFAULT_UP),this.updateMatrix(),this.groundColor=new T(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}},mx=class{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new C)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){let n=e.x,r=e.y,i=e.z,a=this.coefficients;return t.copy(a[0]).multiplyScalar(.282095),t.addScaledVector(a[1],.488603*r),t.addScaledVector(a[2],.488603*i),t.addScaledVector(a[3],.488603*n),t.addScaledVector(a[4],1.092548*(n*r)),t.addScaledVector(a[5],1.092548*(r*i)),t.addScaledVector(a[6],.315392*(3*i*i-1)),t.addScaledVector(a[7],1.092548*(n*i)),t.addScaledVector(a[8],.546274*(n*n-r*r)),t}getIrradianceAt(e,t){let n=e.x,r=e.y,i=e.z,a=this.coefficients;return t.copy(a[0]).multiplyScalar(.886227),t.addScaledVector(a[1],2*.511664*r),t.addScaledVector(a[2],2*.511664*i),t.addScaledVector(a[3],2*.511664*n),t.addScaledVector(a[4],2*.429043*n*r),t.addScaledVector(a[5],2*.429043*r*i),t.addScaledVector(a[6],.743125*i*i-.247708),t.addScaledVector(a[7],2*.429043*n*i),t.addScaledVector(a[8],.429043*(n*n-r*r)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let n=0;n<9;n++)this.coefficients[n].addScaledVector(e.coefficients[n],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let n=0;n<9;n++)this.coefficients[n].lerp(e.coefficients[n],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return new this.constructor().copy(this)}fromArray(e,t=0){let n=this.coefficients;for(let r=0;r<9;r++)n[r].fromArray(e,t+r*3);return this}toArray(e=[],t=0){let n=this.coefficients;for(let r=0;r<9;r++)n[r].toArray(e,t+r*3);return e}static getBasisAt(e,t){let n=e.x,r=e.y,i=e.z;t[0]=.282095,t[1]=.488603*r,t[2]=.488603*i,t[3]=.488603*n,t[4]=1.092548*n*r,t[5]=1.092548*r*i,t[6]=.315392*(3*i*i-1),t[7]=1.092548*n*i,t[8]=.546274*(n*n-r*r)}},hx=class extends ax{constructor(e=new mx,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){let t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}},gx=class extends dx{constructor(e,t,n,r,i,a){super(e,t,n,r,i,a),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}},_x=class extends dx{constructor(e,t,n,r,i,a){super(e,t,n,r,i,a),this.aspect=null}copy(e,t){return super.copy(e,t),this.aspect=e.aspect,this}},vx=class extends Y_{constructor(){super(),this.addMaterial(Db,`MeshPhongMaterial`),this.addMaterial(Ab,`MeshStandardMaterial`),this.addMaterial(Mb,`MeshPhysicalMaterial`),this.addMaterial(Ib,`MeshToonMaterial`),this.addMaterial(zb,`MeshBasicMaterial`),this.addMaterial(Vb,`MeshLambertMaterial`),this.addMaterial(Ub,`MeshNormalMaterial`),this.addMaterial(Gb,`MeshMatcapMaterial`),this.addMaterial(qb,`LineBasicMaterial`),this.addMaterial(Yb,`LineDashedMaterial`),this.addMaterial(ex,`PointsMaterial`),this.addMaterial(Zb,`SpriteMaterial`),this.addMaterial(ix,`ShadowMaterial`),this.addLight(Em,ox),this.addLight(Bg,cx),this.addLight(Wg,lx),this.addLight(Gg,dx),this.addLight(Yg,fx),this.addLight(Xg,px),this.addLight(Zg,hx),this.addLight(Kg,gx),this.addLight(Jg,_x),this.addToneMapping(lp,1),this.addToneMapping(up,2),this.addToneMapping(dp,3),this.addToneMapping(pp,4),this.addToneMapping(_p,6),this.addToneMapping(vp,7)}},yx=class extends Dv{constructor(e={}){let t;e.forceWebGL?t=Cy:(t=Tb,e.getFallback=()=>(console.warn(`THREE.WebGPURenderer: WebGPU is not available, running under WebGL2 backend.`),new Cy(e)));let n=new t(e);super(n,e),this.library=new vx,this.isWebGPURenderer=!0,typeof __THREE_DEVTOOLS__<`u`&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent(`observe`,{detail:this}))}};export{yx as default};