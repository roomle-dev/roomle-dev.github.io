import{Er as e,F as t,Rt as n,Wt as r,en as i,ft as a,gi as o,pt as s,ta as c,tn as l}from"./index-BVOtHrRf.js";var u=class{constructor(){this._nonTransparentComponent=null,this._raycaster=new c,this._raycaster.near=.1,this._raycaster.layers.enable(a.OBJECT),this._raycaster.layers.enable(a.COMPONENT),this._raycaster.layers.enable(a.PREVIEW),this._raycaster.layers.enable(a.UI)}init(e,t){this._object=e,this._camera=t,this.checkComponentVisibility=r(this.checkComponentVisibility,100).bind(this),this.checkPreviewVisibility=r(this.checkPreviewVisibility,100).bind(this)}setCamera(e){this._camera=e}setObject(e){this._object=e}changeMaterialsOnSelect(e,t,n=!1,r){t!==this._nonTransparentComponent&&(this._nonTransparentComponent=t,this._changeMaterialsOnSelect(e,t,n,r))}_changeMaterialsOnSelect(e,t,r=!1,i){if(e.children.length>0)for(let a of e.children){let o=t&&e.id===t.id||r,s=!(a instanceof n);a.userData.ignoreComponentRaycast||this._changeMaterialsOnSelect(a,t,o&&s?!1:o,i)}if(t)e instanceof n&&e.material instanceof s&&!e.userData.oldMaterial&&(e.userData.oldMaterial=e.material,e.material=e.material.clone(),r||o(e,{opacity:.2,transparent:!0}).then(()=>{i?.()}));else if(e.userData.oldMaterial&&e instanceof n&&e.material instanceof s){let{opacity:t,transparent:n}=e.userData.oldMaterial;o(e,{opacity:t,transparent:n}).then(()=>i?.()),e.userData.oldMaterial=void 0}}isComponentVisible(t){let n=[];t.traverse(e=>n.push(e.uuid));let r=new e().setFromObject(t).getCenter(new l),i=new l().subVectors(r,this._camera.position).normalize();this._raycaster.set(this._camera.position,i),this._raycaster.far=this._camera.position.distanceTo(r);let a=[];return this._raycaster.intersectObjects(this._object.children,!0).forEach(e=>{e.object.material.visible&&(n.includes(e.object.uuid)||e.object.userData.ignoreComponentRaycast||a.push(e))}),a.length===0}checkComponentAndPreviewVisibility(e,t){e.hasSelection()?this.checkComponentVisibility(e,t):t.hasPreviews()?this.checkPreviewVisibility(t):this.changeMaterialsOnSelect(this._object,null)}checkComponentVisibility(e,t){if(!e.hasSelection())return;let n=t.getComponentsForIds(e.getSelectedRuntimeComponentIds());if(n.length>1)return;let r=n[0];this.isComponentVisible(r)?this.changeMaterialsOnSelect(this._object,null):this.changeMaterialsOnSelect(this._object,r)}areAllPreviewsVisible(e){if(!e.hasPreviews())return!0;let t=e.getPreviews();return t.length===0?!0:t.map(e=>this.isComponentVisible(e)).reduce((e,t)=>e&&t)}areAllComponentsInFrustum(n){if(n.length===0)return!0;let r=new i,a=new t().multiplyMatrices(this._camera.projectionMatrix,this._camera.matrixWorldInverse),o=new e;r.setFromProjectionMatrix(a);let s=e=>{let t=o.setFromObject(e).getCenter(new l);return r.containsPoint(t)};return n.map(e=>s(e)).reduce((e,t)=>e&&t)}checkPreviewVisibility(e){e.hasPreviewLines()||(this.areAllPreviewsVisible(e)?this.changeMaterialsOnSelect(this._object,null):this.changeMaterialsOnSelect(this._object,{id:-1}))}isComponentMeasurementLabelOccluded(e,t){let n=new l().subVectors(e,this._camera.position).normalize(),r=this._camera.position.distanceTo(e);return this._raycaster.set(this._camera.position,n),this._raycaster.far=r-.01,this._raycaster.intersectObject(t,!0).filter(e=>{let t=e.object;return!(t.type!==`Mesh`||t.userData.ignoreComponentRaycast||t.material&&!t.material.visible)}).length>0}checkMultipleLabelOcclusion(e,t){let n=new Set;return e.forEach(({id:e,worldPos:r})=>{this.isComponentMeasurementLabelOccluded(r,t)&&n.add(e)}),n}};export{u as t};